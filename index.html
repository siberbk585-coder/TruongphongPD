<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cổng Tác Vụ DQA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#5aa9ff',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #3b82f6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#2563eb 0%,#60a5fa 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .modal.open{display:flex}
    .section-title{display:flex;align-items:center;gap:8px}
    .section-title .badge{background:rgba(90,169,255,.15);color:#1e40af;border:1px solid rgba(90,169,255,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .submit-btn{background:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);box-shadow:0 4px 6px rgba(37,99,235,.1),0 1px 3px rgba(37,99,235,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(37,99,235,.12),0 3px 6px rgba(37,99,235,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Form 5: zebra rows & vertical dividers */
    .table-zebra tbody tr:nth-child(even){ background-color:#f8fafc; }
    .cell-div{ border-left:1px solid #e5e7eb; }
    .table-vdiv{ border-collapse: separate; border-spacing: 0; }
    .table-vdiv th+th, .table-vdiv td+td{ border-left:1px solid #e5e7eb; }
    /* Form 5: ẩn cột Số DONE (có thể bật lại sau) */
    .f5a-col-done{ display:table-cell; }
    /* Drag row highlight */
    .drag-over{ background-color:#e0f2fe !important; }
    /* Highlight effect for Form 1 upload sections */
    .highlight-section{
      animation: highlightPulse 2s ease-in-out;
      border: 2px solid #5aa9ff;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(90, 169, 255, 0.3);
      background: linear-gradient(135deg, rgba(90, 169, 255, 0.1), rgba(255, 255, 255, 0.1));
    }
    @keyframes highlightPulse {
      0% { 
        border-color: #5aa9ff;
        box-shadow: 0 0 20px rgba(90, 169, 255, 0.3);
        background: linear-gradient(135deg, rgba(90, 169, 255, 0.1), rgba(255, 255, 255, 0.1));
      }
      50% { 
        border-color: #3b82f6;
        box-shadow: 0 0 30px rgba(90, 169, 255, 0.5);
        background: linear-gradient(135deg, rgba(90, 169, 255, 0.15), rgba(255, 255, 255, 0.15));
      }
      100% { 
        border-color: #5aa9ff;
        box-shadow: 0 0 20px rgba(90, 169, 255, 0.3);
        background: linear-gradient(135deg, rgba(90, 169, 255, 0.1), rgba(255, 255, 255, 0.1));
      }
    }
    /* Sidebar effects for groups */
    .group-btn{ position:relative; font-weight:600; color:#e5f0ff; background:rgba(90,169,255,.12); border:1px solid rgba(90,169,255,.35); border-radius:8px; }
    .group-btn:hover{ background:rgba(90,169,255,.18); color:#ffffff; }
    .group-btn.active{ background:linear-gradient(135deg,#2563eb 0%,#5aa9ff 100%); color:#ffffff; box-shadow:0 4px 10px rgba(37,99,235,.25); border-color:rgba(255,255,255,.35); }
    .group-btn::after{ content:"▾"; position:absolute; right:10px; opacity:.9; transition: transform .2s ease; }
    .group-btn.active::after{ transform: rotate(180deg); }
    .group-items{ transition: all .2s ease; }
    .group-items .nav-btn{ background: transparent; }
    .group-items .nav-btn:hover{ background: rgba(255,255,255,0.06); }
    /* Sidebar collapse/expand on hover - chỉ khi đã chọn form */
    #sidebar-nav {
      transition: width 0.3s ease-in-out;
      position: sticky;
      top: 0;
      align-self: flex-start;
      max-height: 100vh;
      overflow-y: auto;
    }
    /* Khi sidebar có class collapsible và không hover - rút gọn */
    #sidebar-nav.collapsible:not(:hover) {
      width: 4rem;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    #sidebar-nav.collapsible:hover {
      width: 16rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }
    #sidebar-nav.collapsible:not(:hover) h1 {
      opacity: 0;
      height: 0;
      padding: 0;
      margin: 0;
      border: none;
      overflow: hidden;
      white-space: nowrap;
    }
    #sidebar-nav.collapsible:hover h1 {
      opacity: 1;
      height: auto;
      padding-bottom: 1.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid rgba(147, 197, 253, 0.5);
      transition: opacity 0.3s ease-in-out 0.1s, height 0.3s ease-in-out 0.1s;
    }
    #sidebar-nav.collapsible:not(:hover) .group-btn,
    #sidebar-nav.collapsible:not(:hover) .nav-btn {
      font-size: 0.65rem;
      text-align: center;
      padding-left: 0.25rem;
      padding-right: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #sidebar-nav.collapsible:hover .group-btn,
    #sidebar-nav.collapsible:hover .nav-btn {
      font-size: inherit;
      text-align: left;
      padding-left: 1rem;
      padding-right: 1rem;
    }
    #sidebar-nav.collapsible:not(:hover) .group-items:not(.hidden) {
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.2s ease-in-out, max-height 0.2s ease-in-out;
    }
    #sidebar-nav.collapsible:hover .group-items:not(.hidden) {
      opacity: 1;
      max-height: 1000px;
      transition: opacity 0.3s ease-in-out 0.15s, max-height 0.3s ease-in-out 0.15s;
    }
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
  <!-- Sidebar -->
  <aside id="sidebar-nav" class="w-64 min-h-screen bg-sidebar text-white flex flex-col py-8 px-4 shadow-lg transition-all duration-300 ease-in-out overflow-hidden sticky top-0 self-start">
    <h1 class="text-xl font-bold tracking-wide pb-6 border-b border-blue-200 mb-4 whitespace-nowrap">Cổng Tác Vụ DQA</h1>
    <nav class="flex flex-col gap-2 mt-2">
      <div class="rounded-md">
        <button class="group-btn w-full py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base">Trả báo cáo</button>
        <div class="group-items hidden mt-1 pl-2 flex flex-col gap-1">
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form1">Form 1 · Tra cứu tác vụ</button>
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form2">Form 2 · Trả kế hoạch thử nghiệm</button>
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form3">Form 3 · Giao việc</button>
        </div>
      </div>
      <div class="rounded-md">
        <button class="group-btn w-full py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base">KPI nhóm cải tiến</button>
        <div class="group-items hidden mt-1 pl-2 flex flex-col gap-1">
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form4">Form 4 · Bảng theo dõi (Doing)</button>
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form5">Form 5: KPI tháng</button>
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form6">Form 6 · Ý tưởng cải tiến</button>
        </div>
      </div>
      <div class="rounded-md">
        <button class="group-btn w-full py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base">Khai báo</button>
        <div class="group-items hidden mt-1 pl-2 flex flex-col gap-1">
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form7">Form 7 · Triển khai CE</button>
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form8">Form 8 · Triển khai 4M</button>
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form9">Form 9 · Thống kê test bền</button>
        </div>
      </div>
      <div class="rounded-md">
        <button class="group-btn w-full py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base">Khác</button>
        <div class="group-items hidden mt-1 pl-2 flex flex-col gap-1">
          <button class="nav-btn py-2 px-3 rounded transition hover:bg-sidebar-hover text-left text-sm" data-target="form10">Form 10 · Quản lý nhân sự</button>
        </div>
      </div>
      <div class="pt-2 border-t border-white/10 mt-2">
        <button class="nav-btn w-full py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form0">Form 0 · Hướng dẫn sử dụng</button>
      </div>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 py-10 flex flex-col items-center min-h-screen overflow-y-auto">
    <div class="header-container relative w-full max-w-6xl rounded-xl overflow-hidden mb-8">
      <div class="relative z-10 p-8 md:p-10">
        <div class="flex items-center space-x-2 mb-3">
          <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold text-white" style="background-color: rgba(255,255,255,0.15); backdrop-filter: blur(5px);">Phòng DQA</div>
        </div>
        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">Cổng tác vụ DQA - Nội bộ</h2>
        <p class="text-blue-100 text-sm md:text-base">Vui lòng không chia sẻ link cổng tác vụ với người ngoài bộ phận.</p>
      </div>
    </div>

    <!-- Form 1 -->
    <section id="form1" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 1 · Tra cứu tác vụ</h2>
        <div class="flex items-center gap-2">
          <button id="f1-export" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xuất server</button>
          <button id="f1-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xuất XLSX</button>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tên</label>
          <div class="flex gap-2">
            <select id="f1-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
            <button id="f1-search" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra cứu</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Chọn tên và nhấn Tra cứu để gửi yêu cầu và hiển thị tác vụ</p>
        </div>
      </div>
      <div class="mt-2 flex items-center gap-3 flex-wrap">
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Tháng</label>
          <input id="f1-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
        </div>
      </div>
      <div class="mt-4 space-y-6 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[1600px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[160px] border border-gray-500">Trả báo cáo</th>
              <th class="px-3 py-2 min-w-[140px] border border-gray-500">Tình trạng</th>
              <th class="px-3 py-2 min-w-[140px] border border-gray-500">Mã tác vụ</th>
              <th class="px-3 py-2 min-w-[140px] border border-gray-500">Mã</th>
              <th class="px-3 py-2 min-w-[390px] border border-gray-500">Tên tác vụ</th>
              <th class="px-3 py-2 min-w-[180px] border border-gray-500">Tgian nộp form</th>
              <th class="px-3 py-2 min-w-[160px] border border-gray-500">Ngày cần trả BC</th>
              <th class="px-3 py-2 min-w-[160px] border border-gray-500">Người yêu cầu</th>
              <th class="px-3 py-2 min-w-[160px] border border-gray-500">Người nhận mẫu</th>
              <th class="px-3 py-2 min-w-[120px] border border-gray-500">Công chuẩn</th>
              <th class="px-3 py-2 min-w-[140px] border border-gray-500">Ngày yêu cầu</th>
              <th class="px-3 py-2 min-w-[140px] border border-gray-500">Hạn mong muốn</th>
              <th class="px-3 py-2 min-w-[140px] border border-gray-500">Hạn đáp ứng</th>
              <th class="px-3 py-2 min-w-[260px] border border-gray-500">Mục đích đánh giá</th>
              <th class="px-3 py-2 min-w-[360px] border border-gray-500">Note</th>
              <th class="px-3 py-2 min-w-[240px] border border-gray-500">Yêu cầu test đặc biệt</th>
              <th class="px-3 py-2 min-w-[260px] border border-gray-500">Form báo cáo đánh giá</th>
              <th class="px-3 py-2 min-w-[220px] border border-gray-500">Tên file đính kèm</th>
              <th class="px-3 py-2 min-w-[140px] border border-gray-500">Tải đính kèm</th>
            </tr>
          </thead>
          <tbody id="f1-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="19">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <div id="f1-pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="f1-page-info">Trang 1/1 (0 dòng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hiển thị</label>
          <select id="f1-size" class="border border-blue-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <button id="f1-prev" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Trước</button>
          <button id="f1-next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>

      <!-- Điểm lưu trữ file đính kèm -->
      <div class="mt-4">
        <a id="f1-storage-link" href="https://drive.google.com/drive/folders/1hFChHMjIC4ajY4GNX3dLoczWcZ3B9zzg?usp=sharing" target="_blank" rel="noopener" title="Nhấn để mở và tự động copy liên kết"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">
          Điểm lưu trữ file đính kèm
        </a>
        <p class="text-xs text-gray-500 mt-1">Nhấn để mở và copy liên kết.</p>
      </div>
    </section>

    <!-- Form 2 -->
    <section id="form2" class="w-full max-w-7xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 2 · Trả form báo cáo</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tên</label>
          <div class="flex gap-2">
            <select id="f2-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
            <button id="f2-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra cứu</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Chọn tên và nhấn Tra cứu để hiển thị tác vụ cần trả form.</p>
        </div>
      </div>
      <div class="mt-4 overflow-x-auto border border-gray-200 rounded-lg">
        <table class="min-w-[900px] w-full text-sm border-collapse">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700 border-b border-gray-300">
              <th class="px-3 py-2 border-r border-gray-200">Mã tác vụ</th>
              <th class="px-3 py-2 border-r border-gray-200">Ngày yêu cầu</th>
              <th class="px-3 py-2 border-r border-gray-200">Hạn mong muốn</th>
              <th class="px-3 py-2 border-r border-gray-200">Hạn đáp ứng</th>
              <th class="px-3 py-2 border-r border-gray-200">Mã</th>
              <th class="px-3 py-2 border-r border-gray-200">Tên tác vụ</th>
              <th class="px-3 py-2 min-w-[120px]">Nút Trả form</th>
            </tr>
          </thead>
          <tbody id="f2-body" class="divide-y divide-gray-200">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Form 3 -->
    <section id="form3" class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="section-title">
          <h2 class="text-xl font-semibold text-blue-800">Form 3 · Giao việc</h2>
          <span class="badge">DQA nội bộ</span>
        </div>
      </div>
      <form id="assign-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Người yêu cầu <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
            <input id="rq-by" required type="text" placeholder="Nhập tên người yêu cầu" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Thời gian yêu cầu</label>
            <input id="rq-time" readonly type="text" class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">Cố định theo thời gian hệ thống</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email người yêu cầu</label>
            <input id="rq-by-email" type="email" readonly placeholder="Tự động theo Người yêu cầu" class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">Tự động điền theo "Người yêu cầu"</p>
          </div>
        </div>
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tên tác vụ <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
          <input id="task-name" required type="text" placeholder="Nhập tên tác vụ" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
        </div>
      </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Người được giao <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
            <select id="f3-assignee" required class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Công chuẩn <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
            <input id="man-hour" required type="text" min="0" placeholder="VD: 12,5" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            <p class="text-gray-500 text-xs mt-1">Sử dụng dấu phẩy (,) cho số thập phân. VD: 12,5</p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Đầu ra công việc <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
            <input id="output" required type="text" placeholder="Mô tả đầu ra" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
            <input id="deadline" type="date" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mã Odoo/Jira</label>
            <input id="odoo-jira" type="text" placeholder="VD: ODOO-123 hoặc JIRA-456" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tài liệu đính kèm</label>
            <input id="attach" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
            <div id="f3-upload-list" class="mt-2 text-sm"></div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mục đích yêu cầu</label>
            <select id="rq-purpose" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="Đánh giá Sản phẩm SOP">Đánh giá Sản phẩm SOP</option>
              <option value="Đánh giá sản phẩm mới">Đánh giá sản phẩm mới</option>
              <option value="Tác vụ khác">Tác vụ khác</option>
            </select>
          </div>
        </div>
        <div class="pt-2 flex items-center gap-3">
          <button type="submit" class="submit-btn px-6 py-2 text-white font-semibold transition">Giao việc</button>
        </div>
      </form>
    </section>

    <!-- Form 4 -->
    <section id="form4" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="section-title">
          <h2 class="text-xl font-semibold text-blue-800">Form 4 · Bảng theo dõi</h2>
        </div>
        <div class="flex items-center gap-2">
          <input type="hidden" id="f4-status" value="Doing" />
          <label class="text-sm text-gray-700">Tháng</label>
          <input id="f4-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          <button id="f4-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra cứu</button>
        </div>
      </div>
      <div class="mb-2 flex items-center gap-2 flex-wrap">
        <button id="f4-btn-all" class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">Tất cả thành viên</button>
        <button id="f4-btn-linh" class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">Nhóm Linh</button>
        <button id="f4-btn-hieu" class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">Nhóm Hiếu</button>
      </div>
      <div id="f4-main-doing" class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[480px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr id="f4-head-row-static" class="text-left text-gray-700">
              <th class="px-3 py-2 relative">
                <button id="f4-filter-toggle" class="inline-flex items-center gap-1 hover:text-primary-blue">
                  Nhân viên <span class="text-xs">▾</span>
                </button>
                <div id="f4-filter-pop" class="absolute z-20 mt-2 left-0 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 hidden">
                  <div class="flex items-center gap-2 mb-2">
                    <input id="f4-filter-search" type="text" placeholder="Tìm người..." class="flex-1 border border-blue-300 rounded bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
                  </div>
                  <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                    <div class="flex items-center gap-3">
                      <button id="f4-filter-select-all" class="underline">Chọn tất cả</button>
                      <button id="f4-filter-clear" class="underline">Bỏ chọn</button>
                    </div>
                    <button id="f4-filter-apply" class="px-2 py-1 rounded bg-primary-blue text-white text-xs">Lọc</button>
                  </div>
                  <div id="f4-filter-list" class="max-h-60 overflow-auto space-y-1 text-sm">
                    <label class="flex items-center gap-2" data-name="(Chỗ trống)"><input type="checkbox" value="(Chỗ trống)" class="f4-filter-item h-4 w-4"/><span>(Chỗ trống)</span></label>
                  </div>
                </div>
              </th>
              <th class="px-3 py-2">Tổng công chuẩn</th>
              <th class="px-3 py-2">Số tác vụ</th>
              
            </tr>
          </thead>
          <tbody id="f4-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="3">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Form 4: All tasks table (separate structure) -->
      <div id="f4-main-all" class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg hidden">
        <table class="min-w-[1100px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Nhân viên</th>
              <th class="px-3 py-2">Công chuẩn đã nhận</th>
              <th class="px-3 py-2">Số tác vụ</th>
              <th class="px-3 py-2">Số DONE</th>
              <th class="px-3 py-2">Vượt tiến độ</th>
              <th class="px-3 py-2">Đúng tiến độ</th>
              <th class="px-3 py-2">Chậm tiến độ</th>
              <th class="px-3 py-2">Tỷ lệ vượt (%)</th>
              <th class="px-3 py-2">Tỷ lệ đúng (%)</th>
              <th class="px-3 py-2">Tỷ lệ chậm (%)</th>
            </tr>
          </thead>
          <tbody id="f4-body-all" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Pivot Overdue View -->
      <div id="f4-pivot-wrap" class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <div class="flex items-center justify-between p-3">
          <div class="text-sm text-gray-700">Bản tổng hợp việc quá hạn theo trạng thái</div>
          <div class="flex items-center gap-2">
            <button id="f4-pivot-refresh" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">Làm mới</button>
          </div>
        </div>
        <table id="f4-pivot-table" class="min-w-[760px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Assignee</th>
              <th class="px-3 py-2">Mã</th>
              <th class="px-3 py-2">Tên tác vụ</th>
              <th class="px-3 py-2">Trạng thái</th>
              <th class="px-3 py-2">Ngày yêu cầu</th>
              <th class="px-3 py-2">Hạn mong muốn</th>
              <th class="px-3 py-2">Hạn đáp ứng</th>
            </tr>
          </thead>
          <tbody id="f4-pivot-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Chưa có dữ liệu</td></tr>
          </tbody>
          <tfoot>
            <tr class="bg-blue-50 font-semibold text-blue-900">
              <td class="px-3 py-2" colspan="6">Tổng số tác vụ quá hạn:</td>
              <td class="px-3 py-2" id="f4-pivot-sum-total">0</td>
            </tr>
          </tfoot>
        </table>
        <div class="p-2 text-xs text-gray-500" id="f4-pivot-note"></div>
      </div>
      <div id="f4-chart-container" class="mt-4 h-80" style="display:none">
        <canvas id="f4-chart"></canvas>
      </div>
    </section>

    <!-- Form 5: KPI tháng -->
    <section id="form5" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 5: KPI tháng</h2>
        <div class="flex items-center gap-2">
          <button id="f5a-export" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xuất server</button>
          <button id="f5a-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xuất XLSX</button>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center gap-2 p-2">
          <label class="text-sm text-gray-700">Tháng</label>
          <input id="f5a-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
        </div>
        <!-- Tab Navigation -->
        <div class="mt-2 flex items-center gap-2 border-b border-gray-200">
          <button id="f5a-tab-p1" class="px-4 py-2 font-semibold text-white bg-primary-blue rounded-t-lg border-b-2 border-primary-blue">P1</button>
          <button id="f5a-tab-p2" class="px-4 py-2 font-semibold text-gray-600 hover:text-primary-blue hover:bg-blue-50 rounded-t-lg">P2</button>
          <button id="f5a-tab-p3" class="px-4 py-2 font-semibold text-gray-600 hover:text-primary-blue hover:bg-blue-50 rounded-t-lg">P3</button>
          <button id="f5a-tab-p4" class="px-4 py-2 font-semibold text-gray-600 hover:text-primary-blue hover:bg-blue-50 rounded-t-lg">P4</button>
        </div>
        <!-- Thẻ P1: cột 1,5,6,7,8,9 (+ % như cũ) -->
        <div id="f5a-panel-p1" class="f5a-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2">
          <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white flex items-center justify-center">
            <span class="font-semibold text-blue-800 mr-4">Thẻ P1</span>
            <button id="f5a-search-p1" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra cứu P1</button>
          </div>
          <div class="overflow-auto max-h-[60vh] p-2">
          <table class="min-w-[1200px] w-full text-sm table-zebra table-vdiv">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Nhân viên</th>
              <th class="px-3 py-2 f5a-col-done">Số DONE</th>
              <th class="px-3 py-2">Vượt tiến độ</th>
              <th class="px-3 py-2">Đúng tiến độ</th>
              <th class="px-3 py-2">Chậm tiến độ</th>
              <th class="px-3 py-2">Số N/A</th>
              <th class="px-3 py-2">Tỷ lệ vượt (%)</th>
              <th class="px-3 py-2">Tỷ lệ đúng (%)</th>
              <th class="px-3 py-2">Tỷ lệ chậm (%)</th>
              <th class="px-3 py-2">%N/A</th>
            </tr>
          </thead>
            <tbody id="f5a-body-p1" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <!-- Thẻ P2: cột 1,2,3,4 (đã đổi cột 4 -> Tổng giờ công đi làm) -->
        <div id="f5a-panel-p2" class="f5a-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2 hidden">
          <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white flex items-center justify-center">
            <span class="font-semibold text-blue-800 mr-4">Thẻ P2</span>
            <button id="f5a-search-p2" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra cứu P2</button>
          </div>
          <div class="mx-3 my-2 text-xs inline-flex items-center gap-1 px-2 py-1 rounded bg-amber-50 border border-amber-200 text-amber-700">
            Nhấn tra cứu dữ liệu form 10 trước để nhận kết quả chính xác
          </div>
          <div class="overflow-auto max-h-[60vh] p-2">
          <table class="min-w-[900px] w-full text-sm table-zebra table-vdiv">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Nhân viên</th>
                <th class="px-3 py-2">Số tác vụ trong tháng</th>
                <th class="px-3 py-2">Tổng giờ đánh giá thực tế</th>
                <th class="px-3 py-2">Công chuẩn đã nhận</th>
                <th class="px-3 py-2 cell-div">Tổng giờ công đi làm</th>
                <th class="px-3 py-2">Hệ số</th>
              </tr>
            </thead>
            <tbody id="f5a-body-p2" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
          </div>
        </div>
        <!-- Thẻ P3: Rà soát CE -->
        <div id="f5a-panel-p3" class="f5a-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2 hidden">
          <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white flex items-center justify-center">
            <span class="font-semibold text-blue-800 mr-4">Thẻ P3 - Rà soát CE</span>
            <button id="f5a-search-p3" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra cứu P3</button>
          </div>
          <div class="overflow-auto max-h-[60vh] p-2">
            <table class="min-w-[1200px] w-full text-sm table-zebra table-vdiv">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                <tr class="text-left text-gray-700">
                  <th class="px-3 py-2">Tên nhân viên</th>
                  <th class="px-3 py-2">Số tác vụ hoàn thành tháng</th>
                  <th class="px-3 py-2">Tác vụ đã hoàn thiện CE</th>
                  <th class="px-3 py-2">Tác vụ không cần làm CE</th>
                  <th class="px-3 py-2">Chưa hoàn thành</th>
                  <th class="px-3 py-2">Thẻ P3/Rà soát CE (%)</th>
                </tr>
              </thead>
              <tbody id="f5a-body-p3" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Chưa có dữ liệu</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- Thẻ P4: Phân tích chi tiết -->
        <div id="f5a-panel-p4" class="f5a-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2 hidden">
          <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white flex items-center justify-center">
            <span class="font-semibold text-blue-800 mr-4">Thẻ P4 - Phân tích chi tiết</span>
            <button id="f5a-search-p4" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra cứu P4</button>
          </div>
          <div class="overflow-auto max-h-[60vh] p-2">
            <table class="min-w-[1400px] w-full text-sm table-zebra table-vdiv">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
                <tr class="text-left text-gray-700">
                  <th class="px-3 py-2">Tên nhân viên</th>
                  <th class="px-3 py-2">Tổng tác vụ máy</th>
                  <th class="px-3 py-2">TCKT(% hoàn thành)</th>
                  <th class="px-3 py-2">CE(% hoàn thành)</th>
                  <th class="px-3 py-2">HDKT(% hoàn thành)</th>
                  <th class="px-3 py-2">BB đào tạo(% hoàn thành)</th>
                  <th class="px-3 py-2">Jig tool(% hoàn thành)</th>
                  <th class="px-3 py-2">KHKSCL(% hoàn thành)</th>
                  <th class="px-3 py-2">Thẻ P4 (%)</th>
                </tr>
              </thead>
              <tbody id="f5a-body-p4" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Chưa có dữ liệu</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="f5a-chart-controls" class="mt-4 text-sm text-gray-700 flex items-center gap-3" style="display:none">
        <span>Biểu đồ theo PIC</span>
        <div class="flex items-center gap-2">
          <label class="text-xs text-gray-600">Chế độ</label>
          <select id="f5a-mode" class="border border-blue-200 rounded bg-white text-sm px-2 py-1">
            <option value="vertical">Cột dọc</option>
            <option value="horizontal">Thanh ngang</option>
          </select>
        </div>
        <button id="f5a-refresh" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Làm mới</button>
      </div>
      <div class="mt-2" style="display:none">
        <div class="text-xs text-gray-600 mb-1">Tỷ lệ trạng thái</div>
        <div id="f5a-chart-container" class="h-80" style="display:none">
          <canvas id="f5a-chart"></canvas>
        </div>
      </div>
      <div class="mt-4" style="display:none">
        <div class="text-xs text-gray-600 mb-1">Tổng công chuẩn</div>
        <div id="f5a-chart-container-manhour" class="h-80" style="display:none">
          <canvas id="f5a-chart-manhour"></canvas>
        </div>
      </div>
    </section>

    <!-- Form 10 · Quản lý nhân sự -->
    <section id="form10" class="w-full max-w-7xl bg-white p-6 rounded-lg shadow-md hidden">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-blue-800">Form 10 · Quản lý nhân sự</h2>
    </div>
      

      <!-- Bảng công (theo tháng) -->
      <div class="mt-8 flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold text-blue-800">Bảng công (theo tháng)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Tháng</label>
          <input id="f10-att-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          <button id="f10-att-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra cứu</button>
          <button id="f10-att-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xuất XLSX</button>
        </div>
      </div>
      <div class="overflow-x-auto border border-gray-200 rounded-lg">
        <table class="min-w-[800px] w-full text-sm border-collapse">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700 border-b border-gray-300">
              <th class="px-3 py-2">Nhân sự</th>
              <th class="px-3 py-2">Số ngày đi làm (tháng)</th>
              <th class="px-3 py-2">Tổng giờ tăng ca (tháng)</th>
              <th class="px-3 py-2">Tổng giờ công đi làm</th>
            </tr>
          </thead>
          <tbody id="f10-att-body" class="divide-y divide-gray-200">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <div class="mt-3 flex items-center justify-end">
        <a id="f10-att-detail-link" href="https://docs.google.com/spreadsheets/d/1vTaH-tOBv5GZ64Ij34mFyDH3r_7tkaVYCpheyOtDckU/" target="_blank" rel="noopener" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Giờ công chi tiết</a>
      </div>
    </section>

    <!-- Form 6 -->
    <section id="form6" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 6 · Ý tưởng cải tiến</h2>
        <div class="flex items-center gap-2">
          <button id="f6-open-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Nộp ý tưởng</button>
          <button id="f6-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra cứu</button>
          <button id="f6-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xuất XLSX</button>
        </div>
      </div>

      <div class="flex items-center gap-2 p-2">
        <label class="text-sm text-gray-700">Tháng nộp</label>
        <input id="f6-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
      </div>

      <div class="mt-6 -mx-6">
        <div class="overflow-auto max-h-[60vh] border border-gray-200 rounded-lg bg-white">
          <table class="min-w-[2000px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Ngày nộp</th>
                <th class="px-3 py-2">Nhân viên</th>
                <th class="px-3 py-2">Tiêu đề ý tưởng</th>
                <th class="px-3 py-2">Vấn đề nhận diện</th>
                <th class="px-3 py-2">Giải pháp</th>
                <th class="px-3 py-2">Ý kiến trưởng phòng</th>
                <th class="px-3 py-2">Trạng thái</th>
              </tr>
            </thead>
            <tbody id="f6-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="f6-count" class="mt-4 p-3 rounded-lg border border-blue-200 bg-blue-50/30 text-blue-800 cursor-pointer inline-flex items-center gap-2">
        <span>Nhấn để xem số ý tưởng đã nộp</span>
      </div>
      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-blue-800">Thống kê ý tưởng theo nhân viên</h3>
          <span id="f6-agg-note" class="text-xs text-gray-500"></span>
        </div>
        <div class="overflow-auto max-h-[50vh] border border-gray-200 rounded-lg bg-white">
          <table class="min-w-[520px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Nhân viên</th>
                <th class="px-3 py-2">Tổng số ý tưởng</th>
                <th class="px-3 py-2">Số ý tưởng được duyệt</th>
                <th class="px-3 py-2">Hành động</th>
              </tr>
            </thead>
            <tbody id="f6-agg-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- Form 7 · Triển khai CE/4M (clone of Form 2 with wording changes) -->
    <section id="form7" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 7 · Triển khai CE</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tên</label>
          <div class="flex gap-2">
            <select id="f7-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
            <button id="f7-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra cứu</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Chọn tên và nhấn Tra cứu để hiển thị tác vụ cần trả CE/4M.</p>
        </div>
      </div>
      <div class="mt-2 flex items-center gap-3 flex-wrap">
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Lọc theo tháng hoàn thành</label>
          <input id="f7-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          <button id="f7-clear-month" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Xóa lọc</button>
        </div>
        <p class="text-gray-500 text-xs">Để trống để hiển thị tất cả. Lọc theo cột "Ngày hoàn thành thực tế"</p>
      </div>
      
      <!-- Removed stray Form 9 controls from Form 7 -->
      <div class="mt-4 border border-gray-200 rounded-lg shadow-md overflow-x-auto">
        <table class="min-w-[1600px] w-full text-sm border-collapse">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-3 min-w-[120px] border border-gray-300">Mã tác vụ</th>
              <th class="px-3 py-3 min-w-[140px] border border-gray-300">Ngày hoàn thành thực tế</th>
              <th class="px-3 py-3 min-w-[120px] border border-gray-300">Mã linh kiện/máy</th>
              <th class="px-3 py-3 min-w-[200px] border border-gray-300">Task Name</th>
              <th class="px-3 py-3 min-w-[120px] border border-gray-300">Mã Báo cáo</th>
              <th class="px-3 py-3 min-w-[150px] border border-gray-300">Kết quả đánh giá</th>
              <th class="px-3 py-3 min-w-[150px] border border-gray-300">Ghi chú</th>
              <th class="px-3 py-3 min-w-[100px] bg-cyan-50 text-cyan-800 border border-gray-300">Khai báo CE</th>
              <th class="px-3 py-3 min-w-[130px] bg-cyan-50 text-cyan-800 border border-gray-300">Tình trạng rà soát</th>
              <th class="px-3 py-3 min-w-[180px] bg-cyan-50 text-cyan-800 border border-gray-300">Ngày khai báo CE gần nhất</th>
              <th class="px-3 py-3 min-w-[120px] bg-amber-50 text-amber-800 border border-gray-300">Khai báo mẫu bàn giao</th>
              <th class="px-3 py-3 min-w-[150px] bg-amber-50 text-amber-800 border border-gray-300">Tình trạng mẫu bàn giao</th>
              <th class="px-3 py-3 min-w-[200px] bg-amber-50 text-amber-800 border border-gray-300">Ghi chú bàn giao mẫu</th>
            </tr>
          </thead>
          <tbody id="f7-body" class="divide-y divide-gray-200">
            <tr><td class="px-3 py-4 text-center text-gray-500" colspan="13">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Form 8 · Triển khai 4M -->
    <section id="form8" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 8 · Triển khai 4M</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tên</label>
          <div class="flex gap-2">
            <select id="f8-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
            <button id="f8-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra cứu</button>
            <a id="f8-template-link-top" href="https://drive.usercontent.google.com/download?id=1-8rjlAXi1x8lM235Smzd_jxoxmwT39kN&export=download&authuser=5&confirm=t&uuid=1f5e95c2-1291-4c15-a8d7-557f2a291549&at=AKSUxGNj-8k957V0Bj3nmNOF40aM:1760320142017" target="_blank" rel="noopener" class="px-3 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Form mẫu</a>
          </div>
          <p class="text-gray-500 text-xs mt-1">Chọn tên và nhấn Tra cứu để hiển thị tác vụ cần trả 4M.</p>
        </div>
      </div>
      <div class="mt-2 flex items-center gap-3 flex-wrap">
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Lọc theo tháng hoàn thành</label>
          <input id="f8-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          <button id="f8-clear-month" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Xóa lọc</button>
        </div>
        <p class="text-gray-500 text-xs">Để trống để hiển thị tất cả. Lọc theo cột "Ngày hoàn thành thực tế"</p>
      </div>

      <!-- Bảng chi tiết tác vụ -->
      <div class="mt-4 border border-gray-200 rounded-lg shadow-md overflow-auto" style="max-height: 70vh;">
        <table class="min-w-[1600px] w-full text-sm table-auto">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700 font-medium">
              <th class="px-3 py-3 min-w-[120px] border-r border-gray-200">Mã tác vụ</th>
              <th class="px-3 py-3 min-w-[140px] border-r border-gray-200">Ngày hoàn thành thực tế</th>
              <th class="px-3 py-3 min-w-[120px] border-r border-gray-200">Mã linh kiện/máy</th>
              <th class="px-3 py-3 min-w-[200px] border-r border-gray-200">Task Name</th>
              <th class="px-3 py-3 min-w-[120px] border-r border-gray-200">Mã Báo cáo</th>
              <th class="px-3 py-3 min-w-[150px] border-r border-gray-200">Kết quả đánh giá</th>
              <th class="px-3 py-3 min-w-[150px] border-r border-gray-200">Ghi chú</th>
              <th class="px-3 py-3 min-w-[130px] border-r border-gray-200">Tình trạng rà soát</th>
              <th class="px-3 py-3 min-w-[120px] border-r border-gray-200">Khai báo 4M</th>
              <th class="px-3 py-3 min-w-[150px] border-r border-gray-200">Ngày khai báo gần nhất</th>
              <th class="px-3 py-3 min-w-[140px]">Tỷ lệ hoàn thành 4M</th>
            </tr>
          </thead>
          <tbody id="f8-body" class="divide-y divide-gray-200">
            <tr><td class="px-3 py-4 text-center text-gray-500" colspan="11">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Modal: Chi tiết 4M của tác vụ -->
    <div id="f8-4m-modal" class="modal" aria-hidden="true">
      <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 p-6 relative">
        <div class="px-4 py-3 bg-gradient-to-b from-emerald-50 to-white border-b border-gray-200 flex items-center justify-between">
          <h3 id="f8-4m-modal-title" class="text-lg font-semibold text-emerald-800">Chi tiết 4M</h3>
          <button id="f8-4m-modal-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
        </div>
        
        <div class="p-4">
          <!-- Thông tin tác vụ -->
          <div class="mb-4 space-y-2">
            <div class="text-sm"><span class="font-medium text-gray-700">Mã tác vụ:</span> <span id="f8-4m-task-id" class="text-blue-600 font-mono"></span></div>
            <div class="text-sm"><span class="font-medium text-gray-700">Task Name:</span> <span id="f8-4m-task-name" class="font-semibold"></span></div>
            <div class="text-sm"><span class="font-medium text-gray-700">Ngày hoàn thành:</span> <span id="f8-4m-completion-date"></span></div>
          </div>

          <!-- Bảng phần trăm 4M -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gradient-to-r from-emerald-100 to-emerald-50">
                <tr>
                  <th class="px-4 py-2 text-left text-gray-700">Hạng mục</th>
                  <th class="px-4 py-2 text-center text-gray-700">Tiến độ (%)</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2 font-medium">TCKT</td>
                  <td class="px-4 py-2 text-center"><span id="f8-4m-tckt" class="font-semibold text-emerald-700"></span></td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2 font-medium">CE</td>
                  <td class="px-4 py-2 text-center"><span id="f8-4m-ce" class="font-semibold text-emerald-700"></span></td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2 font-medium">HDKT</td>
                  <td class="px-4 py-2 text-center"><span id="f8-4m-hdkt" class="font-semibold text-emerald-700"></span></td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2 font-medium">BB đào tạo</td>
                  <td class="px-4 py-2 text-center"><span id="f8-4m-bb" class="font-semibold text-emerald-700"></span></td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2 font-medium">Jig tool</td>
                  <td class="px-4 py-2 text-center"><span id="f8-4m-jig" class="font-semibold text-emerald-700"></span></td>
                </tr>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2 font-medium">KHKSCL</td>
                  <td class="px-4 py-2 text-center"><span id="f8-4m-khkscl" class="font-semibold text-emerald-700"></span></td>
                </tr>
                <tr class="bg-emerald-50 font-semibold">
                  <td class="px-4 py-3">Trung bình 4M</td>
                  <td class="px-4 py-3 text-center"><span id="f8-4m-avg" class="text-lg text-emerald-700"></span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="px-4 py-3 border-t border-gray-200 flex justify-end">
          <button id="f8-4m-modal-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
        </div>
      </div>
    </div>

    <!-- Form 9 · Thống kê test bền -->
    <section id="form9" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 9 · Thống kê test bền</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tên</label>
          <div class="flex gap-2">
            <select id="f9-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
            <button id="f9-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra cứu</button>
        </div>
          <p class="text-gray-500 text-xs mt-1">Chọn tên và nhấn Tra cứu để hiển thị dữ liệu test bền.</p>
          </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Lọc theo tháng hoàn thành</label>
          <div class="flex items-center gap-2">
            <input id="f9-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            <button id="f9-clear-month" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Xóa lọc</button>
        </div>
          <p class="text-gray-500 text-xs mt-1">Để trống để hiển thị tất cả. Lọc theo cột "Ngày hoàn thành thực tế"</p>
        </div>
      </div>
      <!-- Removed old size/stat controls to avoid duplication -->
      <div id="f9-controls" class="mt-2 flex items-center gap-2">
        <button id="f9-open-stats" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-700">Thống kê</button>
        <button id="f9-export-xlsx" class="px-3 py-1 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Xuất XLSX</button>
      </div>
      <div class="mt-4 space-y-6 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[1600px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[60px] border border-gray-500">STT</th>
              <th class="px-3 py-2 min-w-[160px] border border-gray-500">Khai báo test bền</th>
              <th class="px-3 py-2 min-w-[180px] border border-gray-500">Ngày trả BC tức thời</th>
              <th class="px-3 py-2 min-w-[160px] border border-gray-500">Tình trạng test bền</th>
              <th class="px-3 py-2 min-w-[160px] border border-gray-500">Link bằng chứng</th>
              <th class="px-3 py-2 min-w-[220px] border border-gray-500">Dự kiến hoàn thành test bền</th>
              <th class="px-3 py-2 min-w-[120px] border border-gray-500">Mã</th>
              <th class="px-3 py-2 min-w-[260px] border border-gray-500">Task Name</th>
              <th class="px-3 py-2 min-w-[160px] border border-gray-500">Assignee</th>
              <th class="px-3 py-2 min-w-[140px] border border-gray-500">Mã Báo cáo</th>
              <th class="px-3 py-2 min-w-[140px] border border-gray-500">Mã tác vụ</th>
              <th class="px-3 py-2 min-w-[220px] border border-gray-500">Ghi chú</th>
            </tr>
          </thead>
          <tbody id="f9-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="12">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Form 0 (moved to end) -->
  <section id="form0" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-blue-800">Form 0 · Hướng dẫn sử dụng</h2>
    </div>
    <div class="rounded-lg border border-gray-200 overflow-hidden">
      <iframe src="https://docs.google.com/document/d/17dkhMxqyy2YnSxukHC6y94BSFNfnDQ50/preview" class="w-full" style="height: 80vh;" allow="clipboard-write; fullscreen"></iframe>
    </div>
    <div class="mt-3 text-sm">
      <a href="https://docs.google.com/document/d/17dkhMxqyy2YnSxukHC6y94BSFNfnDQ50/edit?usp=drive_link&ouid=101589232360066908244&rtpof=true&sd=true" target="_blank" rel="noopener" class="text-primary-blue hover:underline">Mở bản đầy đủ (hiện đề mục/thẻ)</a>
    </div>
  </section>
  <!-- Form 9: Modal chi tiết Test bền -->
  <div id="f9-dur-modal" class="modal" aria-hidden="true">
    <div class="bg-white rounded-2xl shadow-2xl max-w-[96vw] w-full mx-4 p-0 relative">
      <div class="px-6 py-4 bg-gradient-to-r from-blue-600 to-primary-blue text-white rounded-t-2xl flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-full bg-white/15 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-white"><path d="M3 6a1 1 0 011-1h3.28a1 1 0 01.948.684l.498 1.493A2 2 0 0010.64 8H19a1 1 0 110 2h-8.36a2 2 0 00-1.914 1.277l-.498 1.493A1 1 0 016.28 13H4a1 1 0 110-2h1.84l.36-1.08A4 4 0 0110.64 8H19V6H10.64a4 4 0 01-3.8-2.723L6.28 2H4a1 1 0 00-1 1v3z"/></svg>
          </div>
          <div>
        <h3 class="text-lg font-semibold leading-tight">Modal F9-1 · Chi tiết Test bền</h3>
            <div class="text-xs opacity-90">Khai báo/điều chỉnh thông tin 4 bài test và lưu một lần</div>
          </div>
        </div>
        <button id="f9-dur-close" class="text-white/90 hover:text-white text-2xl leading-none">&times;</button>
      </div>
      <div class="p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
          <div class="p-3 rounded-lg bg-blue-50 border border-blue-100"><div class="text-xs text-blue-700">Assignee</div><div id="f9-dur-assignee" class="font-medium text-blue-900"></div></div>
          <div class="p-3 rounded-lg bg-blue-50 border border-blue-100"><div class="text-xs text-blue-700">Mã tác vụ</div><div id="f9-dur-taskid" class="font-mono font-medium text-blue-900"></div></div>
          <div class="p-3 rounded-lg bg-blue-50 border border-blue-100 md:col-span-1"><div class="text-xs text-blue-700">Task Name</div><div id="f9-dur-taskname" class="font-medium text-blue-900"></div></div>
        </div>
        <div class="mt-3">
          <div class="inline-flex rounded-lg border border-gray-200 overflow-hidden">
            <button id="f9-tab-gatea" class="px-4 py-2 bg-blue-600 text-white font-semibold">Gate A</button>
            <button id="f9-tab-gateb" class="px-4 py-2 bg-white text-gray-700 hover:bg-gray-50">Gate B</button>
          </div>
        </div>
        <div id="f9-gatea-wrap" class="mt-3">
          <div class="mt-2 rounded-xl border border-gray-200 overflow-hidden">
            <div class="px-4 py-2 bg-gradient-to-r from-amber-100 to-amber-50 text-amber-900 font-semibold flex items-center gap-2">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded bg-amber-500 text-white text-xs">A</span>
              Gate A - Bằng chứng và cập nhật trạng thái
            </div>
            <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
              <div class="md:col-span-1">
                <label class="block text-gray-700 text-xs mb-1">Bằng chứng (đính kèm)</label>
                <input id="f9-gatea-file" type="file" class="block w-full text-sm text-gray-700 file:mr-3 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200" />
              </div>
              <div class="md:col-span-1">
                <label class="block text-gray-700 text-xs mb-1">Trạng thái</label>
                <select id="f9-gatea-status" class="w-full border border-gray-300 rounded px-2 py-2">
                  <option value="Pending">Pending</option>
                  <option value="Đang triển khai">Đang triển khai</option>
                  <option value="Hoàn thành">Hoàn thành</option>
                </select>
              </div>
              <div class="md:col-span-1">
                <label class="block text-gray-700 text-xs mb-1">Ghi chú</label>
                <input id="f9-gatea-note" type="text" class="w-full border border-gray-300 rounded px-2 py-2" placeholder="Ghi chú cho Gate A" />
              </div>
            </div>
          </div>
        </div>
        <div id="f9-gateb-wrap" class="mt-3" style="display:none">
          <div class="mt-2 rounded-xl border border-blue-200 overflow-hidden">
            <div class="px-4 py-2 bg-gradient-to-r from-blue-100 to-blue-50 text-blue-900 font-semibold flex items-center gap-2">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded bg-blue-500 text-white text-xs">B</span>
              Gate B - Trạng thái hiện tại (Test bền)
            </div>
          </div>
          <div class="rounded-xl border border-gray-200 shadow-sm overflow-x-hidden">
            <table class="w-full text-sm table-zebra table-vdiv">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50">
                <tr class="text-left text-gray-700">
                  <th class="px-4 py-2">Bài test</th>
                  <th class="px-4 py-2">Tiêu chuẩn</th>
                  <th class="px-4 py-2">Điều kiện</th>
                  <th class="px-4 py-2">Tiến độ</th>
                  <th class="px-4 py-2">Hành động</th>
                </tr>
              </thead>
              <tbody id="f9-dur-body" class="divide-y divide-gray-100 bg-white"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="px-6 py-4 border-t border-gray-200 bg-slate-50 rounded-b-2xl flex items-center justify-between">
        <div class="text-xs text-gray-600">Kiểm tra lại dữ liệu trước khi lưu. Bạn có thể điều chỉnh nhiều lần.</div>
        <div class="flex items-center gap-2">
          <button id="f9-dur-save-all" class="px-5 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105 shadow">Gửi dữ liệu</button>
          <button id="f9-dur-cancel" class="px-5 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 hover:bg-gray-50">Đóng</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Form 9: Modal thống kê -->
  <div id="f9-stats-modal" class="modal" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-xl max-w-xl w-full mx-4 p-6 relative">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-blue-800">Modal F9-2 · Thống kê test bền</h3>
        <button id="f9-stats-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      </div>
      <div class="p-4" id="f9-stats-body"></div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end">
        <button id="f9-stats-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="upload-title">
    <div class="w-full max-w-3xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
        <div class="flex items-center justify-between">
          <!-- Tabs for Gate 1 / Gate 2 (only show for Form 1) - moved to header as top tabs -->
          <div id="upload-tabs-wrap" class="flex items-end gap-2 text-sm" style="display:none">
            <button id="tab-gate1" class="px-5 py-2.5 rounded-t-lg border border-cyan-400 bg-cyan-200 text-cyan-900 -mb-[1px] text-base md:text-lg font-semibold shadow-sm">Gate 1: Báo cáo LK/Máy</button>
            <button id="tab-gate2" class="px-5 py-2.5 rounded-t-lg border border-cyan-400 bg-cyan-200 text-cyan-900 -mb-[1px] text-base md:text-lg font-semibold shadow-sm">Gate 2: Báo cáo máy Base, rà soát tem nhãn</button>
          </div>
        </div>
        <h3 id="upload-title" class="text-base font-semibold text-gray-800">Gửi báo cáo</h3>
      </div>
      <div id="upload-content" class="p-4 space-y-3 min-h-[460px]">
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Người nộp: <b class="ml-1" id="uploader-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Mã: <b class="ml-1" id="uploader-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Tác vụ: <b class="ml-1" id="uploader-task"></b></span>
        </div>
        <div id="upload-form2-single">
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tệp báo cáo</label>
          <div class="flex items-center gap-3">
            <input id="upload-file" type="file" class="hidden"/>
            <button id="upload-file-btn" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Chọn tệp</button>
            <span id="upload-file-name" class="text-sm text-gray-600">Không có tệp nào được chọn</span>
          </div>
          <p class="text-xs text-gray-500 mt-1">Tệp sẽ gửi kèm timestamp tại thời điểm gửi.</p>
        </div>
        <!-- Gate 1 heading (show only when Gate 1 active) -->
        <div id="gate1-title" class="mt-2 mb-1 text-3xl md:text-4xl font-bold text-cyan-700" style="display:none">Gate 1: Báo cáo LK/Máy</div>
        <div id="upload-form1-split" style="display:none">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Báo cáo PDF (.pdf)</label>
            <input id="upload-file-pdfzip" type="file" accept=".pdf" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-indigo-600 file:text-white"/>
            <p class="text-xs text-gray-500 mt-1">Chỉ nhận tệp .pdf.</p>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Báo cáo Excel (.xlsx)</label>
            <input id="upload-file-xlsxzip" type="file" accept=".xlsx" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white"/>
            <p class="text-xs text-gray-500 mt-1">Chỉ nhận tệp .xlsx.</p>
          </div>
        </div>
        <!-- Gate 1 extra: Phân loại -->
        <div id="upload-classification-group" class="mt-3 highlight-section" style="display:none">
          <label class="block text-sm font-medium text-gray-700 mb-1">Phân loại</label>
          <div class="flex flex-col gap-2">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="upload-classification" value="Sản phẩm" class="h-4 w-4"/>
              <span class="text-sm">Sản phẩm</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="upload-classification" value="Linh kiện" class="h-4 w-4"/>
              <span class="text-sm">Linh kiện</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="upload-classification" value="Tác vụ khác" class="h-4 w-4"/>
              <span class="text-sm">Tác vụ khác</span>
            </label>
          </div>
          <div id="classification-note" class="mt-2 text-xs text-gray-500" style="display:none"></div>
        </div>
        <!-- Gate 1 extra: Conclusion (radio) -->
        <div id="upload-conclusion-group" class="mt-3 highlight-section" style="display:none">
          <label class="block text-sm font-medium text-gray-700 mb-1">Kết luận</label>
          <div class="flex flex-col gap-2">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="upload-conclusion" value="Sản phẩm đạt chất lượng" class="h-4 w-4"/>
              <span class="text-sm">Sản phẩm đạt chất lượng</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="upload-conclusion" value="Sản phẩm không đạt chất lượng" class="h-4 w-4"/>
              <span class="text-sm">Sản phẩm không đạt chất lượng</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="upload-conclusion" value="Báo cáo tham khảo" class="h-4 w-4"/>
              <span class="text-sm">Báo cáo tham khảo</span>
            </label>
          </div>
        </div>
        <!-- Gate 1 extra: Khai báo test bền -->
        <div id="upload-durability-group" class="mt-3 highlight-section" style="display:none">
          <label class="block text-sm font-medium text-gray-700 mb-1">Khai báo test bền</label>
          <div class="flex flex-col gap-2">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="durability-choice" value="co" class="h-4 w-4"/>
              <span class="text-sm">Có test bền</span>
            </label>
            <div id="durability-date-wrap" class="ml-6 mt-1" style="display:none">
              <label class="block text-xs text-gray-600 mb-1">Ngày dự kiến trả test bền</label>
              <input id="durability-date" type="date" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            </div>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="durability-choice" value="khong" class="h-4 w-4"/>
              <span class="text-sm">Không test bền</span>
            </label>
          </div>
        </div>
        <!-- Gate 2: chỉ nhận file nén (.zip/.rar/.7z) -->
        <div id="upload-gate2" class="mt-3" style="display:none">
          <div id="gate2-title" class="mb-2 text-3xl md:text-4xl font-bold text-cyan-700">Gate 2: Báo cáo máy Base, rà soát tem nhãn</div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tệp nén báo cáo (Gate 2)</label>
          <input id="upload-file-archive-g2" type="file" accept=".zip,.rar,.7z" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
          <p class="text-xs text-gray-500 mt-1">Chỉ nhận tệp nén: .zip, .rar, .7z</p>
          <!-- Gate 2 extra: Phân loại -->
          <div id="upload-classification-group-g2" class="mt-3 highlight-section" style="display:none">
            <label class="block text-sm font-medium text-gray-700 mb-1">Phân loại</label>
            <div class="flex flex-col gap-2">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="upload-classification-g2" value="Sản phẩm" class="h-4 w-4"/>
                <span class="text-sm">Sản phẩm</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="upload-classification-g2" value="Linh kiện" class="h-4 w-4"/>
                <span class="text-sm">Linh kiện</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="upload-classification-g2" value="Tác vụ khác" class="h-4 w-4"/>
                <span class="text-sm">Tác vụ khác</span>
              </label>
            </div>
          </div>
        </div>
        <div id="bps-option" class="flex items-center gap-2">
          <input id="upload-bps" type="checkbox" class="h-4 w-4" checked>
          <label for="upload-bps" class="text-sm text-gray-700 select-none">Trả báo cáo BPS</label>
        </div>
      </div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Huỷ</button>
        <button id="btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Gửi báo cáo</button>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detail-title">
    <div class="w-full max-w-[95vw] bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden" style="width:95vw">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="detail-title" class="text-base font-semibold text-gray-800">Nhiệm vụ của <span id="detail-name" class="text-primary-blue"></span></h3>
        <button id="detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
      </div>
      <div class="p-4">
        <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
          <table class="min-w-[1400px] w-full text-sm">
            <tbody id="detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2" id="detail-note"></p>
      </div>
    </div>
  </div>

  <!-- Modal: Danh sách tác vụ nhận trong tháng (Form 5 - theo requestDate) -->
  <div id="rq-detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="rq-detail-title">
    <div class="w-full max-w-[95vw] bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden" style="width:95vw">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="rq-detail-title" class="text-base font-semibold text-gray-800">Tác vụ nhận trong tháng của <span id="rq-detail-name" class="text-primary-blue"></span></h3>
        <button id="rq-detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
      </div>
      <div class="p-4">
        <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
          <table class="min-w-[1200px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">STT</th>
                <th class="px-3 py-2">Mã</th>
                <th class="px-3 py-2">Tên tác vụ</th>
                <th class="px-3 py-2">Ngày yêu cầu</th>
                <th class="px-3 py-2">Công chuẩn</th>
                <th class="px-3 py-2">Số giờ đánh giá thực tế</th>
                <th class="px-3 py-2">Hạn mong muốn</th>
                <th class="px-3 py-2">Ngày hoàn thành</th>
                <th class="px-3 py-2">Trạng thái</th>
              </tr>
            </thead>
            <tbody id="rq-detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Form 5 Submit Modal -->
  <div id="f5-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f5-modal-title">
    <div class="w-full max-w-3xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
        <h3 id="f5-modal-title" class="text-base font-semibold text-gray-800">Nộp ý tưởng cải tiến</h3>
      </div>
      <div class="p-4 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ngày</label>
            <input id="f5-date" type="date" readonly class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">Cố định theo ngày nhập</p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nhân viên</label>
            <select id="f5-employee" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tiêu đề ý tưởng</label>
            <input id="f5-title" type="text" placeholder="Nhập tiêu đề" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Vấn đề nhận diện</label>
            <textarea id="f5-problem" rows="3" placeholder="Mô tả vấn đề" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Giải pháp</label>
            <textarea id="f5-solution" rows="3" placeholder="Mô tả giải pháp" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"></textarea>
          </div>
        </div>
      </div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="f5-btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Huỷ</button>
        <button id="f5-btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Gửi ý tưởng</button>
      </div>
    </div>
  </div>

  <!-- Form 6: Modal xem ý tưởng theo nhân viên -->
  <div id="f6-ideas-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f6-ideas-title">
    <div class="w-full max-w-4xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="f6-ideas-title" class="text-base font-semibold text-gray-800">Ý tưởng của <span id="f6-ideas-name" class="text-primary-blue"></span></h3>
        <button id="f6-ideas-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
      </div>
      <div class="p-4">
        <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
          <table class="min-w-[980px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Ngày nộp</th>
                <th class="px-3 py-2">Tiêu đề</th>
                <th class="px-3 py-2">Vấn đề nhận diện</th>
                <th class="px-3 py-2">Giải pháp</th>
                <th class="px-3 py-2">Ý kiến trưởng phòng</th>
                <th class="px-3 py-2">Trạng thái</th>
              </tr>
            </thead>
            <tbody id="f6-ideas-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Form 7 Modal riêng biệt - ĐÃ VÔ HIỆU HÓA (dùng form7-subpanel-modal thay thế) -->
  <!-- Modal cũ này không còn sử dụng, đã thay bằng form7-subpanel-modal ở dưới -->
  <!--
  <div id="form7-modal-old-deprecated" class="modal" aria-hidden="true" style="display:none !important;">
    ...Modal cũ đã bị vô hiệu hóa...
          </div>
  -->

  <!-- CE Review Modal -->
  <div id="ce-review-modal" class="modal" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 p-6 relative">
      <div class="px-4 py-3 bg-gradient-to-b from-cyan-50 to-white border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-cyan-800">CE Rà soát</h3>
          <button id="ce-review-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
        </div>
      </div>

      <div id="ce-review-content" class="p-4 space-y-4 min-h-[400px]">
        <!-- Thông tin tác vụ -->
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-cyan-50 border border-cyan-200">Người phụ trách: <b class="ml-1" id="ce-review-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-cyan-50 border border-cyan-200">Mã tác vụ: <b class="ml-1" id="ce-review-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-cyan-50 border border-cyan-200">Task Name: <b class="ml-1" id="ce-review-task-name"></b></span>
        </div>

        <!-- Nội dung CE rà soát sẽ được thêm sau -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-gray-600 text-center">Nội dung CE rà soát sẽ được khai báo sau</p>
        </div>
      </div>

      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="ce-review-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
        <button id="ce-review-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-cyan-600 hover:brightness-105">Lưu CE rà soát</button>
      </div>
    </div>
  </div>

  <!-- 4M Review Modal -->
  <div id="4m-review-modal" class="modal" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 p-6 relative">
      <div class="px-4 py-3 bg-gradient-to-b from-emerald-50 to-white border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-emerald-800">4M Rà soát</h3>
          <button id="4m-review-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
        </div>
      </div>

      <div id="4m-review-content" class="p-4 space-y-4 min-h-[400px]">
        <!-- Thông tin tác vụ -->
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Người phụ trách: <b class="ml-1" id="4m-review-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Mã tác vụ: <b class="ml-1" id="4m-review-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Task Name: <b class="ml-1" id="4m-review-task-name"></b></span>
        </div>

        <!-- Nội dung 4M rà soát sẽ được thêm sau -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-gray-600 text-center">Nội dung 4M rà soát sẽ được khai báo sau</p>
        </div>
      </div>

      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="4m-review-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
        <button id="4m-review-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-emerald-600 hover:brightness-105">Lưu 4M rà soát</button>
      </div>
    </div>
  </div>

  <!-- Form 8 Subpanel Modal -->
  <div id="form8-subpanel-modal" class="modal" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6 relative">
      <div class="px-4 py-3 bg-gradient-to-b from-emerald-50 to-white border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 id="form8-subpanel-title" class="text-lg font-semibold text-emerald-800">4M Rà soát - Gửi dữ liệu</h3>
          <button id="form8-subpanel-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
        </div>
      </div>

      <div id="form8-subpanel-content" class="p-4 space-y-4 min-h-[300px]">
        <!-- Thông tin tác vụ -->
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Người phụ trách: <b class="ml-1" id="form8-subpanel-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Mã tác vụ: <b class="ml-1" id="form8-subpanel-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-200">Task Name: <b class="ml-1" id="form8-subpanel-task-name"></b></span>
        </div>

        <!-- Form gửi dữ liệu -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
            <textarea id="form8-subpanel-notes" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent" rows="4" placeholder="Nhập ghi chú rà soát..."></textarea>
          </div>
          <div>
            <label id="form8-subpanel-file-label" class="block text-sm font-medium text-gray-700 mb-1">Đính kèm Excel (bắt buộc)</label>
            <input id="form8-subpanel-file" type="file" accept=".xlsx,.xls,.xlsm,.xlsb" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white"/>
            <p id="form8-subpanel-file-help" class="text-xs text-gray-500 mt-1">Chỉ chấp nhận file Excel (.xlsx, .xls, .xlsm, .xlsb). Tick "Không cần rà soát" để bỏ qua.</p>
          </div>
        </div>

        <!-- Checkbox cho 4M -->
        <div class="flex items-center gap-2 p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
          <input id="form8-subpanel-4m-checkbox" type="checkbox" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
          <label for="form8-subpanel-4m-checkbox" class="text-sm text-gray-700 cursor-pointer select-none">
            Không cần rà soát
          </label>
        </div>
      </div>

      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="form8-subpanel-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
        <button id="form8-subpanel-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-emerald-600 hover:brightness-105">Gửi 4M rà soát</button>
      </div>
    </div>
  </div>


  <!-- Form 7 Subpanel Modal -->
  <div id="form7-subpanel-modal" class="modal" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6 relative">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 id="form7-subpanel-title" class="text-lg font-semibold text-blue-800">CE/4M Rà soát - Gửi dữ liệu</h3>
          <button id="form7-subpanel-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
        </div>
      </div>

      <div id="form7-subpanel-content" class="p-4 space-y-4 min-h-[300px]">
        <!-- Thông tin tác vụ -->
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Người phụ trách: <b class="ml-1" id="form7-subpanel-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Mã tác vụ: <b class="ml-1" id="form7-subpanel-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Task Name: <b class="ml-1" id="form7-subpanel-task-name"></b></span>
        </div>

        <!-- Form gửi dữ liệu -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
            <textarea id="form7-subpanel-notes" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent" rows="4" placeholder="Nhập ghi chú rà soát..."></textarea>
          </div>
          <div>
            <label id="form7-subpanel-file-label" class="block text-sm font-medium text-gray-700 mb-1">Đính kèm (tùy chọn)</label>
            <input id="form7-subpanel-file" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
            <p id="form7-subpanel-file-help" class="text-xs text-gray-500 mt-1">Hỗ trợ mọi định dạng file phổ biến.</p>
          </div>
        </div>

        <!-- Checkbox cho CE -->
        <div id="form7-subpanel-ce-option" class="flex items-center gap-2 p-3 bg-cyan-50 border border-cyan-200 rounded-lg" style="display:none">
          <input id="form7-subpanel-ce-checkbox" type="checkbox" class="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 rounded">
          <label for="form7-subpanel-ce-checkbox" class="text-sm text-gray-700 cursor-pointer select-none">
            Tác vụ không cần làm CE
          </label>
        </div>
      </div>

      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="form7-subpanel-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
        <button id="form7-subpanel-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Gửi</button>
      </div>
    </div>
  </div>

  <!-- Modal: Khai báo mẫu bàn giao -->
  <div id="sample-handover-modal" class="modal" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-xl max-w-xl w-full mx-4 p-6 relative">
      <div class="px-4 py-3 bg-gradient-to-b from-orange-50 to-white border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-orange-800">Khai báo mẫu bàn giao</h3>
          <button id="sample-handover-close" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
        </div>
      </div>

      <div class="p-4 space-y-4">
        <!-- Thông tin tác vụ -->
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-orange-50 border border-orange-200">Người phụ trách: <b class="ml-1" id="sample-handover-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-orange-50 border border-orange-200">Mã tác vụ: <b class="ml-1" id="sample-handover-code"></b></span>
        </div>
        <div class="text-sm text-gray-600 bg-blue-50 p-2 rounded">
          <b>Task Name:</b> <span id="sample-handover-task-name"></span>
        </div>

        <!-- 3 lựa chọn -->
        <div class="space-y-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">Chọn trạng thái bàn giao:</label>
          
          <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-green-50 hover:border-green-300 transition">
            <input type="radio" name="sample-handover-status" value="Đã bàn giao" class="h-5 w-5 text-green-600 focus:ring-green-500">
            <div>
              <div class="font-semibold text-green-700">1. Đã bàn giao</div>
              <div class="text-xs text-gray-500">Mẫu đã được bàn giao đầy đủ</div>
            </div>
          </label>

          <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition">
            <input type="radio" name="sample-handover-status" value="Không cần bàn giao" class="h-5 w-5 text-blue-600 focus:ring-blue-500">
            <div>
              <div class="font-semibold text-blue-700">2. Không cần bàn giao</div>
              <div class="text-xs text-gray-500">Tác vụ không yêu cầu bàn giao mẫu</div>
            </div>
          </label>

          <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-red-50 hover:border-red-300 transition">
            <input type="radio" name="sample-handover-status" value="Không đủ mẫu bàn giao" class="h-5 w-5 text-red-600 focus:ring-red-500">
            <div>
              <div class="font-semibold text-red-700">3. Không đủ mẫu bàn giao</div>
              <div class="text-xs text-gray-500">Mẫu chưa đủ điều kiện để bàn giao</div>
            </div>
          </label>
        </div>

        <!-- Ghi chú bổ sung -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú (tùy chọn)</label>
          <textarea id="sample-handover-notes" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="3" placeholder="Nhập ghi chú bổ sung nếu cần..."></textarea>
        </div>
      </div>

      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="sample-handover-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Hủy</button>
        <button id="sample-handover-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-orange-500 hover:brightness-105">Xác nhận</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Constants
    const WEBHOOK_URL = "https://iatzhxxuk.tino.page/webhook/4cdacd75-92ce-4156-aa79-62fc60f51730";
    const FORM1_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/b843f631-2082-4b0a-b3ca-ba7fdf96f142";
    const FORM7_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/dc3b968a-2f2d-4746-98ac-48247555b9c9";
    // Riêng bảng phụ (subpanel) dùng kênh post này
    const FORM7_SUBPANEL_URL = "https://iatzhxxuk.tino.page/webhook/b33e7270-2817-4261-9936-2a217ef629b7";
    const FORM2_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/e067ccfb-f59b-43f0-b779-b9d1286549f9";
    const FORM2_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/2e394d3e-da1a-4577-9063-359a70518527";
    // Endpoint for Form 3 submission (single webhook; send form-data with optional files)
    const FORM3_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/21b742a9-a6b0-4393-9325-bfa470db5917";
    // Endpoints for Form 6 (submit & list)
    const FORM6_SUBMIT_URL = "https://iatzhxxuk.tino.page/webhook/8e42168f-cb7b-44da-ae44-571f1e072d53";
    // Form 9 endpoints
    const FORM9_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/f8f7bcbd-28a8-4ecf-a67d-551f853a0358";
    const FORM9_POST_URL = "https://iatzhxxuk.tino.page/webhook/a9239a08-167c-4245-b287-f904179aab64";
    const FORM6_LIST_URL = "https://iatzhxxuk.tino.page/webhook/7c18c686-7349-4d09-8769-e6a951096e73";
    // Backward-compat aliases for Form 6 handlers referencing FORM5_* names
    const FORM5_SUBMIT_URL = FORM6_SUBMIT_URL;
    const FORM5_LIST_URL = FORM6_LIST_URL;
    // Form 7 (CE/4M) lookup endpoint
    const FORM7_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/dc3b968a-2f2d-4746-98ac-48247555b9c9";
    // Form 7 (CE/4M) post endpoint
    const FORM7_POST_URL = "https://iatzhxxuk.tino.page/webhook/dc3b968a-2f2d-4746-98ac-48247555b9c9";
    // Form 7: Khai báo mẫu bàn giao endpoint
    const FORM7_SAMPLE_HANDOVER_URL = "https://iatzhxxuk.tino.page/webhook-test/70287654-ab36-4e9c-ba30-c922fdbbe63e";
    // Form 8 (4M) lookup endpoint - GET
    const FORM8_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/a734cb2d-eaa2-490a-95f5-0ce2118eaa6b";
    // Form 8 (4M) post endpoint - POST (để gửi dữ liệu khai báo)
    const FORM8_POST_URL = "https://iatzhxxuk.tino.page/webhook/a734cb2d-eaa2-490a-95f5-0ce2118eaa6b";
    // Form 9 endpoints đã khai báo ở trên
    // Form 5 All (new single-source endpoint)
    const FORM5_ALL_NEW_URL = "https://iatzhxxuk.tino.page/webhook/2c62c918-413c-49c3-99f6-49466f13c6d6";
    // Form 5 P3 (CE Review data)
    const FORM5_P3_URL = "https://iatzhxxuk.tino.page/webhook/ef64c141-a8ba-4bf0-af32-837ffd6f75d1";
    // Form 10 (Attendance) lookup endpoint - GET
    const FORM10_ATTENDANCE_URL = "https://iatzhxxuk.tino.page/webhook/f2baf83d-98c3-44f0-8eb4-b207ca2873d3";
    // Version hoá cache để tránh xung đột/hiển thị sai giữa các máy hoặc lần triển khai
    const APP_CACHE_VERSION = "2025-09-25-f5a-v4";
    let F4_CHART = null;
    let F5_LAST_COUNT = 0;
    let F4_PIVOT_BUSY = false;
    let F4_PIVOT_TMO = null;
    // Pivot cache (Form 4): lưu tất cả dòng quá hạn để lọc cục bộ khi chuyển nhóm
    let F4_PIVOT_ROWS_ALL = [];
    let F4_PIVOT_LAST_PARAMS = { from: '', to: '' };
    // Form 5 (All tasks) chart globals
    let F5A_CHART = null;
    let F5A_LAST_ROWS = [];
    let F5A_MODE = 'vertical';
    let F5A_CHART_MAN = null;
    let F5A_BASIS = 'rates';
    // Tạm thời vô hiệu hoá đồ thị Form 5
    const F5A_DISABLE_CHARTS = true;
    let F5A_RAW_ALL = [];
    let F5A_RAW_META = { month: '' };
    // Form 5 P3: Dữ liệu rà soát CE
    let F5A_P3_RAW = [];
    let F5A_P3_META = { month: '' };
    // Debug flag: bật/tắt bằng localStorage key "f5a.debug" = '1'
    function f5aIsDebug(){ try{ return (localStorage.getItem('f5a.debug')||'') === '1'; }catch(_){ return false; } }
    // Form 5: Công chuẩn cần nhận (có thể chỉnh tại đây)
    // Form 5: Công chuẩn cần nhận (đã bỏ, thay bằng dữ liệu Form 10)
    const F5A_NEED_MANHOUR_DEFAULT = 0;
    const F5A_NEED_MANHOUR_BY_NAME = {};
    // Form 7 rendering (clone of Form 2 with wording changes)
    let f7AllData = []; // Lưu tất cả dữ liệu Form 7
    let f7CurrentName = ''; // Lưu tên hiện tại
    
    function displayForm7Data() {
      const body = document.getElementById('f7-body');
      const monthFilter = (document.getElementById('f7-month').value || '').trim();
      
      // Lọc dữ liệu theo tháng nếu có
      let filteredData = f7AllData;
      if (monthFilter) {
        // monthFilter có dạng "2025-01"
        console.log('[Form7 Debug] Lọc theo tháng:', monthFilter);
        console.log('[Form7 Debug] Tổng số dữ liệu:', f7AllData.length);
        
        filteredData = f7AllData.filter(item => {
          const dateStr = String(item.actualCompletionDate || '').trim();
          if (!dateStr) {
            console.log('[Form7 Debug] Bỏ qua item không có ngày:', item.taskId);
            return false;
          }
          
          // Parse nhiều định dạng ngày
          let parsedDate = null;
          
          try {
            // Thử parse bằng toDateSafe
            const d = toDateSafe(dateStr);
            if (d && d instanceof Date && !isNaN(d.getTime())) {
              const year = d.getFullYear();
              const month = String(d.getMonth() + 1).padStart(2, '0');
              parsedDate = `${year}-${month}`;
            }
          } catch(_) {}
          
          // Nếu chưa parse được, thử regex
          if (!parsedDate) {
            // Thử dd/mm/yyyy hoặc dd-mm-yyyy
            const ddmmyyyyMatch = dateStr.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
            if (ddmmyyyyMatch) {
              const m = ddmmyyyyMatch[2].padStart(2,'0');
              const y = ddmmyyyyMatch[3];
              parsedDate = `${y}-${m}`;
            }
          }
          
          if (!parsedDate) {
            // Thử yyyy-mm-dd hoặc yyyy/mm/dd
            const yyyymmddMatch = dateStr.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
            if (yyyymmddMatch) {
              const y = yyyymmddMatch[1];
              const m = yyyymmddMatch[2].padStart(2,'0');
              parsedDate = `${y}-${m}`;
            }
          }
          
          const matched = parsedDate === monthFilter;
          if (!matched && parsedDate) {
            console.log('[Form7 Debug] Không khớp - dateStr:', dateStr, '| parsedDate:', parsedDate, '| monthFilter:', monthFilter);
          }
          
          return matched;
        });
        
        console.log('[Form7 Debug] Số dữ liệu sau lọc:', filteredData.length);
      }
      
      body.innerHTML = '';
      
      if (!filteredData.length) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Không có tác vụ'+ (monthFilter ? ' trong tháng đã chọn' : '') +'.</td></tr>';
        return;
      }
      
      filteredData.forEach(rowData => {
        const tr = document.createElement('tr');
        const name = f7CurrentName;
        
        // Render theo cấu trúc Form 7 (chỉ CE): Mã tác vụ, Ngày hoàn thành thực tế, Mã linh kiện/máy, Task Name, Mã Báo cáo, Kết quả đánh giá, Ghi chú, Khai báo CE, Tình trạng rà soát, Ngày khai báo gần nhất
        addTd(tr, rowData.taskId);
        addTd(tr, formatDdMmYyyy(rowData.actualCompletionDate));
        addTd(tr, rowData.code);
        addTd(tr, rowData.taskName);
        addTd(tr, rowData.reportCode);
        addTd(tr, rowData.evaluationResult);
        addTd(tr, rowData.notes);
        
        // Cột Khai báo CE (button) - với màu cyan
        const tdCeDeclare = document.createElement('td');
        tdCeDeclare.className = 'px-3 py-4 text-center bg-cyan-50 border border-gray-300';
        const btnCeDeclare = document.createElement('button');
        btnCeDeclare.className = 'px-3 py-1 rounded text-white bg-cyan-600 hover:brightness-105 text-sm font-medium';
        btnCeDeclare.textContent = 'Khai báo CE';
        btnCeDeclare.onclick = (e) => {
          e.preventDefault();
          if (btnCeDeclare.disabled) return;
          btnCeDeclare.disabled = true;
          btnCeDeclare.classList.add('opacity-50', 'pointer-events-none');
          openForm7SubpanelModal('ce', {
            name,
            code: rowData.code,
            taskId: rowData.taskId,
            taskName: rowData.taskName,
            reportCode: rowData.reportCode,
            evaluationResult: rowData.evaluationResult,
            notes: rowData.notes,
            ceReview: rowData.ceReview,
            ceDeclarationDate: rowData.ceDeclarationDate,
            fourMReview: rowData.fourMReview,
            fourMDeclarationDate: rowData.fourMDeclarationDate,
            f7emailassignee: rowData.f7emailassignee,
            rowData
          });
          setTimeout(() => {
            btnCeDeclare.disabled = false;
            btnCeDeclare.classList.remove('opacity-50', 'pointer-events-none');
          }, 300);
        };
        tdCeDeclare.appendChild(btnCeDeclare);
        tr.appendChild(tdCeDeclare);
        
        // Cột Tình trạng rà soát - với màu cyan
        const tdCeReview = document.createElement('td');
        tdCeReview.className = 'px-3 py-4 bg-cyan-50 text-cyan-800 border border-gray-300';
        tdCeReview.textContent = rowData.ceReview || '';
        tr.appendChild(tdCeReview);
        
        // Cột Ngày khai báo CE gần nhất - với màu cyan, hiển thị cả giờ phút
        const tdCeDate = document.createElement('td');
        tdCeDate.className = 'px-3 py-4 bg-cyan-50 text-cyan-800 border border-gray-300';
        tdCeDate.textContent = formatDdMmYyyyHHmm(rowData.ceDeclarationDate) || '';
        tr.appendChild(tdCeDate);
        
        // Khai báo mẫu bàn giao (màu cam)
        const tdSampleDeclare = document.createElement('td');
        tdSampleDeclare.className = 'px-3 py-4 text-center bg-amber-50 border border-gray-300';
        const btnSample = document.createElement('button');
        btnSample.className = 'px-3 py-1 rounded text-white bg-orange-500 hover:brightness-105 text-sm font-medium';
        btnSample.textContent = 'Khai báo mẫu';
        btnSample.onclick = (e)=>{ 
          e.preventDefault(); 
          if (btnSample.disabled) return;
          btnSample.disabled = true;
          btnSample.classList.add('opacity-50', 'pointer-events-none');
          openSampleHandoverModal({
            name,
            taskId: rowData.taskId,
            code: rowData.code,
            taskName: rowData.taskName,
            f7emailassignee: rowData.f7emailassignee
          });
          setTimeout(() => {
            btnSample.disabled = false;
            btnSample.classList.remove('opacity-50', 'pointer-events-none');
          }, 300);
        };
        tdSampleDeclare.appendChild(btnSample);
        tr.appendChild(tdSampleDeclare);

        // Tình trạng mẫu bàn giao (màu vàng nhạt)
        const tdSampleStatus = document.createElement('td');
        tdSampleStatus.className = 'px-3 py-4 bg-amber-50 text-amber-800 border border-gray-300';
        tdSampleStatus.textContent = rowData.sampleHandoverStatus || '';
        tr.appendChild(tdSampleStatus);

        // Ghi chú bàn giao mẫu (màu vàng nhạt)
        const tdSampleNotes = document.createElement('td');
        tdSampleNotes.className = 'px-3 py-4 bg-amber-50 text-amber-800 border border-gray-300';
        tdSampleNotes.textContent = rowData.sampleHandoverNotes || '';
        tr.appendChild(tdSampleNotes);

        body.appendChild(tr);
      });
    }
    
    function restoreForm7FromCache() {
      try {
        const cached = LS.getJSON('f7.cache');
        if (!cached || !Array.isArray(cached.data) || !cached.data.length) return false;
        
        const body = document.getElementById('f7-body');
        const nameSelect = document.getElementById('f7-name');
        if (!body || !nameSelect) return false;
        
        // Khôi phục dữ liệu
        f7AllData = cached.data.slice();
        f7CurrentName = cached.name || '';
        
        // Khôi phục dropdown tên
        if (cached.name) {
          nameSelect.value = cached.name;
        }
        
        // Hiển thị dữ liệu
        displayForm7Data();
        
        return true;
      } catch(_) {
        return false;
      }
    }
    
    async function renderForm7(){
      const name = (document.getElementById('f7-name').value || '').trim();
      const body = document.getElementById('f7-body');
        if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Vui lòng chọn tên</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='13' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      try{
        const headerMapF7 = {
          header_taskId: 'Mã tác vụ',
          header_actualCompletionDate: 'Ngày hoàn thành thực tế',
          header_code: 'Mã linh kiện/máy',
          header_taskName: 'Task Name',
          header_reportCode: 'Mã Báo cáo',
          header_evaluationResult: 'Kết quả đánh giá',
          header_notes: 'Ghi chú',
          header_ceReview: 'Tình trạng rà soát',
          header_ceDeclarationDate: 'Ngày khai báo gần nhất',
          header_4mReview: '4M rà soát',
          header_4mDeclarationDate: 'Ngày khai báo 4M',
          header_f7emailassignee: 'F7emailassignee',
          header_sampleHandoverStatus: 'Tình trạng mẫu bàn giao',
          header_sampleHandoverNotes: 'Ghi chú bàn giao mẫu',
          field_taskId: 'taskId',
          field_actualCompletionDate: 'actualCompletionDate',
          field_code: 'code',
          field_taskName: 'taskName',
          field_reportCode: 'reportCode',
          field_evaluationResult: 'evaluationResult',
          field_notes: 'notes',
          field_ceReview: 'ceReview',
          field_ceDeclarationDate: 'ceDeclarationDate',
          field_4mReview: '4mReview',
          field_4mDeclarationDate: '4mDeclarationDate',
          field_f7emailassignee: 'f7emailassignee',
          field_sampleHandoverStatus: 'sampleHandoverStatus',
          field_sampleHandoverNotes: 'sampleHandoverNotes'
        };
        const params = new URLSearchParams({
          ...headerMapF7,
          action: 'form7_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        const url = `${FORM7_LOOKUP_URL}?${params.toString()}`;
        const resp = await fetch(url, { method: 'GET' });
        const text = await resp.text();
        if(!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
        let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){ const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') queue.push(v);} }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        if(!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="12">Không có tác vụ.</td></tr>'; f7AllData=[]; return; }
        const getV = (obj, keys)=>{
          // Chuẩn hoá key: bỏ dấu, loại emoji/ký tự đặc biệt, gộp khoảng trắng
          const sanitize = (s)=>{
            try{
              const noDiacritics = String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
              const noEmoji = noDiacritics.replace(/[^\p{L}\p{N}\s_:\-]/gu,'');
              return noEmoji.toLowerCase().replace(/\s+/g,' ').trim();
            }catch(_){
              return String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
            }
          };
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{
            const v = obj[k];
            const k1 = String(k).toLowerCase();
            const k2 = k1.replace(/\s+/g,' ').trim();
            const k3 = sanitize(k);
            lower[k1] = v;
            lower[k2] = v;
            lower[k3] = v;
          });
          for(const k of keys){
            const c1 = String(k).toLowerCase();
            const c2 = c1.replace(/\s+/g,' ').trim();
            const c3 = sanitize(k);
            const v = (c1 in lower ? lower[c1] : (c2 in lower ? lower[c2] : lower[c3]));
            if(v!==undefined) return v;
          }
          return '';
        };
        // Dự phòng: tìm theo cụm từ trong key đã chuẩn hoá
        const findBySanitizedIncludes = (obj, needle)=>{
          const san = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); } };
          const target = san(needle);
          for (const k of Object.keys(obj||{})){
            const kk = san(k);
            if (kk.includes(target)) return obj[k];
          }
          return '';
        };
        
        // Parse tất cả dữ liệu
        f7AllData = [];
        f7CurrentName = name;
        console.log('[Form7 Debug] Bắt đầu parse dữ liệu, tổng số rows:', rows.length);
        rows.forEach(item=>{
          // Khớp theo tên "Assignee" từ server với lựa chọn trong ô tên Form 8
          try{
            const assignee = getV(item,[
              'Assignee','assignee','employee','nhân viên','nhan vien','nhanvien',
              'tên nhân viên','ten nhan vien','tennhanvien','phụ trách','phu trac','phutrac'
            ]);
            if (assignee && typeof sameName === 'function'){
              if (!sameName(String(assignee||''), String(name||''))) return; // bỏ nếu không trùng tên chọn
            } else {
              // Fallback: so sánh không dấu/không phân biệt hoa thường
              const a = String(assignee||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
              const b = String(name||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
              if (a && b && a !== b) return;
            }
          }catch(_){ }
          // Lấy dữ liệu theo cấu trúc mới: Mã tác vụ, Ngày hoàn thành thực tế, Mã linh kiện/máy, Task Name, Mã Báo cáo, Kết quả đánh giá, Ghi chú, CE rà soát, Ngày khai báo CE, 4M rà soát, Ngày khai báo 4M
          const taskId = getV(item,['taskid','task_id','ma_tac_vu','mã tác vụ','requestid','id']);
          const actualCompletionDate = getV(item,['actualcompletiondate','actual_completion_date','ngay_hoan_thanh_thuc_te','ngày hoàn thành thực tế','completion_date','ngay hoan thanh','ngày hoàn thành','actual_date']);
          const code = getV(item,['code','ma','taskcode','mã','componentcode','ma_linh_kien','ma_linh_kien_may','mã linh kiện/máy','ma linh kien may']);
          let taskName = getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ','Task Name','task_name']);
          if (!taskName) {
            taskName = findBySanitizedIncludes(item, 'task name') || findBySanitizedIncludes(item, 'ten tac vu');
          }
          const reportCode = getV(item,['reportcode','ma_bao_cao','mã báo cáo','report_id','reportid','🆔 Mã Báo cáo','ma bao cao']);
          const evaluationResult = getV(item,['evaluationresult','ket_qua_danh_gia','kết quả đánh giá','ket qua danh gia','result','ket_qua','kết quả','⁉️ Kết quả','ket qua']);
          const notes = getV(item,['notes','ghi_chu','ghi chú','note','description','mô tả']);
          const ceReview = getV(item,['cereview','ce_ra_soat','ce rà soát','ce review','ce_review','ce_status','CE rà soát','tinh_trang_ra_soat','tình trạng rà soát','tinh trang ra soat','Tình trạng rà soát']);
          const ceDeclarationDate = getV(item,['cedeclarationdate','ngay_khai_bao_ce','ngày khai báo ce','ngay khai bao ce','ce_date','ce declaration','ce_declaration','\nNgày khai báo CE']);
          const fourMReview = getV(item,['4mreview','4m_ra_soat','4m rà soát','4m review','4m_review','4m_status','4M rà soát']);
          const fourMDeclarationDate = getV(item,['4mdeclarationdate','ngay_khai_bao_4m','ngày khai báo 4m','ngay khai bao 4m','4m_date','4m declaration','4m_declaration','Ngày khai báo 4M']);
          const f7emailassignee = getV(item,['f7emailassignee','F7emailassignee','email_assignee','emailassignee','email assignee','assignee_email']);
          const sampleHandoverStatus = getV(item,['samplehandoverstatus','sample_handover_status','tinh_trang_mau_ban_giao','tình trạng mẫu bàn giao','tinh trang mau ban giao','handover_status','sample_status','Tình trạng mẫu bàn giao']);
          const sampleHandoverNotes = getV(item,['samplehandovernotes','sample_handover_notes','ghi_chu_ban_giao_mau','ghi chú bàn giao mẫu','ghi chu ban giao mau','handover_notes','sample_notes']);
          
          // Debug log để kiểm tra dữ liệu
          if (taskId) {
            console.log('[Form7 Debug] Task ID:', taskId, '| CE Review:', ceReview, '| 4M Review:', fourMReview);
            console.log('[Form7 Debug] Raw item keys:', Object.keys(item));
          }
          
          const taskIdBest = pickTaskIdPreferQA(taskId, code);
          const rowData = { taskId: taskIdBest, actualCompletionDate, code, taskName, reportCode, evaluationResult, notes, ceReview, ceDeclarationDate, fourMReview, fourMDeclarationDate, f7emailassignee, sampleHandoverStatus, sampleHandoverNotes };
          
          f7AllData.push(rowData);
        });
        
        // Hiển thị dữ liệu
        displayForm7Data();
        
        // Lưu cache và cập nhật timestamp
        try {
          LS.setJSON('f7.cache', {
            data: f7AllData,
            name: name,
            ts: Date.now()
          });
          LS.set('f7.lastUpdated', String(Date.now()));
          updateLastUpdatedNote('f7-search','f7.lastUpdated');
        } catch(_) {}
      }catch(err){
        body.innerHTML = `<tr><td colspan='13' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }
    const f7SearchBtn = document.getElementById('f7-search');
    if (f7SearchBtn) {
      let f7Busy = false;
      f7SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f7Busy) return;
        f7Busy = true;
        f7SearchBtn.disabled = true;
        const prev = f7SearchBtn.textContent;
        f7SearchBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { await renderForm7(); }
        finally {
          f7Busy = false;
          f7SearchBtn.disabled = false;
          f7SearchBtn.textContent = prev;
        }
      };
    }
    
    // ===== Form 8: Triển khai 4M (sử dụng chung chức năng với Form 7) =====
    let f8AllData = []; // Lưu tất cả dữ liệu Form 8
    let f8CurrentName = ''; // Lưu tên hiện tại
    
    function displayForm8Data() {
      const body = document.getElementById('f8-body');
      const monthFilter = (document.getElementById('f8-month').value || '').trim();
      
      // Lọc dữ liệu theo tháng nếu có
      let filteredData = f8AllData;
      if (monthFilter) {
        console.log('[Form8 Debug] Lọc theo tháng:', monthFilter);
        console.log('[Form8 Debug] Tổng số dữ liệu:', f8AllData.length);
        
        filteredData = f8AllData.filter(item => {
          const dateStr = String(item.actualCompletionDate || '').trim();
          if (!dateStr) {
            console.log('[Form8 Debug] Bỏ qua item không có ngày:', item.taskId);
            return false;
          }
          
          // Parse nhiều định dạng ngày
          let parsedDate = null;
          
          try {
            // Thử parse bằng toDateSafe
            const d = toDateSafe(dateStr);
            if (d && d instanceof Date && !isNaN(d.getTime())) {
              const year = d.getFullYear();
              const month = String(d.getMonth() + 1).padStart(2, '0');
              parsedDate = `${year}-${month}`;
            }
          } catch(_) {}
          
          // Nếu chưa parse được, thử regex
          if (!parsedDate) {
            // Thử dd/mm/yyyy hoặc dd-mm-yyyy
            const ddmmyyyyMatch = dateStr.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
            if (ddmmyyyyMatch) {
              const m = ddmmyyyyMatch[2].padStart(2,'0');
              const y = ddmmyyyyMatch[3];
              parsedDate = `${y}-${m}`;
            }
          }
          
          if (!parsedDate) {
            // Thử yyyy-mm-dd hoặc yyyy/mm/dd
            const yyyymmddMatch = dateStr.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
            if (yyyymmddMatch) {
              const y = yyyymmddMatch[1];
              const m = yyyymmddMatch[2].padStart(2,'0');
              parsedDate = `${y}-${m}`;
            }
          }
          
          const matched = parsedDate === monthFilter;
          if (!matched && parsedDate) {
            console.log('[Form8 Debug] Không khớp - dateStr:', dateStr, '| parsedDate:', parsedDate, '| monthFilter:', monthFilter);
          }
          
          return matched;
        });
        
        console.log('[Form8 Debug] Số dữ liệu sau lọc:', filteredData.length);
      }
      
      body.innerHTML = '';
      
      if (!filteredData.length) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Không có tác vụ'+ (monthFilter ? ' trong tháng đã chọn' : '') +'.</td></tr>';
        return;
      }
      
      filteredData.forEach((rowData, index) => {
        const tr = document.createElement('tr');
        const isLastRow = index === filteredData.length - 1;
        tr.className = 'hover:bg-gray-50' + (isLastRow ? ' border-b border-gray-200' : '');
        const name = f8CurrentName;
        
        // Render theo cấu trúc Form 8 (chỉ 4M): Mã tác vụ, Ngày hoàn thành thực tế, Mã linh kiện/máy, Task Name, Mã Báo cáo, Kết quả đánh giá, Ghi chú, Tình trạng rà soát, Khai báo 4M, Ngày khai báo gần nhất
        addTdF8(tr, rowData.taskId);
        addTdF8(tr, formatDdMmYyyy(rowData.actualCompletionDate));
        addTdF8(tr, rowData.code);
        
        // Task Name - Clickable để xem chi tiết 4M
        const tdTaskName = document.createElement('td');
        tdTaskName.className = 'px-3 py-2 border-r border-gray-200';
        const btnTaskName = document.createElement('button');
        btnTaskName.className = 'text-primary-blue hover:underline cursor-pointer text-left w-full';
        btnTaskName.textContent = rowData.taskName || '';
        btnTaskName.title = 'Click để xem chi tiết % 4M';
        btnTaskName.onclick = (e) => {
          e.preventDefault();
          openF8_4MModal(rowData);
        };
        tdTaskName.appendChild(btnTaskName);
        tr.appendChild(tdTaskName);
        
        addTdF8(tr, rowData.reportCode);
        addTdF8(tr, rowData.evaluationResult);
        addTdF8(tr, rowData.notes);
        
        // Cột Tình trạng rà soát - Bôi vàng nếu khác "Có"
        const tdReview = document.createElement('td');
        tdReview.className = 'px-3 py-4 align-top text-gray-800 border-r border-gray-200';
        const reviewValue = rowData.fourMReview || '';
        tdReview.textContent = reviewValue;
        
        // Bôi vàng nếu giá trị khác "Có", "Không cần rà soát" và "Không cần"
        if (reviewValue.toLowerCase() !== 'có' && 
            reviewValue.toLowerCase() !== 'không cần rà soát' && 
            reviewValue.toLowerCase() !== 'không cần') {
          tdReview.className += ' bg-yellow-100';
        }
        
        tr.appendChild(tdReview);
        
        // Cột Khai báo 4M - Hiển thị giá trị hoặc button
        const td4mDeclare = document.createElement('td');
        td4mDeclare.className = 'px-3 py-2 text-center border-r border-gray-200';
        
        // Nếu đã có dữ liệu khai báo 4M, hiển thị text
        if (rowData.fourMDeclaration) {
          td4mDeclare.textContent = rowData.fourMDeclaration;
        } else {
          // Nếu chưa có, hiển thị button
          const btn4mDeclare = document.createElement('button');
          btn4mDeclare.className = 'px-3 py-1 rounded text-white bg-emerald-600 hover:brightness-105 text-sm font-medium';
          btn4mDeclare.textContent = 'Khai báo 4M';
          btn4mDeclare.onclick = (e) => {
            e.preventDefault();
            if (btn4mDeclare.disabled) return;
            btn4mDeclare.disabled = true;
            btn4mDeclare.classList.add('opacity-50', 'pointer-events-none');
            openForm8SubpanelModal({
              name,
              code: rowData.code,
              taskId: rowData.taskId,
              taskName: rowData.taskName,
              reportCode: rowData.reportCode,
              evaluationResult: rowData.evaluationResult,
              notes: rowData.notes,
              ceReview: rowData.ceReview,
              ceDeclarationDate: rowData.ceDeclarationDate,
              fourMReview: rowData.fourMReview,
              fourMDeclaration: rowData.fourMDeclaration,
              fourMDeclarationDate: rowData.fourMDeclarationDate,
              rowData
            });
            setTimeout(() => {
              btn4mDeclare.disabled = false;
              btn4mDeclare.classList.remove('opacity-50', 'pointer-events-none');
            }, 300);
          };
          td4mDeclare.appendChild(btn4mDeclare);
        }
        tr.appendChild(td4mDeclare);
        
        // Cột Ngày khai báo gần nhất
        const tdLast = document.createElement('td');
        tdLast.className = 'px-3 py-4 align-top text-gray-800 border-r border-gray-200';
        const declarationDate = rowData.fourMDeclarationDate;
        if (declarationDate && declarationDate.trim() !== '') {
          // Hiển thị nguyên gốc nếu có dữ liệu
          tdLast.textContent = declarationDate;
        } else {
          tdLast.textContent = '';
        }
        tr.appendChild(tdLast);
        
        // Cột mới - Tỷ lệ hoàn thành 4M (hiển thị "Trung bình 4M" từ bảng phụ)
        const td4mRate = document.createElement('td');
        td4mRate.className = 'px-3 py-4 align-top text-gray-800 text-center';
        
        // Lấy dữ liệu "Trung bình 4M" từ rowData
        const fourmAverage = rowData.fourmAverage || rowData.fourMAverage || rowData['Trung bình 4M'] || '';
        
        if (fourmAverage && fourmAverage.toString().trim() !== '') {
          // Hiển thị giá trị với định dạng phần trăm
          const value = parseFloat(fourmAverage);
          if (!isNaN(value)) {
            td4mRate.innerHTML = `
              <span class="font-semibold ${value >= 80 ? 'text-green-600' : value >= 50 ? 'text-blue-600' : 'text-orange-600'}">
                ${value.toFixed(2)}%
              </span>
            `;
          } else {
            td4mRate.textContent = fourmAverage;
          }
        } else {
          td4mRate.textContent = '—';
        }
        tr.appendChild(td4mRate);
        
        body.appendChild(tr);
      });
    }
    
    function restoreForm8FromCache() {
      try {
        const cached = LS.getJSON('f8.cache');
        if (!cached || !Array.isArray(cached.data) || !cached.data.length) return false;
        
        const body = document.getElementById('f8-body');
        const nameSelect = document.getElementById('f8-name');
        if (!body || !nameSelect) return false;
        
        // Khôi phục dữ liệu
        f8AllData = cached.data.slice();
        f8CurrentName = cached.name || '';
        
        // Khôi phục dropdown tên
        if (cached.name) {
          nameSelect.value = cached.name;
        }
        
        // Hiển thị dữ liệu
        displayForm8Data();
        
        return true;
      } catch(_) {
        return false;
      }
    }
    
    // Form 8 sử dụng chung renderForm7 nhưng với action khác
    async function renderForm8(){
      const name = (document.getElementById('f8-name').value || '').trim();
      const body = document.getElementById('f8-body');
        if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Vui lòng chọn tên</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='10' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      try{
        const headerMapF8 = {
          header_F8_taskId: 'Mã tác vụ',
          header_F8_actualCompletionDate: 'Ngày hoàn thành thực tế',
          header_F8_code: 'Mã linh kiện/máy',
          header_F8_taskName: 'Task Name',
          header_F8_reportCode: 'Mã Báo cáo',
          header_F8_evaluationResult: 'Kết quả đánh giá',
          header_F8_notes: 'Ghi chú',
          header_F8_4mReview: 'Tình trạng rà soát',
          header_F8_4mDeclaration: 'Khai báo 4M',
          header_F8_4mDeclarationDate: 'Ngày khai báo gần nhất',
          // Các trường % 4M
          header_F8_tckt: 'TCKT(% hoàn thành)',
          header_F8_ce: 'CE(% hoàn thành)',
          header_F8_hdkt: 'HDKT(% hoàn thành)',
          header_F8_bbDaoTao: 'BB đào tạo(% hoàn thành)',
          header_F8_jigTool: 'Jig tool(% hoàn thành)',
          header_F8_khkscl: 'KHKSCL(% hoàn thành)',
          field_F8_taskId: 'taskId',
          field_F8_actualCompletionDate: 'actualCompletionDate',
          field_F8_code: 'code',
          field_F8_taskName: 'taskName',
          field_F8_reportCode: 'reportCode',
          field_F8_evaluationResult: 'evaluationResult',
          field_F8_notes: 'notes',
          field_F8_4mReview: '4mReview',
          field_F8_4mDeclaration: '4mDeclaration',
          field_F8_4mDeclarationDate: '4mDeclarationDate',
          // Field mappings cho % 4M
          field_F8_tckt: 'tckt',
          field_F8_ce: 'ce',
          field_F8_hdkt: 'hdkt',
          field_F8_bbDaoTao: 'bbDaoTao',
          field_F8_jigTool: 'jigTool',
          field_F8_khkscl: 'khkscl'
        };
        const params = new URLSearchParams({
          ...headerMapF8,
          action: 'form8_lookup', // Form 8 có action riêng
          person_name: name,
          assignee: name,
          timestamp: new Date().toISOString()
        });
        // Gửi kèm body meta để server dễ đọc (ngoài query)
        try{
          const meta = {
            action: 'form8_lookup',
            person_name: name,
            assignee: name,
            timestamp_iso: new Date().toISOString()
          };
          params.append('body', JSON.stringify(meta));
        }catch(_){ }
        const url = `${FORM8_LOOKUP_URL}?${params.toString()}`;
        const resp = await fetch(url, { method: 'GET' });
        const text = await resp.text();
        if(!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
        let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){ const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') queue.push(v);} }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        if(!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Không có tác vụ.</td></tr>'; f8AllData=[]; return; }
        const getV = (obj, keys)=>{
          // Chuẩn hoá key: bỏ dấu, loại emoji/ký tự đặc biệt, gộp khoảng trắng
          const sanitize = (s)=>{
            try{
              const noDiacritics = String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
              const noEmoji = noDiacritics.replace(/[^\p{L}\p{N}\s_:\-]/gu,'');
              return noEmoji.toLowerCase().replace(/\s+/g,' ').trim();
            }catch(_){
              return String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
            }
          };
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{
            const v = obj[k];
            const k1 = String(k).toLowerCase();
            const k2 = k1.replace(/\s+/g,' ').trim();
            const k3 = sanitize(k);
            lower[k1] = v;
            lower[k2] = v;
            lower[k3] = v;
          });
          for(const k of keys){
            const c1 = String(k).toLowerCase();
            const c2 = c1.replace(/\s+/g,' ').trim();
            const c3 = sanitize(k);
            const v = (c1 in lower ? lower[c1] : (c2 in lower ? lower[c2] : lower[c3]));
            if(v!==undefined) return v;
          }
          return '';
        };
        // Dự phòng: tìm theo cụm từ trong key đã chuẩn hoá
        const findBySanitizedIncludes = (obj, needle)=>{
          const san = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); } };
          const target = san(needle);
          for (const k of Object.keys(obj||{})){
            const kk = san(k);
            if (kk.includes(target)) return obj[k];
          }
          return '';
        };
        
        // Parse tất cả dữ liệu (để server lọc theo person_name; không lọc tại chỗ theo Assignee)
        f8AllData = [];
        f8CurrentName = name;
        console.log('[Form8 Debug] Bắt đầu parse dữ liệu, tổng số rows:', rows.length);
        rows.forEach(item=>{
          // Lấy dữ liệu theo cấu trúc mới: Mã tác vụ, Ngày hoàn thành thực tế, Mã linh kiện/máy, Task Name, Mã Báo cáo, Kết quả đánh giá, Ghi chú, Tình trạng rà soát, Ngày khai báo gần nhất
          const taskId = getV(item,['Mã tác vụ','mã tác vụ','taskid','task_id','ma_tac_vu','requestid','id']);
          const actualCompletionDate = getV(item,['Ngày hoàn thành thực tế','ngày hoàn thành thực tế','actualcompletiondate','actual_completion_date','ngay_hoan_thanh_thuc_te','completion_date','ngay hoan thanh','ngày hoàn thành','actual_date']);
          const code = getV(item,['Mã linh kiện/máy','mã linh kiện/máy','code','ma','taskcode','mã','componentcode','ma_linh_kien','ma_linh_kien_may','ma linh kien may']);
          let taskName = getV(item,['Task Name','task name','taskname','ten_tac_vu','ten','name','title','tên tác vụ','task_name']);
          if (!taskName) {
            taskName = findBySanitizedIncludes(item, 'task name') || findBySanitizedIncludes(item, 'ten tac vu');
          }
          const reportCode = getV(item,['Mã Báo cáo','mã báo cáo','reportcode','ma_bao_cao','report_id','reportid','🆔 Mã Báo cáo','ma bao cao']);
          const evaluationResult = getV(item,['Kết quả đánh giá','kết quả đánh giá','evaluationresult','ket_qua_danh_gia','ket qua danh gia','result','ket_qua','kết quả','⁉️ Kết quả','ket qua']);
          const notes = getV(item,['Ghi chú','ghi chú','notes','ghi_chu','note','description','mô tả']);
          const fourMReview = getV(item,['Tình trạng rà soát','tình trạng rà soát','4mreview','4m_ra_soat','4m rà soát','4m review','4m_review','4m_status','4M rà soát','tinh_trang_ra_soat','tinh trang ra soat']);
          const fourMDeclaration = getV(item,['Khai báo 4M','khai báo 4m','4m_declaration','4m declaration','khai_bao_4m','khai bao 4m']);
          const fourMDeclarationDate = getV(item,['Ngày khai báo gần nhất','ngày khai báo gần nhất','4mdeclarationdate','ngay_khai_bao_4m','ngày khai báo 4m','ngay khai bao 4m','4m_date','4m_declaration','Ngày khai báo 4M']);
          
          // Lấy các trường phần trăm 4M
          const tckt = getV(item,['TCKT(% hoàn thành)','tckt(% hoàn thành)','TCKT','tckt','tckt%']);
          const ce = getV(item,['CE(% hoàn thành)','ce(% hoàn thành)','CE','ce','ce%']);
          const hdkt = getV(item,['HDKT(% hoàn thành)','hdkt(% hoàn thành)','HDKT','hdkt','hdkt%']);
          const bbDaoTao = getV(item,['BB đào tạo(% hoàn thành)','bb đào tạo(% hoàn thành)','BB đào tạo','bb dao tao','bb%']);
          const jigTool = getV(item,['Jig tool(% hoàn thành)','jig tool(% hoàn thành)','Jig tool','jig tool','jig%']);
          const khkscl = getV(item,['KHKSCL(% hoàn thành)','khkscl(% hoàn thành)','KHKSCL','khkscl','khkscl%']);
          
          // Debug log để kiểm tra dữ liệu
          if (taskId) {
            console.log('[Form8 Debug] Task ID:', taskId, '| Task Name:', taskName);
            console.log('[Form8 Debug] Actual Completion Date:', actualCompletionDate);
            console.log('[Form8 Debug] 4M Data - TCKT:', tckt, 'CE:', ce, 'HDKT:', hdkt);
            console.log('[Form8 Debug] Raw item keys:', Object.keys(item));
          }
          
          // Tính toán "Trung bình 4M" (giống như trong modal)
          const parsePercent = (val) => {
            if (!val || val === '') return 0;
            const s = String(val).replace('%', '').trim();
            const num = parseFloat(s);
            if (isNaN(num)) return 0;
            // If value is 0-1, convert to 0-100
            if (num >= 0 && num <= 1) return num * 100;
            // If already 0-100, use as is
            return num;
          };
          
          const avg4m = (parsePercent(tckt) + parsePercent(ce) + parsePercent(hdkt) + 
                        parsePercent(bbDaoTao) + parsePercent(jigTool) + parsePercent(khkscl)) / 6;
          
          const taskIdBest = pickTaskIdPreferQA(taskId, code);
          const rowData = { 
            taskId: taskIdBest, 
            actualCompletionDate, 
            code, 
            taskName, 
            reportCode, 
            evaluationResult, 
            notes, 
            fourMReview, 
            fourMDeclaration, 
            fourMDeclarationDate,
            // Thêm các trường 4M percentages
            TCKT: tckt,
            CE: ce,
            HDKT: hdkt,
            'BB đào tạo': bbDaoTao,
            'Jig tool': jigTool,
            KHKSCL: khkscl,
            // Thêm trung bình 4M
            fourmAverage: avg4m.toFixed(2)
          };
          
          f8AllData.push(rowData);
        });
        
        // Hiển thị dữ liệu
        displayForm8Data();
        
        // Lưu cache
        try {
          LS.setJSON('f8.cache', {
            data: f8AllData,
            name: name,
            ts: Date.now()
          });
        } catch(_) {}
      }catch(err){
        body.innerHTML = `<tr><td colspan='11' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }

    // ===== Form 5: Bảng phụ P4 - chi tiết tác vụ theo nhân viên =====
    window.showP4TaskDetails = function(empName, month){
      try{
        const modal = document.getElementById('detail-modal');
        const title = document.getElementById('detail-title');
        const body = document.getElementById('detail-body');
        const note = document.getElementById('detail-note');
        if (!modal || !body) return;
        if (title) title.textContent = `Chi tiết tác vụ (P4) của ${empName}`;
        note.textContent = 'Chỉ hiển thị tác vụ Phân loại = Sản phẩm';
        body.innerHTML = `<tr><td colspan="10" class="px-3 py-3 text-center text-gray-500"><span class='spinner mr-2'></span>Đang tải...</td></tr>`;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');

        const norm = (s)=> String(s||'').toLowerCase().trim();
        const getV = (obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=> lower[norm(k)] = obj[k]); for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; } return ''; };
        const parseDate = (v)=>{ try{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/); if(m){ const d=new Date(+m[3],+m[2]-1,+m[1]); return isNaN(d)?null:d; } m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/); if(m){ const d=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(d)?null:d; } const d=new Date(s); return isNaN(d)?null:d; }catch(_){ return null; } };
        const fmt = (d)=>{ if(!d) return ''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}/${d.getFullYear()}`; };

        // Lọc từ F5A_P3_RAW theo nhân viên, tháng, phân loại Sản phẩm
        const list = (Array.isArray(window.F5A_P3_RAW)? window.F5A_P3_RAW: []).filter(r=>{
          const name = String(getV(r,['assignee','employee','name','nhân viên','nhan vien','nhanvien','tên nhân viên','ten nhan vien','tennhanvien','phụ trách','phu trac','phutrac'])||'').trim();
          if (!name || name.toLowerCase()==='x') return false;
          if ((typeof vnLower==='function' ? vnLower(name):name.toLowerCase()) !== (typeof vnLower==='function'? vnLower(empName):empName.toLowerCase())) return false;
          const cls = String(getV(r,['Phân loại','phan loai','phanloai','classification','loai','loại'])||'');
          const clsNorm = (typeof vnLower==='function') ? vnLower(cls) : cls.toLowerCase();
          if (clsNorm !== 'san pham' && clsNorm !== 'sản phẩm') return false;
          const dDone = parseDate(getV(r,['ngày hoàn thành thực tế','ngay hoan thanh thuc te','ngày hoàn thành','ngay hoan thanh','completion date','completiondate','actual completion date','actualcompletiondate']));
          const dCE = parseDate(getV(r,['Ngày khai báo CE','ngay khai bao ce','ngày khai báo ce','cedate','ce_date']));
          const d4M = parseDate(getV(r,['Ngày khai báo 4M','ngay khai bao 4m','ngày khai báo 4m','4m_date','4mdate']));
          const ref = dDone || dCE || d4M;
          if (month){ const ym = ref? `${ref.getFullYear()}-${String(ref.getMonth()+1).padStart(2,'0')}`:''; if (ym !== month) return false; }
          return true;
        });

        if (!list.length){ body.innerHTML = `<tr><td colspan="10" class="px-3 py-3 text-center text-gray-500">Không có dữ liệu</td></tr>`; return; }
        // Header chi tiết: Code, Task, Ngày hoàn thành, TCKT, CE, HDKT, BB, Jig, KHKSCL, Rà soát 4M
        const head = `<tr class="bg-slate-100 text-sm font-semibold"><td class="px-3 py-2">Mã</td><td class="px-3 py-2">Task Name</td><td class="px-3 py-2">Ngày hoàn thành</td><td class="px-3 py-2">TCKT</td><td class="px-3 py-2">CE</td><td class="px-3 py-2">HDKT</td><td class="px-3 py-2">BB</td><td class="px-3 py-2">Jig</td><td class="px-3 py-2">KHKSCL</td><td class="px-3 py-2">Rà soát 4M</td></tr>`;
        const rowHtml = list.map(r=>{
          const code = getV(r,['Mã','code','ma','taskcode']);
          const tname = getV(r,['Task Name','taskname','tên tác vụ','ten_tac_vu','name']);
          const dDone = parseDate(getV(r,['ngày hoàn thành thực tế','ngay hoan thanh thuc te','ngày hoàn thành','ngay hoan thanh','completion date','completiondate']));
          const tckt = getV(r,['TCKT(% hoàn thành)','tckt(% hoàn thành)','tckt']);
          const ce = getV(r,['CE(% hoàn thành)','ce(% hoàn thành)','ce']);
          const hdkt = getV(r,['HDKT(% hoàn thành)','hdkt(% hoàn thành)','hdkt']);
          const bb = getV(r,['BB đào tạo(% hoàn thành)','bb đào tạo(% hoàn thành)','bb đào tạo','bb']);
          const jig = getV(r,['Jig tool(% hoàn thành)','jig tool(% hoàn thành)','jig tool','jig']);
          const kh = getV(r,['KHKSCL(% hoàn thành)','khkscl(% hoàn thành)','khkscl']);
          const fourM = getV(r,['4M rà soát','4m rà soát','4m ra soat','4M','4m rasoat','rasoat4m']);
          return `<tr><td class="px-3 py-2">${code||''}</td><td class="px-3 py-2">${tname||''}</td><td class="px-3 py-2">${fmt(dDone)||''}</td><td class="px-3 py-2">${tckt||''}</td><td class="px-3 py-2">${ce||''}</td><td class="px-3 py-2">${hdkt||''}</td><td class="px-3 py-2">${bb||''}</td><td class="px-3 py-2">${jig||''}</td><td class="px-3 py-2">${kh||''}</td><td class="px-3 py-2">${fourM||''}</td></tr>`;
        }).join('');
        body.innerHTML = head + rowHtml;
      }catch(err){ try{ console.error('showP4TaskDetails error', err); }catch(_){ } }
    };

    // Open modal hiển thị chi tiết 4M của tác vụ
    function openF8_4MModal(taskData) {
      try {
        const modal = document.getElementById('f8-4m-modal');
        if (!modal) return;

        // Helper: parse và format phần trăm
        const formatPercent = (v) => {
          if (!v || v === '') return '0%';
          const s = String(v).replace('%', '').trim();
          const num = parseFloat(s);
          if (isNaN(num)) return '0%';
          // If value is 0-1, convert to 0-100
          if (num >= 0 && num <= 1) return (num * 100).toFixed(1) + '%';
          // If already 0-100, use as is
          return num.toFixed(1) + '%';
        };

        // Fill modal data
        document.getElementById('f8-4m-task-id').textContent = taskData.taskId || '';
        document.getElementById('f8-4m-task-name').textContent = taskData.taskName || '';
        document.getElementById('f8-4m-completion-date').textContent = formatDdMmYyyy(taskData.actualCompletionDate) || '';

        // Fill percentages
        const tckt = formatPercent(taskData.TCKT);
        const ce = formatPercent(taskData.CE);
        const hdkt = formatPercent(taskData.HDKT);
        const bb = formatPercent(taskData['BB đào tạo']);
        const jig = formatPercent(taskData['Jig tool']);
        const khkscl = formatPercent(taskData.KHKSCL);

        document.getElementById('f8-4m-tckt').textContent = tckt;
        document.getElementById('f8-4m-ce').textContent = ce;
        document.getElementById('f8-4m-hdkt').textContent = hdkt;
        document.getElementById('f8-4m-bb').textContent = bb;
        document.getElementById('f8-4m-jig').textContent = jig;
        document.getElementById('f8-4m-khkscl').textContent = khkscl;

        // Calculate average
        const parseNum = (s) => {
          const n = parseFloat(String(s).replace('%', ''));
          return isNaN(n) ? 0 : n;
        };
        const avg = (parseNum(tckt) + parseNum(ce) + parseNum(hdkt) + parseNum(bb) + parseNum(jig) + parseNum(khkscl)) / 6;
        document.getElementById('f8-4m-avg').textContent = avg.toFixed(1) + '%';

        // Show modal
        modal.classList.add('open');
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
      } catch (err) {
        console.error('[Form8] Error opening 4M modal:', err);
      }
    }

    function closeF8_4MModal() {
      const modal = document.getElementById('f8-4m-modal');
      if (!modal) return;
      modal.classList.remove('open');
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
    }

    // Event listeners cho modal
    const f8_4MModalClose = document.getElementById('f8-4m-modal-close');
    const f8_4MModalCancel = document.getElementById('f8-4m-modal-cancel');
    const f8_4MModal = document.getElementById('f8-4m-modal');

    if (f8_4MModalClose) {
      f8_4MModalClose.addEventListener('click', (e) => {
        e.preventDefault();
        closeF8_4MModal();
      });
    }

    if (f8_4MModalCancel) {
      f8_4MModalCancel.addEventListener('click', (e) => {
        e.preventDefault();
        closeF8_4MModal();
      });
    }

    if (f8_4MModal) {
      f8_4MModal.addEventListener('click', (e) => {
        if (e.target === f8_4MModal) {
          closeF8_4MModal();
        }
      });
    }

    // Close với phím Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && f8_4MModal && !f8_4MModal.classList.contains('hidden')) {
        closeF8_4MModal();
      }
    });

    const f8SearchBtn = document.getElementById('f8-search');
    if (f8SearchBtn) {
      let f8Busy = false;
      f8SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f8Busy) return;
        f8Busy = true;
        f8SearchBtn.disabled = true;
        const prev = f8SearchBtn.textContent;
        f8SearchBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { await renderForm8(); }
        finally {
          f8Busy = false;
          f8SearchBtn.disabled = false;
          f8SearchBtn.textContent = prev;
        }
      };
      // Đổi tên -> auto re-search
      const f8Name = document.getElementById('f8-name');
      if (f8Name && !f8Name._bound){
        f8Name.addEventListener('change', async ()=>{
          try{
            if (f8Busy) return;
            f8Busy = true;
            const btn = f8SearchBtn; const prev = btn.textContent; btn.disabled=true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
            try{ await renderForm8(); } finally { btn.disabled=false; btn.textContent=prev; f8Busy=false; }
          }catch(_){ }
        });
        f8Name._bound = true;
      }
    }
    
    // Form 8: Event listeners cho lọc tháng
    const f8MonthInput = document.getElementById('f8-month');
    const f8ClearMonthBtn = document.getElementById('f8-clear-month');
    
    // Mặc định set tháng hiện tại
    if (f8MonthInput) {
      const now = new Date();
      const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      f8MonthInput.value = currentMonth;
      
      f8MonthInput.addEventListener('change', () => {
        if (f8AllData.length > 0) {
          displayForm8Data();
        }
      });
    }
    // (Bỏ lọc tên tại chỗ theo yêu cầu)
    
    if (f8ClearMonthBtn) {
      f8ClearMonthBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const f8MonthInput = document.getElementById('f8-month');
        if (f8MonthInput) {
          f8MonthInput.value = '';
          if (f8AllData.length > 0) {
            displayForm8Data();
          }
        }
      });
    }
    
    // Form 7: Event listeners cho lọc tháng
    const f7MonthInput = document.getElementById('f7-month');
    const f7ClearMonthBtn = document.getElementById('f7-clear-month');
    
    // Mặc định set tháng hiện tại
    if (f7MonthInput) {
      const now = new Date();
      const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      f7MonthInput.value = currentMonth;
      
      f7MonthInput.addEventListener('change', () => {
        if (f7AllData.length > 0) {
          displayForm7Data();
        }
      });
    }
    
    if (f7ClearMonthBtn) {
      f7ClearMonthBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const f7MonthInput = document.getElementById('f7-month');
        if (f7MonthInput) {
          f7MonthInput.value = '';
          if (f7AllData.length > 0) {
            displayForm7Data();
          }
        }
      });
    }

    function f5aGetNeedManhour(name){
      try{
        const monthEl = document.getElementById('f5a-month');
        const month = monthEl ? (monthEl.value||'') : '';
        const attMap = (typeof f5aGetAttendanceMapByMonth==='function') ? f5aGetAttendanceMapByMonth(month) : new Map();
        const resolved = (typeof resolveAlias==='function') ? resolveAlias(name) : name;
        const totalText = attMap.get(resolved) || attMap.get(name) || '';
        const n = (typeof parseNumberFlexible==='function') ? parseNumberFlexible(totalText) : Number(totalText);
        return Number.isFinite(n) ? n : '';
      }catch(_){ return ''; }
    }
    // Form 5: whitelist tên hiển thị (có thể mở rộng)
    const F5A_WHITELIST = [
      "Đỗ Quang Long",
      "Phạm Thành Trung Kiên",
      "Lê Thị Thảo",
      "Vũ Thị Thanh Hiền",
      "Lại Quốc Lộc",
      "Lê Ngọc Ánh",
      "Lê Văn Sơn",
      "Nguyễn Thị Hiền",
      "Phạm Thị Minh",
    ];
    // Bổ sung whitelist riêng (tùy chỉnh nhanh trong vận hành)
    const F5A_WHITELIST_EXTRA = [
      // Thêm tên tại đây nếu cần mở rộng tạm thời
      // "Hà Mỹ Linh",
    ];
    // Ánh xạ alias tên -> tên chuẩn (điền key không dấu/thường)
    const F5A_NAME_ALIASES = {
      // ví dụ: "le thi thao": "Lê Thị Thảo",
    };
    function vnKey(s){
      try{ return (String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim()); }catch(_){ return String(s||'').toLowerCase().trim(); }
    }
    function tokenSet(str){
      const arr = vnKey(str).split(' ').filter(Boolean);
      return new Set(arr);
    }
    function jaccard(aSet, bSet){
      let inter = 0; for (const t of aSet){ if (bSet.has(t)) inter++; }
      const union = aSet.size + bSet.size - inter;
      return union ? (inter/union) : 0;
    }
    const F5A_WHITELIST_KEYS = (function(){
      const base = (Array.isArray(F5A_WHITELIST)? F5A_WHITELIST: []).concat(Array.isArray(F5A_WHITELIST_EXTRA)? F5A_WHITELIST_EXTRA: []);
      return base.map(v=> ({ raw: v, key: vnKey(v), tokens: tokenSet(v) }));
    })();
    function resolveAlias(name){ const k=vnKey(name); const alias = F5A_NAME_ALIASES[k]; return alias || name; }
    function f5aIsWhitelisted(name){
      try{
        const resolved = resolveAlias(name);
        const key = vnKey(resolved);
        // So khớp tuyệt đối
        if (F5A_WHITELIST_KEYS.some(x=> x.key === key)) return true;
        // So khớp tương đồng theo token-set (Jaccard)
        const toks = tokenSet(resolved);
        for (const ref of F5A_WHITELIST_KEYS){
          const sim = jaccard(toks, ref.tokens);
          if (sim >= 0.75) return true; // ngưỡng tương đồng 75%
        }
        return false;
      }catch(_){ return false; }
    }
    // Form 6 (ideas) cache for month filter
    let F6_LAST_ROWS = [];

    // ===== Form 5 (All tasks) - fetch once and aggregate locally =====
    function f5aPickRowsDeep(json){
      if (!json) return [];
      // If input already an array of objects
      if (Array.isArray(json) && json.length && typeof json[0] === 'object' && !Array.isArray(json[0])) return json;

      // Helper convert table [ [headers...], [...], ... ] -> array of objects
      const tableToObjects = (tbl)=>{
        try{
          if (!Array.isArray(tbl) || tbl.length < 2) return [];
          const header = Array.isArray(tbl[0]) ? tbl[0] : null;
          if (!header) return [];
          const keys = header.map(h=> String(h||'').trim());
          return tbl.slice(1).map(row=>{
            const obj = {};
            keys.forEach((k,i)=>{ obj[k] = Array.isArray(row) ? row[i] : undefined; });
            return obj;
          });
        }catch(_){ return []; }
      };

      // Prefer explicit properties at root
      let recs = [];
      if (Array.isArray(json?.records) && json.records.length && typeof json.records[0] === 'object') recs = json.records;
      let tabObjs = [];
      if (Array.isArray(json?.table)) tabObjs = tableToObjects(json.table);
      // Sheets support
      try{
        if ((!recs.length || !tabObjs.length) && Array.isArray(json?.sheets)){
          const sh = json.sheets.find(s => Array.isArray(s?.records) || Array.isArray(s?.table)) || json.sheets[0];
          if (sh){
            if (!recs.length && Array.isArray(sh.records) && sh.records.length && typeof sh.records[0]==='object') recs = sh.records;
            if (!tabObjs.length && Array.isArray(sh.table)) tabObjs = tableToObjects(sh.table);
          }
        }
      }catch(_){ }
      // Merge if both exist (prefer records fields, add missing rows from table by simple key)
      if (recs.length || tabObjs.length){
        if (recs.length && tabObjs.length){
          const seenKeys = new Set();
          const keyOf = (o)=>{
            const code = (o['Mã tác vụ']||o['taskId']||o['TaskId']||o['Mã']||o['code']||o['Code']||'');
            const tname = (o['Tên tác vụ']||o['taskName']||o['Task Name']||o['name']||'');
            const rq = (o['Ngày yêu cầu']||o['requestDate']||o['requestdate']||o['📆 ngày yêu cầu']||o['📆 Ngày yêu cầu']||'');
            // Dùng tổ hợp để không gộp nhầm các dòng trùng mã
            return String(code)+'|'+String(tname)+'|'+String(rq);
          };
          const out = [];
          try{ if (!window.F5A_LOG) window.F5A_LOG = {}; if (!window.F5A_LOG.dupKeys) window.F5A_LOG.dupKeys = []; }catch(_){ }
          recs.forEach(r=>{ const k=keyOf(r); seenKeys.add(k); out.push(r); });
          tabObjs.forEach(t=>{ const k=keyOf(t); if (!seenKeys.has(k)) { out.push(t); } else { try{ window.F5A_LOG.dupKeys.push({ reason:'duplicate_merge', key:k, row:t }); }catch(_){ } } });
          try{ console.info('[F5A] Merge records+table:', { recs: recs.length, table: tabObjs.length, merged: out.length, dups: (window.F5A_LOG&&window.F5A_LOG.dupKeys)? window.F5A_LOG.dupKeys.length:0 }); }catch(_){ }
          return out;
        }
        return recs.length ? recs : tabObjs;
      }

      // Generic deep search fallback (find array of objects; convert table if found)
      try{
        const queue=[json]; const seen=new Set();
        while(queue.length){
          const cur = queue.shift(); if(!cur || typeof cur !== 'object' || seen.has(cur)) continue; seen.add(cur);
          // table inside
          if (Array.isArray(cur.table)){
            const conv = tableToObjects(cur.table); if (conv.length) return conv;
          }
          for (const v of Object.values(cur)){
            if (Array.isArray(v)){
              if (v.length && typeof v[0] === 'object' && !Array.isArray(v[0])) return v;
              // potential nested table
              if (v.length && Array.isArray(v[0])){
                const conv2 = tableToObjects(v); if (conv2.length) return conv2;
              }
            }
            if (v && typeof v === 'object') queue.push(v);
          }
        }
      }catch(_){ }
      return [];
    }

    async function f5aFetchAllOnce(month, fromVal, toVal){
      if (F5A_RAW_ALL && F5A_RAW_ALL.length && F5A_RAW_META && F5A_RAW_META.month === (month||'')) return;
      const makeQs = (withAction, withRange)=>{
        const qs = new URLSearchParams();
        if (withAction) qs.append('action','form5_all');
        if (withRange){
          if (month) qs.append('month', month);
          if (fromVal) qs.append('from', fromVal);
          if (toVal) qs.append('to', toVal);
        }
        qs.append('_ts', Date.now().toString());
        return qs.toString();
      };
      const urls = [];
      const uBase = FORM5_ALL_NEW_URL;
      const uTest = uBase.replace('/webhook/','/webhook-test/');
      [true,false].forEach(withRange=>{
        [true,false].forEach(withAction=>{
          const q = makeQs(withAction, withRange);
          urls.push(`${uBase}${q?`?${q}`:''}`);
          urls.push(`${uTest}${q?`?${q}`:''}`);
        });
      });
      // thêm phương án không query
      urls.push(uBase);
      urls.push(uTest);
      let rows = [];
      for (const u of urls){
        try{
          console.log('Form5 fetch try:', u);
          const r = await fetch(u, { method: 'GET', headers: { 'Accept': 'application/json, text/plain, */*' } });
          const text = await r.text();
          let data = null; try{ data = JSON.parse(text); }catch{ data = null; }
          if (!data && typeof text === 'string'){
            const m = text.match(/\[[\s\S]*\]/);
            if (m) { try { data = JSON.parse(m[0]); } catch(_) { data = null; } }
          }
          const picked = f5aPickRowsDeep(data ?? text);
          if (Array.isArray(picked) && picked.length){ rows = picked; break; }
        }catch(_){ /* next */ }
      }
      // Unwrap n8n format: [{ json: {...} }]
      const unwrapped = Array.isArray(rows) ? rows.map(r=> (r && typeof r==='object' && ('json' in r)) ? r.json : r) : [];
      F5A_RAW_ALL = unwrapped;
      F5A_RAW_META = { month: month || '' };
      try{ LS.set('f5a.lastUpdated', String(Date.now())); updateLastUpdatedNote('f5a-search','f5a.lastUpdated'); }catch(_){ }
      try{ LS.setJSON('f5a.raw', { month: (month||''), rows: F5A_RAW_ALL, ts: Date.now() }); }catch(_){ }
    }

    function f5aAggregate(rows, fromVal, toVal){
      // ==== CONFIG (tham khảo Code tổng hợp.txt) ====
      const assigneeKeys = ['Assignee','Phụ trách','Người phụ trách','Người xử lý','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
      const taskNameKeys = ['Task Name','Tên tác vụ','Task','Công việc','Tên Task','Mã','taskname','ten_tac_vu','ten','title'];
      const scoreKeys = ['Điểm','Score','score'];
      const altScoreKeys = ['Công chuẩn công việc nhận ','Công chuẩn công việc nhận','Công chuẩn','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
      const actualHoursKeys = ['Số giờ đánh giá thực tế','so gio danh gia thuc te','actualhours','actual_hours','gio thuc te','gio_thuc_te','hours_actual'];
      const statusKeys = [
        'Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái',
        // Bổ sung các biến thể cho cột trạng thái theo công chuẩn
        'Trạng thái theo công chuẩn','trang thai theo cong chuan','hiện trạng theo công chuẩn','hien trang theo cong chuan',
        'status_by_man','status_by_manhour','status_manhour','status_by_workload','ht_theo_cong_chuan'
      ];
      // Cột "Hiện trạng theo hạn mong muốn" (đúng/trễ hạn yêu cầu)
      const statusByWishKeys = [
        'Hiện trạng theo hạn mong muốn','hien trang theo han mong muon','trang thai theo han mong muon',
        'status_by_wish','status_wish','statuswish','ht_theo_han_mong_muon'
      ];
      const finishedDateKs = ['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh'];
      const countZeroTasks = true;
      const excludeCanceled = true;
      const minWeight = 0.0001;

      const hasVal = v => v != null && String(v).trim() !== '';
      const normalizeVi = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
      const normKey = (s)=> String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
      const getV = (obj, keys)=>{
        const lower = {};
        Object.keys(obj||{}).forEach(k=>{
          const v = obj[k];
          const k1 = String(k).toLowerCase();
          const k2 = normKey(k);
          lower[k1] = v;
          lower[k2] = v;
        });
        for (const k of keys){
          const cand1 = String(k).toLowerCase();
          const cand2 = normKey(k);
          const v = lower[cand1] ?? lower[cand2];
          if (v !== undefined && hasVal(v)) return v;
        }
        return '';
      };
      function toNum(v){
        if (v == null) return 0;
        let s = String(v).trim();
        if (!s) return 0;
        s = s.replace(/\s|\u00A0/g, '');
        s = s.replace(/[%₫đvnd]/gi, '');
        if (s.includes(',')) s = s.replace(/\./g,'').replace(',', '.');
        else s = s.replace(/\./g,'');
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }
      function getNumberFrom(row, keys){ const v = getV(row, keys); return toNum(v); }
      function getTextFrom(row, keys){ const v = getV(row, keys); return String(v||'').trim(); }
      function isCanceled(row){
        const f = getTextFrom(row, finishedDateKs).toLowerCase();
        const st = getTextFrom(row, statusKeys).toLowerCase();
        return f.includes('cancel') || st.includes('cancel') || st.includes('hủy') || st.includes('huỷ');
      }
      const resultKeys = ['⁉️ Kết quả','ket_qua','kết quả','result'];
      function inRange(v){
        if (!fromVal && !toVal) return true;
        const d = parseDateFlexible(v);
        if (!d) return true;
        const ds = d.toISOString().slice(0,10);
        if (fromVal && ds < fromVal) return false;
        if (toVal && ds > toVal) return false;
        return true;
      }
      // Phạm vi theo NGÀY HOÀN THÀNH: dùng để tính DONE/Vượt/Đúng/Chậm theo tháng hoàn thành
      function inRangeByDone(v){
        if (!fromVal && !toVal) return true;
        const d = parseDateFlexible(v);
        if (!d) return false; // nếu không có ngày hoàn thành thì không tính vào DONE tháng này
        const ds = d.toISOString().slice(0,10);
        if (fromVal && ds < fromVal) return false;
        if (toVal && ds > toVal) return false;
        return true;
      }
      const byName = new Map();
      const dbg = { total:0, done:0, both:0, addAhead:0, addOn:0, addLate:0, missWish:0, missMan:0 };
      rows.forEach(row=>{
        // Bỏ qua bản ghi không phải task (thiếu tên task)
        const taskVal = getTextFrom(row, taskNameKeys);
        if (!hasVal(taskVal)) return;
        if (excludeCanceled && isCanceled(row)) return;
        let name = getTextFrom(row, assigneeKeys);
        if (!name || name.toLowerCase() === 'nan') name = 'Chưa phân công';

        const rq = getV(row,[
          'requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','📆 ngày yêu cầu'
        ]);
        const wish = getV(row,['wishdue','hanmongmuon','han_mong_muon','desireddue']);
        const act = getV(row,['actualdue','handapung','han_dap_ung','completiondate']);
        const doneDate = getV(row, finishedDateKs);
        // Lọc theo mốc ngày ưu tiên: Ngày yêu cầu -> Hạn đáp ứng -> Hạn mong muốn -> Ngày hoàn thành
        const refDate = (
          hasVal(rq) ? rq : (
            hasVal(act) ? act : (
              hasVal(wish) ? wish : (
                hasVal(doneDate) ? doneDate : ''
              )
            )
          )
        );
        const inRef = hasVal(refDate) && inRange(refDate);

        const weight = getNumberFrom(row, scoreKeys) || getNumberFrom(row, altScoreKeys);
        const resText = getTextFrom(row, resultKeys);
        const statusRaw = getTextFrom(row, statusKeys);
        const hasDoneDate = !!parseDateFlexible(doneDate);
        const inDoneMonth = inRangeByDone(doneDate);
        // Bỏ qua hoàn toàn nếu không thuộc ref range và cũng không hoàn thành trong tháng
        if (!inRef && !inDoneMonth) return;
        const normRes = normalizeVi(resText);
        const normStatus = normalizeVi(statusRaw);
        const done = hasDoneDate || /^\s*done\s*$/i.test(resText||'') || /\bdone\b/.test(normRes) || /\bhoan\b|\bdone\b|\bda hoan\b/.test(normStatus);

        let rec = byName.get(name);
        if (!rec) { rec = { name, manhour: 0, count: 0, ahead: 0, ontime: 0, late: 0, na: 0, doneCnt: 0, doneSum: 0, activeCnt: 0, activeSum: 0 }; byName.set(name, rec); }

        const countThis = countZeroTasks ? true : (weight > minWeight);
        // Tính số DONE theo THÁNG HOÀN THÀNH (không phụ thuộc refDate)
        if (done && inDoneMonth) {
          if (countThis) rec.doneCnt = (rec.doneCnt || 0) + 1;
        }
        // Tổng công chuẩn đang xử lý/đã xử lý chỉ tính theo refDate để không lệch tháng nhận
        if (inRef) {
          if (done) {
            rec.doneSum += weight;
          } else {
            if (countThis) rec.activeCnt += 1;
            rec.activeSum += weight;
          }
        }
        rec.count = (rec.doneCnt || 0) + (rec.activeCnt || 0);
        rec.manhour = (rec.doneSum || 0) + (rec.activeSum || 0);
        // Tổng công chuẩn theo mốc tham chiếu refDate (không tính Cancel vì đã loại ở trên)
        try{
          if (inRef){ rec.totalByRef = (rec.totalByRef || 0) + weight; }
        }catch(_){ }

        // Phân loại vượt/đúng/chậm theo cột "Hiện trạng" khi đã Done VÀ ngày hoàn thành nằm trong tháng chọn
        dbg.total++;
        if (done && inDoneMonth){
          // Xác định điều kiện N/A: có ngày hoàn thành và số giờ thực tế = 0
          const EPS_NA = 1e-4;
          let actualNumForNA = 0;
          try { actualNumForNA = getNumberFrom(row, actualHoursKeys); } catch(_) { actualNumForNA = 0; }
          const isNA = (hasDoneDate && Number.isFinite(actualNumForNA) && Math.abs(actualNumForNA) < EPS_NA);
          let handled = false;
          // done & inDoneMonth nên không cộng missWish/missMan vì không xét task ngoài tháng hoàn thành
          // Lấy text nếu có
          const htText = normalizeVi(getTextFrom(row, statusKeys));
          const wishText = normalizeVi(getTextFrom(row, statusByWishKeys));
          let manAhead = htText.includes('vuot tien do');
          let manOn    = htText.includes('dung tien do');
          let manLate  = htText.includes('cham tien do');
          let wishOn   = wishText.includes('dung han');
          let wishLate = wishText.includes('tre han');
          // Fallback: suy ra Đúng/Trễ hạn nếu thiếu text
          if (!(wishOn || wishLate)){
            try{
              const dWish = parseDateFlexible(wish);
              const dDone = parseDateFlexible(doneDate);
              if (dWish && dDone){
                const plus1 = new Date(dWish.getFullYear(), dWish.getMonth(), dWish.getDate()+1);
                if (dDone.getTime() <= plus1.getTime()) wishOn = true; else wishLate = true;
              }
            }catch(_){ }
          }
          // Fallback: suy ra theo công chuẩn nếu thiếu text
          if (!(manAhead || manOn || manLate)){
            try{
              const actualNum = getNumberFrom(row, actualHoursKeys);
              const manNum = weight;
              const EPS = 1e-4;
              // Nếu thực tế = 0 thì coi là thiếu dữ liệu -> không phân loại vào Vượt/Đúng/Chậm
              if (Number.isFinite(actualNum) && Math.abs(actualNum) < EPS) {
                // giữ nguyên manAhead/manOn/manLate = false để đẩy vào N/A
              } else if (Number.isFinite(actualNum) && Number.isFinite(manNum)){
                // Áp dụng dung sai 10% cho Đúng tiến độ
                const tolerance = Math.max(EPS, Math.abs(manNum) * 0.10);
                if (actualNum > manNum + tolerance) manLate = true;
                else if (Math.abs(actualNum - manNum) <= tolerance) manOn = true;
                else manAhead = true;
              }
            }catch(_){ }
          }
          // Nếu thuộc N/A thì ưu tiên đưa vào N/A và bỏ qua các phân loại khác
          if (isNA){
            rec.na = (rec.na || 0) + 1;
            handled = true;
          }
          if (!handled && (wishOn || wishLate) && (manAhead || manOn || manLate)){
            rec.classifiedCnt = (rec.classifiedCnt || 0) + 1;
            dbg.both++;
            if (wishOn){
              if (manAhead) { rec.ahead += 1; dbg.addAhead++; }
              else if (manOn) { rec.ontime += 1; dbg.addOn++; }
              else if (manLate) { rec.late += 1; dbg.addLate++; }
            } else if (wishLate){
              rec.late += 1; dbg.addLate++;
            }
          } else if (!handled) {
            // Nếu chỉ có phân loại theo công chuẩn (thiếu hạn mong muốn) thì vẫn cộng để tránh đếm thiếu
            if (!wishOn && !wishLate && (manAhead || manOn || manLate)){
              rec.classifiedCnt = (rec.classifiedCnt || 0) + 1;
              if (manAhead) { rec.ahead += 1; dbg.addAhead++; }
              else if (manOn) { rec.ontime += 1; dbg.addOn++; }
              else if (manLate) { rec.late += 1; dbg.addLate++; }
            }
            // Nếu chỉ có Trễ hạn theo hạn mong muốn mà thiếu phân loại theo công chuẩn, vẫn tính là Chậm
            else if (wishLate && !(manAhead||manOn||manLate)){
              rec.classifiedCnt = (rec.classifiedCnt || 0) + 1;
              rec.late += 1; dbg.addLate++;
            } else {
              if (!(wishOn||wishLate)) dbg.missWish++;
              if (!(manAhead||manOn||manLate)) dbg.missMan++;
            }
          }
        }
      });
      const out = Array.from(byName.values());
      out.forEach(r=>{
        const na = Math.max(0, Number(r.na||0));
        const sumClassified = Math.max(0, Number(r.ahead||0) + Number(r.ontime||0) + Number(r.late||0));
        // Mẫu số mới: tổng (Vượt + Đúng + Chậm + N/A)
        const denom = sumClassified + na;
        r.rateAhead = denom ? Math.round((Number(r.ahead||0)*100)/denom) : 0;
        r.rateOntime = denom ? Math.round((Number(r.ontime||0)*100)/denom) : 0;
        r.rateLate = denom ? Math.round((Number(r.late||0)*100)/denom) : 0;
        r.rateNA = denom ? Math.max(0, Math.min(100, Math.round((na*100)/denom))) : 0;
        r.classifiedCnt = sumClassified;
        // Map theo biểu mẫu ngoài (ảnh)
        r["Phụ trách"] = r.name || '';
        const activeSum = Number(r.activeSum||0);
        r["Tổng điểm (đang xử lý)"] = +activeSum.toFixed(2);
        r["Số task đang xử lý"] = Number(r.activeCnt||0);
        const totalPts = Number((r.doneSum||0) + (r.activeSum||0));
        r["Tổng điểm tất cả"] = +totalPts.toFixed(2);
        r["Tổng tác vụ đã xử lý"] = Number((r.doneCnt||0) + (r.activeCnt||0));
        // Tổng công chuẩn theo mốc refDate
        const byRef = Number(r.totalByRef||0);
        r["Tổng công chuẩn"] = +byRef.toFixed(2);
      });
      try{ if (f5aIsDebug()) console.log('[F5A] classify summary:', dbg); }catch(_){ }
      return out;
    }

    // Date-time format helpers
    function toDateSafe(value){
      try{
        if (value instanceof Date && !isNaN(value)) return value;
        const parsed = (typeof parseDateFlexible === 'function') ? parseDateFlexible(value) : null;
        if (parsed && !isNaN(parsed)) return parsed;
        const d = new Date(value);
        return isNaN(d) ? null : d;
      }catch(_){ return null; }
    }
    function formatDdMmYyyy(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
      }catch(_){ return ''; }
    }
    function formatDdMmYyyyHHmm(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch(_){ return ''; }
    }

    function formatYyyyMm(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
      }catch(_){ return ''; }
    }
    // ===== Khu vực cấu hình ngày nghỉ (có thể chỉnh sửa) =====
    // Danh sách nghỉ riêng (ví dụ) — có thể thêm/bớt hoặc tạo thêm các Set khác
    const SEP_2025_HOLIDAYS = new Set(["2025-09-01","2025-09-02","2025-09-08","2025-09-09"]);
    // Gộp tất cả set nghỉ vào một Set duy nhất để tiện tra cứu
    const CUSTOM_HOLIDAYS = new Set([
      ...SEP_2025_HOLIDAYS,
      // Thêm spread các set khác tại đây, ví dụ: ...OCT_2025_HOLIDAYS
    ]);
    function isCustomHoliday(date){
      try{
        const d = toDateSafe(date);
        if (!d) return false;
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const iso = `${y}-${m}-${dd}`;
        return CUSTOM_HOLIDAYS.has(iso);
      }catch(_){ return false; }
    }
    // Business time addition: Mon-Sat, 08:00-12:30 and 13:30-17:00 (skip Sundays and custom holidays)
    function addBusinessHours(start, hours){
      try{
        let cur = toDateSafe(start);
        if (!cur || isNaN(cur)) return null;
        let minutesLeft = Math.round((Number(hours)||0) * 60);
        if (minutesLeft <= 0) return cur;
        function cloneAt(d, hh, mm){ const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), hh, mm, 0, 0); return nd; }
        function isSunday(d){ return d.getDay() === 0; }
        function isWorkingDay(d){ return d.getDay() >= 1 && d.getDay() <= 6 && !isCustomHoliday(d); }
        function moveToNextWorkdayMorning(d){
          const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 8, 0, 0, 0);
          // if after or equal 17:00, go to next day 08:00
          const afterClose = d.getHours() > 17 || (d.getHours() === 17 && d.getMinutes() > 0);
          const exactlyClose = d.getHours() === 17 && d.getMinutes() === 0;
          let base = (afterClose || exactlyClose) ? new Date(d.getFullYear(), d.getMonth(), d.getDate()+1, 8, 0, 0, 0) : nd;
          // skip Sundays and custom holidays
          while (isSunday(base) || isCustomHoliday(base)) base = new Date(base.getFullYear(), base.getMonth(), base.getDate()+1, 8, 0, 0, 0);
          return base;
        }
        function normalizeToWorkingSlot(d){
          // If Sunday or custom holiday -> move to next working day 08:00
          while (!isWorkingDay(d)) d = new Date(d.getFullYear(), d.getMonth(), d.getDate()+1, 8, 0, 0, 0);
          const mins = d.getHours()*60 + d.getMinutes();
          const mOpen = 8*60;          // 08:00
          const mLunch = 12*60 + 30;   // 12:30
          const mAfter = 13*60 + 30;   // 13:30
          const mClose = 17*60;        // 17:00
          if (mins < mOpen) return cloneAt(d, 8, 0);
          if (mins >= mClose) return moveToNextWorkdayMorning(d);
          if (mins >= mLunch && mins < mAfter) return cloneAt(d, 13, 30);
          if (mins >= mOpen && mins < mLunch) return d; // morning slot
          if (mins >= mAfter && mins < mClose) return d; // afternoon slot
          return d;
        }
        function segmentEnd(d){
          const mins = d.getHours()*60 + d.getMinutes();
          const mLunch = 12*60 + 30;   // 12:30
          const mAfter = 13*60 + 30;   // 13:30
          const mClose = 17*60;        // 17:00
          if (mins < mLunch) return cloneAt(d, 12, 30);
          if (mins >= mAfter && mins < mClose) return cloneAt(d, 17, 0);
          // exactly 12:30 -> next segment 13:30
          if (mins === mLunch) return cloneAt(d, 13, 30);
          return cloneAt(d, 17, 0);
        }
        cur = normalizeToWorkingSlot(cur);
        while (minutesLeft > 0){
          cur = normalizeToWorkingSlot(cur);
          // determine segment end
          const end = segmentEnd(cur);
          const avail = Math.max(0, Math.floor((end.getTime() - cur.getTime())/60000));
          if (minutesLeft <= avail){
            cur = new Date(cur.getTime() + minutesLeft*60000);
            minutesLeft = 0;
            break;
          }
          // consume this segment
          minutesLeft -= avail;
          // move to next slot
          const mins = cur.getHours()*60 + cur.getMinutes();
          const mLunch = 12*60 + 30; const mClose = 17*60;
          if (mins < mLunch){
            // go to 13:30 same day
            cur = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate(), 13, 30, 0, 0);
          } else {
            // go to next workday 08:00
            cur = moveToNextWorkdayMorning(new Date(cur.getFullYear(), cur.getMonth(), cur.getDate(), 17, 0, 0, 0));
          }
        }
        return cur;
      }catch(_){ return null; }
    }
    // Parse number flexible: supports both comma and dot decimals
    function parseNumberFlexible(value){
      try{
        let s = String(value ?? '').trim();
        if (!s) return NaN;
        s = s.replace(/\s|\u00A0/g,'');
        s = s.replace(/[%₫đvnd]/gi,'');
        if (s.includes(',')) {
          s = s.replace(/\./g,'').replace(',', '.');
        } else {
          s = s.replace(/,/g,'');
        }
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }catch(_){ return NaN; }
    }
    // Number formatters for display only (do not mutate source data)
    function formatNumberVi(num, min=2, max=2){
      try{
        if (!Number.isFinite(num)) return '';
        return num.toLocaleString('vi-VN', { minimumFractionDigits: min, maximumFractionDigits: max });
      }catch(_){
        try{ return String(num); }catch(__){ return ''; }
      }
    }
    function formatNumberViFromRaw(raw, min=2, max=2){
      try{
        const n = parseNumberFlexible(raw);
        return Number.isFinite(n) ? formatNumberVi(n, min, max) : String(raw||'');
      }catch(_){ return String(raw||''); }
    }

    // Local storage helpers & last-updated note
    const LS = {
      get(k){ try{ return localStorage.getItem(k); }catch(_){ return null; } },
      set(k,v){ try{ localStorage.setItem(k,v); }catch(_){ } },
      getJSON(k){ try{ const s=localStorage.getItem(k); return s? JSON.parse(s): null; }catch(_){ return null; } },
      setJSON(k,obj){ try{ localStorage.setItem(k, JSON.stringify(obj)); }catch(_){ } },
      remove(k){ try{ localStorage.removeItem(k); }catch(_){ } }
    };
    function formatHHmmDdMmYyyy(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
      }catch(_){ return ''; }
    }
    function updateLastUpdatedNote(btnId, tsKey){
      try{
        const btn = document.getElementById(btnId);
        if (!btn) return;
        const parent = btn.parentElement || btn;
        // Ghi chú thời gian
        let note = parent.querySelector('[data-last-updated]');
        if (!note){
          note = document.createElement('span');
          note.setAttribute('data-last-updated','1');
          note.className = 'text-xs text-gray-500 ml-2';
          parent.appendChild(note);
        }
        const tsStr = LS.get(tsKey);
        const ts = Number(tsStr);
        const show = tsStr ? (isNaN(ts) ? '' : `Dữ liệu cập nhật lúc ${formatHHmmDdMmYyyy(new Date(ts))}`) : '';
        note.textContent = show;

        // Dòng hướng dẫn nổi bật bên dưới
        const hintId = `${btnId}-refresh-hint`;
        let hint = document.getElementById(hintId);
        if (!hint){
          hint = document.createElement('div');
          hint.id = hintId;
          hint.className = 'mt-1 text-xs inline-flex items-center gap-1 px-2 py-1 rounded bg-amber-50 border border-amber-200 text-amber-700';
          parent.insertAdjacentElement('afterend', hint);
        }
        hint.innerHTML = `🔄 <span>Nhấn <b>TRA CỨU</b> để cập nhật dữ liệu mới nhất.</span>`;
      }catch(_){ }
    }

    function f4SchedulePivot(delay = 80){
      try { if (F4_PIVOT_TMO) clearTimeout(F4_PIVOT_TMO); } catch(_) {}
      F4_PIVOT_TMO = setTimeout(()=>{ try{ renderF4Pivot(); }catch(_){ } }, delay);
    }

    // Global helper: parse various date/time formats robustly (ISO/TZ, DD/MM/YYYY, YYYY-MM-DD, with optional time & AM/PM)
    function parseDateFlexible(value){
      try{
        if (value instanceof Date && !isNaN(value)) return value;
        if (typeof value === 'number'){
          const ts = Number(value);
          if (Number.isFinite(ts)) return new Date(ts > 1e12 ? ts : ts*1000);
        }
        if (!value && value !== 0) return null;
        let s = String(value).trim();
        if (!s) return null;
        // Remove wrappers/words and normalize
        s = s.replace(/\((?:GMT|UTC)[^)]+\)/ig,'');
        s = s.replace(/\b(?:GMT|UTC|ICT)\b/ig,'');
        s = s.replace(/\b(?:at|lúc)\b/ig,'');
        s = s.replace(/,\s*/g,' ');
        s = s.replace(/\s+/g,' ').trim();

        // ISO 8601 with timezone or space
        if (/^\d{4}-\d{2}-\d{2}[ T]\d{1,2}:\d{2}(?::\d{2})?(?:\.\d+)?(?:Z|[+-]\d{2}:?\d{2})?$/i.test(s)){
          const norm = s.replace(/([+-]\d{2})(\d{2})$/,'$1:$2');
          const dISO = new Date(norm);
          if (!isNaN(dISO)) return dISO;
          const m = norm.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{1,2}):(\d{2})(?::(\d{2}))?/);
          if (m){
            return new Date(+m[1], +m[2]-1, +m[3], +(m[4]||0), +(m[5]||0), +(m[6]||0));
          }
        }

        // DD/MM/YYYY (or DD-MM, DD.MM) with optional time and AM/PM
        let m = s.match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?(?:\s*(AM|PM))?)?$/i);
        if (m){
          const day = +m[1], month = +m[2], year = m[3].length===2 ? +('20'+m[3]) : +m[3];
          let hh = m[4] ? +m[4] : 0, mm = m[5] ? +m[5] : 0, ss = m[6] ? +m[6] : 0;
          const ampm = m[7];
          if (ampm){
            const up = ampm.toUpperCase();
            if (up==='PM' && hh<12) hh += 12;
            if (up==='AM' && hh===12) hh = 0;
          }
          const dt = new Date(year, month-1, day, hh, mm, ss);
        return isNaN(dt) ? null : dt;
      }

        // YYYY-MM-DD (or / or .) with optional time
        m = s.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
        if (m){
          const dt = new Date(+m[1], +m[2]-1, +m[3], +(m[4]||0), +(m[5]||0), +(m[6]||0));
        return isNaN(dt) ? null : dt;
      }

      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
      }catch(_){ return null; }
    }

    // Sidebar navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    const sections = ['form1','form2','form3','form4','form5','form6','form7','form8','form9','form10','form0'].map(id=>document.getElementById(id));
    function showSection(id){ sections.forEach(s=>s.classList.toggle('hidden', s.id!==id)); }
    navBtns.forEach((btn)=>{
      btn.onclick=()=>{
        navBtns.forEach(b=>b.classList.remove('bg-primary-blue','font-bold'));
        btn.classList.add('bg-primary-blue','font-bold');
        const target = btn.getAttribute('data-target');
        showSection(target);
        // Bật tính năng collapse sidebar khi đã chọn form
        const sidebarNav = document.getElementById('sidebar-nav');
        if (sidebarNav && target) {
          sidebarNav.classList.add('collapsible');
        }
        if (target === 'form6') { try { if(!restoreForm6FromCache()){ renderForm6List(); } } catch(_){} }
        if (target === 'form4') {
          try {
            const restored = restoreForm4FromCache();
            f4UpdateGroupButtonsUI();
            f4SchedulePivot();
            // Refresh ngầm: giữ UI hiện có, tải dữ liệu mới không hiển thị spinner
            try { F4_SUPPRESS_LOADING = true; } catch(_) {}
            renderForm4().finally(()=>{ try { F4_SUPPRESS_LOADING = false; } catch(_) {} });
          } catch(_){}
        }
        if (target === 'form5') {
          try {
            const restored = restoreForm5FromCache();
            // Luôn làm mới ngầm để đảm bảo % được tính lại sau khi chuyển form hoặc cập nhật mã
            renderForm5All().catch(()=>{});
          } catch(_){}
        }
        if (target === 'form7') {
          try {
            // Khôi phục dữ liệu Form 7 từ cache nếu có
            restoreForm7FromCache();
          } catch(_){}
        }
        if (target === 'form8') {
          try {
            // Khôi phục dữ liệu Form 8 từ cache nếu có
            restoreForm8FromCache();
          } catch(_){}
        }
        if (target === 'form9') {
          try {
            restoreForm9FromCache();
          } catch(_){}
        }
        if (target === 'form10') {
          try { /* no-op */ } catch(_){ }
        }
      }
    });
    // Default
    navBtns[0].classList.add('bg-primary-blue','font-bold');
    showSection(navBtns[0].getAttribute('data-target'));
    // Hiển thị dòng hướng dẫn dưới các nút Tra cứu của các form khác
    try { updateLastUpdatedNote('f4-search','f4.lastUpdated'); } catch(_){}
    try { updateLastUpdatedNote('f5a-search-p1','f5a.lastUpdated'); } catch(_){}
    try { updateLastUpdatedNote('f5a-search-p2','f5a.lastUpdated'); } catch(_){}
    try { updateLastUpdatedNote('f5a-search-p3','f5a.p3.lastUpdated'); } catch(_){}
    try { updateLastUpdatedNote('f6-search','f6.lastUpdated'); } catch(_){}

    // Names
    const FORM1_NAMES = [
      "Bùi Đặng Quốc Huy","Đào Tuấn Kỳ","Đỗ Quang Long","Hà Mỹ Linh","Lại Quốc Lộc",
      "Lê Ngọc Ánh","Lê Thị Thanh Nhàn","Lê Thị Thảo","Lê Văn Sơn","Nguyễn Hữu Thịnh","Nguyễn Thị Hiền",
      "Phạm Thành Trung Kiên","Phạm Thị Minh","Thái Thị Giang","Trần Hiếu Nghĩa","Vũ Thị Hằng","Vũ Thị Thanh Hiền"
    ];
    const FORM2_NAMES = FORM1_NAMES;
    const FORM7_NAMES = FORM1_NAMES;
    const FORM9_NAMES = (function(){
      try{
        const arr = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.slice() : [];
        const exclude = new Set(["Lê Thị Thanh Nhàn"]);
        return arr.filter(n => !exclude.has(n));
      }catch(_){ return FORM1_NAMES; }
    })();
    // Danh sách riêng cho Form 3 (Người được giao): loại 3 tên và thêm 3 tên
    const FORM3_ASSIGNEES = (()=>{
      const base = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.slice() : [];
      const exclude = new Set(["Hà Mỹ Linh","Đỗ Thế Cường","Lê Thị Thanh Nhàn"]);
      const add = ["Đào Hoàng Dương","Nguyễn Văn Linh","Nguyễn Văn Hiếu"];
      const filtered = base.filter(n => !exclude.has(n));
      add.forEach(n => { if (filtered.indexOf(n) === -1) filtered.push(n); });
      return filtered;
    })();

    // ===== Form 10: Quản lý nhân sự =====
    // (Form 10 cũ: đã loại bỏ các bảng chức năng khác, chỉ giữ Bảng công)
    // ==== Form 10: Attendance (Bảng công theo tháng) ====
    let F10_ATT_ROWS = [];
    let F10_ATT_META = { month: '' };

    function f10BuildQuery(month){
      try{
        const qs = new URLSearchParams();
        // Optional action (server có thể bỏ qua)
        const action = 'form10_attendance';
        qs.append('action', action);
        // Header map (để server tạo đúng keys nếu cần)
        const headers = {
          employee: 'Nhân sự',
          month: 'Tháng',
          days: 'Số ngày đi làm (tháng)',
          ot: 'Tổng giờ tăng ca (tháng)',
          total: 'Tổng giờ công đi làm'
        };
        qs.append('header_employee', headers.employee);
        qs.append('header_month', headers.month);
        qs.append('header_days', headers.days);
        qs.append('header_ot', headers.ot);
        qs.append('header_total', headers.total);
        // Standard field keys (fallback)
        const fields = {
          employee: 'employee',
          month: 'month',
          days: 'daysInMonth',
          ot: 'overtimeHours',
          total: 'totalWorkHours'
        };
        qs.append('field_employee', fields.employee);
        qs.append('field_month', fields.month);
        qs.append('field_days', fields.days);
        qs.append('field_ot', fields.ot);
        qs.append('field_total', fields.total);
        // Month filter; if provided as YYYY-MM, also include from/to for convenience
        const m = (month||'').trim();
        let from = '', to = '';
        if (m){
          qs.append('month', m);
          try{
            const [yy, mm] = m.split('-');
            const firstDay = `${yy}-${mm}-01`;
            const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
            const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
            qs.append('from', firstDay);
            qs.append('to', lastDay);
            from = firstDay; to = lastDay;
          }catch(_){ }
        }
        // Add meta body so server vẫn đọc được nếu query bị strip
        try{
          const meta = {
            action,
            headers,
            fields,
            month: m,
            from,
            to,
            timestamp_iso: new Date().toISOString()
          };
          qs.append('body', JSON.stringify(meta));
        }catch(_){ }
        // Cache buster
        qs.append('_ts', Date.now().toString());
        return qs.toString();
      }catch(_){ return ''; }
    }

    async function f10FetchAttendance(month){
      try{
        // Try prod & test variants and GET/POST forms
        const base = FORM10_ATTENDANCE_URL;
        const q = f10BuildQuery(month);
        const postOpts = (mode)=>({ method:'POST', mode, headers: { 'Content-Type':'application/x-www-form-urlencoded', 'Accept':'application/json, text/plain, */*' }, body: q });
        const tryList = [
          { url: `${base}?${q}`, opts: { method:'GET', headers:{ 'Accept':'application/json, text/plain, */*' } } },
          { url: base, opts: postOpts('cors') },
          // As last resort (opaque), still trigger server: result not readable
          { url: base, opts: postOpts('no-cors') },
        ];
        let rows = [];
        for (const t of tryList){
          try{
            const r = await fetch(t.url, t.opts);
            // Skip unreadable opaque responses
            let text = '';
            try{ text = await r.text(); }catch(__){ text = ''; }
            let data = null; try{ data = JSON.parse(text); }catch{ data = null; }
            // Unwrap simple or deep nested
            const picked = (function pickRows(json){
              if (!json) return [];
              if (Array.isArray(json)) return json;
              const keys=['data','rows','result','records','items','list'];
              for (const k of keys){ if (Array.isArray(json?.[k])) return json[k]; }
              try{
                const queue=[json]; const seen=new Set();
                while(queue.length){
                  const cur=queue.shift(); if(!cur||typeof cur!== 'object'||seen.has(cur)) continue; seen.add(cur);
                  for (const v of Object.values(cur)){
                    if (Array.isArray(v) && v.length && typeof v[0]==='object') return v;
                    if (v && typeof v==='object') queue.push(v);
                  }
                }
              }catch(_){ }
              return [];
            })(data ?? text);
            if (Array.isArray(picked) && picked.length){ rows = picked; break; }
          }catch(_){ /* next */ }
        }
        // Normalize sample single-object payload to array
        if (!Array.isArray(rows) && rows && typeof rows==='object') rows = [rows];
        // Store
        F10_ATT_ROWS = Array.isArray(rows) ? rows : [];
        F10_ATT_META = { month: month||'' };
        try{ LS.setJSON('f10.att', { month: (month||''), rows: F10_ATT_ROWS, ts: Date.now() }); LS.set('f10.lastUpdated', String(Date.now())); }catch(_){ }
        // Friendly message for likely CORS/file:// case
        if (!F10_ATT_ROWS.length){
          try{
            const bodyEl = document.getElementById('f10-att-body');
            if (bodyEl){
              const isFile = (typeof location!=='undefined' && String(location.protocol||'').toLowerCase().startsWith('file'));
              bodyEl.innerHTML = `
                <tr>
                  <td colspan="4" class="px-3 py-3 text-center">
                    <div class="text-red-600 mb-2">⚠️ Không thể tải dữ liệu Form 10</div>
                    <div class="text-sm text-gray-600 mb-2">${isFile ? 'Lỗi CORS do mở file trực tiếp (file://)' : 'Có thể do máy chủ chưa bật CORS'}</div>
                    <div class="text-xs text-blue-600 text-left max-w-3xl mx-auto">
                      <strong>Giải pháp:</strong><br>
                      1) Mở file qua web server (ví dụ: VS Code Live Server, hoặc <code>python -m http.server 8080</code>) rồi truy cập <code>http://localhost:8080/index.html</code><br>
                      2) Yêu cầu máy chủ thêm header CORS: <code>Access-Control-Allow-Origin: *</code> và <code>Access-Control-Allow-Headers: *</code><br>
                      3) Nếu cần, cung cấp một endpoint proxy nội bộ có bật CORS
                    </div>
                  </td>
                </tr>
              `;
            }
          }catch(_){ }
        }
        return F10_ATT_ROWS;
      }catch(_){ F10_ATT_ROWS = []; return []; }
    }

    function f10GetV(obj, keys){
      const lower = {}; Object.keys(obj||{}).forEach(k=>{ lower[String(k||'').toLowerCase().trim()] = obj[k]; });
      for (const k of keys){ const v = lower[String(k||'').toLowerCase().trim()]; if (v!==undefined) return v; }
      // Loose includes fallback
      for (const key of Object.keys(lower)){ if (keys.some(k=> key.includes(String(k).toLowerCase()))) return lower[key]; }
      return '';
    }

    function f10MonthMatches(textMonth, monthVal){
      try{
        if (!monthVal) return true;
        const s = String(textMonth||'').trim();
        if (!s) return true;
        // MM/YYYY or M/YYYY
        let m = s.match(/^(\d{1,2})\/(\d{4})$/);
        if (m){
          const yy = m[2]; const mm = String(m[1]).padStart(2,'0');
          return `${yy}-${mm}` === monthVal;
        }
        // YYYY-MM or YYYY-MM-DD
        m = s.match(/^(\d{4})[-\/](\d{1,2})(?:[-\/]\d{1,2})?$/);
        if (m){
          const yy = m[1]; const mm = String(m[2]).padStart(2,'0');
          return `${yy}-${mm}` === monthVal;
        }
        // Fallback by parsing date
        const d = parseDateFlexible(s);
        if (d){
          const yy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0');
          return `${yy}-${mm}` === monthVal;
        }
        return true;
      }catch(_){ return true; }
    }

    function renderForm10Attendance(){
      try{
        const body = document.getElementById('f10-att-body');
        const monthEl = document.getElementById('f10-att-month');
        if (!body) return;
        const monthVal = (monthEl && monthEl.value) ? monthEl.value : '';
        const rows = Array.isArray(F10_ATT_ROWS) ? F10_ATT_ROWS : [];
        if (!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Chưa có dữ liệu</td></tr>'; return; }

        // Helper parse number safely
        const toNum = (v)=>{ try{ const n = (typeof parseNumberFlexible==='function') ? parseNumberFlexible(v) : Number(v); return Number.isFinite(n) ? n : 0; }catch(_){ return 0; } };

        // Build filtered view by month, then sort by Total descending
        const view = [];
        rows.forEach(r=>{
          const emp = f10GetV(r, ['nhân sự','nhan su','employee','name']);
          const month = f10GetV(r, ['tháng','thang','month']);
          const days = f10GetV(r, ['số ngày đi làm (tháng)','so ngay di lam (thang)','days','daysinmonth']);
          const ot = f10GetV(r, ['tổng giờ tăng ca (tháng)','tong gio tang ca (thang)','overtime','overtimehours']);
          const total = f10GetV(r, ['tổng giờ công đi làm','tong gio cong di lam','total','totalworkhours']);
          if (f10MonthMatches(month, monthVal)){
            view.push({ emp, days, ot, total, totalNum: toNum(total) });
          }
        });
        view.sort((a,b)=> b.totalNum - a.totalNum);

        if (view.length){
          body.innerHTML = view.map(x=>`
            <tr>
              <td class="px-3 py-2">${x.emp||''}</td>
              <td class="px-3 py-2">${x.days||''}</td>
              <td class="px-3 py-2">${x.ot||''}</td>
              <td class="px-3 py-2">${x.total||''}</td>
            </tr>
          `).join('');
          return;
        }

        // Fallback: nếu không khớp tháng nhưng có dữ liệu -> hiển thị tất cả, vẫn sort giảm dần
        if (!view.length && rows.length > 0){
          const allView = rows.map(r=>{
            const emp = f10GetV(r, ['nhân sự','nhan su','employee','name']);
            const days = f10GetV(r, ['số ngày đi làm (tháng)','so ngay di lam (thang)','days','daysinmonth']);
            const ot = f10GetV(r, ['tổng giờ tăng ca (tháng)','tong gio tang ca (thang)','overtime','overtimehours']);
            const total = f10GetV(r, ['tổng giờ công đi làm','tong gio cong di lam','total','totalworkhours']);
            return { emp, days, ot, total, totalNum: toNum(total) };
          });
          allView.sort((a,b)=> b.totalNum - a.totalNum);
          body.innerHTML = `
            <tr><td colspan="4" class="px-3 py-2 text-xs text-amber-700 bg-amber-50">Không khớp tháng lọc. Hiển thị tất cả kết quả trả về từ server (đã sắp xếp giảm dần theo Tổng giờ công đi làm).</td></tr>
            ${allView.map(x=>`
              <tr>
                <td class="px-3 py-2">${x.emp||''}</td>
                <td class="px-3 py-2">${x.days||''}</td>
                <td class="px-3 py-2">${x.ot||''}</td>
                <td class="px-3 py-2">${x.total||''}</td>
              </tr>
            `).join('')}
          `;
          return;
        }

        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Không có dữ liệu</td></tr>';
      }catch(_){
        try{ const body = document.getElementById('f10-att-body'); if (body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="4">Lỗi hiển thị dữ liệu</td></tr>'; }catch(__){}
      }
    }

    function f10RowsToAOA(){
      const head = ['Nhân sự','Tháng','Số ngày đi làm (tháng)','Tổng giờ tăng ca (tháng)','Tổng giờ công đi làm'];
      const aoa = [head];
      const rows = Array.isArray(F10_ATT_ROWS)? F10_ATT_ROWS: [];
      rows.forEach(r=>{
        const emp = f10GetV(r, ['nhân sự','nhan su','employee','name']);
        const month = f10GetV(r, ['tháng','thang','month']);
        const days = f10GetV(r, ['số ngày đi làm (tháng)','so ngay di lam (thang)','days','daysinmonth']);
        const ot = f10GetV(r, ['tổng giờ tăng ca (tháng)','tong gio tang ca (thang)','overtime','overtimehours']);
        const total = f10GetV(r, ['tổng giờ công đi làm','tong gio cong di lam','total','totalworkhours']);
        aoa.push([emp, month, days, ot, total]);
      });
      return aoa;
    }

    function f10DownloadXLSX(){
      try{
        const rows = Array.isArray(F10_ATT_ROWS)? F10_ATT_ROWS: [];
        if (!rows.length){ showToast('Form 10: Không có dữ liệu để xuất.','error'); return; }
        const aoa = f10RowsToAOA();
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Form10');
        const monthEl = document.getElementById('f10-att-month');
        const mv = (monthEl && monthEl.value) ? monthEl.value.replace(/\s+/g,'_') : '';
        XLSX.writeFile(wb, `Form10_Attendance_${mv||'export'}.xlsx`);
      }catch(_){ showToast('Form 10: Xuất XLSX thất bại.','error'); }
    }

    (function initForm10(){
      try{
        // Default month = current
        const m = document.getElementById('f10-att-month');
        if (m && !m.value){
          const d = new Date(); const yy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0');
          m.value = `${yy}-${mm}`;
        }
        // Restore cache if exists
        try{
          const cached = LS.getJSON('f10.att');
          if (cached && Array.isArray(cached.rows)){
            F10_ATT_ROWS = cached.rows.slice();
            F10_ATT_META = { month: cached.month || '' };
            renderForm10Attendance();
          }
        }catch(_){ }
        // Bind search
        const btn = document.getElementById('f10-att-search');
        if (btn && !btn._bound){
          btn.addEventListener('click', async (e)=>{
            e.preventDefault();
            if (btn.disabled) return;
            const prev = btn.textContent; btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
            try{
              const month = (document.getElementById('f10-att-month')?.value || '').trim();
              await f10FetchAttendance(month);
              renderForm10Attendance();
              try{ updateLastUpdatedNote('f10-att-search','f10.lastUpdated'); }catch(_){ }
            }finally{
              btn.disabled = false; btn.textContent = prev || 'Tra cứu';
            }
          });
          btn._bound = true;
        }
        // Bind XLSX export
        const btnX1 = document.getElementById('f10-att-export-xlsx');
        if (btnX1 && !btnX1._bound){ btnX1.addEventListener('click', (e)=>{ e.preventDefault(); f10DownloadXLSX(); }); btnX1._bound = true; }
        // Chỉ giữ 1 nút Export ở phần Bảng công (f10-att-export-xlsx)
      }catch(_){ }
    })();

    // ===== Form 5: P4 - Phân tích chi tiết (hiển thị tất cả nhân viên, giống điều kiện Form 8) =====
    async function renderF5PanelP4(){
      const body = document.getElementById('f5a-body-p4');
      const monthEl = document.getElementById('f5a-month');
      if (!body) return;
      const monthVal = (monthEl && monthEl.value) ? monthEl.value : '';
      body.innerHTML = `<tr><td colspan="9" class="px-3 py-3 text-center text-gray-500"><span class='spinner mr-2'></span>Đang tải...</td></tr>`;
      try{
        const params = new URLSearchParams({
          action: 'form8_lookup',
          header_assignee: 'Assignee',
          header_code: 'Mã',
          header_taskName: 'Task Name',
          header_reportCode: 'Mã Báo cáo',
          header_actualCompletionDate: 'Ngày hoàn thành thực tế',
          field_assignee: 'assignee',
          field_code: 'code',
          field_taskName: 'taskName',
          field_reportCode: 'reportCode',
          field_actualCompletionDate: 'actualCompletionDate',
          timestamp: new Date().toISOString()
        });
        const url = `${FORM8_LOOKUP_URL}?${params.toString()}`;
        const resp = await fetch(url, { method: 'GET' });
        const text = await resp.text();
        if (!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
        let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const keys = ['data','rows','result','records','items','list'];
          for (const k of keys){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const q=[json]; const seen=new Set();
            while(q.length){ const cur=q.shift(); if(!cur||typeof cur!=="object"||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') q.push(v);} }
          }catch(_){ }
          return [];
        }
        let rowsRaw = pickRows(data);
        // Unwrap n8n format [{ json: {...} }]
        if (Array.isArray(rowsRaw) && rowsRaw.length && rowsRaw.every(x=> x && typeof x==='object' && ('json' in x))){
          rowsRaw = rowsRaw.map(x=> x.json);
        }
        // Convert table format [[headers], [...]]
        if (Array.isArray(rowsRaw) && rowsRaw.length && Array.isArray(rowsRaw[0])){
          try{
            const header = rowsRaw[0].map(h=> String(h||'').trim());
            rowsRaw = rowsRaw.slice(1).map(r=>{ const o={}; header.forEach((k,i)=>{ o[k]= Array.isArray(r)? r[i]: undefined; }); return o; });
          }catch(_){ }
        }
        const sanitize = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); } };
        const getV = (obj, keys)=>{
          const lower = {}; Object.keys(obj||{}).forEach(k=>{ lower[sanitize(k)] = obj[k]; });
          for (const k of keys){ const v = lower[sanitize(k)]; if (v!==undefined) return v; }
          for (const k of keys){ const c=sanitize(k); const m = Object.keys(lower).find(kk=> kk.includes(c)); if (m) return lower[m]; }
          return '';
        };
        // Normalize and filter by month like Form 8 (Ngày hoàn thành thực tế)
        let rows = rowsRaw.map(it=>({
          assignee: getV(it,['Assignee','assignee','nhân viên','nhanvien','employee','pic']) || '',
          code: getV(it,['Mã','code','ma','taskcode']) || '',
          taskName: getV(it,['Task Name','taskname','tên tác vụ','ten_tac_vu','name']) || '',
          done: getV(it,['Ngày hoàn thành thực tế','actualcompletiondate','ngay hoan thanh thuc te','completiondate','ngay hoan thanh']) || ''
        }));
        if (monthVal){
          rows = rows.filter(r=>{
            const d = toDateSafe ? toDateSafe(r.done) : new Date(r.done);
            if (!d || isNaN(d)) return false;
            const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            return ym === monthVal;
          });
        }
        // Group by assignee
        const byAssignee = new Map();
        rows.forEach(r=>{
          const key = (r.assignee||'').trim();
          if (!byAssignee.has(key)) byAssignee.set(key, []);
          byAssignee.get(key).push(r);
        });
        // Union with all employees list
        const allNames = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.slice() : [];
        const out = allNames.map(name=>{
          const list = byAssignee.get(name) || [];
          const total = list.length;
          return {
            name,
            total,
            tckt: 0, ce: 0, hdkt: 0, bb: 0, jig: 0, khkscl: 0, p4: 0
          };
        });
        if (!out.length){ body.innerHTML = `<tr><td colspan="9" class="px-3 py-3 text-center text-gray-500">Không có dữ liệu</td></tr>`; return; }
        body.innerHTML = out.map(row=>{
          function pct(v){ try{ const n=Number(v); return isNaN(n)?'0%':(`${Math.round(n)}%`); }catch(_){ return '0%'; } }
          return `<tr>
            <td class="px-3 py-2">${row.name}</td>
            <td class="px-3 py-2">${row.total}</td>
            <td class="px-3 py-2">${pct(row.tckt)}</td>
            <td class="px-3 py-2">${pct(row.ce)}</td>
            <td class="px-3 py-2">${pct(row.hdkt)}</td>
            <td class="px-3 py-2">${pct(row.bb)}</td>
            <td class="px-3 py-2">${pct(row.jig)}</td>
            <td class="px-3 py-2">${pct(row.khkscl)}</td>
            <td class="px-3 py-2">${pct(row.p4)}</td>
          </tr>`;
        }).join('');
      }catch(err){
        body.innerHTML = `<tr><td colspan="9" class="px-3 py-3 text-center text-red-600">Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }
    // Bind button for P4
    (function initF5P4(){
      try{
        const btn = document.getElementById('f5a-search-p4');
        if (btn && !btn._bound){ btn.addEventListener('click', (e)=>{ e.preventDefault(); renderF5PanelP4(); }); btn._bound = true; }
      }catch(_){ }
    })();

    // Dữ liệu tác vụ (khởi tạo rỗng; sẽ nối nguồn thật sau)
    const demoTasksForm1 = {};
    const demoTasksForm2 = {};

    // Fill selects
    function fillSelect(sel, arr){ arr.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
    fillSelect(document.getElementById('f1-name'), FORM1_NAMES);
    fillSelect(document.getElementById('f2-name'), FORM2_NAMES);
    fillSelect(document.getElementById('f7-name'), FORM7_NAMES);
    const f9NameSel = document.getElementById('f9-name');
    if (f9NameSel){
      // Thêm mục Tất cả
      try{ const opt=document.createElement('option'); opt.value='__ALL__'; opt.textContent='Tất cả'; f9NameSel.appendChild(opt); }catch(_){ }
      fillSelect(f9NameSel, FORM9_NAMES);
    }
    const f3AssigneeSel = document.getElementById('f3-assignee');
    if (f3AssigneeSel) fillSelect(f3AssigneeSel, FORM3_ASSIGNEES);
    
    // Form 3: Tự động chuyển đổi dấu chấm thành dấu phẩy cho trường Công chuẩn
    const manHourInput = document.getElementById('man-hour');
    if (manHourInput) {
      manHourInput.addEventListener('input', function(e) {
        let value = e.target.value;
        // Chuyển đổi dấu chấm thành dấu phẩy
        if (value.includes('.')) {
          value = value.replace(/\./g, ',');
          e.target.value = value;
          // Hiển thị thông báo nhẹ cho người dùng
          showToast('Đã tự động chuyển dấu chấm (.) thành dấu phẩy (,)', 'info');
        }
      });
    }
    const f4PeopleSel = document.getElementById('f4-people');
    if (f4PeopleSel) fillSelect(f4PeopleSel, FORM1_NAMES);
    const f5EmployeeSel = document.getElementById('f5-employee');
    if (f5EmployeeSel) fillSelect(f5EmployeeSel, FORM1_NAMES);

    // Persist selections and show last-updated notes for Form 1 & 2
    (function initPersistSelections(){
      try{
        const f1Sel = document.getElementById('f1-name');
        if (f1Sel){
          const last = LS.get('f1.selectedName');
          if (last && Array.prototype.some.call(f1Sel.options, op=> op.value===last)) f1Sel.value = last;
          f1Sel.addEventListener('change', ()=>{ LS.set('f1.selectedName', f1Sel.value||''); });
          updateLastUpdatedNote('f1-search','f1.lastUpdated');
        }
        const f2Sel = document.getElementById('f2-name');
        if (f2Sel){
          const last2 = LS.get('f2.selectedName');
          if (last2 && Array.prototype.some.call(f2Sel.options, op=> op.value===last2)) f2Sel.value = last2;
          f2Sel.addEventListener('change', ()=>{ LS.set('f2.selectedName', f2Sel.value||''); });
          updateLastUpdatedNote('f2-search','f2.lastUpdated');
        }
        const f7Sel = document.getElementById('f7-name');
        if (f7Sel){
          const last7 = LS.get('f7.selectedName');
          if (last7 && Array.prototype.some.call(f7Sel.options, op=> op.value===last7)) f7Sel.value = last7;
          f7Sel.addEventListener('change', ()=>{ LS.set('f7.selectedName', f7Sel.value||''); });
          updateLastUpdatedNote('f7-search','f7.lastUpdated');
        }
        const f9Sel = document.getElementById('f9-name');
        if (f9Sel){
          const last9 = LS.get('f9.selectedName');
          if (last9 && Array.prototype.some.call(f9Sel.options, op=> op.value===last9)) f9Sel.value = last9;
          f9Sel.addEventListener('change', ()=>{ LS.set('f9.selectedName', f9Sel.value||''); });
          updateLastUpdatedNote('f9-search','f9.lastUpdated');
        }
      }catch(_){ }
    })();

    // ===== Form 9: Test bền =====
    function addTdF9(tr, text){ const td=document.createElement('td'); td.className='px-3 py-3 align-top text-gray-800 border border-gray-500'; td.textContent=text||''; tr.appendChild(td); }

    function openF9DurabilityModal(row){
      try{
        const modal = document.getElementById('f9-dur-modal');
        const closeBtn = document.getElementById('f9-dur-close');
        const cancelBtn = document.getElementById('f9-dur-cancel');
        const body = document.getElementById('f9-dur-body');
        if (!modal || !body) return;
        // Reset trạng thái nút gửi mỗi lần mở modal
        try{
          const btnSaveAll = document.getElementById('f9-dur-save-all');
          if (btnSaveAll){
            btnSaveAll.disabled = false;
            btnSaveAll.innerHTML = 'Gửi dữ liệu';
          }
        }catch(_){ }
        // Fill header info
        try{ document.getElementById('f9-dur-assignee').textContent = row.assignee || ''; }catch(_){ }
        try{ document.getElementById('f9-dur-taskid').textContent = row.taskId || ''; }catch(_){ }
        try{ document.getElementById('f9-dur-taskname').textContent = row.taskName || ''; }catch(_){ }

        // Tabs Gate B / Gate A: bind and set default active = Gate B
        try{
          const tabA = document.getElementById('f9-tab-gatea');
          const tabB = document.getElementById('f9-tab-gateb');
          const wrapA = document.getElementById('f9-gatea-wrap');
          const wrapB = document.getElementById('f9-gateb-wrap');
          function styleActive(elActive, elInactive){
            if (elActive){ elActive.className = 'px-4 py-2 bg-primary-blue text-white font-semibold border border-blue-600 shadow'; }
            if (elInactive){ elInactive.className = 'px-4 py-2 bg-white text-gray-700 hover:bg-gray-50 border border-gray-200'; }
          }
          function activateB(){ if (wrapB) wrapB.style.display = ''; if (wrapA) wrapA.style.display = 'none'; styleActive(tabB, tabA); }
          function activateA(){ if (wrapA) wrapA.style.display = ''; if (wrapB) wrapB.style.display = 'none'; styleActive(tabA, tabB); }
          if (tabA && !tabA._bound){ tabA.addEventListener('click', (e)=>{ e.preventDefault(); activateA(); }); tabA._bound = true; }
          if (tabB && !tabB._bound){ tabB.addEventListener('click', (e)=>{ e.preventDefault(); activateB(); }); tabB._bound = true; }
          // Default -> Gate A
          activateA();
        }catch(_){ }

        // Build 4 tests rows from row fields or defaults
        const tests = [1,2,3,4].map(i=>({
          name: row && (row[`Bài test ${i}`] || row[`Bai test ${i}`] || row[`test${i}`] || row[`t${i}_name`]) ? String(row[`Bài test ${i}`] || row[`Bai test ${i}`] || row[`test${i}`] || row[`t${i}_name`]) : '',
          standard: (row && (row[`Tiêu chuẩn ${i}`] || row[`Tieu chuan ${i}`] || row[`t${i}_standard`])) || '',
          condition: (row && (row[`Điều kiện ${i}`] || row[`Dieu kien ${i}`] || row[`t${i}_condition`])) || '',
          progress: (row && (row[`Tiến độ ${i}`] || row[`Tien do ${i}`] || row[`t${i}_progress`])) || ''
        }));
        // fallback: try generic keys if backend returns flat structure
        function val(obj, keys){ for(const k of keys){ if (obj && obj[k]!==undefined && obj[k]!==null) return String(obj[k]); } return ''; }
        if (!tests.some(t=> t.standard || t.condition || t.progress)){
          tests[0].standard = val(row,['test1_standard','standard_test1','t1_std']);
          tests[0].condition = val(row,['test1_condition','condition_test1','t1_cond']);
          tests[0].progress = val(row,['test1_progress','progress_test1','t1_prog']);
          tests[1].standard = val(row,['test2_standard','standard_test2','t2_std']);
          tests[1].condition = val(row,['test2_condition','condition_test2','t2_cond']);
          tests[1].progress = val(row,['test2_progress','progress_test2','t2_prog']);
          tests[2].standard = val(row,['test3_standard','standard_test3','t3_std']);
          tests[2].condition = val(row,['test3_condition','condition_test3','t3_cond']);
          tests[2].progress = val(row,['test3_progress','progress_test3','t3_prog']);
          tests[3].standard = val(row,['test4_standard','standard_test4','t4_std']);
          tests[3].condition = val(row,['test4_condition','condition_test4','t4_cond']);
          tests[3].progress = val(row,['test4_progress','progress_test4','t4_prog']);
        }

        body.innerHTML = '';
        tests.forEach((t, idx)=>{
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td'); nameTd.className='px-3 py-2';
          const stdTd = document.createElement('td'); stdTd.className='px-3 py-2';
          const condTd = document.createElement('td'); condTd.className='px-3 py-2';
          const progTd = document.createElement('td'); progTd.className='px-3 py-2';
          const actTd = document.createElement('td'); actTd.className='px-3 py-2 flex items-center';

          const nameInput = document.createElement('input'); nameInput.type='text'; nameInput.className='w-full border border-gray-300 rounded px-2 py-1'; nameInput.value = t.name||'';
          const stdInput = document.createElement('input'); stdInput.type='text'; stdInput.className='w-full border border-gray-300 rounded px-2 py-1'; stdInput.value = t.standard||'';
          const condInput = document.createElement('input'); condInput.type='text'; condInput.className='w-full border border-gray-300 rounded px-2 py-1'; condInput.value = t.condition||'';
          const progInput = document.createElement('input'); progInput.type='text'; progInput.className='w-full border border-gray-300 rounded px-2 py-1'; progInput.value = t.progress||'';
          // Placeholders ví dụ cho bài test 1 (tự ẩn khi nhập)
          if (idx === 0){
            if (!nameInput.value) nameInput.placeholder = 'Bài test: ví dụ Độ bền áp suất động, chu kỳ';
            if (!stdInput.value) stdInput.placeholder = 'Tiêu chuẩn: ví dụ 100000 chu kỳ';
            if (!condInput.value) condInput.placeholder = 'Điều kiện: Áp suất biến động theo dải 0-150 psi. Thời gian tăng áp suất 1-10s, Áp suất <2 psi mới tăng áp lại (Theo NSF/ANSI 42). KPH rò rỉ';
            if (!progInput.value) progInput.placeholder = 'Tiến độ: ví dụ 100 chu kỳ';
          }
          nameTd.appendChild(nameInput); stdTd.appendChild(stdInput); condTd.appendChild(condInput); progTd.appendChild(progInput);

          const sel = document.createElement('select'); sel.className='border border-gray-300 rounded px-2 py-1';
          ;['Done','Doing','Pending'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
          // Default action = Pending (trừ khi dữ liệu có trạng thái rõ ràng)
          try{
            const pickStatus = ()=>{
              const raw = (row && (row[`Trạng thái ${idx+1}`] || row[`Trang thai ${idx+1}`] || row[`status${idx+1}`] || row[`t${idx+1}_status`])) || '';
              const s = String(raw||'').toLowerCase();
              if (s.includes('done')) return 'Done';
              if (s.includes('doing')) return 'Doing';
              if (s.includes('pending') || s.includes('chờ') || s.includes('cho')) return 'Pending';
              return '';
            };
            const st = pickStatus();
            sel.value = st || 'Pending';
          }catch(_){ sel.value = 'Pending'; }
          actTd.appendChild(sel);

          tr.appendChild(nameTd); tr.appendChild(stdTd); tr.appendChild(condTd); tr.appendChild(progTd); tr.appendChild(actTd);
          body.appendChild(tr);
        });

        const btnSaveAll = document.getElementById('f9-dur-save-all');
        if (btnSaveAll){
          if (!btnSaveAll._bound){
            btnSaveAll.addEventListener('click', async (e)=>{
              e.preventDefault();
              if (btnSaveAll.disabled) return;
              // Khóa nút + spinner
              const prevHtml = btnSaveAll.innerHTML;
              btnSaveAll.disabled = true;
              btnSaveAll.innerHTML = "<span class='spinner mr-2'></span>Đang gửi...";
              try{
                try{
                  const ok = window.confirm('Bạn có chắc chắn muốn gửi dữ liệu test bền?');
                  if (!ok) { btnSaveAll.disabled = false; btnSaveAll.innerHTML = prevHtml; return; }
                }catch(_){ }
                const rows = [];
                const trList = Array.from(document.querySelectorAll('#f9-dur-body tr'));
                trList.forEach((tr, i)=>{
                  try{
                    const inputs = tr.querySelectorAll('input');
                    const sel = tr.querySelector('select');
                    const test_name = inputs[0]?.value || '';
                    const standard = inputs[1]?.value || '';
                    const condition = inputs[2]?.value || '';
                    const progress = inputs[3]?.value || '';
                    const status = sel?.value || '';
                    rows.push({ test_no: i+1, test_name, standard, condition, progress, status });
                  }catch(_){ }
                });
                // Flatten tests into individual fields for easier routing on backend
                const flat = {};
                rows.forEach((t)=>{
                  const i = t.test_no;
                  flat[`test${i}_name`] = t.test_name || '';
                  flat[`test${i}_standard`] = t.standard || '';
                  flat[`test${i}_condition`] = t.condition || '';
                  flat[`test${i}_progress`] = t.progress || '';
                  flat[`test${i}_status`] = t.status || '';
                });
                const gateAStatus = (document.getElementById('f9-gatea-status')?.value||'')
                const gateANote = (document.getElementById('f9-gatea-note')?.value||'')
                const gateAFileEl = document.getElementById('f9-gatea-file');
                const gateAHasFile = !!(gateAFileEl && gateAFileEl.files && gateAFileEl.files.length);

                // Ràng buộc: Nếu Gate A trạng thái Done => bắt buộc có Bằng chứng
                if ((gateAStatus||'').toLowerCase().includes('hoàn') || (gateAStatus||'').toLowerCase()==='done'){
                  if (!gateAHasFile){ try{ showToast('Gate A: Trạng thái Hoàn thành/Done cần đính kèm Bằng chứng.','error'); }catch(_){ } return; }
                }
                // Nếu có file bằng chứng Gate A: gửi FormData; nếu không, gửi JSON thường
                // Helper: fetch với timeout + fallback no-cors
                async function fetchWithTimeout(url, opts, timeoutMs){
                  const controller = (typeof AbortController!=='undefined') ? new AbortController() : null;
                  if (controller) opts = { ...(opts||{}), signal: controller.signal };
                  let tmo = null;
                  try{
                    const p = fetch(url, opts);
                    if (Number.isFinite(timeoutMs) && timeoutMs>0){
                      if (controller){
                        tmo = setTimeout(()=>{ try{ controller.abort(); }catch(_){} }, timeoutMs);
                      } else {
                        return await Promise.race([
                          p,
                          new Promise((_,rej)=> setTimeout(()=> rej(new Error('Timeout')), timeoutMs))
                        ]);
                      }
                    }
                    const r = await p;
                    return r;
                  } finally {
                    if (tmo) try{ clearTimeout(tmo); }catch(_){ }
                  }
                }

                const TIMEOUT_MS = 30000;

                if (gateAHasFile){
                  const fd = new FormData();
                  fd.append('action','form9_update_tests_bulk');
                  fd.append('taskId', row.taskId||'');
                  fd.append('code', row.code||'');
                  fd.append('assignee', row.assignee||'');
                  fd.append('taskName', row.taskName||'');
                  fd.append('tests', JSON.stringify(rows));
                  try{ fd.append('gate', (document.getElementById('f9-gatea-wrap')?.style.display !== 'none') ? 'Gate A' : 'Gate B'); }catch(_){ }
                  fd.append('gateAStatus', gateAStatus);
                  fd.append('noteGateA', gateANote);
                  fd.append('timestamp', new Date().toISOString());
                  try{ fd.append('gateAEvidence', gateAFileEl.files[0]); }catch(_){ }
                  // Append flattened test fields
                  Object.keys(flat).forEach(k=>{ try{ fd.append(k, flat[k]); }catch(_){ } });
                  try{
                    await fetchWithTimeout(FORM9_POST_URL, { method:'POST', body: fd, mode:'cors' }, TIMEOUT_MS);
                  }catch(_){
                    // Fallback: no-cors (không đọc được phản hồi nhưng vẫn kích hoạt server)
                    await fetchWithTimeout(FORM9_POST_URL, { method:'POST', body: fd, mode:'no-cors' }, 8000);
                  }
                } else {
                  // active gate info for backend
                  const activeGate = (document.getElementById('f9-gatea-wrap')?.style.display !== 'none') ? 'Gate A' : 'Gate B';
                  const payload = {
                    action: 'form9_update_tests_bulk',
                    taskId: row.taskId||'',
                    code: row.code||'',
                    assignee: row.assignee||'',
                    taskName: row.taskName||'',
                    tests: rows,
                    gate: activeGate,
                    gateAStatus,
                    noteGateA: gateANote,
                    timestamp: new Date().toISOString()
                  };
                  // Merge flattened fields into payload
                  Object.assign(payload, flat);
                  try{
                    await fetchWithTimeout(FORM9_POST_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload), mode:'cors' }, TIMEOUT_MS);
                  }catch(_){
                    // Fallback: no-cors (loại bỏ header để tránh bị chặn)
                    await fetchWithTimeout(FORM9_POST_URL, { method:'POST', body: JSON.stringify(payload), mode:'no-cors' }, 8000);
                  }
                }
                try{ showToast('Đã gửi dữ liệu.','success'); }catch(_){ }
                // Tự động tra cứu lại để làm mới dữ liệu Form 9
                try{ if (typeof renderForm9 === 'function') { await renderForm9(); } }catch(_){ }
                // Làm mới nội dung modal hiện tại (không đóng modal)
                try{
                  let updated = row;
                  try{
                    const cached = (typeof LS!=='undefined' && LS.getJSON) ? LS.getJSON('f9.cache') : null;
                    let rows = (cached && Array.isArray(cached.rows)) ? cached.rows : (Array.isArray(window.F9_LAST_ROWS) ? window.F9_LAST_ROWS : []);
                    const tid = String(row.taskId||'').trim();
                    const codeKey = String(row.code||'').trim();
                    const assigneeKey = String(row.assignee||'').trim();
                    const found = rows.find(x => String(x.taskId||'').trim()===tid || (String(x.code||'').trim()===codeKey && String(x.assignee||'').trim()===assigneeKey));
                    if (found) updated = found;
                  }catch(_){ }
                  // Cập nhật lại nội dung modal với dữ liệu mới nhất
                  try{ openF9DurabilityModal(updated); }catch(_){ }
                }catch(_){ }
                // Đổi trạng thái nút thành 'Đã gửi' và giữ khoá cho đến khi đóng modal
                try{ btnSaveAll.innerHTML = 'Đã gửi'; btnSaveAll.disabled = true; }catch(_){ }
              }catch(err){
                try{ showToast('Lưu thất bại.','error'); }catch(_){ }
                // Mở khóa nút nếu lỗi
                btnSaveAll.disabled = false;
                btnSaveAll.innerHTML = prevHtml;
                return;
              }
              // Giữ trạng thái khóa cho đến khi modal đóng
            });
            btnSaveAll._bound = true;
          }
        }

        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
        if (closeBtn && !closeBtn._bound){ closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }); closeBtn._bound = true; }
        if (cancelBtn && !cancelBtn._bound){ cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }); cancelBtn._bound = true; }
        if (!modal._bound){ modal.addEventListener('click', (e)=>{ if (e.target===modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } }); modal._bound = true; }
      }catch(_){ }
    }

    function restoreForm9FromCache(){
      try{
        const cached = LS.getJSON('f9.cache');
        const name = LS.get('f9.selectedName')||'';
        if (!cached || !Array.isArray(cached.rows) || !name) return false;
        const body = document.getElementById('f9-body');
        if (!body) return false;
        renderForm9FromRows(cached.rows);
        updateLastUpdatedNote('f9-search','f9.lastUpdated');
        return true;
      }catch(_){ return false; }
    }

    function renderForm9FromRows(rows){
      const body = document.getElementById('f9-body');
      if (!body) return;
      if (!Array.isArray(rows) || !rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="12">Không có dữ liệu</td></tr>'; return; }
      body.innerHTML = '';
      const name = (document.getElementById('f9-name')?.value || '').trim();
      const monthFilter = (document.getElementById('f9-month')?.value || '').trim();
      // Page size fixed default (no external selector)
      const pageSize = 50;
      let filtered = Array.isArray(rows) ? rows.slice() : [];
      if (monthFilter){
        filtered = filtered.filter(r => {
          const s = String(r.actualCompletionDate || '').trim();
          if (!s) return false;
          const d = (typeof toDateSafe==='function') ? toDateSafe(s) : new Date(s);
          if (!d || isNaN(d)) return false;
          const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          return ym === monthFilter;
        });
      }
      if (!filtered.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="12">Không có dữ liệu</td></tr>'; return; }
      const limited = filtered.slice(0, Math.max(1, pageSize));
      limited.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        try{
          const dueStr = r.durabilityDue || '';
          const d = (typeof toDateSafe==='function') ? toDateSafe(dueStr) : new Date(dueStr);
          if (d && !isNaN(d)){
            const today = new Date();
            const dStart = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const tStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            if (dStart.getTime() === tStart.getTime()){
              tr.classList.add('bg-yellow-100');
            } else if (dStart.getTime() < tStart.getTime()){
              tr.classList.add('bg-red-100');
            }
          }
        }catch(_){ }
        // STT
        const sttDisp = (r.rowNumber || r.STT || r.row_number || (idx+1));
        addTdF9(tr, String(sttDisp));
        // Khai báo test bền (button)
        const tdAction = document.createElement('td');
        tdAction.className = 'px-3 py-3 align-top text-gray-800 border border-gray-500';
        const btn = document.createElement('button');
        btn.className = 'px-3 py-1 rounded text-white bg-primary-blue hover:brightness-105 text-sm font-medium';
        btn.textContent = 'Sửa/khai báo';
        (function(rowSnapshot){
          // Ghim bản sao dữ liệu hàng để tránh bị thay đổi do render lại hoặc thay đổi mảng nguồn
          btn.onclick = (e)=>{
            e.preventDefault();
            e.stopPropagation();
            try{ openF9DurabilityModal(rowSnapshot); }catch(_){ try{ showToast('Chức năng đang cập nhật.','info'); }catch(__){} }
          };
        })({ ...r });
        tdAction.appendChild(btn);
        tr.appendChild(tdAction);
        // Ngày trả BC tức thời (đưa ngay sau cột Khai báo)
        addTdF9(tr, (typeof formatDdMmYyyy==='function') ? formatDdMmYyyy(r.actualCompletionDate||'') : (r.actualCompletionDate||''));
        // Tình trạng test bền (màu theo trạng thái)
        (function(){
          const td=document.createElement('td');
          td.className='px-3 py-3 align-top text-gray-800 border border-gray-500';
          const val = String(r.durability||'').trim();
          td.textContent = val;
          const v = val.toLowerCase();
          if (v.includes('hoàn thành')){ td.classList.add('bg-green-50','text-green-800'); }
          else if (v.includes('đang triển khai') || v.includes('dang trien khai')){ td.classList.add('bg-yellow-50','text-yellow-800'); }
          tr.appendChild(td);
        })();
        // Link bằng chứng (giữa Trạng thái và Dự kiến hoàn thành)
        (function(){
          const td=document.createElement('td');
          td.className='px-3 py-3 align-top text-gray-800 border border-gray-500';
          const url = String(r.gateAEvidence||'').trim();
          if (url){
            const a = document.createElement('a');
            a.href = url;
            a.target = '_blank';
            a.rel = 'noopener';
            a.className = 'text-primary-blue underline';
            a.textContent = 'Mở';
            td.appendChild(a);
          }
          tr.appendChild(td);
        })();
        // Dự kiến hoàn thành test bền
        addTdF9(tr, (typeof formatDdMmYyyy==='function') ? formatDdMmYyyy(r.durabilityDue||'') : (r.durabilityDue||''));
        // Mã
        addTdF9(tr, r.code||'');
        // Task Name
        addTdF9(tr, r.taskName||'');
        // Assignee
        addTdF9(tr, r.assignee||'');
        // Mã Báo cáo
        addTdF9(tr, r.reportCode||'');
        // Mã tác vụ
        addTdF9(tr, r.taskId||'');
        // Ghi chú (Gate A)
        addTdF9(tr, r.noteGateA || r.note || '');
        body.appendChild(tr);
      });
    }

    async function renderForm9(){
      const rawName = (document.getElementById('f9-name')?.value || '').trim();
      const norm = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
      const n = norm(rawName);
      const isAll = (!rawName) ? false : (n === '__all__' || n === 'all' || n === 'tat ca' || n === 'tatca' || n === 'tất cả');
      const name = isAll ? '__ALL__' : rawName;
      const body = document.getElementById('f9-body');
      if (!body) return;
      if (!name){ body.innerHTML = '<tr><td class="px-3 py-4 text-center text-gray-500" colspan="12">Vui lòng chọn tên</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='12' class='px-3 py-4 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      try{
        const headerMapF9 = {
          // Bảng chính
          header_rowNumber: 'STT',
          header_assignee: 'Assignee',
          header_code: 'Mã',
          header_taskName: 'Task Name',
          header_reportCode: 'Mã Báo cáo',
          header_taskId: 'Mã tác vụ',
          header_result: 'Kết quả',
          header_actualCompletionDate: 'Ngày hoàn thành thực tế',
          header_durability: 'Tình trạng Test bền',
          header_durabilityDue: 'Dự kiến hoàn thành test bền',
          header_durabilityActual: 'Ngày hoàn thành test bền thực tế',
          header_noteGateA: 'Ghi chú',
          header_gateAStatus: 'Trạng thái Gate A',
          header_gateAEvidence: 'Bằng chứng Gate A',
          // Các trường test 1..4
          header_test1: 'Bài test 1',
          header_standard1: 'Tiêu chuẩn 1',
          header_condition1: 'Điều kiện 1',
          header_progress1: 'Tiến độ 1',
          header_test2: 'Bài test 2',
          header_standard2: 'Tiêu chuẩn 2',
          header_condition2: 'Điều kiện 2',
          header_progress2: 'Tiến độ 2',
          header_test3: 'Bài test 3',
          header_standard3: 'Tiêu chuẩn 3',
          header_condition3: 'Điều kiện 3',
          header_progress3: 'Tiến độ 3',
          header_test4: 'Bài test 4',
          header_standard4: 'Tiêu chuẩn 4',
          header_condition4: 'Điều kiện 4',
          header_progress4: 'Tiến độ 4',
          // Field mapping phía client
          field_rowNumber: 'rowNumber',
          field_assignee: 'assignee',
          field_code: 'code',
          field_taskName: 'taskName',
          field_reportCode: 'reportCode',
          field_taskId: 'taskId',
          field_result: 'result',
          field_actualCompletionDate: 'actualCompletionDate',
          field_durability: 'durability',
          field_durabilityDue: 'durabilityDue',
          field_durabilityActual: 'durabilityActual',
          field_noteGateA: 'noteGateA',
          field_gateAStatus: 'gateAStatus',
          field_gateAEvidence: 'gateAEvidence',
          field_test1: 'test1',
          field_standard1: 'standard1',
          field_condition1: 'condition1',
          field_progress1: 'progress1',
          field_test2: 'test2',
          field_standard2: 'standard2',
          field_condition2: 'condition2',
          field_progress2: 'progress2',
          field_test3: 'test3',
          field_standard3: 'standard3',
          field_condition3: 'condition3',
          field_progress3: 'progress3',
          field_test4: 'test4',
          field_standard4: 'standard4',
          field_condition4: 'condition4',
          field_progress4: 'progress4'
        };
        const params = new URLSearchParams({
          ...headerMapF9,
          action: 'form9_lookup',
          timestamp: new Date().toISOString()
        });
        if (name && name !== '__ALL__') params.append('person_name', name);
        const url = `${FORM9_LOOKUP_URL}?${params.toString()}`;
        const resp = await fetch(url, { method: 'GET' });
        const text = await resp.text();
        if (!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
        let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){ const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') queue.push(v);} }
          }catch(_){ }
          return [];
        }
        let rowsRaw = pickRows(data);
        // Unwrap n8n format [{ json: {...} }]
        if (Array.isArray(rowsRaw) && rowsRaw.length && rowsRaw.every(x=> x && typeof x==='object' && ('json' in x))){
          rowsRaw = rowsRaw.map(x=> x.json);
        }
        // Convert table [[headers...], [...]] -> objects
        if (Array.isArray(rowsRaw) && rowsRaw.length && Array.isArray(rowsRaw[0])){
          try{
            const header = rowsRaw[0].map(h=> String(h||'').trim());
            rowsRaw = rowsRaw.slice(1).map(r=>{
              const o={}; header.forEach((k,i)=>{ o[k]= Array.isArray(r)? r[i]: undefined; }); return o;
            });
          }catch(_){ }
        }
        // Helper: get value by flexible keys (diacritics/spacing insensitive)
        const getV = (obj, keys)=>{
          const sanitize = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); } };
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=sanitize(k); lower[k1]=v; });
          for (const k of keys){ const c=sanitize(k); if (c in lower) return lower[c]; }
          // includes fallback
          for (const k of keys){ const c=sanitize(k); const m = Object.keys(lower).find(kk=> kk.includes(c)); if (m) return lower[m]; }
          return '';
        };
        let normRows = rowsRaw.map(item=>{
          const code = getV(item,['code','mã','ma','taskcode','componentcode']);
          const taskIdRaw = getV(item,['taskid','task_id','mã tác vụ','ma_tac_vu','requestid','id']);
          const taskId = (typeof pickTaskIdPreferQA==='function') ? pickTaskIdPreferQA(taskIdRaw, code) : (taskIdRaw || code);
          return {
            rowNumber: getV(item,['row_number','stt','STT']),
            assignee: getV(item,['Assignee','assignee','employee','người phụ trách','nguoi_phu_trach','nhanvien','nhân viên']),
            code: code || getV(item,['Mã']),
            taskName: getV(item,['Task Name','taskname','task name','tên tác vụ','ten_tac_vu','name','title']),
            reportCode: getV(item,['Mã Báo cáo','reportcode','ma_bao_cao','report_id','reportid']),
            taskId,
            result: getV(item,['Kết quả','result','ket_qua']),
            actualCompletionDate: getV(item,['Ngày hoàn thành thực tế','actualcompletiondate','ngay hoan thanh thuc te','ngày hoàn thành','ngay hoan thanh']),
            durability: getV(item,['Tình trạng Test bền','test_ben','durability','has_durability','testben']),
            durabilityDue: getV(item,['Dự kiến hoàn thành test bền','ngay_du_kien_tra_test_ben','du_kien_hoan_thanh_test_ben','testbenduedate']),
            durabilityActual: getV(item,['Ngày hoàn thành test bền thực tế','ngay_hoan_thanh_test_ben_thuc_te','durability_actual']),
            noteGateA: getV(item,['Ghi chú','ghi chú','note','ghi_chu','noteGateA','note_gate_a','ghi chú gate a','gate a note']),
            gateAStatus: getV(item,['Trạng thái Gate A','gate a status','gatea status','gatea_status','status gate a']),
            gateAEvidence: getV(item,['Bằng chứng Gate A','bang chung gate a','gate a evidence','gatea evidence','gatea_file','gateAEvidence'])
          };
        });
        // Locally filter by assignee when not All
        if (name && name !== '__ALL__'){
          const key = (typeof vnLower==='function') ? vnLower(name) : name.toLowerCase();
          normRows = normRows.filter(r => {
            const a = String(r.assignee||'');
            const ak = (typeof vnLower==='function') ? vnLower(a) : a.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
            return ak === key;
          });
        }
        renderForm9FromRows(normRows);
        try{ window.F9_LAST_ROWS = normRows; }catch(_){ }
        try{ LS.setJSON('f9.cache', { name, rows: normRows, ts: Date.now() }); LS.set('f9.lastUpdated', String(Date.now())); updateLastUpdatedNote('f9-search','f9.lastUpdated'); }catch(_){ }
      }catch(err){
        body.innerHTML = `<tr><td colspan='12' class='px-3 py-4 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }

    const f9SearchBtn = document.getElementById('f9-search');
    if (f9SearchBtn){
      let f9Busy = false;
      f9SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f9Busy) return;
        f9Busy = true;
        f9SearchBtn.disabled = true;
        const prev = f9SearchBtn.textContent;
        f9SearchBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try{ await renderForm9(); }
        finally{
          f9Busy = false;
          f9SearchBtn.disabled = false;
          f9SearchBtn.textContent = prev || 'Tra cứu';
        }
      };
    }
    // Form 9: Stats modal
    (function initF9Stats(){
      const btn = document.getElementById('f9-open-stats');
      if (!btn || btn._bound) return;
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        try{
          const cached = LS.getJSON('f9.cache');
          let rows = (cached && Array.isArray(cached.rows)) ? cached.rows : [];
          if (!rows.length && Array.isArray(window.F9_LAST_ROWS)) rows = window.F9_LAST_ROWS;
          openF9StatsModal(rows);
        }catch(_){ openF9StatsModal([]); }
      });
      btn._bound = true;
    })();

    // Form 9: Export XLSX
    (function initF9Export(){
      const btn = document.getElementById('f9-export-xlsx');
      if (!btn || btn._bound) return;
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        try{
          const cached = LS.getJSON('f9.cache');
          let rows = (cached && Array.isArray(cached.rows)) ? cached.rows : (Array.isArray(window.F9_LAST_ROWS) ? window.F9_LAST_ROWS : []);
          if (!rows.length){ try{ showToast('Form 9: Không có dữ liệu để xuất.','error'); }catch(_){ } return; }
          const aoa = f9RowsToAOA(rows);
          const ws = XLSX.utils.aoa_to_sheet(aoa);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Form9');
          const name = (document.getElementById('f9-name')?.value||'').trim().replace(/\s+/g,'_');
          XLSX.writeFile(wb, `Form9_${name||'export'}.xlsx`);
        }catch(_){ try{ showToast('Form 9: Xuất XLSX thất bại.','error'); }catch(__){} }
      });
      btn._bound = true;
    })();


    function f9RowsToAOA(items){
      const head = ['STT','Khai báo test bền','Ngày trả BC tức thời','Tình trạng test bền','Link bằng chứng','Dự kiến hoàn thành test bền','Mã','Task Name','Assignee','Mã Báo cáo','Mã tác vụ','Ghi chú'];
      const aoa = [head];
      (Array.isArray(items)? items:[]).forEach((r, i)=>{
        const row = [
          r.rowNumber || i+1,
          'Sửa/khai báo',
          r.actualCompletionDate || '',
          r.durability || '',
          r.gateAEvidence || '',
          r.durabilityDue || '',
          r.code || '',
          r.taskName || '',
          r.assignee || '',
          r.reportCode || '',
          r.taskId || '',
          r.noteGateA || r.note || ''
        ];
        aoa.push(row);
      });
      return aoa;
    }

    function openF9StatsModal(rows){
      try{
        const modal = document.getElementById('f9-stats-modal');
        const body = document.getElementById('f9-stats-body');
        if (!modal || !body) return;
        const name = (document.getElementById('f9-name')?.value || '').trim();
        const monthFilter = (document.getElementById('f9-month')?.value || '').trim();
        // Filter by person and month like table
        let list = Array.isArray(rows) ? rows.slice() : [];
        if (name && name !== '__ALL__'){
          const key = (typeof vnLower==='function') ? vnLower(name) : name.toLowerCase();
          list = list.filter(r=>{
            const a = String(r.assignee||'');
            const ak = (typeof vnLower==='function') ? vnLower(a) : a.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
            return ak === key;
          });
        }
        if (monthFilter){
          list = list.filter(r=>{
            const s = String(r.actualCompletionDate||'').trim();
            if(!s) return false;
            const d = (typeof toDateSafe==='function') ? toDateSafe(s) : new Date(s);
            if (!d || isNaN(d)) return false;
            const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            return ym === monthFilter;
          });
        }
        // Build stats
        const today = new Date();
        const tStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        let total = 0, dueToday = 0, overdue = 0;
        const byStatus = new Map();
        list.forEach(r=>{
          total++;
          const k = String(r.durability||'').trim() || '(Trống)';
          byStatus.set(k, (byStatus.get(k)||0)+1);
          const ds = r.durabilityDue || '';
          const d = (typeof toDateSafe==='function') ? toDateSafe(ds) : new Date(ds);
          if (d && !isNaN(d)){
            const dStart = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            if (dStart.getTime() === tStart.getTime()) dueToday++;
            else if (dStart.getTime() < tStart.getTime()) overdue++;
          }
        });
        // Render table
        const rowsHtml = Array.from(byStatus.entries()).map(([st, cnt])=>`<tr><td class="px-3 py-2">${st}</td><td class="px-3 py-2 text-right">${cnt}</td></tr>`).join('');
        body.innerHTML = `
          <div class="mb-3 text-sm text-gray-700">Tổng tác vụ: <b>${total}</b> · Đến hạn hôm nay: <b class="text-amber-700">${dueToday}</b> · Quá hạn: <b class="text-red-700">${overdue}</b></div>
          <div class="overflow-auto border border-gray-200 rounded-lg">
            <table class="min-w-[420px] w-full text-sm">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0"><tr class="text-left text-gray-700"><th class="px-3 py-2">Tình trạng test bền</th><th class="px-3 py-2 text-right">Số lượng</th></tr></thead>
              <tbody class="divide-y divide-gray-100">${rowsHtml || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="2">Không có dữ liệu</td></tr>'}</tbody>
            </table>
          </div>`;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
      }catch(_){ }
    }
    // Bind close for stats modal
    (function bindF9StatsClose(){
      try{
        const modal = document.getElementById('f9-stats-modal');
        const closeBtn = document.getElementById('f9-stats-close');
        const cancelBtn = document.getElementById('f9-stats-cancel');
        if (closeBtn && !closeBtn._bound){ closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }); closeBtn._bound = true; }
        if (cancelBtn && !cancelBtn._bound){ cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }); cancelBtn._bound = true; }
        if (modal && !modal._bound){ modal.addEventListener('click', (e)=>{ if (e.target===modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } }); modal._bound = true; }
      }catch(_){ }
    })();
    // Form 9: Month filter events
    const f9MonthInput = document.getElementById('f9-month');
    const f9ClearMonthBtn = document.getElementById('f9-clear-month');
    const f9SizeSel = document.getElementById('f9-size');
    if (f9MonthInput){
      f9MonthInput.addEventListener('change', ()=>{
        try{
          const cached = LS.getJSON('f9.cache');
          if (cached && Array.isArray(cached.rows)) renderForm9FromRows(cached.rows);
          else if (Array.isArray(window.F9_LAST_ROWS)) renderForm9FromRows(window.F9_LAST_ROWS);
        }catch(_){ }
      });
    }
    if (f9ClearMonthBtn){
      f9ClearMonthBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        const el = document.getElementById('f9-month');
        if (el){ el.value=''; }
        try{
          const cached = LS.getJSON('f9.cache');
          if (cached && Array.isArray(cached.rows)) renderForm9FromRows(cached.rows);
          else if (Array.isArray(window.F9_LAST_ROWS)) renderForm9FromRows(window.F9_LAST_ROWS);
        }catch(_){ }
      });
    }
    if (f9SizeSel){
      const onSizeChange = ()=>{
        try{
          const val = f9SizeSel.value || '10';
          try{ if (typeof LS!=='undefined' && LS.set) LS.set('f9.pageSize', val); else localStorage.setItem('f9.pageSize', val); }catch(_){ }
          const cached = LS.getJSON('f9.cache');
          if (cached && Array.isArray(cached.rows)) renderForm9FromRows(cached.rows);
          else if (Array.isArray(window.F9_LAST_ROWS)) renderForm9FromRows(window.F9_LAST_ROWS);
        }catch(_){ }
      };
      f9SizeSel.addEventListener('change', onSizeChange);
      f9SizeSel.addEventListener('input', onSizeChange);
      // Apply saved value if present
      try{
        const saved = (typeof LS!=='undefined' && LS.get) ? LS.get('f9.pageSize') : localStorage.getItem('f9.pageSize');
        if (saved && f9SizeSel.value !== saved){ f9SizeSel.value = saved; }
      }catch(_){ }
    }

    // Delegated listeners to be extra robust
    // Remove delegated size handler since size selector removed
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if (t && t.id === 'f9-open-stats'){
        e.preventDefault();
        try{
          const cached = LS.getJSON('f9.cache');
          let rows = (cached && Array.isArray(cached.rows)) ? cached.rows : [];
          if (!rows.length && Array.isArray(window.F9_LAST_ROWS)) rows = window.F9_LAST_ROWS;
          openF9StatsModal(rows);
        }catch(_){ openF9StatsModal([]); }
      }
    });

    // Ensure Form 9 controls exist even if HTML cache is stale
    (function ensureF9Controls(){
      try{
        const form = document.getElementById('form9');
        if (!form) return;
        let controls = document.getElementById('f9-controls');
        if (!controls){
          // Insert before the table container
          const tableWrap = Array.from(form.children).find(el=> el && el.className && el.className.includes('overflow-x-auto'));
          controls = document.createElement('div');
          controls.id = 'f9-controls';
          controls.className = 'mt-2 flex items-center gap-2';
          controls.innerHTML = '<label class="text-sm text-gray-700">Hiển thị</label>'+
            '<select id="f9-size" class="border border-blue-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">'+
            '<option value="10" selected>10</option><option value="20">20</option><option value="50">50</option></select>'+
            '<button id="f9-open-stats" class="ml-2 px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-700">Thống kê</button>';
          if (tableWrap && tableWrap.parentNode){ tableWrap.parentNode.insertBefore(controls, tableWrap); }
          // Rebind events
          const sizeEl = document.getElementById('f9-size');
          if (sizeEl && !sizeEl._bound){ sizeEl.addEventListener('change', ()=>{ try{ const c=LS.getJSON('f9.cache'); if (c && Array.isArray(c.rows)) renderForm9FromRows(c.rows); }catch(_){ } }); sizeEl._bound=true; }
          const statsBtn = document.getElementById('f9-open-stats');
          if (statsBtn && !statsBtn._bound){ statsBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ const cached=LS.getJSON('f9.cache'); const rows=(cached&&Array.isArray(cached.rows))?cached.rows:[]; openF9StatsModal(rows);}catch(_){ openF9StatsModal([]);} }); statsBtn._bound=true; }
        }
      }catch(_){ }
    })();

    // Toast
    const toastEl = document.getElementById('toast');
    function showToast(msg,type='info'){
      toastEl.textContent = msg;
      toastEl.style.background = type==='success' ? '#137a39' : (type==='error' ? '#b42318' : '#0b1324');
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2600);
    }

    // ==== Sidebar: Nhóm/Accordion + Điều hướng Form ====
    (function initSidebarGroups(){
      try{
        const sections = Array.from(document.querySelectorAll('main section[id^="form"]'));
        function showSection(id){
          sections.forEach(sec=>{ if (!sec || !sec.id) return; sec.classList.toggle('hidden', sec.id !== id); });
          try{ localStorage.setItem('app.lastForm', id); }catch(_){ }
          // Mở nhóm chứa nút đang chọn
          try{
            const btn = document.querySelector(`.nav-btn[data-target="${id}"]`);
            if (btn){
              const group = btn.closest('.rounded-md');
              const items = group && group.querySelector('.group-items');
              if (items){ items.classList.remove('hidden'); }
            }
          }catch(_){ }
        }
        // Click item -> chuyển form
        document.querySelectorAll('.nav-btn[data-target]').forEach(btn=>{
          if (btn._boundNav) return; btn._boundNav = true;
          btn.addEventListener('click', (e)=>{
            e.preventDefault(); const id = btn.getAttribute('data-target'); if (!id) return; showSection(id);
          });
        });
        // Toggle nhóm
        document.querySelectorAll('.group-btn').forEach(h=>{
          if (h._boundGrp) return; h._boundGrp = true;
          h.addEventListener('click', (e)=>{
            e.preventDefault(); const wrap = h.parentElement; if (!wrap) return; const items = wrap.querySelector('.group-items'); if (!items) return; const nowHidden = items.classList.toggle('hidden'); if (nowHidden){ h.classList.remove('active'); } else { h.classList.add('active'); }
          });
        });
        // Khởi tạo: khôi phục form gần nhất hoặc mặc định form1
        let last = '';
        try{ last = localStorage.getItem('app.lastForm') || ''; }catch(_){ last=''; }
        const defaultId = last || 'form1';
        if (!document.getElementById(defaultId)){
          // fallback nếu không tồn tại (ví dụ form1 đã ẩn/đổi id)
          const any = sections.find(s=> s && s.id);
          if (any) showSection(any.id);
        } else {
          showSection(defaultId);
        }
        // Đánh dấu active cho nhóm chứa form đang mở
        try{
          const activeBtn = document.querySelector(`.nav-btn[data-target="${defaultId}"]`);
          if (activeBtn){ const wrap = activeBtn.closest('.rounded-md'); const head = wrap && wrap.querySelector('.group-btn'); const items = wrap && wrap.querySelector('.group-items'); if (items){ items.classList.remove('hidden'); } if (head){ head.classList.add('active'); } }
        }catch(_){ }
      }catch(_){ }
    })();

    // Upload modal
    // ===== Form 1: Export helpers =====
    function f1BuildExportPayload(){
      try{
        const name = (document.getElementById('f1-name')?.value||'').trim();
        // Ưu tiên lấy từ cache raw nếu có
        let rows = [];
        try{
          const raw = LS.getJSON('f1.raw');
          if (raw && Array.isArray(raw.rows)) rows = raw.rows;
        }catch(_){ }
        if (!rows.length && Array.isArray(window.F1_LAST_RAW)) rows = window.F1_LAST_RAW;
        const data = rows.map(item=>({ ...item }));
        return { action:'form1_export', name, items: data, ts: new Date().toISOString() };
      }catch(_){ return { action:'form1_export', name:'', items:[], ts:new Date().toISOString() }; }
    }
    async function f1TryPostJson(url, data, noCors){
      try{
        const r = await fetch(url, { method:'POST', mode:noCors?'no-cors':'cors', headers:{ 'Content-Type':'application/json', 'Accept':'application/json, text/plain, */*' }, body: JSON.stringify(data) });
        const ok = noCors ? true : r.ok; let raw=''; try{ raw = await r.text(); }catch(_){ raw=''; }
        return { ok, raw };
      }catch(err){ return { ok:false, raw:String(err||'') }; }
    }
    async function f1ExportToServer(){
      const payload = f1BuildExportPayload();
      if (!Array.isArray(payload.items) || !payload.items.length){ showToast('Form 1: Không có dữ liệu để xuất.','error'); return; }
      const base = WEBHOOK_URL;
      const test = base.replace('/webhook/', '/webhook-test/');
      const q = new URLSearchParams({ action:'form1_export', _ts: Date.now().toString() }).toString();
      for (const u of [ `${test}?${q}`, `${base}?${q}` ]){
        let r = await f1TryPostJson(u, payload, true);
        if (r.ok) return true;
        r = await f1TryPostJson(u, payload, false);
        if (r.ok) return true;
      }
      return false;
    }
    function f1RowsToAOA(items){
      const head = ['Trạng thái','Mã tác vụ','Mã','Tên tác vụ','Tgian nộp form','Ngày cần trả BC','Người yêu cầu','Người nhận mẫu','Công chuẩn','Ngày yêu cầu','Hạn mong muốn','Hạn đáp ứng','Mục đích đánh giá','Note','Yêu cầu test đặc biệt','Form báo cáo','Tên file','Link'];
      const aoa = [head];
      const getV = (obj, keys)=>{ const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{}); for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; } return ''; };
      (Array.isArray(items)? items:[]).forEach(it=>{
        const code = getV(it,['code','ma','taskcode','mã']);
        const tname = getV(it,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']);
        const statusText = getV(it,['status','trangthai','trang_thai','trạng thái']);
        const submitTimeRaw = getV(it,['submittime','submit_time','submitTime','tgian nop form','thoi_gian_nop_form','thời gian nộp form']);
        const reportDue = getV(it,['reportduedate','report_due_date','reportDueDate','ngay can tra bc','ngay_can_tra_bc','ngày cần trả bc']);
        const requester = getV(it,['requester','nguoiyeucau','nguoi_yeu_cau','assigner','người yêu cầu']);
        const receiver = getV(it,['receiver','receivername','nguoinhanmau','nguoi_nhan_mau','người nhận mẫu','recipient','assignee','người nhận']);
        const man = getV(it,[ 'manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','công chuẩn' ]);
        const requestDate = getV(it,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']);
        const wishDue = getV(it,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
        const actualDue = getV(it,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
        const purpose = getV(it,['purpose','mucdich','muc_dich','mục đích đánh giá','muc dich danh gia','mucdichdanhgia']);
        const note = getV(it,['note','ghi_chu','ghichu']);
        const special = getV(it,['specialtest','yeucau_test_dac_biet','yeu_cau_test_dac_biet']);
        const reportForm = getV(it,['reportform','form_bao_cao','form_bao_cao_danh_gia']);
        const fileName = getV(it,[ 'attachmentfilename','file_name','filename','tenfile','ten_file','tên file','tên file đính kèm','attachment','file' ]);
        const url = getV(it,[ 'attachmenturl','attachment_url','fileurl','file_url','downloadurl','download_url','link','url' ]);
        const taskId = getV(it,['taskid','task_id','ma_tac_vu','mã tác vụ','taskcode2','requestid','id']);
        aoa.push([statusText,taskId,code,tname,submitTimeRaw,reportDue,requester,receiver,man,requestDate,wishDue,actualDue,purpose,note,special,reportForm,fileName,url]);
      });
      return aoa;
    }
    function f1DownloadXLSX(){
      try{
        let items = [];
        try{ const raw = LS.getJSON('f1.raw'); if (raw && Array.isArray(raw.rows)) items = raw.rows; }catch(_){ }
        if (!items.length && Array.isArray(window.F1_LAST_RAW)) items = window.F1_LAST_RAW;
        if (!items.length){ showToast('Form 1: Không có dữ liệu để xuất.','error'); return; }
        const aoa = f1RowsToAOA(items);
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Form1');
        const name = (document.getElementById('f1-name')?.value||'').trim().replace(/\s+/g,'_');
        XLSX.writeFile(wb, `Form1_${name||'export'}.xlsx`);
      }catch(_){ showToast('Form 1: Xuất XLSX thất bại.','error'); }
    }
    (function initF1Exports(){
      const btnServer = document.getElementById('f1-export');
      const btnXlsx = document.getElementById('f1-export-xlsx');
      if (btnServer) btnServer.addEventListener('click', async (e)=>{ e.preventDefault(); btnServer.disabled=true; const prev=btnServer.textContent; btnServer.innerHTML = "<span class='spinner mr-2'></span>Đang xuất..."; try{ const ok = await f1ExportToServer(); if(ok) showToast('Form 1: Đã xuất dữ liệu lên server.','success'); else showToast('Form 1: Xuất thất bại.','error'); } finally { btnServer.disabled=false; btnServer.textContent=prev||'Xuất server'; } });
      if (btnXlsx) btnXlsx.addEventListener('click', (e)=>{ e.preventDefault(); f1DownloadXLSX(); });
    })();
    const modal = document.getElementById('upload-modal');
    const fileInput = document.getElementById('upload-file');
    const uploaderName = document.getElementById('uploader-name');
    const uploaderCode = document.getElementById('uploader-code');
    const uploaderTask = document.getElementById('uploader-task');
    let uploadContext = null;
    let isModalSubmitting = false;
    let lastOpenTrigger = null;
    function openUploadModal(ctx){
      uploadContext = ctx || {};
      uploaderName.textContent = ctx?.name || '';
      uploaderCode.textContent = ctx?.code || '';
      uploaderTask.textContent = ctx?.taskName || '';
      // Hide Người nộp pill for Form 2 per request
      try {
        const namePill = uploaderName && uploaderName.parentElement && uploaderName.parentElement.parentElement ? uploaderName.parentElement.parentElement : null;
        if (namePill) namePill.style.display = (ctx && ctx.form === 'Form 2') ? 'none' : '';
        const bpsOption = document.getElementById('bps-option');
        const bpsCheckbox = document.getElementById('upload-bps');
        if (bpsOption) bpsOption.style.display = (ctx && ctx.form === 'Form 2') ? 'none' : '';
        if (bpsCheckbox) bpsCheckbox.checked = (ctx && ctx.form === 'Form 1') ? true : false;
        const singleWrap = document.getElementById('upload-form2-single');
        const splitWrap = document.getElementById('upload-form1-split');
        const tabsWrap = document.getElementById('upload-tabs-wrap');
        const conclGroup = document.getElementById('upload-conclusion-group');
        const classifGroup = document.getElementById('upload-classification-group');
        const durGroup = document.getElementById('upload-durability-group');
        const durDateWrap = document.getElementById('durability-date-wrap');
        const durDate = document.getElementById('durability-date');
        const gate2Wrap = document.getElementById('upload-gate2');
        if (ctx && ctx.form === 'Form 1'){
          if (singleWrap) singleWrap.style.display = 'none';
          if (splitWrap) splitWrap.style.display = '';
          if (tabsWrap) tabsWrap.style.display = '';
          if (conclGroup) conclGroup.style.display = '';
          if (classifGroup) classifGroup.style.display = '';
          if (durGroup) durGroup.style.display = '';
          if (durDateWrap) durDateWrap.style.display = 'none';
          try { document.querySelectorAll('input[name="durability-choice"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } }); } catch(_){ }
          try { document.querySelectorAll('input[name="upload-classification"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } }); } catch(_){ }
          try { 
            const noteEl = document.getElementById('classification-note');
            if (noteEl) noteEl.style.display = 'none';
          } catch(_){ }
          try { if (durDate) durDate.value = ''; } catch(_){ }
          if (gate2Wrap) gate2Wrap.style.display = 'none';
          try{
            const t1 = document.getElementById('tab-gate1');
            const t2 = document.getElementById('tab-gate2');
            if (t1 && t2){
              t1.classList.add('bg-primary-blue','text-white');
              t2.classList.remove('bg-primary-blue','text-white');
            }
            document.querySelectorAll('input[name="upload-conclusion"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
          }catch(_){ }
          
          // Kích hoạt hiệu ứng highlight cho Form 1
          setTimeout(() => {
            try {
              const conclGroup = document.getElementById('upload-conclusion-group');
              const classifGroup = document.getElementById('upload-classification-group');
              const durGroup = document.getElementById('upload-durability-group');
              if (conclGroup) {
                conclGroup.classList.add('highlight-section');
                // Loại bỏ class sau khi animation kết thúc
                setTimeout(() => {
                  conclGroup.classList.remove('highlight-section');
                }, 2000);
              }
              if (classifGroup) {
                classifGroup.classList.add('highlight-section');
                // Loại bỏ class sau khi animation kết thúc
                setTimeout(() => {
                  classifGroup.classList.remove('highlight-section');
                }, 2000);
              }
              if (durGroup) {
                durGroup.classList.add('highlight-section');
                // Loại bỏ class sau khi animation kết thúc
                setTimeout(() => {
                  durGroup.classList.remove('highlight-section');
                }, 2000);
              }
            } catch(_) {}
          }, 300); // Delay để đảm bảo modal đã hiển thị
        } else {
          if (singleWrap) singleWrap.style.display = '';
          if (splitWrap) splitWrap.style.display = 'none';
          if (tabsWrap) tabsWrap.style.display = 'none';
          if (conclGroup) conclGroup.style.display = 'none';
          if (classifGroup) classifGroup.style.display = 'none';
          if (durGroup) durGroup.style.display = 'none';
          if (gate2Wrap) gate2Wrap.style.display = 'none';
        }
      } catch(_) {}
      try { if (ctx && ctx.form === 'Form 2') { sendForm2RowMeta(ctx); } } catch(_) {}
      fileInput.value = '';
      // Reset text hiển thị cho Form 2
      try { 
        const fileNameSpan = document.getElementById('upload-file-name');
        if (fileNameSpan) {
          fileNameSpan.textContent = 'Không có tệp nào được chọn';
          fileNameSpan.className = 'text-sm text-gray-600';
        }
      } catch(_){ }
      try { document.getElementById('upload-file-pdfzip').value = ''; } catch(_){}
      try { document.getElementById('upload-file-xlsxzip').value = ''; } catch(_){}
      try { document.getElementById('upload-file-archive-g2').value = ''; } catch(_){ }
      // Reset radio buttons cho Form 1
      try { document.querySelectorAll('input[name="upload-conclusion"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } }); } catch(_){ }
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeUploadModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      // Re-enable last trigger and reset submit button state
      if (lastOpenTrigger) {
        try {
          lastOpenTrigger.disabled = false;
          if (lastOpenTrigger.classList) lastOpenTrigger.classList.remove('opacity-50','pointer-events-none');
        } catch(_) {}
        lastOpenTrigger = null;
      }
      const sendBtn = document.getElementById('btn-send');
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Gửi báo cáo';
      }
      isModalSubmitting = false;
    }
    document.getElementById('btn-cancel').onclick = closeUploadModal;
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeUploadModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeUploadModal(); });
    // Tabs: Gate 1 / Gate 2
    (function initUploadTabs(){
      try{
        const t1 = document.getElementById('tab-gate1');
        const t2 = document.getElementById('tab-gate2');
        const conclGroup = document.getElementById('upload-conclusion-group');
        const gate2Wrap = document.getElementById('upload-gate2');
        const splitWrap = document.getElementById('upload-form1-split');
        const contentWrap = document.getElementById('upload-content') || document.querySelector('#upload-modal .p-4');
        function activateGate1(){
          try{
            if (t1){ t1.classList.add('bg-cyan-700','text-white','border-cyan-800','shadow'); t1.classList.remove('bg-cyan-200','text-cyan-900','border-cyan-400'); }
            if (t2){ t2.classList.remove('bg-cyan-700','text-white','border-cyan-800','shadow'); t2.classList.add('bg-cyan-200','text-cyan-900','border-cyan-400'); }
          }catch(_){ }
          try{ conclGroup && (conclGroup.style.display = ''); }catch(_){ }
          try{ const classifGroup = document.getElementById('upload-classification-group'); if (classifGroup) classifGroup.style.display = ''; }catch(_){ }
          try{ const durGroup = document.getElementById('upload-durability-group'); if (durGroup) durGroup.style.display = ''; }catch(_){ }
          try{ gate2Wrap && (gate2Wrap.style.display = 'none'); }catch(_){ }
          try{ const classifGroupG2 = document.getElementById('upload-classification-group-g2'); if (classifGroupG2) classifGroupG2.style.display = 'none'; }catch(_){ }
          try{ splitWrap && (splitWrap.style.display = ''); }catch(_){ }
          try{ if (contentWrap) { contentWrap.style.background = 'linear-gradient(180deg, rgba(207,250,254,0.35), rgba(255,255,255,0))'; contentWrap.style.transition = 'background 200ms ease'; } }catch(_){ }
          try{ const g1t = document.getElementById('gate1-title'); if (g1t) g1t.style.display = ''; }catch(_){ }
          try{ const g2t = document.getElementById('gate2-title'); if (g2t) g2t.style.display = 'none'; }catch(_){ }
          try{
            const bpsOption = document.getElementById('bps-option');
            if (bpsOption) bpsOption.style.display = '';
            const bpsCheckbox = document.getElementById('upload-bps');
            if (bpsCheckbox) bpsCheckbox.checked = true;
          }catch(_){ }
        }
        function activateGate2(){
          try{
            if (t2){ t2.classList.add('bg-cyan-700','text-white','border-cyan-800','shadow'); t2.classList.remove('bg-cyan-200','text-cyan-900','border-cyan-400'); }
            if (t1){ t1.classList.remove('bg-cyan-700','text-white','border-cyan-800','shadow'); t1.classList.add('bg-cyan-200','text-cyan-900','border-cyan-400'); }
          }catch(_){ }
          try{ conclGroup && (conclGroup.style.display = 'none'); }catch(_){ }
          try{ const classifGroup = document.getElementById('upload-classification-group'); if (classifGroup) classifGroup.style.display = 'none'; }catch(_){ }
          try{ const durGroup = document.getElementById('upload-durability-group'); if (durGroup) durGroup.style.display = 'none'; }catch(_){ }
          try{ gate2Wrap && (gate2Wrap.style.display = ''); }catch(_){ }
          try{ const classifGroupG2 = document.getElementById('upload-classification-group-g2'); if (classifGroupG2) classifGroupG2.style.display = ''; }catch(_){ }
          try{
            // reset Gate 1 inputs when chuyển sang Gate 2
            const pdf = document.getElementById('upload-file-pdfzip'); if (pdf) pdf.value = '';
            const xlsx = document.getElementById('upload-file-xlsxzip'); if (xlsx) xlsx.value = '';
            const dateDur = document.getElementById('durability-date'); if (dateDur) dateDur.value = '';
            document.querySelectorAll('input[name="durability-choice"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
            document.querySelectorAll('input[name="upload-conclusion"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
            document.querySelectorAll('input[name="upload-classification"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
            document.querySelectorAll('input[name="upload-classification-g2"]').forEach(el=>{ try{ el.checked = false; }catch(_){ } });
            try { 
              const noteEl = document.getElementById('classification-note');
              if (noteEl) noteEl.style.display = 'none';
            } catch(_){ }
          }catch(_){ }
          try{ splitWrap && (splitWrap.style.display = 'none'); }catch(_){ }
          try{ if (contentWrap) { contentWrap.style.background = 'linear-gradient(180deg, rgba(232,121,249,0.18), rgba(255,255,255,0))'; contentWrap.style.transition = 'background 200ms ease'; } }catch(_){ }
          try{ const g1t = document.getElementById('gate1-title'); if (g1t) g1t.style.display = 'none'; }catch(_){ }
          try{ const g2t = document.getElementById('gate2-title'); if (g2t) g2t.style.display = ''; }catch(_){ }
          try{
            const bpsOption = document.getElementById('bps-option');
            if (bpsOption) bpsOption.style.display = 'none';
            const bpsCheckbox = document.getElementById('upload-bps');
            if (bpsCheckbox) bpsCheckbox.checked = false;
          }catch(_){ }
        }
        if (t1 && !t1._bound){ t1.addEventListener('click', (e)=>{ e.preventDefault(); activateGate1(); }); t1._bound = true; }
        if (t2 && !t2._bound){ t2.addEventListener('click', (e)=>{ e.preventDefault(); activateGate2(); }); t2._bound = true; }
        
      }catch(_){ }
    })();
    // Show/hide ngày dự kiến trả test bền theo lựa chọn
    (function initDurabilityChoice(){
      try{
        // Gate 1 durability choice
        const wrap = document.getElementById('durability-date-wrap');
        const radios = document.querySelectorAll('input[name="durability-choice"]');
        function update(){
          try{
            let v = '';
            radios.forEach(r=>{ if (r && r.checked) v = r.value || ''; });
            if (wrap) wrap.style.display = (v === 'co') ? '' : 'none';
          }catch(_){ }
        }
        radios.forEach(r=>{ r.addEventListener('change', update); });
        
      }catch(_){ }
    })();

    // Show/hide chú thích phân loại theo lựa chọn
    (function initClassificationNote(){
      try{
        const noteEl = document.getElementById('classification-note');
        const radios = document.querySelectorAll('input[name="upload-classification"]');
        function update(){
          try{
            let v = '';
            radios.forEach(r=>{ if (r && r.checked) v = r.value || ''; });
            if (!noteEl) return;
            if (v === 'Sản phẩm' || v === 'Linh kiện') {
              noteEl.textContent = 'Dữ liệu sẽ được gửi lên hệ thống phân tích';
              noteEl.style.display = '';
            } else if (v === 'Tác vụ khác') {
              noteEl.textContent = 'Dữ liệu sẽ KHÔNG được gửi lên hệ thống phân tích';
              noteEl.style.display = '';
            } else {
              noteEl.style.display = 'none';
            }
          }catch(_){ }
        }
        radios.forEach(r=>{ r.addEventListener('change', update); });
        
      }catch(_){ }
    })();

    function sendForm2RowMeta(ctx){
      try{
        if (!ctx || ctx.form !== 'Form 2') return;
        const p = new URLSearchParams();
        p.append('action','form2_report_open');
        p.append('person_name', ctx.name || '');
        p.append('taskId', ctx.taskId || ctx.code || '');
        p.append('code', ctx.code || '');
        p.append('taskName', ctx.taskName || '');
        const rd = ctx.rowData || {};
        try{
          Object.keys(rd).forEach(k=>{
            const v = rd[k];
            p.append(`row.${k}`, String(v ?? ''));
          });
        }catch(_){ }
        p.append('timestamp', new Date().toISOString());
        // Body tổng hợp để server đọc dễ hơn
        try{
          const meta = {
            action: 'form2_report_open',
            person_name: ctx.name || '',
            taskId: ctx.taskId || ctx.code || '',
            code: ctx.code || '',
            taskName: ctx.taskName || '',
            row: rd,
            timestamp_iso: new Date().toISOString()
          };
          p.append('body', JSON.stringify(meta));
        }catch(_){ }
        fetch(WEBHOOK_URL, { method:'POST', mode:'no-cors', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: p.toString() }).catch(()=>{});
      }catch(_){ }
    }

    document.getElementById('btn-send').onclick = async ()=>{
      if (isModalSubmitting) return;
      const isForm1 = (uploadContext && uploadContext.form === 'Form 1');
      const btn = document.getElementById('btn-send');
      const bpsCheckbox = document.getElementById('upload-bps');
      const bpsChecked = bpsCheckbox ? bpsCheckbox.checked : false;
      function extOf(name){ const m = String(name||'').toLowerCase().match(/\.([a-z0-9]+)$/); return m?m[1]:''; }
      let fd = new FormData();
      if (isForm1) {
        // Determine active gate
        const g2Wrap = document.getElementById('upload-gate2');
        const isGate2 = !!(g2Wrap && g2Wrap.style.display !== 'none');
        if (isGate2){
          // Gate 2: only archive
          const arch = document.getElementById('upload-file-archive-g2');
          if (!arch || !arch.files || arch.files.length===0){ showToast('Vui lòng chọn tệp nén (.zip/.rar/.7z).','error'); return; }
          const fArc = arch.files[0];
          const ext = extOf(fArc.name);
          const okArc = ['zip','rar','7z'];
          if (okArc.indexOf(ext)===-1){ showToast('Chỉ nhận tệp nén .zip/.rar/.7z cho Gate 2.','error'); return; }
          isModalSubmitting = true;
          if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
          fd.append('file_archive', fArc);
          fd.append('upload_type', 'archive_only');
          fd.append('file_name', fArc.name || '');
          fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
          // Gate 2: kết luận mặc định (ẩn)
          try { fd.append('ket_luan', 'Báo cáo máy Base, rà soát tem nhãn'); } catch(_){ }
          if(uploadContext){
            fd.append('nguoi_nop', uploadContext.name||'');
            const taskIdVal = uploadContext.taskId || uploadContext.code || '';
            fd.append('ma_tac_vu', taskIdVal);
            fd.append('ten_tac_vu', uploadContext.taskName||'');
            fd.append('form', uploadContext.form||'Form 1');
          }
          // Append Gate 2 classification if selected
          try{
            const classifPickedG2 = (function(){ const els = document.querySelectorAll('input[name="upload-classification-g2"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
            if (classifPickedG2) fd.append('phan_loai', classifPickedG2);
          }catch(_){ }
          try{
            const classifPickedG2 = (function(){ const els = document.querySelectorAll('input[name="upload-classification-g2"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
            const meta = {
              action: 'form1_upload',
              gate: 'Gate 2',
              person_name: uploadContext?.name || '',
              taskId: (uploadContext?.taskId || uploadContext?.code || ''),
              code: uploadContext?.code || '',
              taskName: uploadContext?.taskName || '',
              ket_luan: 'Báo cáo máy Base, rà soát tem nhãn',
              phan_loai: classifPickedG2 || '',
              is_bps: bpsChecked ? '1' : '0',
              upload_type: 'archive_only',
              timestamp_iso: new Date().toISOString()
            };
            fd.append('meta_json', JSON.stringify(meta));
            fd.append('body', JSON.stringify(meta));
            fd.append('action', 'form1_upload');
            fd.append('gate', 'Gate 2');
          }catch(_){ }
          try{
            await fetch(FORM1_UPLOAD_URL,{method:'POST',body:fd, mode: 'no-cors'});
            showToast('Đã gửi báo cáo Gate 2.','success');
            closeUploadModal();
          } catch(e){
            console.error(e);
            showToast('Gửi thất bại.','error');
            isModalSubmitting = false;
            if (btn) { btn.disabled = false; btn.textContent = 'Gửi báo cáo'; }
          }
          return;
        }
        const pdfInput = document.getElementById('upload-file-pdfzip');
        const xlsxInput = document.getElementById('upload-file-xlsxzip');
        const okPdf = ['pdf'];
        const okXlsx = ['xlsx'];
        if (!pdfInput || !pdfInput.files || pdfInput.files.length===0){ showToast('Vui lòng chọn file PDF.','error'); return; }
        const fPdf = pdfInput.files[0];
        const extPdf = extOf(fPdf.name);
        if (okPdf.indexOf(extPdf)===-1){ showToast('File PDF không đúng định dạng.','error'); return; }
        let fXlsx = null;
        // Bắt buộc phải nộp file Excel bất kể có gửi BPS hay không
        if (!xlsxInput || !xlsxInput.files || xlsxInput.files.length===0){ showToast('Vui lòng chọn file Excel (.xlsx).','error'); return; }
        fXlsx = xlsxInput.files[0];
        const extX = extOf(fXlsx.name);
        if (okXlsx.indexOf(extX)===-1){ showToast('File Excel không đúng định dạng (.xlsx).','error'); return; }
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
        // Append with original field names
        fd.append('file_pdfzip', fPdf);
        if (fXlsx) fd.append('file_xlsxzip', fXlsx);
        // Extra compatibility: duplicate under common field names
        try { fd.append('file', fPdf); } catch(_){ }
        try { if (fXlsx) fd.append('file2', fXlsx); } catch(_){ }
        try { fd.append('files[]', fPdf); } catch(_){ }
        try { if (fXlsx) fd.append('files[]', fXlsx); } catch(_){ }
        fd.append('upload_type', fXlsx ? 'pdf_xlsx' : 'pdf_only');
        fd.append('file_name', fPdf.name || '');
        if (fXlsx) fd.append('file_name_xlsx', fXlsx.name || '');
        fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
        if(uploadContext){
          fd.append('nguoi_nop', uploadContext.name||'');
          const taskIdVal = uploadContext.taskId || uploadContext.code || '';
          fd.append('ma_tac_vu', taskIdVal);
          fd.append('ten_tac_vu', uploadContext.taskName||'');
          fd.append('form', uploadContext.form||'Form 1');
        }
        // Durability test fields
        let durPicked = '';
        try{ durPicked = (function(){ const els = document.querySelectorAll('input[name="durability-choice"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })(); }catch(_){ }
        const durDateVal = (document.getElementById('durability-date')?.value || '');
        if (durPicked){ fd.append('test_ben', durPicked === 'co' ? 'Có test bền' : 'Không test bền'); }
        if (durPicked === 'co' && durDateVal){ fd.append('ngay_du_kien_tra_test_ben', durDateVal); }
        // Append Gate 1 conclusion if selected
        try{
          const picked = (function(){ const els = document.querySelectorAll('input[name="upload-conclusion"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
          if (picked) fd.append('ket_luan', picked);
        }catch(_){ }
        // Append Gate 1 classification if selected
        try{
          const classifPicked = (function(){ const els = document.querySelectorAll('input[name="upload-classification"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
          if (classifPicked) fd.append('phan_loai', classifPicked);
        }catch(_){ }
        // Append meta JSON body for server
        try{
          const activeGate = (function(){ const g2 = document.getElementById('upload-gate2'); return (g2 && g2.style.display !== 'none') ? 'Gate 2' : 'Gate 1'; })();
          const classifPicked = (function(){ const els = document.querySelectorAll('input[name="upload-classification"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })();
          const meta = {
            action: 'form1_upload',
            gate: activeGate,
            person_name: uploadContext?.name || '',
            taskId: (uploadContext?.taskId || uploadContext?.code || ''),
            code: uploadContext?.code || '',
            taskName: uploadContext?.taskName || '',
            ket_luan: (function(){ const els = document.querySelectorAll('input[name="upload-conclusion"]'); for (const el of els){ if (el && el.checked) return el.value || ''; } return ''; })(),
            phan_loai: classifPicked || '',
            test_ben: (function(v){ return v==='co' ? 'Có test bền' : (v==='khong' ? 'Không test bền' : ''); })(durPicked),
            ngay_du_kien_tra_test_ben: durDateVal || '',
            is_bps: bpsChecked ? '1' : '0',
            timestamp_iso: new Date().toISOString()
          };
          fd.append('meta_json', JSON.stringify(meta));
          // Thêm body cho server
          try{ fd.append('body', JSON.stringify(meta)); }catch(_){ }
          fd.append('action', 'form1_upload');
          fd.append('gate', activeGate);
        }catch(_){ }
        if (bpsCheckbox) { fd.append('is_bps', bpsChecked ? '1' : '0'); }
        try{
          try { showToast(`Sẽ gửi ${fXlsx? '2 tệp' : '1 tệp'}: ${fPdf?.name||''}${fXlsx? (', '+(fXlsx.name||'')) : ''}`,'info'); } catch(_){}
          await fetch(FORM1_UPLOAD_URL,{method:'POST',body:fd, mode: 'no-cors'});
          showToast('Đã gửi báo cáo.','success');
          closeUploadModal();
        } catch(e){
          console.error(e);
          showToast('Gửi thất bại.','error');
          isModalSubmitting = false;
          if (btn) { btn.disabled = false; btn.textContent = 'Gửi báo cáo'; }
        }
        return;
      }
      // Form 2 (giữ nguyên logic upload 1 file)
      if(!fileInput.files || fileInput.files.length===0){ showToast('Vui lòng chọn tệp báo cáo.','error'); return; }
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
      fd.append('file', fileInput.files[0]);
      fd.append('file_name', fileInput.files[0].name || '');
      fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
      if(uploadContext){
        fd.append('nguoi_nop', uploadContext.name||'');
        const taskIdVal = uploadContext.taskId || uploadContext.code || '';
        fd.append('ma_tac_vu', taskIdVal);
        fd.append('ten_tac_vu', uploadContext.taskName||'');
        fd.append('form', uploadContext.form||'');
      }
      if (bpsCheckbox) { fd.append('is_bps', bpsChecked ? '1' : '0'); }
      // Thêm body tổng hợp cho Form 2
      try{
        const meta2 = {
          action: 'form2_upload',
          person_name: uploadContext?.name || '',
          taskId: (uploadContext?.taskId || uploadContext?.code || ''),
          code: uploadContext?.code || '',
          taskName: uploadContext?.taskName || '',
          is_bps: bpsChecked ? '1' : '0',
          timestamp_iso: new Date().toISOString()
        };
        fd.append('body', JSON.stringify(meta2));
      }catch(_){ }
      // (Giữ nguyên Form 2 - không thêm meta JSON, theo yêu cầu chỉ chỉnh Form 1)
      try{
        await fetch(FORM2_UPLOAD_URL,{method:'POST',body:fd, mode: 'no-cors'});
        showToast('Đã gửi báo cáo.','success');
        closeUploadModal();
      } catch(e){
        console.error(e);
        showToast('Gửi thất bại.','error');
        isModalSubmitting = false;
        if (btn) { btn.disabled = false; btn.textContent = 'Gửi báo cáo'; }
      }
    };

    

    // Helpers for tables - Cập nhật cho Form 7 mở rộng
    function addTd(tr, text){ const td=document.createElement('td'); td.className='px-3 py-4 align-top text-gray-800 border border-gray-500'; td.textContent=text; tr.appendChild(td); }
    
    // Hàm riêng cho Form 8 để xử lý đường viền
    function addTdF8(tr, text, isLastColumn = false){ 
      const td=document.createElement('td'); 
      td.className='px-3 py-4 align-top text-gray-800 border-r border-gray-200'; 
      td.textContent=text; 
      tr.appendChild(td); 
    }
    // Enable drag-drop reordering on table body rows
    function enableTableDrag(tbodyId){
      try{
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        let dragging = null;
        const onDragStart = (e)=>{ dragging = e.currentTarget; dragging.classList.add('opacity-50'); try{ e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain',''); }catch(_){ } };
        const onDragEnd = ()=>{ try{ if (dragging) dragging.classList.remove('opacity-50'); }catch(_){ } dragging = null; try{ tbody.querySelectorAll('tr').forEach(r=> r.classList.remove('drag-over')); }catch(_){ } };
        const onDragOver = (e)=>{ e.preventDefault(); const row = e.target && e.target.closest ? e.target.closest('tr') : null; if (!row || row === dragging) return; try{ tbody.querySelectorAll('tr').forEach(r=> r.classList.remove('drag-over')); row.classList.add('drag-over'); }catch(_){ } };
        const onDrop = (e)=>{ e.preventDefault(); const row = e.target && e.target.closest ? e.target.closest('tr') : null; if (!row || !dragging || row===dragging) { onDragEnd(); return; } try{ tbody.insertBefore(dragging, row.nextSibling); }catch(_){ } onDragEnd(); };
        tbody.querySelectorAll('tr').forEach(tr=>{ try{ tr.setAttribute('draggable','true'); tr.classList.add('cursor-move','select-none'); tr.removeEventListener('dragstart', onDragStart); tr.addEventListener('dragstart', onDragStart); tr.removeEventListener('dragend', onDragEnd); tr.addEventListener('dragend', onDragEnd); }catch(_){ } });
        try{ tbody.removeEventListener('dragover', onDragOver); tbody.addEventListener('dragover', onDragOver); }catch(_){ }
        try{ tbody.removeEventListener('drop', onDrop); tbody.addEventListener('drop', onDrop); }catch(_){ }
      }catch(_){ }
    }
    // Flexible date parser supporting multiple formats
    function parseDateFlexible(v){
      if(!v) return null;
      const s = String(v).trim();
      // DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY
      let m = s.match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
      if (m){
        const d = +m[1], mo = +m[2], y = m[3].length===2 ? +('20'+m[3]) : +m[3];
        const hh = m[4] ? +m[4] : 0, mm = m[5] ? +m[5] : 0, ss = m[6] ? +m[6] : 0;
        const dt = new Date(y, mo-1, d, hh, mm, ss);
        return isNaN(dt) ? null : dt;
      }
      // YYYY-MM-DD or YYYY/MM/DD
      m = s.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
      if (m){
        const y = +m[1], mo = +m[2], d = +m[3];
        const hh = m[4] ? +m[4] : 0, mm = m[5] ? +m[5] : 0, ss = m[6] ? +m[6] : 0;
        const dt = new Date(y, mo-1, d, hh, mm, ss);
        return isNaN(dt) ? null : dt;
      }
      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
    }

    // Form 1: fetch via webhook with query for headers/fields
    let F1_ALL_ROWS = [];
    let F1_PAGE = 1;
    let F1_SIZE = 20;
    // Cache bản rỗng đã chuẩn hoá cho Form 1 để lọc theo tháng với Done/Cancel
    let F1_LAST_ITEMS = [];
    function applyForm1Paging(){
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      const total = F1_ALL_ROWS.length;
      if(total === 0){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="19">Không có tác vụ</td></tr>';
        pager.style.display = 'none';
        return;
      }
      pager.style.display = '';
      const maxPage = Math.max(1, Math.ceil(total / F1_SIZE));
      if(F1_PAGE > maxPage) F1_PAGE = maxPage;
      const start = (F1_PAGE - 1) * F1_SIZE;
      const end = Math.min(total, start + F1_SIZE);
      const slice = F1_ALL_ROWS.slice(start, end);
      const pageInfo = document.getElementById('f1-page-info');
      if(pageInfo) pageInfo.textContent = `Trang ${F1_PAGE}/${maxPage} (${total} dòng)`;
      const prev = document.getElementById('f1-prev');
      const next = document.getElementById('f1-next');
      if(prev) prev.disabled = (F1_PAGE <= 1);
      if(next) next.disabled = (F1_PAGE >= maxPage);
      // render rows
      body.innerHTML = '';
      slice.forEach(tr => body.appendChild(tr));
    }

    function formatYyyyMmSafe(v){ try{ const d = toDateSafe(v); if(!d) return ''; const mm=String(d.getMonth()+1).padStart(2,'0'); return `${d.getFullYear()}-${mm}`; }catch(_){ return ''; } }

    function vnLower(s){
      try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); }
    }

    function applyForm1MonthFilter(){
      try{
        const monthEl = document.getElementById('f1-month');
        const monthVal = monthEl ? (monthEl.value||'').trim() : '';
        const items = Array.isArray(F1_LAST_ITEMS) ? F1_LAST_ITEMS.slice() : [];
        // Done & Cancel: lọc theo tháng (monthVal)
        let partDoneCancel = items.filter(it=> it.isDone || it.isCancel);
        if (monthVal) partDoneCancel = partDoneCancel.filter(it=> it.monthTagReq === monthVal);
        // Doing, Chờ phê duyệt, Chờ phân công, Test bền: luôn hiển thị không phụ thuộc thời gian
        let partTimeRestricted = items.filter(it=> {
          const s = it.statusNorm || '';
          return s.includes('doing') || s.includes('cho phe duyet') || s.includes('truong nhom review') || s.includes('cho phan cong') || s.includes('test ben');
        });
        // Ưu tiên nhóm thời gian thực (Doing/Chờ phân công/Test bền) lên trước
        const filtered = partTimeRestricted.concat(partDoneCancel);
        // Render lại tbody và phân trang
        const body = document.getElementById('f1-body');
        const pager = document.getElementById('f1-pager');
        if (!filtered.length){
          if (body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="19">Không có tác vụ</td></tr>';
          if (pager) pager.style.display = 'none';
          F1_ALL_ROWS = [];
          return;
        }
        F1_ALL_ROWS = filtered.map(it=> it.rowEl).filter(Boolean);
        F1_PAGE = 1;
        applyForm1Paging();
      }catch(_){ }
    }

    // Render Form 1 từ mảng rows (dùng cho cache)
    function renderForm1FromRows(rows){
      const body = document.getElementById('f1-body');
      if(!rows || !rows.length){ body.innerHTML = "<tr><td colspan='19' class='px-3 py-3 text-center text-gray-500 border border-gray-500'>Không có tác vụ</td></tr>"; return; }
      const getV = (obj, keys)=>{
        const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
        for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      };
      function getStatusRank(obj){
        const s = vnLower(getV(obj,['status','trangthai','trang_thai','trạng thái']) || '');
        if (s.includes('doing') || s.includes('dang')) return 0; // ưu tiên cao nhất
        if (s.includes('cho phan cong') || s.includes('test ben')) return 1; // nhóm thứ hai
        return 2; // còn lại
      }
      function getTimeValue(obj){
        const v = getV(obj,[
          'requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu'
        ]) || getV(obj,[
          'actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng'
        ]) || getV(obj,[
          'wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn'
        ]);
        const d = parseDateFlexible(v);
        return d ? d.getTime() : 0;
      }
      const rowsSorted = rows.slice().sort((a,b)=>{
        const ra = getStatusRank(a), rb = getStatusRank(b);
        if (ra !== rb) return ra - rb;
        const ta = getTimeValue(a), tb = getTimeValue(b);
        return tb - ta; // mới nhất trước
      });
      F1_ALL_ROWS = [];
      F1_LAST_ITEMS = [];
      rowsSorted.forEach(item=>{
        const tr=document.createElement('tr');
        const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2 border border-gray-500';
        const code = getV(item,['code','ma','taskcode','mã']);
        const taskId = getV(item,['taskid','task_id','ma_tac_vu','mã tác vụ','taskcode2','requestid','id']);
        const tname = getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']);
        const statusText = getV(item,['status','trangthai','trang_thai','trạng thái']);
        const statusLower = (statusText||'').toLowerCase();
        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('hủy') || statusLower.includes('huỷ');
        const isPendingApproval = statusLower.includes('chờ phê duyệt') || statusLower.includes('cho phe duyet') || statusLower.includes('trưởng nhóm review') || statusLower.includes('truong nhom review');
        const isEmptyStatus = statusLower.trim()==='';
        const isLocked = isDone || isCancelled || isPendingApproval || isEmptyStatus;
        const isDoing = statusLower.includes('doing') || statusLower.includes('đang');
        const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
        const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
        const dueStr = actualDue || wishDue || '';
        const dueDate = parseDateFlexible(dueStr);
        if (isDoing && dueDate){
          const today = new Date();
          const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const dueDayStart = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
          const isSameDay = dueDayStart.getTime() === todayStart.getTime();
          const isPast = dueDayStart.getTime() < todayStart.getTime();
          try { if (isSameDay) { tr.style.backgroundColor = '#fef3c7'; } else if (isPast) { tr.style.backgroundColor = '#fee2e2'; } } catch(_){}
        }
        const labelBtn = document.createElement('button');
        if (isLocked) {
          labelBtn.disabled = true;
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60';
          labelBtn.textContent = isCancelled ? 'Đã hủy' : (isDone ? 'Đã hoàn thành' : (isPendingApproval ? 'Chờ phê duyệt' : 'Không thể gửi'));
          labelBtn.title = labelBtn.textContent;
        } else {
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105 cursor-pointer';
          labelBtn.textContent = 'Trả báo cáo';
          labelBtn.onclick = (e)=>{ e.preventDefault(); if (labelBtn.disabled) return; labelBtn.disabled=true; labelBtn.classList.add('opacity-50','pointer-events-none'); lastOpenTrigger = labelBtn; const name=(document.getElementById('f1-name')?.value||'').trim(); openUploadModal({ form: 'Form 1', name, code, taskId, taskName: tname }); };
        }
        tdBtn.appendChild(labelBtn);
        tr.appendChild(tdBtn);
        const tdStatus=document.createElement('td'); tdStatus.className='px-3 py-2 border border-gray-500';
        const s=(statusText||'').toLowerCase();
        const badge=document.createElement('span');
        let badgeClass = 'bg-blue-100 text-blue-800';
        if (s.includes('chờ phê duyệt') || s.includes('cho phe duyet') || s.includes('trưởng nhóm review') || s.includes('truong nhom review')) badgeClass = 'bg-orange-100 text-orange-800';
        else if (s.includes('hoàn') || s.includes('done')) badgeClass = 'bg-green-100 text-green-800';
        else if (s.includes('cancel') || s.includes('hủy') || s.includes('huỷ') || s.includes('chờ') || s.includes('pending')) badgeClass = 'bg-yellow-100 text-yellow-800';
        badge.className='px-2 py-1 rounded text-xs ' + badgeClass; badge.textContent=statusText||''; tdStatus.appendChild(badge); tr.appendChild(tdStatus);
        addTd(tr, taskId);
        addTd(tr, code);
        addTd(tr, tname);
        // New columns right after Task Name: Tgian nộp form & Ngày cần trả BC
        (function(){
          const submitTimeRaw = getV(item,['submittime','submit_time','submitTime','tgian nop form','thoi_gian_nop_form','thời gian nộp form']);
          const manHourRaw = getV(item,[ 'manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','công chuẩn' ]);
          const submitTimeDisp = (function(v){ const d=toDateSafe(v); if(!d) return String(v||''); const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`; })(submitTimeRaw);
          addTd(tr, submitTimeDisp);
          let dueDateRaw = getV(item,['reportduedate','report_due_date','reportDueDate','ngay can tra bc','ngay_can_tra_bc','ngày cần trả bc']);
          if (!dueDateRaw){
            try{
              const base = toDateSafe(submitTimeRaw);
              const hrs = parseNumberFlexible(manHourRaw);
              const calc = (base && Number.isFinite(hrs)) ? addBusinessHours(base, hrs) : null;
              if (calc) dueDateRaw = calc;
            }catch(_){ }
          }
          const dueDisp = (function(v){ const d=toDateSafe(v); if(!d) return String(v||''); const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`; })(dueDateRaw || '');
          addTd(tr, dueDisp);
        })();
        addTd(tr, getV(item,['requester','nguoiyeucau','nguoi_yeu_cau','assigner','người yêu cầu']));
        addTd(tr, getV(item,['receiver','receivername','nguoinhanmau','nguoi_nhan_mau','người nhận mẫu','recipient','assignee','người nhận']));
        addTd(tr, getV(item,[ 'manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','công chuẩn' ]));
        const requestDateStr = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']);
        addTd(tr, requestDateStr);
        addTd(tr, getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']));
        addTd(tr, getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']));
        addTd(tr, getV(item,['purpose','mucdich','muc_dich','mục đích đánh giá','muc dich danh gia','mucdichdanhgia']));
        addTd(tr, getV(item,['note','ghi_chu','ghichu']));
        addTd(tr, getV(item,['specialtest','yeucau_test_dac_biet','yeu_cau_test_dac_biet']));
        addTd(tr, getV(item,['reportform','form_bao_cao','form_bao_cao_danh_gia']));
        const attachmentName = getV(item,[ 'attachmentfilename','file_name','filename','tenfile','ten_file','tên file','tên file đính kèm','attachment','file' ]);
        addTd(tr, attachmentName);
        const tdDl = document.createElement('td'); tdDl.className='px-3 py-2 border border-gray-500';
        const url = getV(item,[ 'attachmenturl','attachment_url','fileurl','file_url','downloadurl','download_url','link','url' ]);
        if (url) { const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105'; a.textContent = 'Tải về'; tdDl.appendChild(a); }
        else { const btn = document.createElement('button'); btn.disabled = true; btn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60'; btn.textContent = 'Không có link'; tdDl.appendChild(btn); }
        tr.appendChild(tdDl);
        F1_ALL_ROWS.push(tr);
        try{ if (!window.F1_LAST_RAW) window.F1_LAST_RAW = []; window.F1_LAST_RAW.push(item); }catch(_){ }
        const statusNorm = vnLower(statusText);
        const monthTagReq = formatYyyyMmSafe(requestDateStr);
        F1_LAST_ITEMS.push({ rowEl: tr, statusNorm, monthTagReq, requestDateRaw: requestDateStr, isDone, isCancel: isCancelled });
      });
      applyForm1Paging();
      try{ applyForm1MonthFilter(); }catch(_){ }
    }

    async function renderForm1(){
      const name = (document.getElementById('f1-name').value || '').trim();
      const body = document.getElementById('f1-body');
      if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500 border border-gray-500" colspan="19">Vui lòng chọn tên</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='19' class='px-3 py-3 text-center text-gray-500 border border-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      try{
          const headerMapF1 = {
          header_btn: 'Nút nhập gửi báo cáo',
          header_requester: 'Người yêu cầu',
          header_requestDate: 'Ngày yêu cầu',
          header_wishDue: 'Hạn mong muốn',
          header_actualDue: 'Hạn đáp ứng',
          header_code: 'Mã',
          header_taskId: 'Mã tác vụ',
          header_taskName: 'Tên tác vụ',
          header_receiverSample: 'Người nhận mẫu',
          header_manHour: 'Công chuẩn',
          header_purpose: 'Mục đích đánh giá',
          header_note: 'Note',
          header_specialTest: 'Yêu cầu test đặc biệt',
          header_reportForm: 'Form báo cáo đánh giá',
          header_submitTime: 'Tgian nộp form',
          header_reportDueDate: 'Ngày cần trả BC',
          header_status: 'Trạng thái',
          header_attachmentFileName: 'Tên file đính kèm',
          header_attachmentUrl: 'Tải đính kèm',
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskId: 'taskId',
          field_taskName: 'taskName',
          field_receiverSample: 'receiverSample',
          field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_submitTime: 'submitTime',
          field_reportDueDate: 'reportDueDate',
          field_status: 'status',
          field_attachmentFileName: 'attachmentFileName',
          field_attachmentUrl: 'attachmentUrl'
        };
        const params = new URLSearchParams({
          ...headerMapF1,
          action: 'form1_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const text = await r.text();
          if(!r.ok) throw new Error(text || `HTTP ${r.status}`);
          let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
          return { parsed, raw: text };
        }
        let data = null; let firstErr = null;
        try{
          const { parsed, raw } = await fetchJson(testUrl);
          if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
            throw new Error('WEBHOOK_TEST_INACTIVE');
          }
          data = parsed ?? raw;
        } catch (e) {
          firstErr = e;
          // Fallback sang production webhook khi test webhook chưa bật lắng nghe
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          const { parsed, raw } = await fetchJson(prodUrl);
          data = parsed ?? raw;
        }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          // Deep search first array of objects
          try{
            const queue = [json];
            const seen = new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        try{ LS.setJSON('f1.raw', { name, rows, ts: Date.now() }); }catch(_){ }
        if(!rows.length){ body.innerHTML = "<tr><td colspan='17' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>"; return; }
        // Cache và timestamp
        try{ LS.setJSON('f1.cache', { name, rows }); LS.set('f1.lastUpdated', String(Date.now())); updateLastUpdatedNote('f1-search','f1.lastUpdated'); }catch(_){ }
        renderForm1FromRows(rows);
      }catch(err){
        body.innerHTML = `<tr><td colspan='17' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }
    document.getElementById('f1-name').onchange = ()=>{};
    // Tự khởi tạo từ cache nếu có
    (function initF1FromCache(){
      try{
        const cached = LS.getJSON('f1.cache');
        const cachedName = LS.get('f1.selectedName')||'';
        if (!cached || !cached.rows || !cachedName) return;
        const sel = document.getElementById('f1-name');
        if (sel && (!sel.value)) sel.value = cachedName;
        renderForm1FromRows(cached.rows);
        updateLastUpdatedNote('f1-search','f1.lastUpdated');
      }catch(_){ }
    })();
    const f1SearchBtn = document.getElementById('f1-search');
    if (f1SearchBtn) {
      let f1Busy = false;
      f1SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1Busy) return;
        f1Busy = true;
        f1SearchBtn.disabled = true;
        const prev = f1SearchBtn.textContent;
        f1SearchBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { await renderForm1(); }
        finally {
          f1Busy = false;
          f1SearchBtn.disabled = false;
          f1SearchBtn.textContent = prev;
        }
      };
    }
    // Pagination events
    const f1Prev = document.getElementById('f1-prev');
    const f1Next = document.getElementById('f1-next');
    const f1Size = document.getElementById('f1-size');
    if (f1Prev) f1Prev.onclick = (e)=>{ e.preventDefault(); if(F1_PAGE>1){ F1_PAGE--; applyForm1Paging(); } };
    if (f1Next) f1Next.onclick = (e)=>{ e.preventDefault(); F1_PAGE++; applyForm1Paging(); };
    if (f1Size) f1Size.onchange = (e)=>{ F1_SIZE = parseInt(e.target.value||'20',10)||20; F1_PAGE=1; applyForm1Paging(); };
    // Default month and change handler for Form 1 filter (Done/Cancel)
    (function initF1Month(){
      const m = document.getElementById('f1-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
      if (!m._bound){ m.addEventListener('change', ()=> applyForm1MonthFilter()); m._bound = true; }
    })();

    // Helper: ưu tiên chọn Mã tác vụ theo tiền tố QA.Y/QA.NB
    function pickTaskIdPreferQA(taskId, code){
      try{
        const s1 = String(taskId||'').trim();
        const s2 = String(code||'').trim();
        const re = /^QA\.(?:Y|NB)\./i;
        const has1 = re.test(s1);
        const has2 = re.test(s2);
        if (has1 && has2) return s1;
        if (has1) return s1;
        if (has2) return s2;
        return s1 || s2 || '';
      }catch(_){ return String(taskId||code||'').trim(); }
    }

    // Form 2 rendering
    async function renderForm2(){
      const name = (document.getElementById('f2-name').value || '').trim();
      const body = document.getElementById('f2-body');
      if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Vui lòng chọn tên</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='6' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      try{
        // Helper function để thêm border cho các ô
        const addTd = (tr, content)=>{ const td=document.createElement('td'); td.className='px-3 py-2 border-r border-gray-200'; td.textContent=content||''; tr.appendChild(td); };
        const addTdLast = (tr, element)=>{ const td=document.createElement('td'); td.className='px-3 py-2'; if(typeof element === 'string'){ td.textContent=element; } else { td.appendChild(element); } tr.appendChild(td); };
        
        const headerMapF2 = {
          header_taskId: 'Mã tác vụ',
          header_requestDate: 'Ngày yêu cầu',
          header_wishDue: 'Hạn mong muốn',
          header_actualDue: 'Hạn đáp ứng',
          header_code: 'Mã',
          header_taskName: 'Tên tác vụ',
          field_taskId: 'taskId',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName'
        };
        const params = new URLSearchParams({
          ...headerMapF2,
          action: 'form2_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        const url = `${FORM2_LOOKUP_URL}?${params.toString()}`;
        const resp = await fetch(url, { method: 'GET' });
        const text = await resp.text();
        if(!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
        let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){ const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') queue.push(v);} }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        if(!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Không có tác vụ.</td></tr>'; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        // Cache và timestamp
        try{ LS.setJSON('f2.cache', { name, rows }); LS.set('f2.lastUpdated', String(Date.now())); updateLastUpdatedNote('f2-search','f2.lastUpdated'); }catch(_){ }
        body.innerHTML='';
        rows.forEach(item=>{
          const tr=document.createElement('tr');
          const taskId = getV(item,['taskid','task_id','ma_tac_vu','mã tác vụ','requestid','id']);
          const requestDate = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']);
          const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
          const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
          const code = getV(item,['code','ma','taskcode','mã']);
          const taskName = getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']);
          const taskIdBest = pickTaskIdPreferQA(taskId, code);
          const rowData = { taskId: taskIdBest, requestDate, wishDue, actualDue, code, taskName };
          addTd(tr, taskIdBest);
          addTd(tr, requestDate);
          addTd(tr, wishDue);
          addTd(tr, actualDue);
          addTd(tr, code);
          addTd(tr, taskName);
          
          // Button ô cuối (không có border-r)
          const btn=document.createElement('button'); 
          btn.className='px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105'; 
          btn.textContent='Trả form báo cáo';
          btn.onclick=(e)=>{
            e.preventDefault();
            if (btn.disabled) return;
            btn.disabled = true;
            btn.classList.add('opacity-50','pointer-events-none');
            lastOpenTrigger = btn;
            openUploadModal({form:'Form 2', name, code, taskId: taskIdBest, taskName, rowData});
          };
          addTdLast(tr, btn);
          body.appendChild(tr);
        });
      }catch(err){
        body.innerHTML = `<tr><td colspan='6' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }
    document.getElementById('f2-name').onchange = ()=>{};
    // Hiển thị từ cache Form 2 nếu có
    (function initF2FromCache(){
      try{
        const cached = LS.getJSON('f2.cache');
        const name = LS.get('f2.selectedName')||'';
        if (!cached || !Array.isArray(cached.rows) || !name) return;
        const body = document.getElementById('f2-body');
        if (!body) return;
        body.innerHTML='';
        
        // Helper function để thêm border cho các ô
        const addTd = (tr, content)=>{ const td=document.createElement('td'); td.className='px-3 py-2 border-r border-gray-200'; td.textContent=content||''; tr.appendChild(td); };
        const addTdLast = (tr, element)=>{ const td=document.createElement('td'); td.className='px-3 py-2'; if(typeof element === 'string'){ td.textContent=element; } else { td.appendChild(element); } tr.appendChild(td); };
        
        const rows = cached.rows;
        const getV = (obj, keys)=>{ const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{}); for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; } return ''; };
        rows.forEach(item=>{
          const tr=document.createElement('tr');
          const taskId = getV(item,['taskid','task_id','ma_tac_vu','mã tác vụ','requestid','id']);
          const requestDate = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']);
          const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
          const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
          const code = getV(item,['code','ma','taskcode','mã']);
          const taskName = getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']);
          const taskIdBest = pickTaskIdPreferQA(taskId, code);
          const rowData = { taskId: taskIdBest, requestDate, wishDue, actualDue, code, taskName };
          addTd(tr, taskIdBest);
          addTd(tr, requestDate);
          addTd(tr, wishDue);
          addTd(tr, actualDue);
          addTd(tr, code);
          addTd(tr, taskName);
          
          // Button ô cuối (không có border-r)
          const btn=document.createElement('button'); 
          btn.className='px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105'; 
          btn.textContent='Trả form báo cáo';
          btn.onclick=(e)=>{ 
            e.preventDefault(); 
            if (btn.disabled) return; 
            btn.disabled = true; 
            btn.classList.add('opacity-50','pointer-events-none'); 
            lastOpenTrigger = btn; 
            openUploadModal({form:'Form 2', name, code, taskId: taskIdBest, taskName, rowData}); 
          };
          addTdLast(tr, btn);
          body.appendChild(tr);
        });
        updateLastUpdatedNote('f2-search','f2.lastUpdated');
      }catch(_){ }
    })();
    const f2SearchBtn = document.getElementById('f2-search');
    if (f2SearchBtn) {
      let f2Busy = false;
      f2SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f2Busy) return;
        f2Busy = true;
        f2SearchBtn.disabled = true;
        const prev = f2SearchBtn.textContent;
        f2SearchBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { await renderForm2(); }
        finally {
          f2Busy = false;
          f2SearchBtn.disabled = false;
          f2SearchBtn.textContent = prev;
        }
      };
    }
    // Clear button removed per request

    // Form 3 logic
    function setRqTime(){ const d=new Date(); const el=document.getElementById('rq-time'); if (el) el.value = formatDdMmYyyyHHmm(d); }
    setRqTime();
    // Default Form 4 month = current month
    (function setDefaultF4Month(){
      const m = document.getElementById('f4-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
    })();
    // Helper: set default date for Form 5 inputs
    function setF5DateDefault(){
      const el = document.getElementById('f5-date');
      if (!el) return;
      const d = new Date();
      const pad = n=>String(n).padStart(2,'0');
      el.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // Form 3: preview selected file (send with form later via webhook)
    (function setupForm3UploadPreview(){
      const fileInput = document.getElementById('attach');
      const list = document.getElementById('f3-upload-list');
      if (!fileInput || !list) return;
      list.innerHTML = '';
      function renderPreview(file){
        const row = document.createElement('div');
        row.className = "flex items-center justify-between p-2 bg-blue-50 rounded";
        row.innerHTML = `<span>📄<span class="ml-2">${file.name}</span></span><span class="text-xs text-blue-700">Sẽ gửi kèm khi giao việc</span>`;
        list.innerHTML = '';
        list.appendChild(row);
      }
      fileInput.addEventListener('change', function(){
        list.innerHTML = '';
        if (!this.files || this.files.length === 0) return;
        renderPreview(this.files[0]);
      });
    })();

    // Submit Form 3 via webhook endpoint (multipart form-data)
    document.getElementById('assign-form').onsubmit = async (e)=>{
      e.preventDefault();
      const requester = document.getElementById('rq-by').value.trim();
      const requesterEmail = (document.getElementById('rq-by-email')?.value || '').trim();
      const taskName = (document.getElementById('task-name')?.value || '').trim();
      const rqTime = document.getElementById('rq-time').value;
      let manHourRaw = document.getElementById('man-hour').value;
      const output = document.getElementById('output').value.trim();
      const assignee = (document.getElementById('f3-assignee').value || '').trim();
      const deadline = document.getElementById('deadline').value;
      const odooJira = document.getElementById('odoo-jira').value.trim();
      const rqPurpose = (document.getElementById('rq-purpose')?.value || '').trim();

      if(!requester || !taskName || !output || !manHourRaw || !assignee){ showToast('Vui lòng điền đủ trường bắt buộc.','error'); return; }
      
      // Tự động chuyển đổi dấu chấm thành dấu phẩy cho số thập phân
      manHourRaw = manHourRaw.replace(/\./g, ',');
      
      // Cập nhật giá trị trong input để người dùng thấy sự thay đổi
      document.getElementById('man-hour').value = manHourRaw;
      
      if(!/^\d+(,\d{1,2})?$/.test(manHourRaw)){ showToast('Công chuẩn tối đa 2 chữ số thập phân. Sử dụng dấu phẩy (,) thay vì dấu chấm (.)','error'); return; }

      const btn = e.target.querySelector('button[type="submit"]');
      const prev = btn ? btn.textContent : '';
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }

      // Generate Reqcode: QA.NB.DDMM-XXXXXX (X: A-Z0-9)
      const Reqcode = (function(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const ddmm = pad(d.getDate()) + pad(d.getMonth()+1);
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let rand = '';
        for (let i = 0; i < 6; i++) rand += chars[Math.floor(Math.random()*chars.length)];
        return `QA.NB.${ddmm}-${rand}`;
      })();

      const mapped = {
        requesterName: requester,
        requesterEmail: requesterEmail,
        requestDate: formatDdMmYyyyHHmm(rqTime || new Date()),
        itemName: taskName,
        Score: String(manHourRaw || '').trim(),
        changeReq: output,
        Assignee: assignee,
        desiredDate: deadline ? formatDdMmYyyy(deadline) : '',
        Odoojira: odooJira,
        purpose: rqPurpose,
        deptRequest: 'DQA',
        Reqcode: Reqcode
      };

      const fd = new FormData();
      Object.entries(mapped).forEach(([k,v])=> fd.append(k, v));
      // Also append explicitly for form-data pipelines
      try { fd.append('Reqcode', mapped.Reqcode || ''); } catch(_){ }
      const fileEl = document.getElementById('attach');
      if (fileEl && fileEl.files && fileEl.files.length){
        const f = fileEl.files[0];
        try { fd.append('file', f, f.name); } catch(_){ fd.append('file', f); }
      }

      try{
        let resp = await fetch(FORM3_ENDPOINT, { method: 'POST', body: fd });
        if (!resp.ok) {
          // Fallback: send JSON
          const r2 = await fetch(FORM3_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify({ data: [mapped] }) });
          if (!r2.ok) {
            const t = await r2.text();
            throw new Error(t || `HTTP ${r2.status}`);
          }
        }
        showToast('Đã giao việc và gửi dữ liệu.','success');
        e.target.reset();
        setRqTime();
        try{ const list = document.getElementById('f3-upload-list'); if (list) list.innerHTML = ''; }catch(_){ }
      }catch(err){
        console.error(err);
        showToast('Gửi thất bại.','error');
      }finally{
        if (btn) { btn.disabled = false; btn.textContent = prev || 'Giao việc'; }
      }
    };

    // ===== Form 4: filter popover & selection =====
    let F4_SELECTED_NAMES = new Set();
    let F4_ALL_NAMES = [];
    let F4_SUPPRESS_LOADING = false;

    // Form 4: cache dữ liệu để lọc client-side (không refetch khi bấm nút nhóm)
    let F4_LAST_NORMALIZED = [];
    let F4_LAST_MERGED = [];
    let F4_COUNTS_BY_NAME = new Map();
    let F4_LAST_PARAMS = { status: '', from: '', to: '', month: '' };

    // Predefined groups for Form 4 filters
    // Loại bỏ: Hà Mỹ Linh, Đỗ Thế Cường, Lê Thị Thanh Nhàn
    const F4_EXCLUDED = new Set(["Hà Mỹ Linh","Đỗ Thế Cường","Lê Thị Thanh Nhàn"]);
    const F4_GROUP_LINH = [
      "Bùi Đặng Quốc Huy","Nguyễn Hữu Thịnh","Trần Hiếu Nghĩa","Lại Quốc Lộc",
      "Lê Ngọc Ánh","Lê Văn Sơn","Nguyễn Thị Hiền","Phạm Thị Minh"
    ];
    const F4_GROUP_HIEU = [
      "Đỗ Quang Long","Phạm Thành Trung Kiên","Thái Thị Giang",
      "Vũ Thị Hằng","Đào Tuấn Kỳ","Lê Thị Thảo","Vũ Thị Thanh Hiền"
    ];
    function f4SetGroupSelection(names){
      if (!names || names.length === 0) {
        F4_SELECTED_NAMES.clear();
      } else {
        F4_SELECTED_NAMES = new Set(names);
      }
      // Lọc cục bộ từ cache, không gọi server
      renderForm4Local();
      try { renderF4Pivot(); } catch(_) {}
    }
    function f4UpdateGroupButtonsUI(){
      const btnAll = document.getElementById('f4-btn-all');
      const btnLinh = document.getElementById('f4-btn-linh');
      const btnHieu = document.getElementById('f4-btn-hieu');
      const reset = (btn)=>{ if(!btn) return; btn.classList.remove('bg-primary-blue','text-white'); btn.classList.add('bg-blue-50/30','text-primary-blue'); };
      const active = (btn)=>{ if(!btn) return; btn.classList.add('bg-primary-blue','text-white'); btn.classList.remove('bg-blue-50/30','text-primary-blue'); };
      reset(btnAll); reset(btnLinh); reset(btnHieu);
      const setEq = (a,b)=>{ if(a.size!==b.size) return false; for(const v of a){ if(!b.has(v)) return false; } return true; };
      const setLinh = new Set(F4_GROUP_LINH);
      const setHieu = new Set(F4_GROUP_HIEU);
      if (F4_SELECTED_NAMES.size === 0) active(btnAll);
      else if (setEq(F4_SELECTED_NAMES, setLinh)) active(btnLinh);
      else if (setEq(F4_SELECTED_NAMES, setHieu)) active(btnHieu);
    }

    function f4BuildFilterList(names){
      const list = document.getElementById('f4-filter-list');
      if (!list) return;
      list.innerHTML = '';
      const uniq = Array.from(new Set(names)).sort((a,b)=> a.localeCompare(b,'vi'));
      uniq.forEach(n=>{
        const safe = n.replace(/"/g,'&quot;');
        const checked = (F4_SELECTED_NAMES.size===0) || F4_SELECTED_NAMES.has(n);
        const row = document.createElement('label');
        row.className = 'flex items-center gap-2';
        row.setAttribute('data-name', n);
        row.innerHTML = `<input type="checkbox" value="${safe}" class="f4-filter-item h-4 w-4" ${checked?'checked':''}/><span>${safe}</span>`;
        list.appendChild(row);
      });
    }
    function f4SyncSelectionFromUI(){
      const list = document.getElementById('f4-filter-list');
      if (!list) return;
      const boxes = list.querySelectorAll('input.f4-filter-item');
      const picked = [];
      boxes.forEach(b=>{ if (b.checked) picked.push(b.value); });
      if (picked.length === boxes.length || picked.length === 0) {
        F4_SELECTED_NAMES.clear();
      } else {
        F4_SELECTED_NAMES = new Set(picked);
      }
    }
    (function f4InitFilterPopover(){
      const btn = document.getElementById('f4-filter-toggle');
      const pop = document.getElementById('f4-filter-pop');
      const list = document.getElementById('f4-filter-list');
      const search = document.getElementById('f4-filter-search');
      const selAll = document.getElementById('f4-filter-select-all');
      const clear = document.getElementById('f4-filter-clear');
      const applyBtn = document.getElementById('f4-filter-apply');
      if (!btn || !pop) return;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); pop.classList.toggle('hidden'); if(!pop.classList.contains('hidden')){ try{ search&&search.focus(); }catch(_){} }});
      document.addEventListener('click', (e)=>{ if (!pop || pop.classList.contains('hidden')) return; if (btn.contains(e.target) || pop.contains(e.target)) return; pop.classList.add('hidden'); });
      if (list) list.addEventListener('change', (e)=>{ /* không auto render khi tick */ });
      if (search) search.addEventListener('input', (e)=>{
        const q = (e.target.value||'').toLowerCase().trim();
        pop.querySelectorAll('label[data-name]').forEach(el=>{
          const nm = (el.getAttribute('data-name')||'').toLowerCase();
          el.style.display = nm.includes(q) ? '' : 'none';
        });
      });
      if (selAll) selAll.addEventListener('click',(e)=>{ e.preventDefault(); pop.querySelectorAll('input.f4-filter-item').forEach(cb=> cb.checked=true); });
      if (clear) clear.addEventListener('click',(e)=>{ e.preventDefault(); pop.querySelectorAll('input.f4-filter-item').forEach(cb=> cb.checked=false); });
      if (applyBtn) applyBtn.addEventListener('click',(e)=>{ e.preventDefault(); f4SyncSelectionFromUI(); pop.classList.add('hidden'); renderForm4(); f4SchedulePivot(); f4UpdateGroupButtonsUI(); });
    })();

    // Helper: đếm số tác vụ theo người với filter trạng thái
    async function f4FetchTaskCount(name, statusVal, fromVal, toVal){
      const headerMapF1 = {
        header_code: 'Mã',
        header_taskName: 'Tên tác vụ',
        header_status: 'Trạng thái',
        field_code: 'code',
        field_taskName: 'taskName',
        field_status: 'status'
      };
      const params = new URLSearchParams({
        ...headerMapF1,
        action: 'form1_lookup',
        person_name: name,
        timestamp: new Date().toISOString()
      });
      if (fromVal) params.append('from', fromVal);
      if (toVal) params.append('to', toVal);
      async function fetchJson(url){
        const r = await fetch(url, { method: 'GET' });
        const text = await r.text();
        let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
        return { ok: r.ok, parsed, raw: text, status: r.status };
      }
      function pickRows(json){
        if (!json) return [];
        if (Array.isArray(json)) return json;
        const candidates = ['data','rows','result','records','items','list'];
        for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
        try{
          const queue=[json]; const seen=new Set();
          while(queue.length){
            const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
            for (const v of Object.values(cur)){
              if (Array.isArray(v) && v.length && typeof v[0]==='object') return v;
              if (v && typeof v==='object') queue.push(v);
            }
          }
        }catch(_){}
        return [];
      }
      function getV(obj, keys){
        const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
        for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      }
      try{
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        let first = await fetchJson(testUrl);
        if (!first.ok || (first.parsed && first.parsed.code === 0 && /could not be started/i.test(String(first.parsed.message||'')))){
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          first = await fetchJson(prodUrl);
        }
        if (!first.ok) return 0;
        let rows = pickRows(first.parsed ?? (first.raw ? JSON.parse(first.raw) : null));
        if (statusVal === 'Doing'){
          rows = rows.filter(item=>{
            const s = String(getV(item,['status','trangthai','trang_thai','trạng thái'])||'').toLowerCase();
            return s.includes('doing') || s.includes('đang');
          });
        }
        return rows.length;
      }catch(_){ return 0; }
    }

    // Form 4 logic: GET Doing data and render two columns
    async function renderForm4(){
      const body = document.getElementById('f4-body');
      const bodyAll = document.getElementById('f4-body-all');
      const chartWrap = document.getElementById('f4-chart-container');
      if (!F4_SUPPRESS_LOADING){
        if (chartWrap) chartWrap.style.display = 'none';
        if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} F4_CHART = null; }
      }
      const statusSelEl = document.getElementById('f4-status');
      const statusValPreview = statusSelEl ? statusSelEl.value : 'Doing';
      const colSpan = (statusValPreview === 'All') ? 10 : 3;
      if (!F4_SUPPRESS_LOADING){
        body.innerHTML = `<tr><td colspan='${colSpan}' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>`;
      }
      try{
        const urlTest = 'https://iatzhxxuk.tino.page/webhook/9cdcf54b-f98f-42b8-ab15-824d5b6da050';
        const urlProd = urlTest.replace('/webhook-test/', '/webhook/');
        const params = new URLSearchParams();
        const statusEl = document.getElementById('f4-status');
        const statusVal = (statusEl && statusEl.value) ? statusEl.value : 'Doing';
        params.append('status', statusVal);
        // Date range filter -> from month
        const monthInput = document.getElementById('f4-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        let fromVal = '';
        let toVal = '';
        if (monthVal) {
          try{
            const [yy, mm] = monthVal.split('-');
            const firstDay = `${yy}-${mm}-01`;
            const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
            const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
            fromVal = firstDay; toVal = lastDay;
          }catch(_){ }
        }
        if (fromVal) params.append('from', fromVal);
        if (toVal) params.append('to', toVal);
        // Query mapping for 2 output columns
        params.append('header_employee', 'Nhân viên');
        params.append('header_current_manhour', 'Công chuẩn hiện tại');
        params.append('field_employee', 'employee');
        params.append('field_current_manhour', 'manhour');
        params.append('header_task_count', 'Số tác vụ trong tháng');
        params.append('field_task_count', 'taskCount');
        params.append('_ts', Date.now().toString());
        // Debug: log the exact URL being requested
        try { console.log('Form4 GET (test):', `${urlTest}?${params.toString()}`); } catch(_) {}

        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const text = await r.text();
          let parsed = null; try { parsed = JSON.parse(text); } catch { parsed = null; }
          return { ok: r.ok, ct: r.headers.get('content-type')||'', parsed, raw: text, status: r.status };
        }

        let first = await fetchJson(`${urlTest}?${params.toString()}`);
        // Fallback to production webhook if test not active or server error like n8n "Can't determine which item to use"
        if (!first.ok || /could not be started/i.test(String(first.parsed?.message||'')) || /Can't determine which item to use|Can't determine which item to use/i.test(first.raw||'')){
          try { console.warn('Form4 GET fallback -> prod'); } catch(_){ }
          first = await fetchJson(`${urlProd}?${params.toString()}`);
        }
        if(!first.ok){
          throw new Error(first.raw || `HTTP ${first.status}`);
        }
        const data = Array.isArray(first.parsed) || first.parsed ? first.parsed : (first.raw ? JSON.parse(first.raw) : null);
        function pickRowsDeep(json){
          if (!json) return [];
          if (Array.isArray(json) && json.length && typeof json[0] === 'object') return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k]) && json[k].length && typeof json[k][0] === 'object') return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        const rows = pickRowsDeep(data);
        try{ LS.setJSON('f4.cache', { params: { status: statusVal, from: fromVal, to: toVal, month: monthVal }, rows, ts: Date.now() }); LS.set('f4.lastUpdated', String(Date.now())); }catch(_){ }
        if(!rows.length){ body.innerHTML = "<tr><td colspan='3' class='px-3 py-3 text-center text-gray-500'>Không có dữ liệu</td></tr>"; if(chartWrap) chartWrap.style.display='none'; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        const normalized = rows.map(r=>{
          const name = getV(r,[
            'field_employee','employee','employee_name','nhanvien','nhan_vien','nhân viên','họ tên','ho_ten','user','name',
            'assignee','assignee_name','pic','nguoi_phu_trach','người phụ trách','người nhận','receiver','recipient'
          ]).toString().trim();
          const manRaw = getV(r,[
            'field_current_manhour','manhour','manhour_current','current_manhour','current_manhours','man_hours','man_hour',
            'congchuan','cong_chuan','công chuẩn hiện tại','công chuẩn nhận','công chuẩn tổng tháng','cong_chuan_thang','hours','score'
          ]);
          const man = Number(manRaw);
          const countRaw = getV(r,[
            'field_task_count','taskcount','task_count','count','sotacvu','so_tac_vu','số tác vụ','số tác vụ trong tháng',
            'so_tac_vu_thang','sotacvu_thang','tasks','total_tasks','task_total','so_luong','so_luong_tac_vu','so_dau_muc',
            'so_doing','doing_count','count_doing','so_luong_doing','in_month_count','count_in_month'
          ]);
          const count = Number(countRaw);
          return { name: name || '-', manhour: isNaN(man) ? 0 : man, count: isNaN(count) ? null : count };
        }).filter(x=>x.name && x.name !== '-');
        // Bổ sung mọi nhân sự từ danh sách chuẩn để không bị thiếu tên (vd: "Hà Mỹ Linh")
        const baseNames = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.filter(n=> !F4_EXCLUDED.has(n)) : [];
        const unionNamesRaw = Array.from(new Set([ ...normalized.map(x=>x.name), ...baseNames ]));
        const unionNames = unionNamesRaw.filter(n=> !F4_EXCLUDED.has(n));
        const merged = unionNames.map(n=>{
          const exist = normalized.find(x=>x.name===n);
          return exist ? exist : { name: n, manhour: 0, count: null };
        });
        // Lưu cache để phục vụ lọc cục bộ không cần refetch
        F4_LAST_NORMALIZED = normalized.slice();
        F4_LAST_MERGED = merged.slice();
        F4_LAST_PARAMS = { status: statusVal, from: fromVal, to: toVal, month: monthVal };
        F4_COUNTS_BY_NAME = new Map();
        // Cập nhật danh sách người trong popover
        F4_ALL_NAMES = unionNames;
        f4BuildFilterList(F4_ALL_NAMES);
        // Lọc theo các tên đã chọn (Set rỗng = tất cả)
        const selectedNames = Array.from(F4_SELECTED_NAMES);
        const filtered = selectedNames.length ? merged.filter(x => F4_SELECTED_NAMES.has(x.name)) : merged;
        if (!filtered.length) { body.innerHTML = "<tr><td colspan='3' class='px-3 py-3 text-center text-gray-500'>Không có dữ liệu</td></tr>"; if(chartWrap) chartWrap.style.display='none'; return; }
        const normalizedSorted = filtered.slice().sort((a,b)=> b.manhour - a.manhour);
        // Nếu trạng thái là All, mở rộng cột theo yêu cầu và lấy dữ liệu server
        const isAll = (statusVal === 'All');
        async function fetchStatsFor(name){
          try{
            const qs = new URLSearchParams();
            qs.append('action','form4_employee_stats');
            qs.append('employee', name);
            if (fromVal) qs.append('from', fromVal);
            if (toVal) qs.append('to', toVal);
            const r = await fetch(`${urlTest}?${qs.toString()}`);
            const t = await r.text();
            let j = null; try{ j = JSON.parse(t); }catch{}
            const obj = (j && typeof j==='object') ? j : {};
            const getN = (k)=>{ const v = obj[k]; const n = Number(v); return isNaN(n)?0:n; };
            const done = getN('done');
            const ahead = getN('ahead');
            const ontime = getN('ontime');
            const late = getN('late');
            const rateOntime = getN('rate_ontime');
            const rateLate = getN('rate_late');
            const rateAhead = getN('rate_ahead');
            return { done, ahead, ontime, late, rateOntime, rateLate, rateAhead };
          }catch(_){ return { done:0,ahead:0,ontime:0,late:0,rateOntime:0,rateLate:0,rateAhead:0 }; }
        }
        // Cập nhật header động theo chế độ
        (function updateHeader(){
          const headRow = document.getElementById('f4-head-row');
          if (!headRow) return;
          const isAll = (statusVal === 'All');
          try {
            const mainTable = document.getElementById('f4-main-table');
            if (mainTable) {
              if (isAll) {
                mainTable.classList.add('min-w-[1100px]');
                mainTable.classList.remove('min-w-[480px]');
              } else {
                mainTable.classList.add('min-w-[480px]');
                mainTable.classList.remove('min-w-[1100px]');
              }
            }
          } catch(_) {}
          headRow.innerHTML = `
            <th class="px-3 py-2 relative">
              <button id="f4-filter-toggle" class="inline-flex items-center gap-1 hover:text-primary-blue">Nhân viên <span class="text-xs">▾</span></button>
              <div id="f4-filter-pop" class="absolute z-20 mt-2 left-0 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 hidden">
                <div class="flex items-center gap-2 mb-2">
                  <input id="f4-filter-search" type="text" placeholder="Tìm người..." class="flex-1 border border-blue-300 rounded bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                  <div class="flex items-center gap-3">
                    <button id="f4-filter-select-all" class="underline">Chọn tất cả</button>
                    <button id="f4-filter-clear" class="underline">Bỏ chọn</button>
                  </div>
                  <button id="f4-filter-apply" class="px-2 py-1 rounded bg-primary-blue text-white text-xs">Lọc</button>
                </div>
                <div id="f4-filter-list" class="max-h-60 overflow-auto space-y-1 text-sm">
                  <label class="flex items-center gap-2" data-name="(Chỗ trống)"><input type="checkbox" value="(Chỗ trống)" class="f4-filter-item h-4 w-4"/><span>(Chỗ trống)</span></label>
                </div>
              </div>
            </th>
            <th class="px-3 py-2">Công chuẩn hiện tại</th>
            <th class="px-3 py-2">Số tác vụ</th>
            ${isAll ? `
              <th class="px-3 py-2">Số DONE</th>
              <th class="px-3 py-2">Vượt tiến độ</th>
              <th class="px-3 py-2">Đúng tiến độ</th>
              <th class="px-3 py-2">Chậm tiến độ</th>
              <th class="px-3 py-2">Tỷ lệ vượt (%)</th>
              <th class="px-3 py-2">Tỷ lệ đúng (%)</th>
              <th class="px-3 py-2">Tỷ lệ chậm (%)</th>
            `: ''}`;
          // re-bind filter popover events
          try { f4InitFilterPopover(); } catch(_) {}
        })();

        const html = await (async ()=>{
          const rowsHtml = [];
          for (const x of normalizedSorted){
            if (!isAll){
              rowsHtml.push(`
                <tr>
             <td class="px-3 py-2">
               <button class="text-primary-blue hover:underline" data-emp="${x.name}">${x.name}</button>
             </td>
             <td class="px-3 py-2">${x.manhour.toFixed(2)}</td>
             <td class="px-3 py-2"><span class="emp-count" data-emp-count="${x.name}">${(x.count==null)?'<span class="spinner"></span>':String(x.count)}</span></td>
                </tr>`);
              continue;
            }
            const st = await fetchStatsFor(x.name);
            rowsHtml.push(`
              <tr>
                <td class="px-3 py-2">${x.name}</td>
                <td class="px-3 py-2">${x.manhour.toFixed(2)}</td>
                <td class="px-3 py-2">${(x.count==null)?'':String(x.count)}</td>
                <td class="px-3 py-2">${(st.done ?? '')}</td>
                <td class="px-3 py-2">${(st.ahead ?? '')}</td>
                <td class="px-3 py-2">${(st.ontime ?? '')}</td>
                <td class="px-3 py-2">${(st.late ?? '')}</td>
                <td class="px-3 py-2">${isNaN(st.rateOntime)?'':(st.rateOntime.toFixed(0)+"%")}</td>
                <td class="px-3 py-2">${isNaN(st.rateLate)?'':(st.rateLate.toFixed(0)+"%")}</td>
                <td class="px-3 py-2">${isNaN(st.rateAhead)?'':(st.rateAhead.toFixed(0)+"%")}</td>
              </tr>`);
          }
          return rowsHtml.join('');
        })();
        if (isAll) {
          if (bodyAll) { bodyAll.innerHTML = html; try{ enableTableDrag('f4-body-all'); }catch(_){ } }
        } else {
        body.innerHTML = html; try{ enableTableDrag('f4-body'); }catch(_){ }
        // Điền số tác vụ bất đồng bộ theo trạng thái hiện tại
        const statusForCount = statusVal;
        const names = normalizedSorted.filter(x=> x.count == null && !F4_COUNTS_BY_NAME.has(x.name)).map(x=>x.name);
        const findCountEl = (n)=>{
          const all = body.querySelectorAll('.emp-count');
          for (const el of all){ if ((el.getAttribute('data-emp-count')||'') === n) return el; }
          return null;
        };
        const promises = names.map(async n=>{
          const c = await f4FetchTaskCount(n, statusForCount, fromVal, toVal);
          const el = findCountEl(n);
          if (el) {
            el.textContent = String(c);
            try { const tr = el.closest('tr'); if (tr) tr.setAttribute('data-task-count', String(c)); } catch(_) {}
          }
          try { F4_COUNTS_BY_NAME.set(n, c); } catch(_) {}
        });
        Promise.allSettled(promises).then(()=>{ try { f4ApplyCountFilter(); } catch(_) {} }).catch(()=>{});
        }
        // Render bar chart
        const labels = normalizedSorted.map(x=> x.name);
        const values = normalizedSorted.map(x=> x.manhour);
        if (chartWrap) chartWrap.style.display = '';
        const canvas = document.getElementById('f4-chart');
        if (canvas && typeof Chart !== 'undefined'){
          const ctx = canvas.getContext('2d');
          if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} }
          F4_CHART = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Công chuẩn nhận',
                data: values,
                backgroundColor: 'rgba(90, 169, 255, 0.6)',
                borderColor: '#5aa9ff',
                borderWidth: 1,
                hoverBackgroundColor: 'rgba(59, 130, 246, 0.7)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Công chuẩn nhận' }
                },
                x: {
                  title: { display: true, text: 'Nhân viên' },
                  ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 }
                }
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (ctx)=> ` ${Number(ctx.raw).toFixed(2)}`
                  }
                }
              }
            }
          });
        }
      }catch(err){
        body.innerHTML = `<tr><td colspan='3' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message || err)}</td></tr>`;
        if (chartWrap) chartWrap.style.display = 'none';
        if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} F4_CHART = null; }
      }
    }
    function restoreForm4FromCache(){
      try{
        const cached = LS.getJSON('f4.cache');
        if (!cached || !Array.isArray(cached.rows) || !cached.rows.length) return false;
        // kích hoạt UI cơ bản và ghi chú thời gian
        updateLastUpdatedNote('f4-search','f4.lastUpdated');
        // Dùng pipeline render hiện tại: gán rows vào F4_LAST_MERGED để re-render nhanh
        const rows = cached.rows;
        const getV = (obj, keys)=>{ const lower = Object.keys(obj||{}).reduce((a,k)=>{ a[k.toLowerCase()] = obj[k]; return a; },{}); for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; } return ''; };
        const normalized = rows.map(r=>({
          name: getV(r,['employee','employee_name','nhanvien','nhân viên','name','assignee','pic']) || '-',
          manhour: Number(getV(r,['manhour','current_manhour','congchuan']))||0,
          count: null
        })).filter(x=>x.name && x.name!=='-');
        F4_LAST_MERGED = normalized;
        renderForm4Local();
        return true;
      }catch(_){ return false; }
    }
    // Render lại Form 4 từ cache khi đổi nhóm (lọc client-side, không refetch)
    function renderForm4Local(){
      try{
        const body = document.getElementById('f4-body');
        const chartWrap = document.getElementById('f4-chart-container');
        if (chartWrap) chartWrap.style.display = 'none';
        if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} F4_CHART = null; }
        if (!Array.isArray(F4_LAST_MERGED) || F4_LAST_MERGED.length===0){
          // Chưa có cache -> tải một lần
          return renderForm4();
        }
        const selected = Array.from(F4_SELECTED_NAMES);
        const filtered = selected.length ? F4_LAST_MERGED.filter(x=> F4_SELECTED_NAMES.has(x.name)) : F4_LAST_MERGED.slice();
        if (!filtered.length){ body.innerHTML = "<tr><td colspan='3' class='px-3 py-3 text-center text-gray-500'>Không có dữ liệu</td></tr>"; return; }
        const normalizedSorted = filtered.slice().sort((a,b)=> b.manhour - a.manhour);
        const rowsHtml = [];
        for (const x of normalizedSorted){
          const cached = F4_COUNTS_BY_NAME.get(x.name);
          const baseCnt = (x.count==null) ? cached : x.count;
          const cntText = (baseCnt==null || Number.isNaN(baseCnt)) ? "<span class='spinner'></span>" : String(baseCnt);
          rowsHtml.push(`
            <tr>
              <td class="px-3 py-2">
                <button class="text-primary-blue hover:underline" data-emp="${x.name}">${x.name}</button>
              </td>
              <td class="px-3 py-2">${x.manhour.toFixed(2)}</td>
              <td class="px-3 py-2"><span class="emp-count" data-emp-count="${x.name}">${cntText}</span></td>
            </tr>`);
        }
        body.innerHTML = rowsHtml.join('');
        try{ enableTableDrag('f4-body'); }catch(_){ }
        // Bổ sung: tải số tác vụ bất đồng bộ cho các tên chưa có
        const statusForCount = (F4_LAST_PARAMS && F4_LAST_PARAMS.status) ? F4_LAST_PARAMS.status : 'Doing';
        const fromVal = F4_LAST_PARAMS?.from || '';
        const toVal = F4_LAST_PARAMS?.to || '';
        const namesNeed = normalizedSorted.filter(x=> (x.count==null) && !F4_COUNTS_BY_NAME.has(x.name)).map(x=> x.name);
        const findCountEl = (n)=>{ const all = body.querySelectorAll('.emp-count'); for (const el of all){ if ((el.getAttribute('data-emp-count')||'') === n) return el; } return null; };
        const promises = namesNeed.map(async n=>{ const c = await f4FetchTaskCount(n, statusForCount, fromVal, toVal); const el = findCountEl(n); if (el) { el.textContent = String(c); try { const tr = el.closest('tr'); if (tr) tr.setAttribute('data-task-count', String(c)); } catch(_) {} } try { F4_COUNTS_BY_NAME.set(n, c); } catch(_) {} });
        Promise.allSettled(promises).then(()=>{ try { f4ApplyCountFilter(); } catch(_) {} }).catch(()=>{});
        // Vẽ chart theo dữ liệu đã lọc
        const labels = normalizedSorted.map(x=> x.name);
        const values = normalizedSorted.map(x=> x.manhour);
        if (chartWrap) chartWrap.style.display = '';
        const canvas = document.getElementById('f4-chart');
        if (canvas && typeof Chart !== 'undefined'){
          const ctx = canvas.getContext('2d');
          if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} }
          F4_CHART = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Công chuẩn nhận', data: values, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1, hoverBackgroundColor: 'rgba(59, 130, 246, 0.7)' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Công chuẩn nhận' } }, x: { title: { display: true, text: 'Nhân viên' }, ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx)=> ` ${Number(ctx.raw).toFixed(2)}` } } } }
          });
        }
        try { f4ApplyCountFilter(); } catch(_) {}
      }catch(_){}
    }
    // ===== Form 4: Modal chi tiết theo nhân viên =====
    const detailModal = document.getElementById('detail-modal');
    const detailBody = document.getElementById('detail-body');
    const detailNameEl = document.getElementById('detail-name');
    const detailNote = document.getElementById('detail-note');
    const detailClose = document.getElementById('detail-close');

    function openDetailModal(empName, filter, from, to){
      if (!detailModal) return;
      detailNameEl.textContent = empName || '';
      detailBody.innerHTML = `<tr><td colspan="10" class="px-3 py-3 text-center text-gray-500"><span class="spinner mr-2"></span>Đang tải...</td></tr>`;
      detailNote.textContent = filter === 'Doing' ? 'Chỉ hiển thị tác vụ đang Doing.' : 'Hiển thị tất cả tác vụ.';
      detailModal.classList.add('open');
      detailModal.setAttribute('aria-hidden','false');
      try{
        const isForm5Visible = (function(){
          try{
            const sec5 = document.getElementById('form5');
            return sec5 && !sec5.classList.contains('hidden');
          }catch(_){ return false; }
        })();
        if (isForm5Visible && Array.isArray(F5A_RAW_ALL) && F5A_RAW_ALL.length){
          renderDetailTasksFromF5All(empName, from, to).catch(()=> renderDetailTasks(empName, filter, from, to));
          return;
        }
      }catch(_){ }
      renderDetailTasks(empName, filter, from, to).catch(()=>{});
    }
    function closeDetailModal(){
      if (!detailModal) return;
      detailModal.classList.remove('open');
      detailModal.setAttribute('aria-hidden','true');
    }
    if (detailClose) detailClose.onclick = closeDetailModal;
    if (detailModal) detailModal.addEventListener('click', (e)=>{ if(e.target===detailModal) closeDetailModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && detailModal && detailModal.classList.contains('open')) closeDetailModal(); });

    // Renderer dùng đúng nguồn dữ liệu của Form 5 và thuật toán lọc "Công chuẩn đã nhận"
    async function renderDetailTasksFromF5All(name, from, to){
      try{
        if (!Array.isArray(F5A_RAW_ALL) || !F5A_RAW_ALL.length){
          try{
            const monthGuess = (from || '').slice(0,7);
            await f5aFetchAllOnce(monthGuess || '', from || '', to || '');
          }catch(_){ }
        }
        const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
        function hasVal(v){ return v != null && String(v).trim() !== ''; }
        const assigneeKeys = [
          'Assignee','Assignee Name','AssigneeName','Assignee name',
          'Phụ trách','Phụ trách chính','Người phụ trách','Người xử lý','Người nhận mẫu','Người nhận',
          'employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'
        ];
        const taskNameKeys = ['Task Name','Tên tác vụ','Task','Công việc','Tên Task','Mã','taskname','ten_tac_vu','ten','name','title'];
        const scoreKeys = ['Điểm','Score','score'];
        const altScoreKeys = ['Công chuẩn công việc nhận ','Công chuẩn công việc nhận','Công chuẩn','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
        const statusKeys = ['Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái'];
        const statusByWishKeys = ['Hiện trạng theo hạn mong muốn','hien trang theo han mong muon','Hiện trạng theo hạn mong muon','status_by_wish','statusbywish','statusWish','status_wish','ht_theo_han_mong_muon'];
        const finishedDateKs = ['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','Ngày kết thúc','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
        function norm(s){ return String(s||'').trim(); }
        function normNameTxt(s){
          try{
            const raw = String(s||'').trim();
            const noAcc = (typeof vnLower==='function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
            return noAcc.replace(/\s+/g,' ').trim();
          }catch(_){ return String(s||'').toLowerCase().trim(); }
        }
        function equalsName(a,b){ return normNameTxt(a) === normNameTxt(b); }
        function getV(obj, keys){
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; });
          for (const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v = lower[c1] ?? lower[c2]; if (v!==undefined) return v; }
          return '';
        }
        function toNum(v){ try{ let s=String(v||'').trim(); if(!s) return 0; s=s.replace(/\s|\u00A0/g,''); s=s.replace(/[%₫đvnd]/gi,''); if (s.includes(',')) s=s.replace(/\./g,'').replace(',', '.'); else s=s.replace(/\./g,''); const n=Number(s); return Number.isFinite(n)?n:0; }catch(_){ return 0; } }
        function isCanceled(o){ const f = String(getV(o, finishedDateKs)||'').toLowerCase(); const st = String(getV(o, statusKeys)||'').toLowerCase(); return f.includes('cancel') || st.includes('cancel') || st.includes('hủy') || st.includes('huỷ'); }
        function pickName(o){ let n = norm(getV(o, assigneeKeys)); if (!n || n.toLowerCase()==='nan') n = 'Chưa phân công'; return n; }
        function iso(d){ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; }
        function inRangeIso(ds){ if (!hasVal(from) && !hasVal(to)) return true; if (!ds) return false; if (hasVal(from) && ds < from) return false; if (hasVal(to) && ds > to) return false; return true; }
        const listSameMonth = [];
        const listPrevMonth = [];
        rows.forEach(o=>{
          const tname = norm(getV(o, taskNameKeys));
          if (!tname) return;
          if (isCanceled(o)) return;
          const n = pickName(o);
          if (!equalsName(n, name)) return;
          const rq = norm(getV(o,[
            '📆 ngày yêu cầu','📆 Ngày yêu cầu','📆 Ngày yêu cầu ',
            'ngày yêu cầu','Ngày yêu cầu','requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui'
          ]));
          const done = norm(getV(o, finishedDateKs));
          const doneD = parseDateFlexible(done);
          const doneIso = doneD ? iso(doneD) : '';
          if (!inRangeIso(doneIso)) return;
          const code = norm(getV(o,['code','ma','taskcode','mã']));
          const status = norm(getV(o, statusKeys));
          const man = toNum(getV(o, scoreKeys)) || toNum(getV(o, altScoreKeys));
          const wish = norm(getV(o,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn','Hạn mong muốn ','Hạn mong muốn']));
          const act = norm(getV(o,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng','Ngày có thể đáp ứng']));
          // Số giờ đánh giá thực tế: cố gắng lấy từ các field thường gặp
          const actualHours = norm(getV(o,[ 'Số giờ đánh giá thực tế','so gio danh gia thuc te','số giờ đánh giá thực tế','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te' ]));
          // Chuẩn hóa hiển thị (display only)
          const actualNum = toNum(actualHours);
          const actualHoursDisp = Number.isFinite(actualNum) ? formatNumberVi(actualNum, 2, 2) : (actualHours||'');
          const manDisp = formatNumberVi(Number(man)||0, 2, 2);
          const wishDisp = formatDdMmYyyy(wish);
          let wishPlus2Disp = '';
          try{
            const dW = parseDateFlexible(wish);
            if (dW){
              const plus1 = new Date(dW.getFullYear(), dW.getMonth(), dW.getDate() + 1);
              wishPlus2Disp = formatDdMmYyyy(plus1);
            }
          }catch(_){ }
          const doneDisp = formatDdMmYyyy(done);
          // Hiện trạng theo hạn mong muốn: ưu tiên lấy trực tiếp từ dữ liệu server
          let statusVsWish = norm(getV(o, statusByWishKeys));
          // Fallback nếu server không có cột này
          if (!statusVsWish){
            try{
              const dDone = parseDateFlexible(done);
              const dWish = parseDateFlexible(wish);
              if (dWish && dDone){
                const wishPlus1 = new Date(dWish.getFullYear(), dWish.getMonth(), dWish.getDate() + 1);
                statusVsWish = (dDone.getTime() <= wishPlus1.getTime()) ? 'Đúng hạn yêu cầu' : 'Trễ hạn yêu cầu';
              }
            }catch(_){ }
          }
          // Tính Trạng thái theo công chuẩn dựa trên so sánh số giờ thực tế và công chuẩn (chuẩn hoá dấu thập phân)
          let statusByMan = '';
          const actualIsZero = Number.isFinite(actualNum) && Math.abs(actualNum) < 1e-9;
          try{
            const actualNum = toNum(actualHours);
            const EPS = 1e-4;
            const hasDone = !!parseDateFlexible(done);
            if (actualIsZero) {
              statusByMan = 'Thiếu dữ liệu';
            } else if (hasDone && !isNaN(actualNum) && !isNaN(man)){
              // Áp dụng dung sai 10% cho "Đúng tiến độ"
              const tolerance = Math.max(EPS, Math.abs(Number(man)) * 0.10);
              if (actualNum > Number(man) + tolerance) statusByMan = 'Chậm tiến độ';
              else if (Math.abs(actualNum - Number(man)) <= tolerance) statusByMan = 'Đúng tiến độ';
              else statusByMan = 'Vượt tiến độ';
            }
          }catch(_){ }
          const rqD = parseDateFlexible(rq);
          const rqIso = rqD ? iso(rqD) : '';
          // Chỉ tính các tác vụ HOÀN THÀNH trong tháng chọn (dùng doneIso đã tính ở trên)
          if (!doneIso) return; // chưa có ngày hoàn thành -> không thuộc "Done trong tháng"
          if ((hasVal(from) && doneIso < from) || (hasVal(to) && doneIso > to)) return; // hoàn thành ngoài tháng
          // Bỏ Cancel
          const stLower = String(status||'').toLowerCase();
          const doneLowerTxt = String(done||'').toLowerCase();
          if (stLower.includes('cancel') || stLower.includes('hủy') || stLower.includes('huỷ') || /cancel/i.test(doneLowerTxt)) return;

          const item = { code, tname, status, man, rq, wish, act, done, actualHours, statusVsWish, statusByMan, actualHoursDisp, manDisp, wishDisp, doneDisp, wishPlus2Disp, actualIsZero };
          // Nhận trong tháng hay nhận tháng trước (nhưng đều hoàn thành trong tháng do lọc trên)
          if (rqIso && hasVal(from) && rqIso >= from && rqIso <= to) listSameMonth.push(item); else listPrevMonth.push(item);
        });
        if (!listSameMonth.length && !listPrevMonth.length){
          const hasRange = Boolean((from||'').trim() || (to||'').trim());
          const msg = hasRange ? 'Không có tác vụ trong tháng đã chọn.' : 'Không có tác vụ.';
          detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">${msg}</td></tr>`;
          return;
        }
        let stt = 0;
        function renderRow(it){ return `
          <tr>
            <td class="px-3 py-2">${++stt}</td>
            <td class="px-3 py-2">${it.code}</td>
            <td class="px-3 py-2">${it.tname}</td>
            <td class="px-3 py-2">${(function(v){ try{ return v? formatDdMmYyyy(v):''; }catch(_){ return v||''; } })(it.rq||it.rqDisp||'')}</td>
            <td class="px-3 py-2${it.actualIsZero ? ' bg-amber-100 text-amber-800' : ''}">${it.actualHoursDisp||''}</td>
            <td class="px-3 py-2">${it.manDisp||''}</td>
            <td class="px-3 py-2">${(function(s){ const t=String(s||'').toLowerCase(); let cls='bg-blue-100 text-blue-800'; if(t.includes('thiếu dữ liệu')) cls='bg-amber-100 text-amber-800'; else if(t.includes('vượt tiến độ')) cls='bg-blue-100 text-blue-800'; else if(t.includes('đúng tiến độ')||t.includes('dung tien do')) cls='bg-green-100 text-green-800'; else if(t.includes('chậm tiến độ')||t.includes('cham tien do')) cls='bg-red-100 text-red-800'; else if(t.includes('chờ phê duyệt')||t.includes('cho phe duyet')) cls='bg-orange-100 text-orange-800'; else if(t.includes('cancel')||t.includes('hủy')||t.includes('huỷ')) cls='bg-gray-200 text-gray-700'; else if(t.includes('doing')||t.includes('đang')) cls='bg-blue-100 text-blue-800'; return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`; })(it.statusByMan || it.status)}</td>
            <td class="px-3 py-2">${it.wishDisp||it.wish||''}${it.wishPlus2Disp? `<div class=\"text-xs text-gray-500 mt-0.5\">Hạn +1: ${it.wishPlus2Disp}</div>`:''}</td>
            <td class="px-3 py-2">${it.doneDisp||it.done||''}</td>
            <td class="px-3 py-2">${(function(s){ s=String(s||''); const isOn = /đúng hạn yêu cầu/i.test(s); const isLate = /trễ hạn yêu cầu/i.test(s); if(isOn) return `<span class=\"px-2 py-1 rounded text-xs bg-green-100 text-green-800\">${s}</span>`; if(isLate) return `<span class=\"px-2 py-1 rounded text-xs bg-red-100 text-red-800\">${s}</span>`; return s; })(it.statusVsWish||'')}</td>
          </tr>
        `; }
        const groupHeader = (title)=> `<tr class="bg-blue-50"><td class="px-3 py-2 font-semibold" colspan="10">${title}</td></tr>`;
        const headerRow = `<tr class="bg-slate-100 text-sm font-semibold"><td class="px-3 py-2">STT</td><td class="px-3 py-2">Mã</td><td class="px-3 py-2">Tên tác vụ</td><td class="px-3 py-2">Ngày yêu cầu</td><td class="px-3 py-2">Số giờ đánh giá thực tế</td><td class="px-3 py-2">Công chuẩn</td><td class="px-3 py-2">Trạng thái theo công chuẩn</td><td class="px-3 py-2">Hạn mong muốn</td><td class="px-3 py-2">Ngày hoàn thành</td><td class="px-3 py-2">Hiện trạng theo hạn mong muốn</td></tr>`;
        const htmlParts = [];
        htmlParts.push(groupHeader('Nhận trong tháng này và hoàn thành trong tháng'));
        htmlParts.push(headerRow);
        htmlParts.push(listSameMonth.length ? listSameMonth.map(renderRow).join('') : `<tr><td colspan="10" class="px-3 py-2 text-gray-500">Không có dữ liệu</td></tr>`);
        htmlParts.push(groupHeader('Nhận tháng trước nhưng hoàn thành trong tháng'));
        htmlParts.push(headerRow);
        htmlParts.push(listPrevMonth.length ? listPrevMonth.map(renderRow).join('') : `<tr><td colspan="10" class="px-3 py-2 text-gray-500">Không có dữ liệu</td></tr>`);
        detailBody.innerHTML = htmlParts.join('');
      }catch(_){
        detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-red-600" colspan="8">Lỗi hiển thị dữ liệu.</td></tr>`;
      }
    }

    async function renderDetailTasks(name, filter, from, to){
      const headerMapF1 = {
        header_requester: 'Người yêu cầu',
        header_requestDate: 'Ngày yêu cầu',
        header_wishDue: 'Hạn mong muốn',
        header_actualDue: 'Hạn đáp ứng',
        header_code: 'Mã',
        header_taskName: 'Tên tác vụ',
        header_manHour: 'Công chuẩn',
        header_status: 'Trạng thái',
        field_requester: 'requester',
        field_requestDate: 'requestDate',
        field_wishDue: 'wishDue',
        field_actualDue: 'actualDue',
        field_code: 'code',
        field_taskName: 'taskName',
        field_manHour: 'manHour',
        field_status: 'status'
      };
      const params = new URLSearchParams({
        ...headerMapF1,
        action: 'form1_lookup',
        person_name: name,
        timestamp: new Date().toISOString()
      });
      // KHÔNG truyền from/to lên server để tránh lọc sai mốc (server có thể chỉ lọc theo Ngày yêu cầu);
      // Thay vào đó, lọc cục bộ theo tháng bằng logic refDate ở dưới để khớp với "Công chuẩn đã nhận".
      function getV(obj, keys){
        const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
        for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      }
      async function fetchJson(url){
        const r = await fetch(url, { method: 'GET' });
        const text = await r.text();
        let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
        return { ok: r.ok, parsed, raw: text, status: r.status };
      }
      try{
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        let first = await fetchJson(testUrl);
        if (!first.ok || (first.parsed && first.parsed.code === 0 && /could not be started/i.test(String(first.parsed.message||'')))){
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          first = await fetchJson(prodUrl);
        }
        if (!first.ok) throw new Error(first.raw || `HTTP ${first.status}`);
        const data = first.parsed ?? (first.raw ? JSON.parse(first.raw) : null);
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){
              const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0]==='object') return v;
                if (v && typeof v==='object') queue.push(v);
              }
            }
          }catch(_){}
          return [];
        }
        let rows = pickRows(data);
        if (filter === 'Doing'){
          rows = rows.filter(item=>{
            const statusText = String(getV(item,['status','trangthai','trang_thai','trạng thái'])||'');
            const s = statusText.toLowerCase();
            const isDoing = s.includes('doing') || s.includes('đang');
            return isDoing;
          });
        }
        // Lọc cục bộ theo tháng dựa trên mốc tham chiếu refDate (requestDate -> actualDue -> wishDue -> doneDate), loại Cancel
        (function(){
          try{
            const fromVal = (from || '').trim();
            const toVal = (to || '').trim();
            function hasVal(v){ return v != null && String(v).trim() !== ''; }
            function getText(o, keys){
              const lower = Object.keys(o||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = o[k]; return acc; },{});
              for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return String(v); }
              return '';
            }
            function isCanceledRow(o){
              const st = getText(o,['status','trangthai','trang_thai','trạng thái']).toLowerCase();
              const doneDate = getText(o,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh']);
              return st.includes('cancel') || st.includes('hủy') || st.includes('huỷ') || /cancel/i.test(doneDate||'');
            }
            function chooseRefDate(o){
              const rq = getText(o,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','📆 ngày yêu cầu']);
              const act = getText(o,['actualdue','handapung','han_dap_ung','completiondate']);
              const wish= getText(o,['wishdue','hanmongmuon','han_mong_muon','desireddue']);
              const done= getText(o,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh']);
              return hasVal(rq) ? rq : (hasVal(act) ? act : (hasVal(wish) ? wish : (hasVal(done) ? done : '')));
            }
            try{ if (!window.F5A_LOG) window.F5A_LOG = {}; if (!window.F5A_LOG.filteredOut) window.F5A_LOG.filteredOut = []; }catch(_){ }
            if (fromVal || toVal){
              rows = rows.filter(o=>{
                if (isCanceledRow(o)) return false;
                const ref = chooseRefDate(o);
                const d = parseDateFlexible(ref);
                if (!d){ try{ window.F5A_LOG.filteredOut.push({ reason:'bad_date', row:o, ref }); }catch(_){ } return false; }
                const ds = d.toISOString().slice(0,10);
                if (fromVal && ds < fromVal){ try{ window.F5A_LOG.filteredOut.push({ reason:'before_range', row:o, refDate: ds }); }catch(_){ } return false; }
                if (toVal && ds > toVal){ try{ window.F5A_LOG.filteredOut.push({ reason:'after_range', row:o, refDate: ds }); }catch(_){ } return false; }
                return true;
              });
            } else {
              rows = rows.filter(o=> { const drop = isCanceledRow(o); try{ if (drop){ if (!window.F5A_LOG) window.F5A_LOG={}; if(!window.F5A_LOG.filteredOut) window.F5A_LOG.filteredOut=[]; window.F5A_LOG.filteredOut.push({ reason:'cancel', row:o }); } }catch(_){ } return !drop; });
            }
            try{ console.info('[F5A] Month filter result:', { kept: rows.length, filtered: (window.F5A_LOG&&window.F5A_LOG.filteredOut)? window.F5A_LOG.filteredOut.length:0 }); }catch(_){ }
          }catch(_){ }
        })();
        if (!rows.length){
          const hasRange = Boolean((from||'').trim() || (to||'').trim());
          const msg = hasRange ? 'Không có tác vụ trong tháng đã chọn.' : `Không có tác vụ${filter==='Doing'?' Doing':''}.`;
          detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">${msg}</td></tr>`;
          return;
        }
        // Helper parse date (hỗ trợ YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY, YYYY/MM/DD, có/không giờ)
        function toDate(v){
          if(!v) return null;
          const s = String(v).trim();
          let m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
          if (m) {
            const d = +m[1], mo = +m[2], y = m[3].length===2 ? +('20'+m[3]) : +m[3];
            const dt = new Date(y, mo-1, d); return isNaN(dt) ? null : dt;
          }
          m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
          if (m) {
            const dt = new Date(+m[1], +m[2]-1, +m[3]); return isNaN(dt) ? null : dt;
          }
          const dt = new Date(s);
          return isNaN(dt) ? null : dt;
        }

        let stt = 0;
        const html = rows.map(item=>{
          const code = getV(item,['code','ma','taskcode','mã']);
          const tname = getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']);
          const status = getV(item,['status','trangthai','trang_thai','trạng thái']);
          const man = getV(item,['manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','công chuẩn']);
          const rq = getV(item,['📆 ngày yêu cầu','requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']);
          const wish = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
          const act = getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
          const done = getV(item,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh','completion','done_date','ngày hoàn thành']);
          const actualHours = getV(item,[ 'so gio danh gia thuc te','số giờ đánh giá thực tế','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te' ]);
          // Hiển thị đồng nhất
          const manNum = parseNumberFlexible(man);
          const actualNum = parseNumberFlexible(actualHours);
          const manDisp = Number.isFinite(manNum) ? formatNumberVi(manNum, 2, 2) : String(man||'');
          const actualHoursDisp = Number.isFinite(actualNum) ? formatNumberVi(actualNum, 2, 2) : String(actualHours||'');
          const wishDisp = formatDdMmYyyy(wish);
          const doneDisp = formatDdMmYyyy(done);
          let wishPlus1Disp = '';
          try{
            const dW = toDate(wish);
            if (dW){
              const plus1 = new Date(dW.getFullYear(), dW.getMonth(), dW.getDate() + 1);
              wishPlus1Disp = formatDdMmYyyy(plus1);
            }
          }catch(_){ }
          // Tính Trạng thái theo công chuẩn bằng so sánh số giờ thực tế và công chuẩn (hỗ trợ dấu phẩy/dấu chấm)
          let statusByMan = '';
          try{
            // Custom parse function to handle comma decimal separator
            const parseNumberFlexible = (value) => {
              if (!value) return NaN;
              const str = String(value).trim();
              // Replace comma with dot for decimal separator
              const normalized = str.replace(',', '.');
              const num = parseFloat(normalized);
              return isNaN(num) ? NaN : num;
            };
            
            const manNum = parseNumberFlexible(man);
            const actualNum = parseNumberFlexible(actualHours);
            const EPS = 1e-4;
            const hasDone = !!toDate(done);
            if (Number.isFinite(actualNum) && Math.abs(actualNum) < EPS) {
              statusByMan = 'Thiếu dữ liệu';
            } else if (hasDone && !isNaN(actualNum) && !isNaN(manNum)){
              // Cho phép sai lệch 10% cho "Đúng tiến độ"
              const tolerance = manNum * 0.1; // 10% tolerance
              const diff = Math.abs(actualNum - manNum);
              
              if (actualNum > manNum + tolerance) {
                statusByMan = 'Chậm tiến độ';
              } else if (diff <= tolerance) {
                statusByMan = 'Đúng tiến độ';
              } else {
                statusByMan = 'Vượt tiến độ';
              }
            }
          }catch(_){ }
          let statusVsWish = '';
          try{
            const dDone = toDate(done);
            const dWish = toDate(wish);
            if (dWish && dDone){
              const wishPlus1 = new Date(dWish.getFullYear(), dWish.getMonth(), dWish.getDate() + 1);
              statusVsWish = (dDone.getTime() <= wishPlus1.getTime()) ? 'Đúng hạn yêu cầu' : 'Trễ hạn yêu cầu';
            }
          }catch(_){ }

          // Late completed highlight (yellow)
          const dueForCompare = act || wish || '';
          const isLate = (()=>{ const d1 = toDate(done), d2 = toDate(dueForCompare); return d1 && d2 ? (d1.getTime() > d2.getTime()) : false; })();
          let trClass = isLate ? 'bg-yellow-100' : '';
          // Overdue doing highlight + today highlight (match Form 1)
          const sLower = (status||'').toLowerCase();
          const isDoing = sLower.includes('doing') || sLower.includes('đang');
          const dueDate = parseDateFlexible(dueForCompare);
          if (isDoing && dueDate){
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const dueDayStart = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
            const isSameDay = dueDayStart.getTime() === todayStart.getTime();
            const isPast = dueDayStart.getTime() < todayStart.getTime();
            if (isSameDay) trClass = 'bg-yellow-100';
            else if (isPast) trClass = 'bg-red-100';
          }

          return `
            <tr class="${trClass}">
              <td class="px-3 py-2">${++stt}</td>
              <td class="px-3 py-2">${code}</td>
              <td class="px-3 py-2">${tname}</td>
              <td class="px-3 py-2${(function(n){ const EPS=1e-4; return (Number.isFinite(parseNumberFlexible(actualHours)) && Math.abs(parseNumberFlexible(actualHours))<EPS) ? ' bg-amber-100 text-amber-800' : ''; })()}">${actualHoursDisp}</td>
              <td class="px-3 py-2">${manDisp}</td>
              <td class="px-3 py-2">${(function(s){ const t=String(s||'').toLowerCase(); let cls='bg-blue-100 text-blue-800'; if(t.includes('thiếu dữ liệu')) cls='bg-amber-100 text-amber-800'; else if(t.includes('vượt tiến độ')) cls='bg-blue-100 text-blue-800'; else if(t.includes('đúng tiến độ')||t.includes('dung tien do')) cls='bg-green-100 text-green-800'; else if(t.includes('chậm tiến độ')||t.includes('cham tien do')) cls='bg-red-100 text-red-800'; else if(t.includes('chờ phê duyệt')||t.includes('cho phe duyet')) cls='bg-orange-100 text-orange-800'; else if(t.includes('cancel')||t.includes('hủy')||t.includes('huỷ')) cls='bg-gray-200 text-gray-700'; else if(t.includes('doing')||t.includes('đang')) cls='bg-blue-100 text-blue-800'; return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`; })(statusByMan && statusByMan.trim() ? statusByMan : status)}</td>
              <td class="px-3 py-2">${wishDisp||wish||''}${wishPlus1Disp? `<div class=\"text-xs text-gray-500 mt-0.5\">Hạn +1: ${wishPlus1Disp}</div>`:''}</td>
              <td class="px-3 py-2">${doneDisp||done||''}</td>
              <td class="px-3 py-2">${(function(s){ s=String(s||''); const isOn = /đúng hạn yêu cầu/i.test(s); const isLate = /trễ hạn yêu cầu/i.test(s); if(isOn) return `<span class=\"px-2 py-1 rounded text-xs bg-green-100 text-green-800\">${s}</span>`; if(isLate) return `<span class=\"px-2 py-1 rounded text-xs bg-red-100 text-red-800\">${s}</span>`; return s; })(statusVsWish)}</td>
            </tr>
          `;
        }).join('');
        detailBody.innerHTML = html;
      }catch(err){
        detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-red-600" colspan="9">Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }

    // Copy on click and open link for storage (Form 1)
    const f1StorageLink = document.getElementById('f1-storage-link');
    if (f1StorageLink) {
      f1StorageLink.addEventListener('click', async ()=>{
        const url = f1StorageLink.getAttribute('href') || '';
        try { await navigator.clipboard.writeText(url); showToast('Đã copy liên kết.','success'); }
        catch(_) { /* ignore copy error to not block open */ }
      });
    }
    // Trigger fetch only when nhấn Tra cứu ở Form 4
    const f4Btn = document.getElementById('f4-search');
    if (f4Btn) {
      f4Btn.addEventListener('click', (e)=>{ e.preventDefault(); renderForm4(); f4UpdateGroupButtonsUI(); });
    }
    // Pivot handlers
    (function initF4Pivot(){
      const refresh = document.getElementById('f4-pivot-refresh');
      if (refresh) refresh.addEventListener('click', (e)=>{ e.preventDefault(); F4_PIVOT_ROWS_ALL = []; renderF4Pivot(); });
      // auto render once when form loads
      try { renderF4Pivot(); } catch(_) {}
    })();

    // Render detailed list of overdue Doing tasks (mirrors Form 1 highlight)
    async function renderF4Pivot(){
      if (F4_PIVOT_BUSY) return;
      F4_PIVOT_BUSY = true;
      const body = document.getElementById('f4-pivot-body');
      const sumTotal = document.getElementById('f4-pivot-sum-total');
      const note = document.getElementById('f4-pivot-note');
      if (!body) return;
      body.innerHTML = `<tr><td colspan="7" class="px-3 py-3 text-center text-gray-500"><span class='spinner mr-2'></span>Đang tải...</td></tr>`;
      const fromVal = document.getElementById('f4-from')?.value || '';
      const toVal = document.getElementById('f4-to')?.value || '';
      const base = F4_ALL_NAMES && F4_ALL_NAMES.length ? F4_ALL_NAMES : (FORM1_NAMES || []);
      const names = base.filter(n=> !F4_EXCLUDED.has(n));
      const selected = Array.from(F4_SELECTED_NAMES);
      const targetNames = selected.length ? names.filter(n => F4_SELECTED_NAMES.has(n)) : names.slice();

      // Nếu cache chưa có hoặc phạm vi thời gian đổi -> tải và xây cache
      const needRefetch = (!Array.isArray(F4_PIVOT_ROWS_ALL) || !F4_PIVOT_ROWS_ALL.length
        || F4_PIVOT_LAST_PARAMS.from !== fromVal || F4_PIVOT_LAST_PARAMS.to !== toVal);

      if (needRefetch){
        F4_PIVOT_ROWS_ALL = [];
        F4_PIVOT_LAST_PARAMS = { from: fromVal, to: toVal };
        await Promise.all(names.map(async (name)=>{
          try{
            const headerMap = {
              header_requestDate: 'Ngày yêu cầu', header_wishDue: 'Hạn mong muốn', header_actualDue: 'Hạn đáp ứng',
              header_status: 'Trạng thái', header_code: 'Mã', header_taskName: 'Tên tác vụ',
              field_requestDate: 'requestDate', field_wishDue: 'wishDue', field_actualDue: 'actualDue',
              field_status: 'status', field_code: 'code', field_taskName: 'taskName'
            };
            const qs = new URLSearchParams({ ...headerMap, action:'form1_lookup', person_name: name, timestamp: new Date().toISOString() });
            if (fromVal) qs.append('from', fromVal);
            if (toVal) qs.append('to', toVal);
            const u = `${WEBHOOK_URL}?${qs.toString()}`;
            const r = await fetch(u);
            const t = await r.text();
            let json = null; try{ json = JSON.parse(t); }catch{ json = null; }
            let rows = [];
            if (Array.isArray(json)) rows = json; else if (json && typeof json==='object'){
              const keys = ['data','rows','result','records','items','list'];
              for (const k of keys){ if (Array.isArray(json[k])) { rows = json[k]; break; } }
            }
            function getV(o, keys){ const L = Object.keys(o||{}).reduce((a,k)=>{a[k.toLowerCase()]=o[k];return a;},{}); for(const k of keys){ const v=L[k.toLowerCase()]; if(v!==undefined) return v; } return ''; }
            rows.forEach(it=>{
              const statusText = String(getV(it,['status','trangthai','trang_thai','trạng thái'])||'');
              const s = statusText.toLowerCase();
              const isDoing = s.includes('doing') || s.includes('đang');
              if (!isDoing) return;
              const wish = getV(it,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
              const act = getV(it,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
              const due = parseDateFlexible(act || wish || '');
              if (!due) return;
              const now = new Date();
              if (now.getTime() >= due.getTime()){
                F4_PIVOT_ROWS_ALL.push({
                  assignee: name,
                  code: getV(it,['code','ma','taskcode','mã']),
                  taskName: getV(it,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']),
                  status: statusText,
                  requestDate: getV(it,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']),
                  wishDue: wish,
                  actualDue: act
                });
              }
            });
          }catch(_){ /* skip one name */ }
        }));
      }

      // Lọc cục bộ từ cache theo nhóm đang chọn
      let rowsOut = F4_PIVOT_ROWS_ALL.filter(r => targetNames.includes(r.assignee));
      rowsOut.sort((a,b)=>{
        const byName = a.assignee.localeCompare(b.assignee,'vi');
        if (byName !== 0) return byName;
        const da = parseDateFlexible(a.actualDue || a.wishDue || '') || new Date(0);
        const db = parseDateFlexible(b.actualDue || b.wishDue || '') || new Date(0);
        return da.getTime() - db.getTime();
      });

      if (!rowsOut.length){
        body.innerHTML = `<tr><td colspan="7" class="px-3 py-3 text-center text-gray-500">Không có dữ liệu</td></tr>`;
      } else {
        const todayStart = (()=>{ const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); })();
        function toDate(v){ try{ return parseDateFlexible(v||''); }catch(_){ return null; } }
        body.innerHTML = rowsOut.map(r=>{
          const due = toDate(r.actualDue || r.wishDue || '');
          let trClass = 'bg-red-50';
          if (due){
            const dueStart = new Date(due.getFullYear(), due.getMonth(), due.getDate());
            if (dueStart.getTime() === todayStart.getTime()) trClass = 'bg-yellow-100';
            else if (dueStart.getTime() < todayStart.getTime()) trClass = 'bg-red-100';
          }
          return `<tr class="${trClass}">
          <td class="px-3 py-2">${r.assignee}</td>
          <td class="px-3 py-2">${r.code}</td>
          <td class="px-3 py-2">${r.taskName}</td>
          <td class="px-3 py-2">${r.status}</td>
          <td class="px-3 py-2">${r.requestDate}</td>
          <td class="px-3 py-2">${r.wishDue}</td>
          <td class="px-3 py-2">${r.actualDue}</td>
          </tr>`;
        }).join('');
        try{ enableTableDrag('f4-pivot-body'); }catch(_){ }
      }
      if (sumTotal) sumTotal.textContent = String(rowsOut.length);
      if (note) note.textContent = 'Danh sách tác vụ Doing bị quá hạn (cache cục bộ; nhấn Làm mới để tải lại)';
      F4_PIVOT_BUSY = false;
    }
    // Group filter buttons
    (function initF4GroupButtons(){
      const btnAll = document.getElementById('f4-btn-all');
      const btnLinh = document.getElementById('f4-btn-linh');
      const btnHieu = document.getElementById('f4-btn-hieu');
      if (btnAll) btnAll.addEventListener('click', (e)=>{ e.preventDefault(); f4SetGroupSelection([]); f4UpdateGroupButtonsUI(); f4SchedulePivot(); });
      if (btnLinh) btnLinh.addEventListener('click', (e)=>{ e.preventDefault(); f4SetGroupSelection(F4_GROUP_LINH); f4UpdateGroupButtonsUI(); f4SchedulePivot(); });
      if (btnHieu) btnHieu.addEventListener('click', (e)=>{ e.preventDefault(); f4SetGroupSelection(F4_GROUP_HIEU); f4UpdateGroupButtonsUI(); f4SchedulePivot(); });
      // set initial visual state
      f4UpdateGroupButtonsUI();
    })();
    // Trigger fetch only when nhấn Tra cứu ở Form 6
    const f6Btn = document.getElementById('f6-search');
    if (f6Btn) {
      f6Btn.addEventListener('click', async (e)=>{
        e.preventDefault();
        console.log('[DEBUG] Button clicked:', e.target);
        console.log('[DEBUG] Current form visible:', document.querySelector('section:not(.hidden)')?.id);
        if (f6Btn.disabled) return;
        const prev = f6Btn.textContent;
        f6Btn.disabled = true;
        f6Btn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { 
          console.log('[DEBUG] Form 6 Tra cứu button clicked, calling renderForm6List()');
          await renderForm6List(); 
          console.log('[DEBUG] renderForm6List() completed');
        }
        finally {
          f6Btn.disabled = false;
          f6Btn.textContent = prev || 'Tra cứu';
          try{ updateLastUpdatedNote('f6-search','f6.lastUpdated'); }catch(_){ }
        }
      });
    }
    // Default month and change handler for Form 6 filtering
    (function initF6MonthFilter(){
      const m = document.getElementById('f6-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      try{
        const last = LS.get('f6.selectedMonth');
        if (!m.value) m.value = (last && /\d{4}-\d{2}/.test(last)) ? last : `${yy}-${mm}`;
      }catch(_){ if (!m.value) m.value = `${yy}-${mm}`; }
      // on change, re-apply local filter if data already loaded and persist selection
      if (!m._bound){
        m.addEventListener('change', ()=>{
          try{ LS.set('f6.selectedMonth', m.value||''); }catch(_){ }
          try{
            if (Array.isArray(F6_LAST_ROWS) && F6_LAST_ROWS.length) {
              if (typeof applyForm6LocalFilter === 'function') applyForm6LocalFilter();
              else renderForm6List();
            }
          }catch(_){ }
        });
        m._bound = true;
      }
    })();
    // Trigger fetch for Form 5 - P1, P2 (shared data source)
    const f5aBtnP1 = document.getElementById('f5a-search-p1');
    const f5aBtnP2 = document.getElementById('f5a-search-p2');
    
    if (f5aBtnP1) { 
      f5aBtnP1.addEventListener('click', async (e)=>{ 
        e.preventDefault(); 
        if(f5aBtnP1.disabled) return;
        f5aBtnP1.disabled = true;
        const prevText = f5aBtnP1.textContent;
        f5aBtnP1.innerHTML = "<span class='spinner mr-1'></span>Đang tải...";
        try{ 
          await renderForm5All(); 
          console.log('[F5A P1] Data loaded successfully.');
        }catch(err){ 
          console.error('[F5A P1] Search error:', err); 
          showToast('Lỗi tải dữ liệu P1', 'error');
        }finally{
          f5aBtnP1.disabled = false;
          f5aBtnP1.textContent = prevText;
        }
      }); 
    }
    
    if (f5aBtnP2) { 
      f5aBtnP2.addEventListener('click', async (e)=>{ 
        e.preventDefault(); 
        if(f5aBtnP2.disabled) return;
        f5aBtnP2.disabled = true;
        const prevText = f5aBtnP2.textContent;
        f5aBtnP2.innerHTML = "<span class='spinner mr-1'></span>Đang tải...";
        try{ 
          await renderForm5All(); 
          // Sau khi render P2, điều chỉnh cột theo dữ liệu Form 10
          await adjustForm5P2WithAttendance();
          console.log('[F5A P2] Data loaded successfully.');
        }catch(err){ 
          console.error('[F5A P2] Search error:', err); 
          showToast('Lỗi tải dữ liệu P2', 'error');
        }finally{
          f5aBtnP2.disabled = false;
          f5aBtnP2.textContent = prevText;
        }
      }); 
    }
    
    // Trigger fetch for Form 5 - P3 (separate data source)
    const f5aBtnP3 = document.getElementById('f5a-search-p3');
    if (f5aBtnP3) { 
      f5aBtnP3.addEventListener('click', async (e)=>{ 
        e.preventDefault(); 
        if(f5aBtnP3.disabled) return;
        f5aBtnP3.disabled = true;
        const prevText = f5aBtnP3.textContent;
        f5aBtnP3.innerHTML = "<span class='spinner mr-1'></span>Đang tải...";
        try{ 
          const monthInput = document.getElementById('f5a-month');
          const month = monthInput ? monthInput.value : '';
          await f5aFetchP3Data(month);
          renderForm5P3();
          console.log('[F5A P3] Data loaded successfully.');
        }catch(err){ 
          console.error('[F5A P3] Search error:', err); 
          showToast('Lỗi tải dữ liệu P3', 'error');
        }finally{
          f5aBtnP3.disabled = false;
          f5aBtnP3.textContent = prevText;
        }
      }); 
    }
    
    // Trigger fetch for Form 5 - P4 (uses P3 data source)
    const f5aBtnP4 = document.getElementById('f5a-search-p4');
    if (f5aBtnP4) { 
      f5aBtnP4.addEventListener('click', async (e)=>{ 
        e.preventDefault(); 
        if(f5aBtnP4.disabled) return;
        f5aBtnP4.disabled = true;
        const prevText = f5aBtnP4.textContent;
        f5aBtnP4.innerHTML = "<span class='spinner mr-1'></span>Đang tải...";
        try{ 
          const monthInput = document.getElementById('f5a-month');
          const month = monthInput ? monthInput.value : '';
          
          // P4 always fetches P3 data first (same source)
          await f5aFetchP3Data(month);
          
          // Then render P4 using P3 data
          renderForm5P4();
          showToast('Dữ liệu P4 đã được cập nhật', 'success');
        }catch(err){ 
          console.error('[F5A P4] Search error:', err); 
          showToast('Lỗi tải dữ liệu P4', 'error');
        }finally{
          f5aBtnP4.disabled = false;
          f5aBtnP4.textContent = prevText;
        }
      }); 
    }

    // ===== Form 5 P2: Adjust with Form 10 attendance =====
    function f5aGetAttendanceMapByMonth(month){
      try{
        const map = new Map();
        let rows = Array.isArray(window.F10_ATT_ROWS) ? window.F10_ATT_ROWS : [];
        // Restore from localStorage cache if empty
        if ((!rows || !rows.length) && typeof LS !== 'undefined'){
          try{
            const cached = LS.getJSON('f10.att');
            if (cached && Array.isArray(cached.rows)){
              rows = cached.rows.slice();
              window.F10_ATT_ROWS = rows;
              window.F10_ATT_META = { month: cached.month || '' };
            }
          }catch(_){ }
        }
        rows.forEach(r=>{
          const emp = (typeof f10GetV==='function') ? f10GetV(r, ['nhân sự','nhan su','employee','name']) : (r['Nhân sự']||r['employee']||r['name']||'');
          const m = (typeof f10GetV==='function') ? f10GetV(r, ['tháng','thang','month']) : (r['Tháng']||r['month']||'');
          const total = (typeof f10GetV==='function') ? f10GetV(r, ['tổng giờ công đi làm','tong gio cong di lam','total','totalworkhours']) : (r['Tổng giờ công đi làm']||r['total']||r['totalWorkHours']||'');
          const matches = (typeof f10MonthMatches==='function') ? f10MonthMatches(m, month) : true;
          if (!emp || !matches) return;
          const raw = String(emp).trim();
          map.set(raw, total);
          try{
            const nk = (typeof vnKey==='function') ? vnKey(raw) : raw.toLowerCase().trim();
            map.set(`__norm__:${nk}`, total);
          }catch(_){ }
        });
        return map;
      }catch(_){ return new Map(); }
    }

    async function adjustForm5P2WithAttendance(){
      try{
        const tbody = document.getElementById('f5a-body-p2');
        if (!tbody) return;
        const monthEl = document.getElementById('f5a-month');
        const month = monthEl ? (monthEl.value||'') : '';
        // Ensure attendance loaded for this month
        const needFetch = !(window.F10_ATT_META && window.F10_ATT_META.month === (month||''));
        if (needFetch && typeof f10FetchAttendance === 'function'){
          try{ await f10FetchAttendance(month); }catch(_){ }
        }
        const attMap = f5aGetAttendanceMapByMonth(month);
        // Iterate rows and rewrite 4th and 5th columns
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.forEach(tr=>{
          const tds = tr.querySelectorAll('td');
          if (!tds || tds.length < 5) return;
          let name = (tds[0].textContent||'').trim();
          // Clean decorations: take first segment before '(' or line-break or ' - '
          try{ name = name.split('\n')[0]; }catch(_){ }
          try{ name = name.split('(')[0]; }catch(_){ }
          try{ name = name.split(' - ')[0]; }catch(_){ }
          name = name.trim();
          if (!name) return;
          // Current manhour received (col 3)
          const manText = (tds[2].textContent||'').trim();
          // Try exact, then alias, then case-insensitive match
          let totalText = attMap.get(name) || '';
          if (!totalText && typeof resolveAlias==='function'){
            const alias = resolveAlias(name);
            totalText = attMap.get(alias) || '';
          }
          if (!totalText){
            const key = (typeof vnKey==='function') ? vnKey(name) : String(name).toLowerCase().trim();
            // Direct normalized key hit
            totalText = attMap.get(`__norm__:${key}`) || '';
            if (!totalText){
              for (const k of attMap.keys()){
                if (String(k).startsWith('__norm__:')){
                  if (k === `__norm__:${key}`){ totalText = attMap.get(k); break; }
                } else {
                  const kk = (typeof vnKey==='function') ? vnKey(k) : String(k).toLowerCase().trim();
                  if (kk === key){ totalText = attMap.get(k); break; }
                }
              }
            }
          }
          // Update col 4: nếu không khớp thì để rỗng, không ghi 0
          tds[3].textContent = totalText ? String(totalText) : '';
          // Nếu vẫn rỗng, thử hiển thị debug ẩn (console) 1 lần đầu
          if (!totalText){
            try{ console.debug('[P2] No attendance match for:', name, 'month:', month, 'map keys:', Array.from(attMap.keys())); }catch(_){ }
          }
          // Compute Hệ số = manReceived / totalWorkHours
          function toNum(v){ try{ return (typeof parseNumberFlexible==='function') ? parseNumberFlexible(v) : Number(String(v).replace(/[^0-9.,-]/g,'').replace('.', '').replace(',', '.')); }catch(_){ return NaN; } }
          const man = toNum(manText);
          const denom = toNum(totalText);
          const coef = (Number.isFinite(man) && Number.isFinite(denom) && Math.abs(denom) > 1e-9) ? (man/denom) : NaN;
          tds[4].textContent = Number.isFinite(coef) ? coef.toFixed(2) : '';
        });
      }catch(_){ }
    }
    
    // Auto render once when Form 5 first shows - DISABLED to prevent interference with Form 6
    try {
      // setTimeout(()=>{ try{ renderForm5All(); }catch(_){ } }, 300); // Disabled
      // Rebind khi user thay đổi chế độ biểu đồ để tránh mất handler sau khi chuyển form
      const modeSel = document.getElementById('f5a-mode');
      if (modeSel && !modeSel._bound){
        modeSel.addEventListener('change', ()=>{ try{ renderForm5All(); }catch(_){ } });
        modeSel._bound = true;
      }
      const refreshBtn = document.getElementById('f5a-refresh');
      if (refreshBtn && !refreshBtn._bound){
        refreshBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ renderForm5All(); }catch(_){ } });
        refreshBtn._bound = true;
      }
    } catch(_) {}
    // Tự động render khi đổi trạng thái
    const f4StatusHidden = document.getElementById('f4-status');
    if (f4StatusHidden) f4StatusHidden.value = 'Doing';
    const f4FromInput = document.getElementById('f4-from');
    const f4ToInput = document.getElementById('f4-to');
    if (f4FromInput) f4FromInput.addEventListener('change', ()=>{ renderForm4(); f4SchedulePivot(); });
    if (f4ToInput) f4ToInput.addEventListener('change', ()=>{ renderForm4(); f4SchedulePivot(); });
    const f4CountFilterInput = document.getElementById('f4-count-filter');
    if (f4CountFilterInput) f4CountFilterInput.addEventListener('input', ()=> f4ApplyCountFilter());
    const f4PeopleSel2 = document.getElementById('f4-people');
    if (f4PeopleSel2) f4PeopleSel2.addEventListener('change', ()=> renderForm4());
    // Click tên nhân viên để xem chi tiết
    const f4Body = document.getElementById('f4-body');
    if (f4Body) {
      f4Body.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-emp]');
        if (!btn) return;
        const name = btn.getAttribute('data-emp') || '';
        const filter = (document.getElementById('f4-status')?.value === 'Doing') ? 'Doing' : 'All';
        const fromVal = (document.getElementById('f4-from')?.value || '');
        const toVal = (document.getElementById('f4-to')?.value || '');
        if (name) openDetailModal(name, filter, fromVal, toVal);
      });
    }

    // Form 4: filter rows by "số tác vụ" (>= input)
    function f4ApplyCountFilter(){
      const input = document.getElementById('f4-count-filter');
      const body = document.getElementById('f4-body');
      if (!input || !body) return;
      const raw = (input.value || '').trim();
      const threshold = raw === '' ? NaN : parseInt(raw, 10);
      const rows = body.querySelectorAll('tr');
      rows.forEach(tr=>{
        const cEl = tr.querySelector('.emp-count');
        if (!cEl) return;
        const val = parseInt((cEl.textContent || '').trim(), 10);
        if (isNaN(threshold)) {
          tr.style.display = '';
        } else if (isNaN(val)) {
          tr.style.display = '';
        } else {
          tr.style.display = (val >= threshold) ? '' : 'none';
        }
      });
    }

    // ===== Form 6: submit and list ideas =====
    async function renderForm6List(){
      console.log('[DEBUG] renderForm6List() started');
      const body = document.getElementById('f6-body');
      const aggBody = document.getElementById('f6-agg-body');
      const aggNote = document.getElementById('f6-agg-note');
      console.log('[DEBUG] Elements found:', { body: !!body, aggBody: !!aggBody, aggNote: !!aggNote });
      if (!body) return;
      body.innerHTML = "<tr><td colspan='7' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      const headerMapF6 = {
        header_submitDate: 'Ngày nộp',
        header_employee: 'Nhân viên',
        header_title: 'Tiêu đề ý tưởng',
        header_problem: 'Vấn đề nhận diện',
        header_solution: 'Giải pháp',
        header_managerOpinion: 'Ý kiến trưởng phòng',
        header_status: 'Trạng thái',
        field_submitDate: 'submitDate',
        field_employee: 'employee',
        field_title: 'title',
        field_problem: 'problem',
        field_solution: 'solution',
        field_managerOpinion: 'managerOpinion',
        field_status: 'status'
      };
      const params = new URLSearchParams({ ...headerMapF6, action: 'form6_list', _ts: Date.now().toString() });
      async function fetchJson(url){
        const r = await fetch(url, { method: 'GET' });
        const t = await r.text();
        let parsed=null; try{ parsed=JSON.parse(t);}catch{}
        return { ok:r.ok, parsed, raw:t, status:r.status };
      }
      function pickRows(json){
        if (!json) return [];
        if (Array.isArray(json)) return json;
        const cands=['data','rows','result','records','items','list'];
        for (const k of cands){ if (Array.isArray(json?.[k])) return json[k]; }
        try{
          const q=[json], seen=new Set();
          while(q.length){
            const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
            for (const v of Object.values(cur)){ if (Array.isArray(v) && v.length && typeof v[0]==='object') return v; if (v && typeof v==='object') q.push(v); }
          }
        }catch(_){}
        return [];
      }
      console.log('[DEBUG] Form 6 calling URL:', `${FORM6_LIST_URL}?${params.toString()}`);
      console.log('[DEBUG] FORM6_LIST_URL value:', FORM6_LIST_URL);
      let first = await fetchJson(`${FORM6_LIST_URL}?${params.toString()}`);
      console.log('[DEBUG] First response:', { ok: first.ok, status: first.status, parsed: first.parsed, raw: first.raw });
      if (!first.ok || (first.parsed && first.parsed.code===0 && /could not be started/i.test(String(first.parsed.message||'')))){
        console.log('[DEBUG] Retrying with webhook URL...');
        first = await fetchJson(`${FORM6_LIST_URL.replace('/webhook-test/','/webhook/')}?${params.toString()}`);
        console.log('[DEBUG] Second response:', { ok: first.ok, status: first.status, parsed: first.parsed, raw: first.raw });
      }
      if (!first.ok){
        console.log('[DEBUG] Fetch failed:', first);
        body.innerHTML = `<tr><td colspan='7' class='px-3 py-3 text-center text-red-600'>Lỗi tải: ${String(first.raw||first.status)}</td></tr>`;
        return;
      }
      const rows = pickRows(first.parsed ?? (first.raw ? JSON.parse(first.raw) : null));
      console.log('[DEBUG] Parsed rows:', rows.length, 'items:', rows);
      if (!rows.length){
        console.log('[DEBUG] No rows found, showing empty state');
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Chưa có dữ liệu</td></tr>';
        F5_LAST_COUNT = 0;
        F6_LAST_ROWS = [];
        if (aggBody) aggBody.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Chưa có dữ liệu</td></tr>';
        if (aggNote) aggNote.textContent = '';
        return;
      }
      const getV = (obj, keys)=>{
        const lower = Object.keys(obj||{}).reduce((a,k)=>{ a[k.toLowerCase()] = obj[k]; return a; },{});
        for (const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      };
      // Normalize to cache for client-side month filtering
      F6_LAST_ROWS = rows.map((item)=>{
        const submitDate = getV(item,['submitdate','date','submit_date','ngaynop','ngay_nop','ngày nộp']);
        const employee = getV(item,['employee','nhanvien','nhan_vien','nhân viên']);
        const title = getV(item,['title','tieude','tieu_de','tiêu đề ý tưởng','nội dung đề xuất']);
        const problem = getV(item,['problem','van_de','vande','vấn đề nhận diện']);
        const solution = getV(item,['solution','giai_phap','giaiphap','giải pháp']);
        const managerOpinion = getV(item,[
          'manageropinion','manager_opinion','y_kien_truong_phong','ý kiến trưởng phòng','ykien_truong_phong','ykien_tp',
          'ykien','y_kien','ykien_duyet','ykien_phe_duyet','tp dqa nhận xét','tp_dqa_nhan_xet','nhận xét','nhan xet'
        ]);
        // Trạng thái: quét thêm các biến thể thường gặp
        const statusRaw = getV(item,[
          'status','trangthai','trang_thai','trạng thái','phe_duyet','phê duyệt','approval','approve','approved',
          'duyet','đã duyệt','ket_qua','kết quả','result','tinh_trang','tình trạng','state','trang thai'
        ]) || managerOpinion || getV(item,['Trạng thái']);
        return { submitDate, employee, title, problem, solution, managerOpinion, status: statusRaw };
      });
      // Local filter + render
      window.applyForm6LocalFilter = function(){
        console.log('[DEBUG] applyForm6LocalFilter called');
        try{
          const monthEl = document.getElementById('f6-month');
          const monthVal = monthEl ? (monthEl.value || '').trim() : '';
          let list = Array.isArray(F6_LAST_ROWS) ? F6_LAST_ROWS.slice() : [];
          console.log('[DEBUG] Month filter:', monthVal, 'Total rows:', list.length);
          console.log('[DEBUG] F6_LAST_ROWS type:', typeof F6_LAST_ROWS, 'isArray:', Array.isArray(F6_LAST_ROWS));
          if (monthVal) {
            console.log('[DEBUG] Applying month filter...');
            list = list.filter(r => {
              const formatted = formatYyyyMm(r.submitDate);
              console.log('[DEBUG] Row date:', r.submitDate, '-> formatted:', formatted, 'matches?', formatted === monthVal);
              return formatted === monthVal;
            });
          }
          console.log('[DEBUG] After month filter:', list.length);
          if (!list.length){
            console.log('[DEBUG] No data after filtering, showing empty state');
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Không có dữ liệu</td></tr>';
            if (aggBody) aggBody.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Không có dữ liệu</td></tr>';
            if (aggNote) aggNote.textContent = '';
            return;
          }
          const html2 = list.map(r=>`
            <tr class="${(function(st,op){ try{ const raw1=String(st||''); const raw2=String(op||''); const s1=raw1.toLowerCase(); const s2=raw2.toLowerCase(); if(s1.includes('không được duyệt')||s2.includes('không được duyệt')) return 'bg-yellow-100'; const n1=(typeof vnLower==='function'? vnLower(raw1): raw1.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); const n2=(typeof vnLower==='function'? vnLower(raw2): raw2.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); if(n1.includes('khong duoc duyet')||n2.includes('khong duoc duyet')) return 'bg-yellow-100'; return ''; }catch(_){ return ''; }})(r.status, r.managerOpinion)}">
              <td class="px-3 py-2">${r.submitDate}</td>
              <td class="px-3 py-2">${r.employee}</td>
              <td class="px-3 py-2">${r.title}</td>
              <td class="px-3 py-2">${r.problem}</td>
              <td class="px-3 py-2">${r.solution}</td>
              <td class="px-3 py-2">${(function(s){
                try{
                  const t = ((typeof vnLower==='function') ? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()).replace(/\s+/g,' ').trim();
                  const approved = (
                    t.includes('duoc duyet') || t.includes('da duyet') || t.includes('duoc phe duyet') || t.includes('da phe duyet') ||
                    t.includes('phe duyet') || t.includes('phe chuan') || t.includes('thong qua') || t.includes('chap thuan') ||
                    t.includes('approved') || t.includes('approve') || (t.includes('dong y') && (t.includes('duyet') || t.includes('phe duyet')))
                  );
                  const denied = (
                    (t.includes('khong') && (t.includes('duyet') || t.includes('phe duyet'))) || t.includes('ko duyet') || t.includes('k duyet') ||
                    t.includes('chua duyet') || t.includes('tu choi') || t.includes('reject') || t.includes('rejected')
                  );
                  let cls = '';
                  if (approved) cls = 'bg-green-100 text-green-800';
                  else if (denied) cls = 'bg-red-100 text-red-800';
                  return cls ? `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>` : (s||'');
                }catch(_){ return String(s||''); }
              })(r.managerOpinion||'')}</td>
              <td class="px-3 py-2">${(function(s){
                try{
                  const raw = String(s||'');
                  const sLower = raw.toLowerCase().trim();
                  const t = ((typeof vnLower==='function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()).replace(/\s+/g,' ').trim();
                  const approved = (
                    t.includes('duoc duyet') || t.includes('da duyet') || t.includes('duoc phe duyet') || t.includes('da phe duyet') ||
                    t.includes('phe duyet') || t.includes('phe chuan') || t.includes('thong qua') || t.includes('chap thuan') ||
                    t.includes('approved') || t.includes('approve') || (t.includes('dong y') && (t.includes('duyet') || t.includes('phe duyet'))) ||
                    sLower.includes('được duyệt') || sLower.includes('đã duyệt') || sLower.includes('được phê duyệt') || sLower.includes('đã phê duyệt') ||
                    sLower.includes('phê duyệt') || sLower.includes('phê chuẩn') || sLower.includes('thông qua') || sLower.includes('chấp thuận') ||
                    (sLower.includes('đồng ý') && (sLower.includes('duyệt') || sLower.includes('phê duyệt')))
                  );
                  const denied = (
                    (t.includes('khong') && (t.includes('duyet') || t.includes('phe duyet'))) || t.includes('ko duyet') || t.includes('k duyet') ||
                    t.includes('chua duyet') || t.includes('tu choi') || t.includes('reject') || t.includes('rejected') ||
                    ((sLower.includes('không') && (sLower.includes('duyệt') || sLower.includes('phê duyệt'))) || sLower.includes('từ chối'))
                  );
                  const deniedStrict = sLower.includes('không được duyệt') || t.includes('khong duoc duyet');
                  // Chỉ bôi xanh chữ khi trạng thái đã duyệt
                  if (approved) return `<span class=\"text-green-700 font-semibold\">${s||''}</span>`;
                  if (deniedStrict) return `<span class=\"text-red-700 font-semibold\">${s||''}</span>`;
                  let cls = 'bg-gray-100 text-gray-800';
                  if (denied) cls = 'bg-red-100 text-red-800';
                  return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`;
                }catch(_){ return String(s||''); }
              })(r.status||'')}</td>
            </tr>
          `).join('');
          console.log('[DEBUG] Generated HTML length:', html2.length);
          console.log('[DEBUG] First 500 chars of HTML:', html2.substring(0, 500));
          body.innerHTML = html2;
          console.log('[DEBUG] HTML set to body, body children count:', body.children.length);
          try{ enableTableDrag('f6-body'); }catch(_){ }

          // Aggregate by employee and render f6-agg-body (kèm số ý tưởng được duyệt)
          try{
            const totalCounts = new Map();
            const rejectedCounts = new Map();
            const toNorm = (s)=>{
              try{ return (typeof vnLower==='function') ? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); }
            };
            list.forEach(r=>{
              const name = String(r.employee||'').trim() || '(Chưa rõ)';
              totalCounts.set(name, (totalCounts.get(name)||0) + 1);
              // XÁC ĐỊNH BỊ TỪ CHỐI: hàng bị bôi vàng ("Không được duyệt")
              const rawSt = String(r.status||'');
              const rawOp = String(r.managerOpinion||'');
              const sLower = rawSt.toLowerCase();
              const oLower = rawOp.toLowerCase();
              const stNz = toNorm(rawSt);
              const opNz = toNorm(rawOp);
              const isRejected = (
                sLower.includes('không được duyệt') || oLower.includes('không được duyệt') ||
                stNz.includes('khong duoc duyet') || opNz.includes('khong duoc duyet')
              );
              if (isRejected) rejectedCounts.set(name, (rejectedCounts.get(name)||0) + 1);
            });
            const items = Array.from(totalCounts.entries()).map(([name, cnt])=>{
              const rej = rejectedCounts.get(name)||0;
              const approved = Math.max(0, cnt - rej);
              return { name, cnt, approved };
            })
              .sort((a,b)=> b.cnt - a.cnt || a.name.localeCompare(b.name,'vi'));
            const rowsHtml = items.map(it=>`
              <tr${it.cnt < 5 ? ' class="bg-yellow-100"' : ''}>
                <td class="px-3 py-2">${it.name}</td>
                <td class="px-3 py-2">${it.cnt}</td>
                <td class="px-3 py-2">${it.approved}</td>
                <td class="px-3 py-2"><button class="px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105" data-f6-view="${it.name.replace(/"/g,'&quot;')}">Xem</button></td>
              </tr>
            `).join('');
            if (aggBody) aggBody.innerHTML = rowsHtml || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Không có dữ liệu</td></tr>';
            if (aggNote) {
              const monthTxt = monthVal ? `tháng ${monthVal}` : 'tất cả thời gian';
              aggNote.textContent = `Đếm theo ${monthTxt}`;
            }
          }catch(_){ }
        }catch(err){ 
          console.error('[DEBUG] Error in applyForm6LocalFilter:', err);
        }
      };
      // initial render
      try{ applyForm6LocalFilter(); }catch(_){ }
      F5_LAST_COUNT = F6_LAST_ROWS.length;
      try{ LS.setJSON('f6.cache', { rows: F6_LAST_ROWS, ts: Date.now() }); LS.set('f6.lastUpdated', String(Date.now())); }catch(_){ }
    }

    // Form 6: Modal helpers
    (function initF6IdeasModal(){
      const modal = document.getElementById('f6-ideas-modal');
      const closeBtn = document.getElementById('f6-ideas-close');
      if (closeBtn) closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } });
      if (modal) modal.addEventListener('click', (e)=>{ if(e.target===modal){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('open')){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
    })();

    function openF6IdeasModal(empName, ideas){
      try{
        const modal = document.getElementById('f6-ideas-modal');
        const nameEl = document.getElementById('f6-ideas-name');
        const body = document.getElementById('f6-ideas-body');
        if (!modal || !nameEl || !body) return;
        nameEl.textContent = empName || '';
        if (!Array.isArray(ideas) || !ideas.length){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Không có dữ liệu</td></tr>';
        } else {
        const rows = ideas.map(r=>`
          <tr class="${(function(st,op){ try{ const raw1=String(st||''); const raw2=String(op||''); const s1=raw1.toLowerCase(); const s2=raw2.toLowerCase(); if(s1.includes('không được duyệt')||s2.includes('không được duyệt')) return 'bg-yellow-100'; const n1=(typeof vnLower==='function'? vnLower(raw1): raw1.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); const n2=(typeof vnLower==='function'? vnLower(raw2): raw2.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); if(n1.includes('khong duoc duyet')||n2.includes('khong duoc duyet')) return 'bg-yellow-100'; return ''; }catch(_){ return ''; }})(r.status, r.managerOpinion)}">
              <td class="px-3 py-2">${r.submitDate||''}</td>
              <td class="px-3 py-2">${r.title||''}</td>
              <td class="px-3 py-2">${r.problem||''}</td>
              <td class="px-3 py-2">${r.solution||''}</td>
              <td class="px-3 py-2">${r.managerOpinion||''}</td>
              <td class="px-3 py-2">${(function(s){
                try{
                  const raw = String(s||'');
                  const sLower = raw.toLowerCase();
                  const t = (typeof vnLower==='function') ? vnLower(raw) : raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
                  // Chỉ bôi xanh chữ khi trạng thái đã duyệt
                  if (
                    t.includes('duoc duyet') || t.includes('da duyet') || t.includes('duoc phe duyet') || t.includes('da phe duyet') ||
                    t.includes('phe duyet') || t.includes('phe chuan') || t.includes('thong qua') || t.includes('chap thuan') ||
                    sLower.includes('được duyệt') || sLower.includes('đã duyệt') || sLower.includes('được phê duyệt') || sLower.includes('đã phê duyệt') ||
                    sLower.includes('phê duyệt') || sLower.includes('phê chuẩn') || sLower.includes('thông qua') || sLower.includes('chấp thuận')
                  ) return `<span class=\"text-green-700 font-semibold\">${s||''}</span>`;
                  let cls = 'bg-gray-100 text-gray-800';
                  const deniedStrict = sLower.includes('không được duyệt') || t.includes('khong duoc duyet');
                  if (deniedStrict) return `<span class=\"text-red-700 font-semibold\">${s||''}</span>`;
                  if ((t.includes('khong') && (t.includes('duyet') || t.includes('phe duyet'))) || t.includes('tu choi') || (sLower.includes('không') && (sLower.includes('duyệt') || sLower.includes('phê duyệt'))) || sLower.includes('từ chối')) cls = 'bg-red-100 text-red-800';
                  return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`;
                }catch(_){ return String(s||''); }
              })(r.status||'')}</td>
            </tr>
          `).join('');
          body.innerHTML = rows;
        }
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
      }catch(_){ }
    }
    function restoreForm6FromCache(){
      try{
        const cached = LS.getJSON('f6.cache');
        if (!cached || !Array.isArray(cached.rows) || !cached.rows.length) return false;
        const body = document.getElementById('f6-body');
        if (!body) return false;
        F6_LAST_ROWS = cached.rows.slice();
        try{ const m = document.getElementById('f6-month'); if (m && cached.ts) { updateLastUpdatedNote('f6-search','f6.lastUpdated'); } }catch(_){ }
        if (typeof applyForm6LocalFilter === 'function') applyForm6LocalFilter();
        return true;
      }catch(_){ return false; }
    }

    // ===== Form 6: Export XLSX =====
    function f6GetListForCurrentMonth(){
      try{
        let list = Array.isArray(F6_LAST_ROWS) ? F6_LAST_ROWS.slice() : [];
        const monthEl = document.getElementById('f6-month');
        const monthVal = monthEl ? (monthEl.value || '').trim() : '';
        if (monthVal) list = list.filter(r => formatYyyyMm(r.submitDate) === monthVal);
        return list;
      }catch(_){ return []; }
    }
    function f6RowsToAOA(list){
      try{
        const headers = ['Ngày nộp','Nhân viên','Tiêu đề ý tưởng','Vấn đề nhận diện','Giải pháp','Ý kiến trưởng phòng','Trạng thái'];
        const aoa = [headers];
        (Array.isArray(list)? list: []).forEach(r=>{
          aoa.push([
            r.submitDate||'', r.employee||'', r.title||'', r.problem||'', r.solution||'', r.managerOpinion||'', r.status||''
          ]);
        });
        return aoa;
      }catch(_){ return [['Lỗi xây dựng dữ liệu']]; }
    }
    function f6AggToAOA(list){
      try{
        const toNorm = (s)=>{ try{ return (typeof vnLower==='function') ? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); } };
        const totalCounts = new Map();
        const rejectedCounts = new Map();
        (Array.isArray(list)? list: []).forEach(r=>{
          const name = String(r.employee||'').trim() || '(Chưa rõ)';
          totalCounts.set(name, (totalCounts.get(name)||0) + 1);
          const st = String(r.status||'');
          const op = String(r.managerOpinion||'');
          const isRejected = st.toLowerCase().includes('không được duyệt') || op.toLowerCase().includes('không được duyệt') || toNorm(st).includes('khong duoc duyet') || toNorm(op).includes('khong duoc duyet');
          if (isRejected) rejectedCounts.set(name, (rejectedCounts.get(name)||0) + 1);
        });
        const items = Array.from(totalCounts.entries()).map(([name, cnt])=>{ const rej = rejectedCounts.get(name)||0; return { name, cnt, approved: Math.max(0, cnt - rej) }; })
          .sort((a,b)=> b.cnt - a.cnt || a.name.localeCompare(b.name,'vi'));
        const headers = ['Nhân viên','Tổng số ý tưởng','Số ý tưởng được duyệt'];
        const aoa = [headers];
        items.forEach(it=> aoa.push([ it.name, it.cnt, it.approved ]));
        return aoa;
      }catch(_){ return [['Lỗi xây dựng thống kê']]; }
    }
    function f6DownloadXLSX(){
      try{
        const list = f6GetListForCurrentMonth();
        if (!Array.isArray(list) || !list.length){ showToast('Form 6: Không có dữ liệu để xuất.','error'); return; }
        const wb = XLSX.utils.book_new();
        const wsList = XLSX.utils.aoa_to_sheet(f6RowsToAOA(list));
        XLSX.utils.book_append_sheet(wb, wsList, 'Danh sách');
        const wsAgg = XLSX.utils.aoa_to_sheet(f6AggToAOA(list));
        XLSX.utils.book_append_sheet(wb, wsAgg, 'Thống kê');
        const month = (document.getElementById('f6-month')?.value || '').replace(/\s+/g,'');
        XLSX.writeFile(wb, `Form6_Ideas_${month||'export'}.xlsx`);
      }catch(_){ showToast('Form 6: Xuất XLSX thất bại.','error'); }
    }
    (function initF6Export(){
      const btn = document.getElementById('f6-export-xlsx');
      if (!btn) return;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); f6DownloadXLSX(); });
    })();

    (function setupForm6(){
      const openBtn = document.getElementById('f6-open-submit');
      const modal = document.getElementById('f5-modal');
      const sendBtn = document.getElementById('f5-btn-send');
      const cancelBtn = document.getElementById('f5-btn-cancel');
      const countBox = document.getElementById('f6-count');
      const aggBody = document.getElementById('f6-agg-body');

      function openF5Modal(){
        try { setF5DateDefault(); } catch(_){}
        // reset inputs
        try{ (document.getElementById('f5-title')||{}).value=''; }catch(_){ }
        try{ (document.getElementById('f5-problem')||{}).value=''; }catch(_){ }
        try{ (document.getElementById('f5-solution')||{}).value=''; }catch(_){ }
        if (modal){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
      }
      function closeF5Modal(){ if (modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } }
      if (openBtn) openBtn.addEventListener('click', (e)=>{ e.preventDefault(); openF5Modal(); });
      if (cancelBtn) cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeF5Modal(); });
      if (modal) modal.addEventListener('click', (e)=>{ if(e.target===modal) closeF5Modal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('open')) closeF5Modal(); });

      async function submitF5(){
        const date = (document.getElementById('f5-date')?.value||'').trim();
        const emp = (document.getElementById('f5-employee')?.value||'').trim();
        const title = (document.getElementById('f5-title')?.value||'').trim();
        const prob = (document.getElementById('f5-problem')?.value||'').trim();
        const sol = (document.getElementById('f5-solution')?.value||'').trim();
        if (!date || !emp || !title || !prob || !sol){ showToast('Vui lòng điền đủ tất cả trường.','error'); return; }
        const prev = sendBtn ? sendBtn.textContent : '';
        if (sendBtn){ sendBtn.disabled = true; sendBtn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
        // Build payload (send both submitDate and date for compatibility)
        const toDMY = (v)=>{ try{ return formatDdMmYyyy(v); }catch(_){ return String(v||''); } };
        const p = new URLSearchParams({
          submitDate: date,
          date: date,
          submit_date: date,
          ngay_nop: date,
          ngayNop: date,
          ngayNopDMY: toDMY(date),
          employee: emp,
          title,
          problem: prob,
          solution: sol,
          _ts: Date.now().toString()
        });
        async function tryPost(url){
          try{
            const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: p.toString() });
            const t = await r.text().catch(()=>"");
            return { ok: r.ok, raw: t };
          }catch(err){ return { ok:false, raw: String(err||'') }; }
        }
        async function tryPostNoCors(url){
          try{
            await fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: p.toString() });
            // opaque response cannot be inspected; treat as success if resolved
            return { ok: true, raw: '' };
          }catch(err){ return { ok:false, raw: String(err||'') }; }
        }
        async function tryGet(url){
          try{
            const r = await fetch(`${url}?${p.toString()}`, { method:'GET' });
            const t = await r.text();
            return { ok: r.ok, raw: t };
          }catch(err){ return { ok:false, raw: String(err||'') }; }
        }
        try{
          // 1) POST no-cors to test URL (avoid CORS false negatives)
          let r = await tryPostNoCors(FORM5_SUBMIT_URL);
          // 2) If above failed (network), try normal POST test URL
          if (!r.ok) r = await tryPost(FORM5_SUBMIT_URL);
          // 3) Fallback GET test URL
          if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryGet(FORM5_SUBMIT_URL);
          // 4) Fallback POST prod URL
          if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryPost(FORM5_SUBMIT_URL.replace('/webhook-test/','/webhook/'));
          // 5) Fallback GET prod URL
          if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryGet(FORM5_SUBMIT_URL.replace('/webhook-test/','/webhook/'));
          if (!r.ok) throw new Error(r.raw||'Gửi thất bại');
          showToast('Đã gửi ý tưởng.','success');
          closeF5Modal();
          // Làm mới bảng sau 3 giây để backend kịp ghi dữ liệu
          setTimeout(()=>{ try{ renderForm6List(); }catch(_){} }, 3000);
        }catch(err){
          showToast('Gửi thất bại.','error');
        }finally{
          if (sendBtn){ sendBtn.disabled=false; sendBtn.textContent = prev || 'Gửi ý tưởng'; }
        }
      }
      if (sendBtn) sendBtn.addEventListener('click', (e)=>{ e.preventDefault(); submitF5(); });

      if (countBox){
        countBox.addEventListener('click', ()=>{
          countBox.innerHTML = `<span>📊</span><span>Số ý tưởng đã nộp: <b>${F5_LAST_COUNT}</b></span>`;
        });
      }

      // Delegate click on "Xem" buttons in aggregate table
      if (aggBody){
        aggBody.addEventListener('click', (e)=>{
          const btn = e.target && e.target.closest ? e.target.closest('[data-f6-view]') : null;
          if (!btn) return;
          const name = btn.getAttribute('data-f6-view') || '';
          try {
            const list = Array.isArray(F6_LAST_ROWS) ? F6_LAST_ROWS.slice() : [];
            const monthEl = document.getElementById('f6-month');
            const monthVal = monthEl ? (monthEl.value || '').trim() : '';
            const filtered = list.filter(r=> (!monthVal || formatYyyyMm(r.submitDate) === monthVal) && String(r.employee||'').trim() === name);
            openF6IdeasModal(name, filtered);
          } catch(_) {}
        });
      }
    })();

    // Map tên -> email cho Form 3 (tự động điền)
    const REQUESTER_EMAIL = (()=>{
      const normalize = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
      const raw = {
        "Bùi Đặng Quốc Huy":"huy.bui@karofi.vn",
        "Đào Hoàng Dương":"duong.dao@karofi.vn",
        "Đỗ Quang Long":"long.do@karofi.vn",
        "Nguyễn Văn Hiếu":"hieu.nguyen2@karofi.vn",
        "Nguyễn Hữu Thịnh":"thinh.nguyen2@karofi.vn",
        "Nguyễn Văn Hiếu":"hieu.nguyen2@karofi.vn",
        "Nguyễn Văn Linh":"linh.nguyen@karofi.vn",
        "Phạm Thành Trung Kiên":"kien.pham1@karofi.vn",
        "Thái Thị Giang":"giang.thai@karofi.vn",
        "Trần Hiếu Nghĩa":"nghia.tran1@karofi.vn",
        "Vũ Thị Hằng":"hang.vu@karofi.vn",
        "Đào Tuấn Kỳ":"ky.dao@karofi.vn",
        "Nguyễn Văn Linh":"linh.nguyen@karofi.vn",
        "Lại Quốc Lộc":"loc.lai@karofi.vn",
        "Lê Ngọc Ánh":"anh.le1@karofi.vn",
        "Lê Thị Thanh Nhàn":"nhan.le@karofi.vn",
        "Lê Thị Thảo":"thao.le@karofi.vn",
        "Lê Văn Sơn":"son.le2@karofi.vn",
        "Nguyễn Thị Hiền":"hien.nguyen1@karofi.vn",
        "Phạm Thị Minh":"minh.pham1@karofi.vn",
        "Vũ Duy Minh":"minh.vu@karofi.com",
        "Vũ Thị Thanh Hiền":"hien.vu2@karofi.vn"
      };
      const map = {};
      Object.keys(raw).forEach(k => map[normalize(k)] = raw[k]);
      return { get: (name)=> map[normalize(name)] || '' };
    })();
    function syncRequesterEmail(){
      const nameEl = document.getElementById('rq-by');
      const emailEl = document.getElementById('rq-by-email');
      if (!nameEl || !emailEl) return;
      emailEl.value = REQUESTER_EMAIL.get(nameEl.value||'');
    }
    (function initRequesterEmail(){
      const nameEl = document.getElementById('rq-by');
      if (!nameEl) return;
      nameEl.addEventListener('input', syncRequesterEmail);
      nameEl.addEventListener('change', syncRequesterEmail);
      syncRequesterEmail();
    })();

    async function renderForm5All(){
      const bodyP1 = document.getElementById('f5a-body-p1');
      const bodyP2 = document.getElementById('f5a-body-p2');
      try{ if (bodyP1) bodyP1.innerHTML = "<tr><td colspan='10' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>"; }catch(_){ }
      try{ if (bodyP2) bodyP2.innerHTML = "<tr><td colspan='6' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>"; }catch(_){ }
      const chartWrap = document.getElementById('f5a-chart-container');
      const chartCanvas = document.getElementById('f5a-chart');
      const chartWrapMan = document.getElementById('f5a-chart-container-manhour');
      const chartCanvasMan = document.getElementById('f5a-chart-manhour');
      function destroyChart(){ try{ if (F5A_CHART) { F5A_CHART.destroy(); F5A_CHART = null; } }catch(_){}
        try{ if (F5A_CHART_MAN) { F5A_CHART_MAN.destroy(); F5A_CHART_MAN = null; } }catch(_){}
      }
      function renderStackedChart(rows){
        try{
          // Nếu tạm thời vô hiệu hoá biểu đồ, ẩn containers và thoát sớm
          if (typeof F5A_DISABLE_CHARTS !== 'undefined' && F5A_DISABLE_CHARTS){
            const chartWrap = document.getElementById('f5a-chart-container');
            const chartWrapMan = document.getElementById('f5a-chart-container-manhour');
            if (chartWrap) chartWrap.style.display = 'none';
            if (chartWrapMan) chartWrapMan.style.display = 'none';
            try{ destroyChart(); }catch(_){ }
            return;
          }
          try{ window.F5A_RENDER_CHART = (r)=>{ try{ renderStackedChart(r || F5A_LAST_ROWS || []); }catch(_){ } }; }catch(_){ }
          if (!Array.isArray(rows) || !rows.length || !chartCanvas) { if(chartWrap) chartWrap.style.display='none'; destroyChart(); return; }
          // Chọn chế độ dữ liệu: rates (cũ) hoặc manhour (mới)
          const basisSel = document.getElementById('f5a-basis');
          const basis = basisSel ? (basisSel.value || 'rates') : 'rates';
          if (basis === 'manhour'){
            const filteredRows = rows.filter(r => {
              const name = (r['Phụ trách'] || r.name || '').trim().toLowerCase();
              return name !== 'x';
            });
            const labels = filteredRows.map(r=> r.name);
            const isHorizontal = (F5A_MODE === 'horizontal');
            if (chartWrap) {
              chartWrap.style.display = '';
              const baseH = 420;
              chartWrap.style.height = isHorizontal ? Math.max(baseH, 28*labels.length + 100) + 'px' : baseH + 'px';
            }
            const ctx = chartCanvas.getContext('2d');
            destroyChart();
            const dataMan = filteredRows.map(r=> Number(r.manhour)||0);
            const valueLabelsPlugin = {
              id: 'valueLabels',
              afterDatasetsDraw(chart){
                const { ctx } = chart;
                const isHorizontal = chart.options.indexAxis === 'y';
                const meta = chart.getDatasetMeta(0);
                if (!meta || !meta.data) return;
                ctx.save();
                meta.data.forEach((bar, i)=>{
                  const val = Number(chart.data.datasets[0].data?.[i]) || 0;
                  if (val <= 0) return;
                  const x = isHorizontal ? (bar.x + 12) : bar.x;
                  const y = isHorizontal ? bar.y : (bar.y - 6);
                  ctx.fillStyle = '#0b1324';
                  ctx.font = 'bold 12px Inter, Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'bottom';
                  ctx.fillText(val.toFixed(2), x, y);
                });
                ctx.restore();
              }
            };
            F5A_CHART = new Chart(ctx, {
              type: 'bar',
              data: { labels, datasets: [{ label: 'Công chuẩn hiện tại', data: dataMan, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1 }] },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: isHorizontal ? 'y' : 'x',
                scales: {
                  x: { ticks: { autoSkip: false, maxRotation: isHorizontal?0:20, minRotation: 0, font: { size: 11 } }, grid: { display: false }, title: { display: true, text: isHorizontal? 'Công chuẩn' : 'Nhân viên' } },
                  y: { beginAtZero: true, ticks: { precision:0 }, grid: { color: 'rgba(0,0,0,0.06)', borderDash:[4,3] }, title: { display: true, text: isHorizontal? 'Nhân viên' : 'Công chuẩn' } }
                },
                plugins: { legend: { display: false } }
              },
              plugins: [valueLabelsPlugin]
            });
            try { setTimeout(()=>{ chartWrap && chartWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100); } catch(_) {}
            F5A_LAST_ROWS = filteredRows;
            const modeSel = document.getElementById('f5a-mode');
            if (modeSel){ modeSel.value = F5A_MODE; modeSel.onchange = ()=>{ F5A_MODE = modeSel.value || 'vertical'; renderStackedChart(F5A_LAST_ROWS); }; }
            if (basisSel){ basisSel.value = basis; basisSel.onchange = ()=> renderStackedChart(F5A_LAST_ROWS); }
            try{ window.F5A_RENDER_CHART = (r)=>{ try{ renderStackedChart(r || F5A_LAST_ROWS || []); }catch(_){ } }; }catch(_){ }
            return;
          }
          // Fallback tính tỷ lệ nếu chưa có % nhưng có số lượng
          const normalized = rows.filter(r => {
            const name = (r['Phụ trách'] || r.name || '').trim().toLowerCase();
            return name !== 'x';
          }).map(r=>{
            const a = Number(r.rateAhead)||0, o = Number(r.rateOntime)||0, l = Number(r.rateLate)||0;
            if ((a+o+l) > 0) return { ...r, rateAhead:a, rateOntime:o, rateLate:l };
            const ca = Number(r.ahead)||0, co = Number(r.ontime)||0, cl = Number(r.late)||0;
            const sum = ca + co + cl;
            if (sum > 0) return { ...r, rateAhead: Math.round(ca*100/sum), rateOntime: Math.round(co*100/sum), rateLate: Math.round(cl*100/sum) };
            return { ...r };
          });
          const labels = normalized.map(r=> r.name);
          const counts   = normalized.map(r=> isNaN(r.count)?0:Number(r.count));
          // Tính số lượng theo trạng thái, nếu thiếu thì suy ra từ % * tổng count
          const cntOn  = normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.ontime)||Math.round((Number(r.rateOntime)||0)*c/100); return v; });
          const cntLate= normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.late)||Math.round((Number(r.rateLate)||0)*c/100); return v; });
          const cntAhead=normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.ahead)||Math.round((Number(r.rateAhead)||0)*c/100); return v; });
          // Tính phần trăm để hiển thị nhãn
          const pctOn   = normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntOn[i]||0)*100/c); });
          const pctLate = normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntLate[i]||0)*100/c); });
          const pctAhead= normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntAhead[i]||0)*100/c); });
          const maxCount = Math.max(1, ...counts);
          const isHorizontal = (F5A_MODE === 'horizontal');
          if (chartWrap) { chartWrap.style.display = ''; chartWrap.style.height = (isHorizontal ? Math.max(440, 28*labels.length + 100) : 440) + 'px'; }
          if (chartWrapMan) { chartWrapMan.style.display = ''; chartWrapMan.style.height = 420 + 'px'; }
          const ctx = chartCanvas.getContext('2d');
          destroyChart();
          const stackedLabelsPlugin = {
            id: 'stackedLabels',
            afterDatasetsDraw(chart){
              const { ctx, chartArea } = chart;
              ctx.save();
              const isHorizontal = chart.options.indexAxis === 'y';
              chart.data.datasets.forEach((ds, dsIdx)=>{
                const meta = chart.getDatasetMeta(dsIdx);
                if (!meta || meta.hidden || !meta.data || (ds.type && ds.type !== 'bar')) return;
                const inSameStack = (other)=> (other.stack || '') === (ds.stack || '');
                meta.data.forEach((bar, i)=>{
                  const val = Number(ds.data?.[i]) || 0;
                  if (val <= 0) return;
                  let total = 0;
                  chart.data.datasets.forEach((ods, j)=>{
                    const m = chart.getDatasetMeta(j);
                    if (!m || m.hidden || (ods.type && ods.type !== 'bar')) return;
                    if (!inSameStack(ods)) return;
                    total += Number(ods.data?.[i]) || 0;
                  });
                  if (!total) return;
                  const percent = Math.round((val * 100) / total);
                  const x = bar.x !== undefined ? bar.x : (bar.tooltipPosition ? bar.tooltipPosition().x : 0);
                  const y = bar.y !== undefined ? bar.y : (bar.tooltipPosition ? bar.tooltipPosition().y : 0);
                  const base = bar.base !== undefined ? bar.base : (isHorizontal ? chart.scales.x.getPixelForValue(0) : chart.scales.y.getPixelForValue(0));
                  const midX = isHorizontal ? (x + base) / 2 : x;
                  const midY = isHorizontal ? y : (y + base) / 2;
                  ctx.fillStyle = '#000000';
                  ctx.font = 'bold 12px Inter, Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  ctx.fillText(`${percent}%`, midX, Math.min(midY, chartArea.bottom - 4));
                });
              });
              ctx.restore();
            }
          };
          const stackTotalsPlugin = {
            id: 'stackTotals',
            afterDatasetsDraw(chart){
              const { ctx } = chart;
              const isHorizontal = chart.options.indexAxis === 'y';
              const datasets = chart.data.datasets || [];
              const labels = chart.data.labels || [];
              ctx.save();
              for (let i=0; i<labels.length; i++){
                let total = 0;
                let anchor = null;
                datasets.forEach((ds, idx)=>{
                  const meta = chart.getDatasetMeta(idx);
                  if (!meta || meta.hidden || (ds.type && ds.type !== 'bar')) return;
                  if ((ds.stack || '') !== 'rates') return;
                  const val = Number(ds.data?.[i]) || 0;
                  total += val;
                  if (!anchor) anchor = meta.data?.[i] || null;
                });
                if (!anchor || !total) continue;
                const scale = isHorizontal ? chart.scales.x : chart.scales.y;
                const pos = scale.getPixelForValue(total);
                const x = isHorizontal ? (pos + 12) : anchor.x;
                const y = isHorizontal ? anchor.y : (pos - 6);
                ctx.fillStyle = '#0b1324';
                ctx.font = 'bold 12px Inter, Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(String(total), x, y);
              }
              ctx.restore();
            }
          };
          const COLOR_ON = 'rgba(134,239,172,0.85)';      // green-300
          const COLOR_LATE = 'rgba(254,202,202,0.9)';     // red-200
          const COLOR_AHEAD = 'rgba(147,197,253,0.9)';    // blue-300
          const BORDER_SEG = '#e5e7eb';                   // slate-200
          const barT = isHorizontal ? 20 : 26;
          const catPct = isHorizontal ? 0.75 : 0.9;
          const barPct = isHorizontal ? 0.9 : 0.95;
          F5A_CHART = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                { label: 'Vượt tiến độ', data: cntAhead, backgroundColor: COLOR_AHEAD, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct },
                { label: 'Đúng tiến độ', data: cntOn, backgroundColor: COLOR_ON, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct },
                { label: 'Chậm tiến độ', data: cntLate, backgroundColor: COLOR_LATE, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: isHorizontal ? 'y' : 'x',
              scales: {
                x: { stacked: true, ticks: { autoSkip: false, maxRotation: isHorizontal?0:20, minRotation: 0, font: { size: 11 } }, grid: { display: false } },
                y: { stacked: true, beginAtZero: true, suggestedMax: Math.ceil(maxCount*1.15), ticks: { precision:0 }, grid: { color: 'rgba(0,0,0,0.06)', borderDash:[4,3] }, title: { display: true, text: 'Số tác vụ' } }
              },
              plugins: {
                stackedLabels: {},
                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
                tooltip: {
                  callbacks: {
                    label: (ctx)=>{
                      const dsLabel = ctx.dataset.label || '';
                      const value = ctx.parsed[isHorizontal?'x':'y'];
                      const total = counts[ctx.dataIndex] || 0;
                      const pct = total ? Math.round(value*100/total) : 0;
                      return ` ${dsLabel}: ${value} (${pct}%)`;
                    }
                  }
                }
              },
              plugins: [stackedLabelsPlugin, stackTotalsPlugin]
            }
          });
          try { setTimeout(()=>{ chartWrap && chartWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100); } catch(_) {}
          // lưu lại rows (giữ đủ thuộc tính, kể cả manhour) để đổi chế độ
          F5A_LAST_ROWS = rows;
          const modeSel = document.getElementById('f5a-mode');
          if (modeSel){
            modeSel.value = F5A_MODE;
            modeSel.onchange = ()=>{ F5A_MODE = modeSel.value || 'vertical'; renderStackedChart(F5A_LAST_ROWS); };
          }
          // Render chart manhour song song
          try {
            const manRows = ((F5A_LAST_ROWS && Array.isArray(F5A_LAST_ROWS)) ? F5A_LAST_ROWS : normalized).filter(r => {
              const name = (r['Phụ trách'] || r.name || '').trim().toLowerCase();
              return name !== 'x';
            }).slice().sort((a,b)=> Number(b.manhour||0) - Number(a.manhour||0));
            const labels2 = manRows.map(r=> r.name);
            const ctxMan = chartCanvasMan ? chartCanvasMan.getContext('2d') : null;
            if (ctxMan){
              const dataMan = manRows.map(r=> Number(r.manhour)||0);
              try{ if (F5A_CHART_MAN) { F5A_CHART_MAN.destroy(); } }catch(_){ }
              const valueLabelsPlugin2 = {
                id: 'valueLabels2',
                afterDatasetsDraw(chart){
                  const { ctx } = chart; const meta = chart.getDatasetMeta(0); if (!meta||!meta.data) return;
                  ctx.save(); meta.data.forEach((bar,i)=>{ const v=Number(chart.data.datasets[0].data?.[i])||0; if(v<=0) return; const x=bar.x; const y=(bar.y-6); ctx.fillStyle='#0b1324'; ctx.font='bold 12px Inter, Arial'; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillText(v.toFixed(2), x, y); }); ctx.restore();
                }
              };
              F5A_CHART_MAN = new Chart(ctxMan, {
                type: 'bar',
                data: { labels: labels2, datasets: [{ label: 'Công chuẩn hiện tại', data: dataMan, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1 }] },
                options: { responsive:true, maintainAspectRatio:false, indexAxis: 'x', scales: { x:{ ticks:{ autoSkip:false, maxRotation:20, minRotation:0, font:{ size:11 } }, grid:{ display:false }, title:{ display:true, text: 'Nhân viên' } }, y:{ beginAtZero:true, ticks:{ precision:0 }, grid:{ color:'rgba(0,0,0,0.06)', borderDash:[4,3] }, title:{ display:true, text: 'Công chuẩn' } } }, plugins: { legend:{ display:false } } },
                plugins: [valueLabelsPlugin2]
              });
            }
          } catch(_) {}
        }catch(_){ if(chartWrap) chartWrap.style.display='none'; }
      }
      try{
        const monthInput = document.getElementById('f5a-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        const toNumeric = (v)=>{ const s=String(v??''); const n=parseFloat(s.replace(/[^0-9.+-]/g,'')); return isNaN(n)?0:n; };
        let fromVal = '';
        let toVal = '';
        if (monthVal) {
          try{
            const [yy, mm] = monthVal.split('-');
            const firstDay = `${yy}-${mm}-01`;
            const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
            const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
            fromVal = firstDay; toVal = lastDay;
          }catch(_){ }
        }
        // Fetch once from the new single-source endpoint
        await f5aFetchAllOnce(monthVal, fromVal, toVal);
        // Merge previous month to cover tasks received last month but completed this month
        let mergedRaw = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL.slice() : [];
        try{
          if (monthVal){
            const [yyStr, mmStr] = monthVal.split('-');
            let yy = Number(yyStr)||0; let mm = Number(mmStr)||0;
            if (mm <= 1){ yy = yy - 1; mm = 12; } else { mm = mm - 1; }
            const mmPad = String(mm).padStart(2,'0');
            const prevMonthVal = `${yy}-${mmPad}`;
            const prevFrom = `${yy}-${mmPad}-01`;
            const prevLastDate = new Date(yy, mm, 0).getDate();
            const prevTo = `${yy}-${mmPad}-${String(prevLastDate).padStart(2,'0')}`;
            try{
              await f5aFetchAllOnce(prevMonthVal, prevFrom, prevTo);
              const rawPrev = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL.slice() : [];
              const pick = (o, ks)=>{ try{ const L={}; Object.keys(o||{}).forEach(k=>{ const v=o[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); L[k1]=v; L[k2]=v; }); for(const k of ks){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=L[c1] ?? L[c2]; if(v!==undefined) return String(v||''); } }catch(_){ } return ''; };
              const keyOf = (o)=>{ const code = pick(o,['code','ma','taskcode','mã']); if (code) return `C:${code}`; const tn = pick(o,['Task Name','Tên tác vụ','Task','Công việc','Tên Task','taskname','ten_tac_vu','ten','name','title']); const rq = pick(o,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','📆 ngày yêu cầu']); return `N:${tn}|RQ:${rq}`; };
              const map = new Map();
              mergedRaw.forEach(o=>{ try{ map.set(keyOf(o), o); }catch(_){ } });
              rawPrev.forEach(o=>{ try{ const k = keyOf(o); if (!map.has(k)) map.set(k, o); }catch(_){ } });
              mergedRaw = Array.from(map.values());
            }catch(_){ }
          }
        }catch(_){ }
        try{ F5A_RAW_ALL = Array.isArray(mergedRaw) ? mergedRaw.slice() : mergedRaw; }catch(_){ }
        // Use original aggregation logic to preserve existing Vượt/Đúng/Trễ classification
        const aggregated = f5aAggregate(F5A_RAW_ALL || [], fromVal, toVal);
        try{ 
          LS.setJSON('f5a.cache', { version: APP_CACHE_VERSION, month: monthVal, rows: aggregated, ts: Date.now() }); 
          LS.set('f5a.lastUpdated', String(Date.now())); 
          updateLastUpdatedNote('f5a-search-p1','f5a.lastUpdated');
          updateLastUpdatedNote('f5a-search-p2','f5a.lastUpdated');
        }catch(_){ }
        // Sau khi render, giữ một bản sao trong biến toàn cục để các lần render lại nhanh không phụ thuộc cache/bộ nhớ ngoài
        try { F5A_LAST_ROWS = Array.isArray(aggregated) ? aggregated.slice() : []; } catch(_) {}
        // Lọc theo whitelist tên và loại bỏ nhân viên test "x"
        const filtered = Array.isArray(aggregated) ? aggregated.filter(item => {
          const name = (item['Phụ trách'] || item.name || '').trim().toLowerCase();
          // Loại bỏ nhân viên có tên là "x" (dùng cho test code)
          if (name === 'x') return false;
          return true;
        }) : [];
        if (!filtered.length){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Không có dữ liệu</td></tr>';
          if (chartWrap) chartWrap.style.display = 'none';
          if (chartWrapMan) chartWrapMan.style.display = 'none';
            return;
          }
        const sorted = filtered.slice().sort((a,b)=> Number(b["Tổng công chuẩn"]||b.manhour||0) - Number(a["Tổng công chuẩn"]||a.manhour||0));
        // Tính lại "Số tác vụ trong tháng" theo ngày nhận (requestDate) từ dữ liệu thô để khớp bảng phụ
        const rqCountMap = (()=>{
          try{
            const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
            const map = new Map();
            const toKey = (s)=>{ try{ const raw=String(s||'').trim(); const vz=(typeof vnLower==='function'? vnLower(raw): raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); return vz.replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
            const sameName = (a,b)=> toKey(a)===toKey(b);
            const getV = (obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
            const parseDate = (v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
            const iso = (d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
            const inRange = (ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
            const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Phụ trách','Phụ trách chính','Người phụ trách','Người xử lý','Người nhận mẫu','Người nhận','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
            const rqKeys = [
              '📆 ngày yêu cầu','📆 Ngày yêu cầu','📆 Ngày yêu cầu ',
              'ngày yêu cầu','Ngày yêu cầu','Ngày yêu cầu ',
              'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
              'submissiondate','submitteddate','submitdate','submit_date',
              'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
              'ngaygui','ngay_gui','ngày gửi','Ngày gửi',
              'createddate','created_date','creationdate','created',
              'ngaytao','ngay_tao','ngày tạo','Ngày tạo',
              'thời gian yêu cầu','thời điểm yêu cầu'
            ];
            const statusKeys = ['Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái'];
            const doneKeys = ['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','Ngày kết thúc','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
            const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const done=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('hủy')||st.includes('huỷ')||/cancel/i.test(done); };
            // Đếm theo từng tên hiển thị trong bảng sorted (không phụ thuộc trùng khớp tuyệt đối)
            const displayKeys = [];
            const keyToDisplay = new Map();
            sorted.forEach(it=>{ const displayName = it['Phụ trách'] || it.name || ''; const key = toKey(displayName); if(!map.has(key)) map.set(key,0); displayKeys.push(key); keyToDisplay.set(key, displayName); });
            rows.forEach(o=>{
              if (isCanceled(o)) return;
              const emp = getV(o, assigneeKeys);
              const rq = getV(o, rqKeys); const rqD = parseDate(rq); const rqIso = rqD? iso(rqD):''; if (!inRange(rqIso)) return;
              const rk = toKey(emp);
              // tìm khớp gần đúng với tên hiển thị
              let matchedKey = null;
              if (map.has(rk)) matchedKey = rk; else {
                for (const dk of displayKeys){ if (rk.includes(dk) || dk.includes(rk)) { matchedKey = dk; break; } }
              }
              if (!matchedKey) return;
              map.set(matchedKey, (map.get(matchedKey)||0) + 1);
            });
            return map;
          }catch(_){ return new Map(); }
        })();
        function f5aCountByAssigneeInline(displayName){
          try{
            const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
            const toKey = (s)=>{ try{ const raw=String(s||'').trim(); const vz=(typeof vnLower==='function'? vnLower(raw): raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); return vz.replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
            const targetKey = toKey(displayName);
            const getV = (obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
            const iso = (d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
            const inRange = (ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
            const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Phụ trách','Phụ trách chính','Người phụ trách','Người xử lý','Người nhận mẫu','Người nhận','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
            const rqKeys = [
              '📆 ngày yêu cầu','📆 Ngày yêu cầu','📆 Ngày yêu cầu ',
              'ngày yêu cầu','Ngày yêu cầu','Ngày yêu cầu ',
              'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
              'submissiondate','submitteddate','submitdate','submit_date',
              'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
              'ngaygui','ngay_gui','ngày gửi','Ngày gửi',
              'createddate','created_date','creationdate','created',
              'ngaytao','ngay_tao','ngày tạo','Ngày tạo',
              'thời gian yêu cầu','thời điểm yêu cầu'
            ];
            const statusKeys = ['Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái'];
            const doneKeys = ['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','Ngày kết thúc','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
            const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const done=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('hủy')||st.includes('huỷ')||/cancel/i.test(done); };
            let cnt = 0;
            // debug bucket
            try{ if (!window.F5A_DBG) window.F5A_DBG = {}; window.F5A_DBG[targetKey] = []; }catch(_){ }
            rows.forEach(o=>{
              const pushLog = (rec)=>{ try{ window.F5A_DBG[targetKey].push(rec); }catch(_){ } };
              if (isCanceled(o)) { pushLog({ reason:'cancel', row:o }); return; }
              const emp = getV(o, assigneeKeys); const rk = toKey(emp);
              if (rk !== targetKey) { pushLog({ reason:'emp_mismatch', emp }); return; }
              const rq = getV(o, rqKeys); let d = parseDateFlexible(rq); let ds = d? iso(d):'';
              if (!inRange(ds)) {
                // Fallback: quét tất cả trường, lấy ngày đầu tiên rơi trong khoảng
                try{
                  let found = '';
                  for (const v of Object.values(o||{})){
                    const dv = parseDateFlexible(v); if (!dv) continue; const svi = iso(dv); if (inRange(svi)) { found = svi; break; }
                  }
                  if (found){ cnt++; pushLog({ reason:'fallback_ok', rq, fallback: found }); return; }
                }catch(_){ }
                pushLog({ reason:'out_of_range', rq }); return;
              }
              cnt++; pushLog({ reason:'ok', rq });
            });
            try{ console.info('[F5A DBG] count for', displayName, '=>', cnt, 'range=', { from: fromVal, to: toVal }); }catch(_){ }
            return cnt;
          }catch(_){ return 0; }
        }
        const rowsP1 = [];
        const rowsP2 = [];
        sorted.forEach(item=>{
          // Dùng các trường theo ảnh: Phụ trách, Tổng điểm (đang xử lý), Số task đang xử lý, Tổng điểm tất cả, Tổng tác vụ đã xử lý
          const name = item['Phụ trách'] || item.name || '';
          const man = Number(((item['Tổng công chuẩn'] ?? item['Tổng điểm (đang xử lý)'] ?? item.manhour) || 0));
          const count = f5aCountByAssigneeInline(name);
          const ahead = Number(item.ahead||0);
          const ontime = Number(item.ontime||0);
          const late = Number(item.late||0);
          const rAhead = Number(item.rateAhead||0);
          const rOn = Number(item.rateOntime||0);
          const rLate = Number(item.rateLate||0);
          const rNA = Number(item.rateNA||0);
          const clsCnt = Number(item.classifiedCnt|| (ahead+ontime+late));
          const need = f5aGetNeedManhour(name);
        // Tính tổng giờ đánh giá thực tế cho nhân viên này
        const totalActualHoursData = calculateTotalActualHours(name, fromVal, toVal);
        const totalActualHours = totalActualHoursData.formatted;
        
        // Lưu vào Map để sử dụng sau này
        if (!window.F5A_TOTAL_ACTUAL_HOURS_MAP) {
          window.F5A_TOTAL_ACTUAL_HOURS_MAP = new Map();
        }
        window.F5A_TOTAL_ACTUAL_HOURS_MAP.set(name, totalActualHoursData);
          rowsP2.push(`
                  <tr>
                    <td class="px-3 py-2">${name}</td>
              <td class="px-3 py-2"><button class="text-primary-blue hover:underline" data-f5a-rqcount="${name}">${count}</button></td>
              <td class="px-3 py-2">${totalActualHours}</td>
              <td class="px-3 py-2">${man.toFixed(2)}</td>
              <td class="px-3 py-2 cell-div">${need}</td>
              <td class="px-3 py-2">${(function(){ const v = (Number(need)||0) ? (Number(man)/Number(need)) : 0; return (Number.isFinite(v)? v.toFixed(2):''); })()}</td>
            </tr>`);
          rowsP1.push(`
            <tr>
              <td class="px-3 py-2">${name}</td>
              <td class="px-3 py-2 f5a-col-done"><button class="text-primary-blue hover:underline" data-f5a-done="${name}">${Number(item.doneCnt || (ahead + ontime + late))}</button></td>
              <td class="px-3 py-2">${ahead}</td>
              <td class="px-3 py-2">${ontime}</td>
              <td class="px-3 py-2">${late}</td>
              <td class="px-3 py-2">${Number(item.na||0)}</td>
              <td class="px-3 py-2">${rAhead.toFixed(0)}%</td>
              <td class="px-3 py-2">${rOn.toFixed(0)}%</td>
              <td class="px-3 py-2">${rLate.toFixed(0)}%</td>
              <td class="px-3 py-2">${rNA.toFixed(0)}%</td>
            </tr>`);
        });
        try{ const b1 = document.getElementById('f5a-body-p1'); if (b1) b1.innerHTML = rowsP1.join('') || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Chưa có dữ liệu</td></tr>'; }catch(_){ }
        try{ const b2 = document.getElementById('f5a-body-p2'); if (b2) b2.innerHTML = rowsP2.join('') || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Chưa có dữ liệu</td></tr>'; }catch(_){ }
              // Hàng tổng cuối bảng
              const sumMan = sorted.reduce((a,it)=> a + Number(((it['Tổng công chuẩn'] ?? it['Tổng điểm (đang xử lý)'] ?? it.manhour) || 0)), 0);
              const sumNeed = sorted.reduce((a,it)=> a + Number(f5aGetNeedManhour(it['Phụ trách'] || it.name || '')), 0);
              const sumCount = (function(){ try{ return sorted.reduce((acc,it)=> acc + Number(f5aCountByAssigneeInline(it['Phụ trách'] || it.name || '')||0), 0); }catch(_){ return 0; } })();
              const sumAhead = sorted.reduce((a,it)=> a + Number(it.ahead||0), 0);
              const sumOn = sorted.reduce((a,it)=> a + Number(it.ontime||0), 0);
              const sumLate = sorted.reduce((a,it)=> a + Number(it.late||0), 0);
              const sumDone = sorted.reduce((a,it)=> a + Number(it.doneCnt || ((Number(it.ahead||0) + Number(it.ontime||0) + Number(it.late||0)))), 0);
              // Tính tổng giờ đánh giá thực tế từ Map (đã được tính toán ở trên)
              const sumTotalActualHoursRaw = sorted.reduce((a,it)=> {
                const name = it['Phụ trách'] || it.name || '';
                const hoursData = (window.F5A_TOTAL_ACTUAL_HOURS_MAP && window.F5A_TOTAL_ACTUAL_HOURS_MAP.get(name)) || { raw: 0, formatted: '0,00' };
                return a + Number(hoursData.raw);
              }, 0);
              const sumTotalActualHours = sumTotalActualHoursRaw.toFixed(2).replace('.', ',');
              const totalP2 = `
                  <tr class="bg-blue-50 font-semibold">
                    <td class="px-3 py-2">TỔNG</td>
                    <td class="px-3 py-2">${sumCount}</td>
                    <td class="px-3 py-2">${sumTotalActualHours}</td>
                    <td class="px-3 py-2">${sumMan.toFixed(2)}</td>
                    <td class="px-3 py-2 cell-div">${sumNeed.toFixed(2)}</td>
                    <td class="px-3 py-2">${(function(){ const v=(Number(sumNeed)||0)? (Number(sumMan)/Number(sumNeed)) : 0; return (Number.isFinite(v)? v.toFixed(2):''); })()}</td>
                </tr>`;
              const totalP1 = `
                <tr class="bg-blue-50 font-semibold">
                  <td class="px-3 py-2">TỔNG</td>
                    <td class="px-3 py-2 f5a-col-done">${sumDone}</td>
                    <td class="px-3 py-2">${sumAhead}</td>
                    <td class="px-3 py-2">${sumOn}</td>
                    <td class="px-3 py-2">${sumLate}</td>
                    <td class="px-3 py-2"></td>
                  </tr>`;
        try{ const b1 = document.getElementById('f5a-body-p1'); if (b1) b1.innerHTML = (rowsP1.join('') + totalP1); }catch(_){ }
        try{ const b2 = document.getElementById('f5a-body-p2'); if (b2) b2.innerHTML = (rowsP2.join('') + totalP2); }catch(_){ }
        try{ enableTableDrag('f5a-body-p1'); }catch(_){ }
        try{ enableTableDrag('f5a-body-p2'); }catch(_){ }
        // Chart
        F5A_LAST_ROWS = sorted;
        renderStackedChart(sorted);
      }catch(err){
        try{ const b1 = document.getElementById('f5a-body-p1'); if (b1) b1.innerHTML = `<tr><td colspan='10' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`; }catch(_){ }
        try{ const b2 = document.getElementById('f5a-body-p2'); if (b2) b2.innerHTML = `<tr><td colspan='6' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`; }catch(_){ }
        if (chartWrap) chartWrap.style.display = 'none';
      }
    }
    function restoreForm5FromCache(){
      try{
        const cached = LS.getJSON('f5a.cache');
        if (!cached || cached.version !== APP_CACHE_VERSION || !Array.isArray(cached.rows) || !cached.rows.length) return false;
        // Chỉ khôi phục khi trùng tháng hiện đang chọn; nếu input trống thì gán theo cache
        const monthInput = document.getElementById('f5a-month');
        const wantMonth = monthInput ? (monthInput.value || '').trim() : '';
        if (wantMonth && cached.month && cached.month !== wantMonth) return false;
        if (!wantMonth && cached.month && monthInput) { try { monthInput.value = cached.month; } catch(_){} }
        updateLastUpdatedNote('f5a-search-p1','f5a.lastUpdated');
        updateLastUpdatedNote('f5a-search-p2','f5a.lastUpdated');
        const body = document.getElementById('f5a-body');
        if (!body) return false;
        const baseRows = Array.isArray(cached.rows) ? cached.rows.slice() : [];
        const filtered = baseRows.filter(item => {
          const name = (item['Phụ trách'] || item.name || '').trim().toLowerCase();
          // Loại bỏ nhân viên có tên là "x" (dùng cho test code)
          if (name === 'x') return false;
          return true;
        });
        if (!filtered.length){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="12">Không có dữ liệu</td></tr>';
          try{ const chartWrap = document.getElementById('f5a-chart-container'); if(chartWrap) chartWrap.style.display='none'; }catch(_){ }
          return true;
        }
        const sorted = filtered.slice().sort((a,b)=> Number(b["Tổng công chuẩn"]||b.manhour||0) - Number(a["Tổng công chuẩn"]||a.manhour||0));
        const html = sorted.map(item=>{
          const name = item['Phụ trách'] || item.name || '';
          const man = Number(((item['Tổng công chuẩn'] ?? item['Tổng điểm (đang xử lý)'] ?? item.manhour) || 0));
          const count = Number(((item['Tổng tác vụ đã xử lý'] ?? item.count) || 0));
          const ahead = Number(item.ahead||0);
          const ontime = Number(item.ontime||0);
          const late = Number(item.late||0);
          const rAhead = Number(item.rateAhead||0);
          const rOn = Number(item.rateOntime||0);
          const rLate = Number(item.rateLate||0);
          const rNA = Number(item.rateNA||0);
          const need = f5aGetNeedManhour(name);
          return `<tr>
              <td class="px-3 py-2">${name}</td>
              <td class="px-3 py-2">${man.toFixed(2)}</td>
              <td class="px-3 py-2 cell-div">${need}</td>
              <td class="px-3 py-2">${count}</td>
              <td class="px-3 py-2 f5a-col-done">${Number(item.doneCnt || (ahead + ontime + late))}</td>
              <td class="px-3 py-2">${ahead}</td>
              <td class="px-3 py-2">${ontime}</td>
              <td class="px-3 py-2">${late}</td>
              <td class="px-3 py-2">${rAhead.toFixed(0)}%</td>
              <td class="px-3 py-2">${rOn.toFixed(0)}%</td>
              <td class="px-3 py-2">${rLate.toFixed(0)}%</td>
              <td class="px-3 py-2">${rNA.toFixed(0)}%</td>
            </tr>`; }).join('');
        // Hàng tổng cuối bảng (khôi phục từ cache)
        const sumMan = sorted.reduce((a,it)=> a + Number(((it['Tổng công chuẩn'] ?? it['Tổng điểm (đang xử lý)'] ?? it.manhour) || 0)), 0);
        const sumNeed = sorted.reduce((a,it)=> a + Number(f5aGetNeedManhour(it['Phụ trách'] || it.name || '')), 0);
        const sumCount = sorted.reduce((a,it)=> a + Number(((it['Tổng tác vụ đã xử lý'] ?? it.count) || 0)), 0);
        const sumAhead = sorted.reduce((a,it)=> a + Number(it.ahead||0), 0);
        const sumOn = sorted.reduce((a,it)=> a + Number(it.ontime||0), 0);
        const sumLate = sorted.reduce((a,it)=> a + Number(it.late||0), 0);
        const sumDone = sorted.reduce((a,it)=> a + Number(it.doneCnt || ((Number(it.ahead||0) + Number(it.ontime||0) + Number(it.late||0)))), 0);
        const totalRow = `
            <tr class="bg-blue-50 font-semibold">
              <td class="px-3 py-2">TỔNG</td>
              <td class="px-3 py-2">${sumMan.toFixed(2)}</td>
              <td class="px-3 py-2 cell-div">${sumNeed.toFixed(2)}</td>
              <td class="px-3 py-2">${sumCount}</td>
              <td class="px-3 py-2 f5a-col-done">${sumDone}</td>
              <td class="px-3 py-2">${sumAhead}</td>
              <td class="px-3 py-2">${sumOn}</td>
              <td class="px-3 py-2">${sumLate}</td>
              <td class="px-3 py-2"></td>
              <td class="px-3 py-2"></td>
              <td class="px-3 py-2"></td>
              <td class="px-3 py-2"></td>
            </tr>`;
        body.innerHTML = html + totalRow;
        try{ enableTableDrag('f5a-body'); }catch(_){ }
        F5A_LAST_ROWS = sorted;
        try{ const chartWrap = document.getElementById('f5a-chart-container'); if(chartWrap) chartWrap.style.display='none'; }catch(_){ }
        return true;
      }catch(_){ return false; }
    }
    // Build payload (rows + tổng) để xuất server
    function f5aBuildExportPayload(rows){
      try{
        // Lọc bỏ nhân viên test "x"
        const list = Array.isArray(rows) ? rows.filter(it => {
          const name = (it['Phụ trách'] || it.name || '').trim().toLowerCase();
          return name !== 'x';
        }) : [];
        const items = list.map(it=>{
          const name = it['Phụ trách'] || it.name || '';
          const man = Number(((it['Tổng công chuẩn'] ?? it['Tổng điểm (đang xử lý)'] ?? it.manhour) || 0));
          const count = Number(((it['Tổng tác vụ đã xử lý'] ?? it.count) || 0));
          const ahead = Number(it.ahead||0);
          const ontime = Number(it.ontime||0);
          const late = Number(it.late||0);
          const na = Number(it.na||0);
          const need = Number(f5aGetNeedManhour(name) || 0);
          return { name, manhour: +man.toFixed(2), need: +need.toFixed(2), count, ahead, ontime, late, na };
        });
        const total = items.reduce((acc,it)=>{
          acc.manhour += Number(it.manhour||0);
          acc.need += Number(it.need||0);
          acc.count += Number(it.count||0);
          acc.ahead += Number(it.ahead||0);
          acc.ontime += Number(it.ontime||0);
          acc.late += Number(it.late||0);
          acc.na += Number(it.na||0);
          return acc;
        }, { manhour:0, need:0, count:0, ahead:0, ontime:0, late:0, na:0 });
        const month = (document.getElementById('f5a-month')?.value||'');
        return {
          action: 'form5_export',
          month,
          items,
          total: {
            manhour: +total.manhour.toFixed(2),
            need: +total.need.toFixed(2),
            count: total.count,
            ahead: total.ahead,
            ontime: total.ontime,
            late: total.late,
            na: total.na
          },
          ts: new Date().toISOString()
        };
      }catch(_){
        return { action:'form5_export', month:'', items:[], total:{manhour:0,need:0,count:0,ahead:0,ontime:0,late:0,na:0}, ts:new Date().toISOString() };
      }
    }
    async function f5aTryPostJson(url, data, noCors){
      try{
        const r = await fetch(url, { method:'POST', mode: noCors ? 'no-cors' : 'cors', headers:{ 'Content-Type':'application/json', 'Accept':'application/json, text/plain, */*' }, body: JSON.stringify(data) });
        const ok = noCors ? true : r.ok;
        let raw = '';
        try{ raw = await r.text(); }catch(_){ raw = ''; }
        return { ok, raw };
      }catch(err){ return { ok:false, raw: String(err||'') }; }
    }
    async function f5aExportToServer(payload){
      const base = WEBHOOK_URL;
      const test = base.replace('/webhook/', '/webhook-test/');
      const q = new URLSearchParams({ action:'form5_export', _ts: Date.now().toString() }).toString();
      const targets = [ `${test}?${q}`, `${base}?${q}` ];
      // Thử tuần tự: POST no-cors -> POST thường
      for (const u of targets){
        let r = await f5aTryPostJson(u, payload, true);
        if (r.ok) return true;
        r = await f5aTryPostJson(u, payload, false);
        if (r.ok) return true;
      }
      return false;
    }
    // Gắn sự kiện cho nút Xuất server
    (function initF5aExport(){
      const btn = document.getElementById('f5a-export');
      if (!btn) return;
      btn.addEventListener('click', async (e)=>{
        e.preventDefault();
        const rows = Array.isArray(F5A_LAST_ROWS) ? F5A_LAST_ROWS.slice() : [];
        if (!rows.length){ showToast('Không có dữ liệu để xuất.','error'); return; }
        const payload = f5aBuildExportPayload(rows);
        btn.disabled = true;
        const prev = btn.textContent;
        btn.innerHTML = "<span class='spinner mr-2'></span>Đang xuất...";
        try{
          const ok = await f5aExportToServer(payload);
          if (ok) showToast('Đã xuất dữ liệu lên server.','success'); else showToast('Xuất thất bại.','error');
        }catch(_){ showToast('Xuất thất bại.','error'); }
        finally{
          btn.disabled = false;
          btn.textContent = prev || 'Xuất server';
        }
      });
    })();

    // Xuất CSV/XLSX
    function f5aRowsToAOA(rows){
      // Lấy tháng hiện chọn để lọc theo ngày nhận
      let fromVal = '', toVal = '';
      try{
        const m = (document.getElementById('f5a-month')?.value||'').trim();
        if (m){ const [yy,mm] = m.split('-'); fromVal = `${yy}-${mm}-01`; const last = new Date(Number(yy), Number(mm), 0).getDate(); toVal = `${yy}-${mm}-${String(last).padStart(2,'0')}`; }
      }catch(_){ }
      const headers = [
        'Nhân viên','Số tác vụ trong tháng','Tổng giờ đánh giá thực tế','Công chuẩn đã nhận','Công chuẩn cần nhận','Số hoàn thành trong tháng','Vượt tiến độ','Đúng tiến độ','Chậm tiến độ','Số N/A','%Vượt','%Đúng','%Chậm','%N/A'
      ];
      const aoa = [headers];
      // Lọc bỏ nhân viên test "x" 
      const list = Array.isArray(rows) ? rows.filter(item => {
        const name = (item['Phụ trách'] || item.name || '').trim().toLowerCase();
        return name !== 'x';
      }) : [];
      // Map đếm số task theo ngày nhận (requestDate) trong tháng đã chọn, loại Cancel
      const rqCountMap = (function(){
        try{
          const raw = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
          const map = new Map();
          const toKey = (s)=>{ try{ const raw=String(s||'').trim(); const vz=(typeof vnLower==='function'? vnLower(raw): raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); return vz.replace(/\s+/g,' ').trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
          const getV = (obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
          const parseDate = (v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
          const iso = (d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
          const inRange = (ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
          const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Phụ trách','Phụ trách chính','Người phụ trách','Người xử lý','Người nhận mẫu','Người nhận','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
            const rqKeys = [
              '📆 ngày yêu cầu','📆 Ngày yêu cầu','📆 Ngày yêu cầu ',
              'ngày yêu cầu','Ngày yêu cầu','Ngày yêu cầu ',
              'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
              'submissiondate','submitteddate','submitdate','submit_date',
              'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
              'ngaygui','ngay_gui','ngày gửi','Ngày gửi',
              'createddate','created_date','creationdate','created',
              'ngaytao','ngay_tao','ngày tạo','Ngày tạo',
              '📆 ngày gửi','📆 Ngày gửi'
            ];
          const statusKeys = ['Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái'];
          const doneKeys = ['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','Ngày kết thúc','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
          const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const done=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('hủy')||st.includes('huỷ')||/cancel/i.test(done); };
          raw.forEach(o=>{
            if (isCanceled(o)) return;
            const emp = getV(o, assigneeKeys);
            const rq = getV(o, rqKeys); const rqD = parseDate(rq); const rqIso = rqD? iso(rqD):''; if (!inRange(rqIso)) return;
            const key = toKey(emp);
            map.set(key, (map.get(key)||0) + 1);
          });
          return map;
        }catch(_){ return new Map(); }
      })();
      list.forEach(item=>{
        const name = item['Phụ trách'] || item.name || '';
        const man = Number(((item['Tổng công chuẩn'] ?? item['Tổng điểm (đang xử lý)'] ?? item.manhour) || 0));
        const need = Number(f5aGetNeedManhour(name)||0);
        const ahead = Number(item.ahead||0);
        const ontime = Number(item.ontime||0);
        const late = Number(item.late||0);
        const done = Number(item.doneCnt || (ahead+ontime+late));
        const na = Number(item.na||0);
        const rAhead = Number(item.rateAhead||0);
        const rOn = Number(item.rateOntime||0);
        const rLate = Number(item.rateLate||0);
        const rNA = Number(item.rateNA||0);
        const key = (function(){ try{ const raw = String(name||'').trim(); const vz=(typeof vnLower==='function'? vnLower(raw): raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); return vz.replace(/\s+/g,' ').trim(); }catch(_){ return String(name||'').toLowerCase().trim(); } })();
        const count = Number(rqCountMap.get(key)||0);
        // Lấy tổng giờ đánh giá thực tế từ Map (đã được tính toán)
        const totalActualHoursData = (window.F5A_TOTAL_ACTUAL_HOURS_MAP && window.F5A_TOTAL_ACTUAL_HOURS_MAP.get(name)) || { raw: 0, formatted: '0,00' };
        const totalActualHours = totalActualHoursData.formatted;
        aoa.push([
          name,
          count,
          totalActualHours,
          man,
          need,
          done,
          ahead,
          ontime,
          late,
          na,
          rAhead,
          rOn,
          rLate,
          rNA
        ]);
      });
      // Tổng cuối (đồng bộ thứ tự cột)
      const sumMan = list.reduce((a,it)=> a + Number(((it['Tổng công chuẩn'] ?? it['Tổng điểm (đang xử lý)'] ?? it.manhour) || 0)), 0);
      const sumNeed = list.reduce((a,it)=> a + Number(f5aGetNeedManhour(it['Phụ trách'] || it.name || '')), 0);
      const sumCount = (function(){ try{ let s=0; (Array.isArray(list)?list:[]).forEach(it=>{ const n=it['Phụ trách']||it.name||''; const key=(typeof vnLower==='function'? vnLower(String(n||'')): String(n||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()).replace(/\s+/g,' ').trim(); s += Number(rqCountMap.get(key)||0); }); return s; }catch(_){ return 0; } })();
      const sumAhead = list.reduce((a,it)=> a + Number(it.ahead||0), 0);
      const sumOn = list.reduce((a,it)=> a + Number(it.ontime||0), 0);
      const sumLate = list.reduce((a,it)=> a + Number(it.late||0), 0);
      const sumDone = list.reduce((a,it)=> a + Number(it.doneCnt || ((Number(it.ahead||0) + Number(it.ontime||0) + Number(it.late||0)))), 0);
      // Tính tổng giờ đánh giá thực tế từ Map (đã được tính toán)
      const sumTotalActualHoursRaw = list.reduce((a,it)=> {
        const name = it['Phụ trách'] || it.name || '';
        const hoursData = (window.F5A_TOTAL_ACTUAL_HOURS_MAP && window.F5A_TOTAL_ACTUAL_HOURS_MAP.get(name)) || { raw: 0, formatted: '0,00' };
        return a + Number(hoursData.raw);
      }, 0);
      const sumTotalActualHours = sumTotalActualHoursRaw.toFixed(2).replace('.', ',');
      aoa.push(['TỔNG', sumCount, sumTotalActualHours, +sumMan.toFixed(2), +sumNeed.toFixed(2), sumDone, sumAhead, sumOn, sumLate, '', '', '', '', '' ]);
      return aoa;
    }
    function f5aDownloadXLSX(rows){
      try{
        const wb = XLSX.utils.book_new();
        const month = (document.getElementById('f5a-month')?.value || '').replace(/\s+/g,'');
        // Sheet tổng hợp
        const aoa = f5aRowsToAOA(rows);
        const wsAll = XLSX.utils.aoa_to_sheet(aoa);
        XLSX.utils.book_append_sheet(wb, wsAll, 'Tổng hợp');
        // Sheet bảng phụ - Hoàn thành (lọc theo ngày hoàn thành, chia nhóm theo ngày nhận)
        (function appendDetailDoneSheet(){
          try{
            let fromVal = '', toVal = '';
            try{ const m=(document.getElementById('f5a-month')?.value||'').trim(); if(m){ const [yy,mm]=m.split('-'); fromVal=`${yy}-${mm}-01`; const last=new Date(Number(yy), Number(mm), 0).getDate(); toVal=`${yy}-${mm}-${String(last).padStart(2,'0')}`; } }catch(_){ }
            const rowsRaw = Array.isArray(F5A_RAW_ALL)? F5A_RAW_ALL: [];
            const getV=(obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
            const toDate=(v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
            const iso=(d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
            const inRange=(ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
            const noAcc=(s)=>{ try{ return (typeof vnLower==='function')? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); } };
            const sameName=(a,b)=> noAcc(a).replace(/\s+/g,' ').trim() === noAcc(b).replace(/\s+/g,' ').trim();
            const empKeys=['Assignee','Assignee Name','AssigneeName','Assignee name','Phụ trách','Phụ trách chính','Người phụ trách','Người xử lý','Người nhận mẫu','Người nhận','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
            const rqKeys=[
              '📆 ngày yêu cầu','📆 Ngày yêu cầu','📆 Ngày yêu cầu ',
              'ngày yêu cầu','Ngày yêu cầu','Ngày yêu cầu ',
              'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
              'submissiondate','submitteddate','submitdate','submit_date',
              'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
              'ngaygui','ngay_gui','ngày gửi','Ngày gửi',
              'createddate','created_date','creationdate','created',
              'ngaytao','ngay_tao','ngày tạo','Ngày tạo'
            ];
            const codeKeys=['code','ma','taskcode','mã'];
            const tnameKeys=['Task Name','Tên tác vụ','Task','Công việc','Tên Task','taskname','ten_tac_vu','ten','name','title'];
            const manKeys=['Điểm','Score','score','Công chuẩn công việc nhận ','Công chuẩn công việc nhận','Công chuẩn','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
            const actualKeys=['Số giờ đánh giá thực tế','so gio danh gia thuc te','số giờ đánh giá thực tế','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te'];
            const wishKeys=['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn','Hạn mong muốn ','Hạn mong muốn'];
            const doneKeys=['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','Ngày kết thúc','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
            const statusKeys=['Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái'];
            const isCanceled=(o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const dn=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('hủy')||st.includes('huỷ')||/cancel/i.test(dn); };
            const head=['Nhân viên','Nhóm theo ngày nhận','Mã','Tên tác vụ','Ngày yêu cầu','Số giờ đánh giá thực tế','Công chuẩn','Hạn mong muốn','Hạn +1','Ngày hoàn thành','Trạng thái theo công chuẩn','Hiện trạng theo hạn mong muốn'];
            const aoaD=[head];
            rowsRaw.forEach(o=>{
              if (isCanceled(o)) return;
              const done = getV(o, doneKeys); const dD = toDate(done); const doneIso = dD? iso(dD):''; if (!inRange(doneIso)) return;
              const emp = getV(o, empKeys);
              const rq = getV(o, rqKeys); const rqD = toDate(rq); const rqIso = rqD? iso(rqD):'';
              const grp = (rqIso && inRange(rqIso)) ? 'Nhận trong tháng' : 'Nhận tháng trước';
              const code=getV(o, codeKeys);
              const tn=getV(o, tnameKeys);
              const man=getV(o, manKeys);
              const act=getV(o, actualKeys);
              const wish=getV(o, wishKeys);
              let wishP1=''; try{ const dW=toDate(wish); if(dW){ const p1=new Date(dW.getFullYear(), dW.getMonth(), dW.getDate()+1); const pad=n=>String(n).padStart(2,'0'); wishP1=`${pad(p1.getDate())}/${pad(p1.getMonth()+1)}/${p1.getFullYear()}`; } }catch(_){ }
              const stByWish = getV(o,['Hiện trạng theo hạn mong muốn','status_by_wish','status_wish','statuswish','ht_theo_han_mong_muon']);
              // Tính "Trạng thái theo công chuẩn" giống modal P1
              const toNum=(s)=>{ try{ const t=String(s||'').trim().replace(/[^0-9.,-]/g,'').replace(',', '.'); const n=parseFloat(t); return Number.isFinite(n)? n: 0; }catch(_){ return 0; } };
              let stByMan = '';
              try{
                const actualNum = toNum(act);
                const manNum = toNum(man);
                const EPS = 1e-4;
                const hasDone = !!toDate(done);
                const actualIsZero = Number.isFinite(actualNum) && Math.abs(actualNum) < 1e-9;
                if (actualIsZero){
                  stByMan = 'Thiếu dữ liệu';
                } else if (hasDone && Number.isFinite(actualNum) && Number.isFinite(manNum)){
                  const tolerance = Math.max(EPS, Math.abs(manNum) * 0.10);
                  if (actualNum > manNum + tolerance) stByMan = 'Chậm tiến độ';
                  else if (Math.abs(actualNum - manNum) <= tolerance) stByMan = 'Đúng tiến độ';
                  else stByMan = 'Vượt tiến độ';
                }
              }catch(_){ }
              const fmt=(v)=>{ try{ return v? formatDdMmYyyy(v):''; }catch(_){ return v||''; } };
              aoaD.push([ emp, grp, code, tn, fmt(rq), act, man, wish, wishP1, fmt(done), stByMan, stByWish ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(aoaD);
            XLSX.utils.book_append_sheet(wb, ws, 'Bảng phụ - Hoàn thành');
          }catch(_){ }
        })();
        // Sheet bảng phụ - Nhận tháng (lọc theo ngày yêu cầu, loại Cancel)
        (function appendDetailReceivedSheet(){
          try{
            let fromVal = '', toVal = '';
            try{ const m=(document.getElementById('f5a-month')?.value||'').trim(); if(m){ const [yy,mm]=m.split('-'); fromVal=`${yy}-${mm}-01`; const last=new Date(Number(yy), Number(mm), 0).getDate(); toVal=`${yy}-${mm}-${String(last).padStart(2,'0')}`; } }catch(_){ }
            const rowsRaw = Array.isArray(F5A_RAW_ALL)? F5A_RAW_ALL: [];
            const getV=(obj, keys)=>{ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; };
            const toDate=(v)=>{ if(!v) return null; const s=String(v).trim(); let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/); if(m){ const d=+m[1],mo=+m[2],y=m[3].length===2?+('20'+m[3]):+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(m){ const dt=new Date(+m[1],+m[2]-1,+m[3]); return isNaN(dt)?null:dt; } const dt=new Date(s); return isNaN(dt)?null:dt; };
            const iso=(d)=>{ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
            const inRange=(ds)=>{ if(!fromVal && !toVal) return true; if(!ds) return false; if(fromVal && ds < fromVal) return false; if(toVal && ds > toVal) return false; return true; };
            const empKeys=['Assignee','Assignee Name','AssigneeName','Assignee name','Phụ trách','Phụ trách chính','Người phụ trách','Người xử lý','Người nhận mẫu','Người nhận','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
            const rqKeys=['📆 ngày yêu cầu','📆 Ngày yêu cầu','📆 Ngày yêu cầu ','ngày yêu cầu','Ngày yêu cầu','requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui'];
            const codeKeys=['code','ma','taskcode','mã'];
            const tnameKeys=['Task Name','Tên tác vụ','Task','Công việc','Tên Task','taskname','ten_tac_vu','ten','name','title'];
            const manKeys=['Điểm','Score','score','Công chuẩn công việc nhận ','Công chuẩn công việc nhận','Công chuẩn','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
            const actualKeys=['Số giờ đánh giá thực tế','so gio danh gia thuc te','số giờ đánh giá thực tế','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te'];
            const wishKeys=['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn','Hạn mong muốn ','Hạn mong muốn'];
            const doneKeys=['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','Ngày kết thúc','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
            const statusKeys=['Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái'];
            const isCanceled=(o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const dn=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('hủy')||st.includes('huỷ')||/cancel/i.test(dn); };
            const head=['Nhân viên','Mã','Tên tác vụ','Ngày yêu cầu','Công chuẩn','Số giờ đánh giá thực tế','Hạn mong muốn','Ngày hoàn thành','Trạng thái'];
            const aoaR=[head];
            rowsRaw.forEach(o=>{
              if (isCanceled(o)) return;
              const rq = getV(o, rqKeys); const rqD = toDate(rq); const rqIso = rqD? iso(rqD):''; if (!inRange(rqIso)) return;
              const emp=getV(o, empKeys);
              const code=getV(o, codeKeys);
              const tn=getV(o, tnameKeys);
              const man=getV(o, manKeys);
              const act=getV(o, actualKeys);
              const wish=getV(o, wishKeys);
              const done=getV(o, doneKeys);
              const st=getV(o, statusKeys);
              const fmt=(v)=>{ try{ return v? formatDdMmYyyy(v):''; }catch(_){ return v||''; } };
              aoaR.push([ emp, code, tn, fmt(rq), man, act, wish, fmt(done), st ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(aoaR);
            XLSX.utils.book_append_sheet(wb, ws, 'Bảng phụ - Nhận tháng');
          }catch(_){ }
        })();
        // Bỏ tạo sheet riêng từng nhân viên; đã có 2 bảng phụ ở trên theo yêu cầu
        
        // Add P3 sheet
        try{
          const aoaP3 = f5aExportP3ToAOA();
          const wsP3 = XLSX.utils.aoa_to_sheet(aoaP3);
          XLSX.utils.book_append_sheet(wb, wsP3, 'P3 - Rà soát CE');
        }catch(err){
          console.error('[Export] P3 sheet error:', err);
        }
        
        // Add P4 sheet
        try{
          const aoaP4 = f5aExportP4ToAOA();
          const wsP4 = XLSX.utils.aoa_to_sheet(aoaP4);
          XLSX.utils.book_append_sheet(wb, wsP4, 'P4 - 4M rà soát');
        }catch(err){
          console.error('[Export] P4 sheet error:', err);
        }
        
        XLSX.writeFile(wb, `Form5_All_${month||'export'}.xlsx`);
      }catch(_){ showToast('Xuất XLSX thất bại.','error'); }
    }
    (function initF5aFileExports(){
      const btnXlsx = document.getElementById('f5a-export-xlsx');
      if (btnXlsx) btnXlsx.addEventListener('click', (e)=>{ e.preventDefault(); const rows = Array.isArray(F5A_LAST_ROWS)?F5A_LAST_ROWS:[]; if(!rows.length){ showToast('Không có dữ liệu để xuất.','error'); return; } f5aDownloadXLSX(rows); });
    })();
    
    // Helper functions to export P3 and P4 data
    function f5aExportP3ToAOA(){
      try{
        const monthInput = document.getElementById('f5a-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        
        if(!Array.isArray(F5A_P3_RAW) || !F5A_P3_RAW.length){
          return [['Chưa có dữ liệu P3. Vui lòng nhấn "Tra cứu P3" trước.']];
        }
        
        // Helper functions
        const norm = (s) => String(s||'').toLowerCase().trim();
        const getV = (obj, keys) => {
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
          for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
          return '';
        };
        
        const parseDate = (value) => {
          try{
            if(!value) return null;
            const s = String(value).trim();
            let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if(m){ return new Date(+m[3], +m[2]-1, +m[1]); }
            m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
            if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
            return new Date(s);
          }catch(_){ return null; }
        };
        
        const formatYyyyMm = (d) => {
          if(!d) return '';
          return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        };
        
        // Aggregate by employee
        const byName = new Map();
        
        F5A_P3_RAW.forEach(r => {
          let name = String(getV(r, [
            'assignee','employee','name',
            'nhân viên','nhan vien','nhanvien',
            'tên nhân viên','ten nhan vien','tennhanvien',
            'phụ trách','phu trac','phutrac'
          ])||'').trim();
          if(!name){
            const email = String(getV(r, ['EmailofAssignee','emailofassignee','email'])) || '';
            if (email){
              try{ name = email.split('@')[0] || email; }catch(_){ name = email; }
            }
          }
          
          if(!name || name.toLowerCase() === 'x') return;
          
          const completionDateStr = getV(r, [
            'ngày hoàn thành thực tế','ngay hoan thanh thuc te',
            'ngày hoàn thành','ngay hoan thanh',
            'completion date','completiondate'
          ]);
          
          const completionDate = parseDate(completionDateStr);
          
          if(monthVal && completionDate){
            const taskMonth = formatYyyyMm(completionDate);
            if(taskMonth !== monthVal) return;
          } else if(monthVal && !completionDate) {
            return;
          }
          
          const ceReview = String(getV(r, [
            'ce rà soát','ce ra soat','cerasoat',
            'ce review','cereview'
          ])||'').trim();
          
          if(!byName.has(name)){
            byName.set(name, { name, completed: 0, notNeeded: 0, pending: 0 });
          }
          
          const rec = byName.get(name);
          const ceNorm = ceReview.toLowerCase();
          
          if(ceNorm === 'đã gửi' || ceNorm === 'da gui'){
            rec.completed++;
          } else if(ceNorm === 'không cần' || ceNorm === 'khong can'){
            rec.notNeeded++;
          } else if(!ceReview || ceNorm === ''){
            rec.pending++;
          }
        });
        
        // Build AOA
        const headers = ['Tên nhân viên', 'Số tác vụ hoàn thành tháng', 'Tác vụ đã hoàn thiện CE', 'Tác vụ không cần làm CE', 'Chưa hoàn thành', 'Thẻ P3/Rà soát CE (%)'];
        const aoa = [headers];
        
        const sorted = Array.from(byName.values()).sort((a,b)=> a.name.localeCompare(b.name, 'vi'));
        
        let sumTotal = 0, sumCompleted = 0, sumNotNeeded = 0, sumPending = 0;
        
        sorted.forEach(rec => {
          const total = rec.completed + rec.notNeeded + rec.pending;
          const percentage = total > 0 ? ((rec.completed + rec.notNeeded) / total * 100).toFixed(2) : '0.00';
          
          aoa.push([
            rec.name,
            total,
            rec.completed,
            rec.notNeeded,
            rec.pending,
            `${percentage}%`
          ]);
          
          sumTotal += total;
          sumCompleted += rec.completed;
          sumNotNeeded += rec.notNeeded;
          sumPending += rec.pending;
        });
        
        // Total row
        const totalPercentage = sumTotal > 0 ? ((sumCompleted + sumNotNeeded) / sumTotal * 100).toFixed(2) : '0.00';
        aoa.push([
          'TỔNG',
          sumTotal,
          sumCompleted,
          sumNotNeeded,
          sumPending,
          `${totalPercentage}%`
        ]);
        
        return aoa;
      }catch(err){
        console.error('[P3 Export] Error:', err);
        return [['Lỗi xuất dữ liệu P3']];
      }
    }
    
    function f5aExportP4ToAOA(){
      try{
        const monthInput = document.getElementById('f5a-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        
        if(!Array.isArray(F5A_P3_RAW) || !F5A_P3_RAW.length){
          return [['Chưa có dữ liệu P4. Vui lòng nhấn "Tra cứu P4" trước.']];
        }
        
        // Helper functions
        const norm = (s) => String(s||'').toLowerCase().trim();
        const getV = (obj, keys) => {
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
          for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
          return '';
        };
        
        const parseDate = (value) => {
          try{
            if(!value) return null;
            const s = String(value).trim();
            let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if(m){ return new Date(+m[3], +m[2]-1, +m[1]); }
            m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
            if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
            return new Date(s);
          }catch(_){ return null; }
        };
        
        const formatYyyyMm = (d) => {
          if(!d) return '';
          return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        };
        
        const parsePercent = (v) => {
          try{
            if(!v) return 0;
            const s = String(v).trim();
            const num = parseFloat(s);
            if(isNaN(num)) return 0;
            // If already in 0-1 range, convert to 0-100
            if(num >= 0 && num <= 1) return num * 100;
            // If in 0-100 range, use as is
            if(num >= 0 && num <= 100) return num;
            return 0;
          }catch(_){ return 0; }
        };
        
        // Aggregate by employee
        const byName = new Map();
        
        F5A_P3_RAW.forEach(r => {
          const name = String(getV(r, [
            'assignee','employee','name',
            'nhân viên','nhan vien','nhanvien',
            'tên nhân viên','ten nhan vien','tennhanvien',
            'phụ trách','phu trac','phutrac'
          ])||'').trim();
          
          if(!name || name.toLowerCase() === 'x') return;
          
          const completionDateStr = getV(r, [
            'ngày hoàn thành thực tế','ngay hoan thanh thuc te',
            'ngày hoàn thành','ngay hoan thanh'
          ]);
          
          const completionDate = parseDate(completionDateStr);
          
          if(monthVal && completionDate){
            const taskMonth = formatYyyyMm(completionDate);
            if(taskMonth !== monthVal) return;
          } else if(monthVal && !completionDate) {
            return;
          }
          
          // Check "4M rà soát"
          const rasoat4m = String(getV(r, [
            '4M rà soát','4m rà soát','4m ra soat',
            '4M','4m rasoat'
          ])||'').trim();
          
          if(!rasoat4m) return; // Only count tasks with 4M data
          
          if(!byName.has(name)){
            byName.set(name, {
              name,
              totalTasks: 0,
              tcktCompleted: 0, tcktTotal: 0,
              ceCompleted: 0, ceTotal: 0,
              hdktCompleted: 0, hdktTotal: 0,
              bbCompleted: 0, bbTotal: 0,
              jigCompleted: 0, jigTotal: 0,
              khksclCompleted: 0, khksclTotal: 0
            });
          }
          
          const rec = byName.get(name);
          rec.totalTasks++;
          
          // Parse percentages
          const tckt = parsePercent(getV(r, ['TCKT(% hoàn thành)','tckt','tckt%']));
          const ce = parsePercent(getV(r, ['CE(% hoàn thành)','ce','ce%']));
          const hdkt = parsePercent(getV(r, ['HDKT(% hoàn thành)','hdkt','hdkt%']));
          const bb = parsePercent(getV(r, ['BB đào tạo(% hoàn thành)','bb dao tao','bb%']));
          const jig = parsePercent(getV(r, ['Jig tool(% hoàn thành)','jig tool','jig%']));
          const khkscl = parsePercent(getV(r, ['KHKSCL(% hoàn thành)','khkscl','khkscl%']));
          
          // Accumulate
          if(tckt > 0) { rec.tcktCompleted += tckt; rec.tcktTotal++; }
          if(ce > 0) { rec.ceCompleted += ce; rec.ceTotal++; }
          if(hdkt > 0) { rec.hdktCompleted += hdkt; rec.hdktTotal++; }
          if(bb > 0) { rec.bbCompleted += bb; rec.bbTotal++; }
          if(jig > 0) { rec.jigCompleted += jig; rec.jigTotal++; }
          if(khkscl > 0) { rec.khksclCompleted += khkscl; rec.khksclTotal++; }
        });
        
        // Build AOA
        const headers = ['Tên nhân viên', 'Tổng tác vụ máy', 'TCKT(% hoàn thành)', 'CE(% hoàn thành)', 'HDKT(% hoàn thành)', 'BB đào tạo(% hoàn thành)', 'Jig tool(% hoàn thành)', 'KHKSCL(% hoàn thành)', 'Thẻ P4 (%)'];
        const aoa = [headers];
        
        const sorted = Array.from(byName.values()).sort((a,b)=> a.name.localeCompare(b.name, 'vi'));
        
        let sumTotal = 0, sumTckt = 0, sumCe = 0, sumHdkt = 0, sumBb = 0, sumJig = 0, sumKhkscl = 0, sumP4 = 0;
        
        sorted.forEach(r => {
          const tcktPercentage = r.tcktTotal > 0 ? (r.tcktCompleted / r.tcktTotal).toFixed(2) : '0.00';
          const cePercentage = r.ceTotal > 0 ? (r.ceCompleted / r.ceTotal).toFixed(2) : '0.00';
          const hdktPercentage = r.hdktTotal > 0 ? (r.hdktCompleted / r.hdktTotal).toFixed(2) : '0.00';
          const bbPercentage = r.bbTotal > 0 ? (r.bbCompleted / r.bbTotal).toFixed(2) : '0.00';
          const jigPercentage = r.jigTotal > 0 ? (r.jigCompleted / r.jigTotal).toFixed(2) : '0.00';
          const khksclPercentage = r.khksclTotal > 0 ? (r.khksclCompleted / r.khksclTotal).toFixed(2) : '0.00';
          
          // Calculate P4 percentage (average of all 6, always divide by 6)
          const tcktVal = parseFloat(tcktPercentage);
          const ceVal = parseFloat(cePercentage);
          const hdktVal = parseFloat(hdktPercentage);
          const bbVal = parseFloat(bbPercentage);
          const jigVal = parseFloat(jigPercentage);
          const khksclVal = parseFloat(khksclPercentage);
          
          const totalSum = tcktVal + ceVal + hdktVal + bbVal + jigVal + khksclVal;
          const p4Percentage = (totalSum / 6).toFixed(2);
          
          aoa.push([
            r.name,
            r.totalTasks,
            `${tcktPercentage}%`,
            `${cePercentage}%`,
            `${hdktPercentage}%`,
            `${bbPercentage}%`,
            `${jigPercentage}%`,
            `${khksclPercentage}%`,
            `${p4Percentage}%`
          ]);
          
          sumTotal += r.totalTasks;
          sumTckt += parseFloat(tcktPercentage);
          sumCe += parseFloat(cePercentage);
          sumHdkt += parseFloat(hdktPercentage);
          sumBb += parseFloat(bbPercentage);
          sumJig += parseFloat(jigPercentage);
          sumKhkscl += parseFloat(khksclPercentage);
          sumP4 += parseFloat(p4Percentage);
        });
        
        // Total row
        const count = sorted.length;
        const avgTckt = count > 0 ? (sumTckt / count).toFixed(2) : '0.00';
        const avgCe = count > 0 ? (sumCe / count).toFixed(2) : '0.00';
        const avgHdkt = count > 0 ? (sumHdkt / count).toFixed(2) : '0.00';
        const avgBb = count > 0 ? (sumBb / count).toFixed(2) : '0.00';
        const avgJig = count > 0 ? (sumJig / count).toFixed(2) : '0.00';
        const avgKhkscl = count > 0 ? (sumKhkscl / count).toFixed(2) : '0.00';
        const avgP4 = count > 0 ? (sumP4 / count).toFixed(2) : '0.00';
        
        aoa.push([
          'TỔNG',
          sumTotal,
          `${avgTckt}%`,
          `${avgCe}%`,
          `${avgHdkt}%`,
          `${avgBb}%`,
          `${avgJig}%`,
          `${avgKhkscl}%`,
          `${avgP4}%`
        ]);
        
        return aoa;
      }catch(err){
        console.error('[P4 Export] Error:', err);
        return [['Lỗi xuất dữ liệu P4']];
      }
    }
    // Nút làm mới lựa chọn biểu đồ Form 5
    (function initF5aRefresh(){
      const btn = document.getElementById('f5a-refresh');
      if (!btn) return;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); try{ if (window.F5A_RENDER_CHART) { window.F5A_RENDER_CHART(); } else { try{ renderStackedChart(F5A_LAST_ROWS||[]); }catch(_){ } } }catch(_){ } });
    })();
    // Default Form 4 month = current month (đã có ở trên)
    // Thêm default cho Form 5 (All tasks)
    (function setDefaultF5aMonth(){
      const m = document.getElementById('f5a-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
    })();
    // Modal: tác vụ nhận trong tháng (lọc theo requestDate thuộc [from,to])
    (function initRqDetailModal(){
      const modal = document.getElementById('rq-detail-modal');
      const closeBtn = document.getElementById('rq-detail-close');
      if (closeBtn) closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } });
      if (modal) modal.addEventListener('click', (e)=>{ if(e.target===modal){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('open')){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
      
      
    })();
    // Hàm tính tổng giờ đánh giá thực tế cho một nhân viên
    function calculateTotalActualHours(empName, from, to) {
      try {
        const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
        function norm(s){ return String(s||'').trim(); }
        function getV(obj, keys){ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; }
        function vnNoAcc(s){ try{ return (typeof vnLower==='function')? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); } }
        function sameName(a,b){ return vnNoAcc(a).replace(/\s+/g,' ').trim() === vnNoAcc(b).replace(/\s+/g,' ').trim(); }
        function parseDate(v){ try{ return parseDateFlexible(v); } catch(_){ return null; } }
        function iso(d){ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; }
        function inRange(ds){ if(!from && !to) return true; if(!ds) return false; if(from && ds < from) return false; if(to && ds > to) return false; return true; }
        
        const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Phụ trách','Phụ trách chính','Người phụ trách','Người xử lý','Người nhận mẫu','Người nhận','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
        const rqKeys = [
          '📆 ngày yêu cầu','📆 Ngày yêu cầu','📆 Ngày yêu cầu ',
          'ngày yêu cầu','Ngày yêu cầu','Ngày yêu cầu ',
          'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
          'submissiondate','submitteddate','submitdate','submit_date',
          'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
          'ngaygui','ngay_gui','ngày gửi','Ngày gửi',
          'createddate','created_date','creationdate','created',
          'ngaytao','ngay_tao','ngày tạo','Ngày tạo',
          '📆 ngày gửi','📆 Ngày gửi',
          'thời gian yêu cầu','thời điểm yêu cầu'
        ];
        const actualKeys = ['Số giờ đánh giá thực tế','so gio danh gia thuc te','số giờ đánh giá thực tế','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te'];
        const statusKeys = ['Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái'];
        const doneKeys = ['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','Ngày kết thúc','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
        
        const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const dn=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('hủy')||st.includes('huỷ')||/cancel/i.test(dn); };
        
        let totalActualHours = 0;
        rows.forEach(o=>{
          if (isCanceled(o)) return;
          const emp = norm(getV(o, assigneeKeys));
          if(!sameName(emp, empName)) return;
          
          let rq = norm(getV(o, rqKeys)); let rqD = parseDate(rq); let rqIso = rqD? iso(rqD):'';
          if(!rqD || !inRange(rqIso)){
            let picked = '';
            try{
              const normKey = (s)=> String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
              const rqSet = new Set(rqKeys.map(normKey));
              const wishSet = new Set(['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn','Hạn mong muốn ','Hạn mong muốn'].map(normKey));
              for(const [k, v] of Object.entries(o||{})){
                const kn = normKey(k);
                if (!rqSet.has(kn) || wishSet.has(kn)) continue;
                const d = parseDate(v); if(!d) continue; const ds = iso(d); if(inRange(ds)){ picked = v; rqD = d; rqIso = ds; break; }
              }
            }catch(_){ }
            if (picked) rq = norm(picked); else if (!inRange(rqIso)) return;
          }
          
          const actual = norm(getV(o, actualKeys));
          // Parse giá trị actual một cách robust hơn
          let actualStr = String(actual || '').trim();
          actualStr = actualStr.replace(/[^\d.,]/g, '');
          actualStr = actualStr.replace(',', '.');
          const actualNum = parseFloat(actualStr) || 0;
          totalActualHours += actualNum;
        });
        
        // Làm tròn đến 2 chữ số thập phân và format với dấu phẩy
        const totalActualHoursFormatted = totalActualHours.toFixed(2).replace('.', ',');
        
        return {
          raw: totalActualHours,
          formatted: totalActualHoursFormatted
        };
      } catch(_) {
        return { raw: 0, formatted: '0,00' };
      }
    }

    function openRqDetailModal(empName, from, to){
      try{
        const modal = document.getElementById('rq-detail-modal');
        const nameEl = document.getElementById('rq-detail-name');
        const body = document.getElementById('rq-detail-body');
        if (!modal || !nameEl || !body) return;
        nameEl.textContent = empName || '';
        body.innerHTML = `<tr><td colspan="9" class="px-3 py-3 text-center text-gray-500"><span class='spinner mr-2'></span>Đang tải...</td></tr>`;
        const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
        function norm(s){ return String(s||'').trim(); }
        function getV(obj, keys){ const lower={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; }); for(const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v=lower[c1] ?? lower[c2]; if(v!==undefined) return v; } return ''; }
        function vnNoAcc(s){ try{ return (typeof vnLower==='function')? vnLower(String(s||'')) : String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); } }
        function sameName(a,b){ return vnNoAcc(a).replace(/\s+/g,' ').trim() === vnNoAcc(b).replace(/\s+/g,' ').trim(); }
        function parseDate(v){ try{ return parseDateFlexible(v); } catch(_){ return null; } }
        function iso(d){ if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; }
        function inRange(ds){ if(!from && !to) return true; if(!ds) return false; if(from && ds < from) return false; if(to && ds > to) return false; return true; }
        const assigneeKeys = ['Assignee','Assignee Name','AssigneeName','Assignee name','Phụ trách','Phụ trách chính','Người phụ trách','Người xử lý','Người nhận mẫu','Người nhận','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
        const rqKeys = [
          '📆 ngày yêu cầu','📆 Ngày yêu cầu','📆 Ngày yêu cầu ',
          'ngày yêu cầu','Ngày yêu cầu','Ngày yêu cầu ',
          'requestdate','request_date','requestDate','date_request','rqdate','rq_date','requesteddate','requested_date',
          'submissiondate','submitteddate','submitdate','submit_date',
          'ngayyeucau','ngay_yeu_cau','ngay yeu cau',
          'ngaygui','ngay_gui','ngày gửi','Ngày gửi',
          'createddate','created_date','creationdate','created',
          'ngaytao','ngay_tao','ngày tạo','Ngày tạo',
          '📆 ngày gửi','📆 Ngày gửi',
          'thời gian yêu cầu','thời điểm yêu cầu'
        ];
        const codeKeys = ['code','ma','taskcode','mã'];
        const nameKeys = ['Task Name','Tên tác vụ','Task','Công việc','Tên Task','taskname','ten_tac_vu','ten','name','title'];
        const manKeys = ['Điểm','Score','score','Công chuẩn công việc nhận ','Công chuẩn công việc nhận','Công chuẩn','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
        const actualKeys = ['Số giờ đánh giá thực tế','so gio danh gia thuc te','số giờ đánh giá thực tế','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te'];
        const wishKeys = ['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn','Hạn mong muốn ','Hạn mong muốn'];
        const doneKeys = ['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','Ngày kết thúc','completiondate','completeddate','completion','done_date','ngayhoanthanh','ngay_hoan_thanh','ngay ket thuc'];
        const statusKeys = ['Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái'];
        const isCanceled = (o)=>{ const st=String(getV(o,statusKeys)||'').toLowerCase(); const dn=String(getV(o,doneKeys)||'').toLowerCase(); return st.includes('cancel')||st.includes('hủy')||st.includes('huỷ')||/cancel/i.test(dn); };
        const items = [];
        rows.forEach(o=>{
          if (isCanceled(o)) return;
          const emp = norm(getV(o, assigneeKeys));
          if(!sameName(emp, empName)) return;
          
          let rq = norm(getV(o, rqKeys)); let rqD = parseDate(rq); let rqIso = rqD? iso(rqD):'';
          if(!rqD || !inRange(rqIso)){
            let picked = '';
            try{
              const normKey = (s)=> String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
              const rqSet = new Set(rqKeys.map(normKey));
              const wishSet = new Set(['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn','Hạn mong muốn ','Hạn mong muốn'].map(normKey));
              for(const [k, v] of Object.entries(o||{})){
                const kn = normKey(k);
                if (!rqSet.has(kn) || wishSet.has(kn)) continue;
                const d = parseDate(v); if(!d) continue; const ds = iso(d); if(inRange(ds)){ picked = v; rqD = d; rqIso = ds; break; }
              }
            }catch(_){ }
            if (picked) rq = norm(picked); else if (!inRange(rqIso)) return;
          }
          const code = norm(getV(o, codeKeys));
          const tname = norm(getV(o, nameKeys)); if(!tname) return;
          const man = norm(getV(o, manKeys));
          const actual = norm(getV(o, actualKeys));
          const wish = norm(getV(o, wishKeys));
          const done = norm(getV(o, doneKeys));
          const status = norm(getV(o, statusKeys));
          items.push({ code, tname, rq, man, actual, wish, done, status });
        });
        if (!items.length){ body.innerHTML = `<tr><td colspan="9" class="px-3 py-3 text-center text-gray-500">Không có dữ liệu</td></tr>`; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); return; }
        const fmt = (v)=>{ try{ return v? formatDdMmYyyy(v):''; }catch(_){ return v||''; } };
        let stt = 0;
        
        // Lấy tổng giờ đánh giá thực tế từ Map (đã được tính toán khi render P2)
        const totalActualHoursData = (window.F5A_TOTAL_ACTUAL_HOURS_MAP && window.F5A_TOTAL_ACTUAL_HOURS_MAP.get(empName)) || { raw: 0, formatted: '0,00' };
        const totalActualHours = totalActualHoursData.raw;
        const totalActualHoursFormatted = totalActualHoursData.formatted;
        
        // Render các hàng dữ liệu
        const dataRows = items.map(it=>`
          <tr>
            <td class="px-3 py-2">${++stt}</td>
            <td class="px-3 py-2">${it.code}</td>
            <td class="px-3 py-2">${it.tname}</td>
            <td class="px-3 py-2">${fmt(it.rq)}</td>
            <td class="px-3 py-2">${it.man}</td>
            <td class="px-3 py-2">${it.actual}</td>
            <td class="px-3 py-2">${fmt(it.wish)}</td>
            <td class="px-3 py-2">${fmt(it.done)}</td>
            <td class="px-3 py-2">${it.status}</td>
          </tr>
        `).join('');
        
        // Hàng tổng
        const totalRow = `
          <tr class="bg-blue-50 font-semibold">
            <td class="px-3 py-2" colspan="5">TỔNG GIỜ ĐÁNH GIÁ THỰC TẾ</td>
            <td class="px-3 py-2">${totalActualHoursFormatted}</td>
            <td class="px-3 py-2" colspan="3"></td>
          </tr>
        `;
        
        body.innerHTML = dataRows + totalRow;
        
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
      }catch(_){ }
    }
    // Mở bảng phụ theo yêu cầu: DONE (P1) -> Hoàn thành; Số tác vụ trong tháng (P2) -> Nhận tháng
    (function initF5aSubTables(){
      const p1 = document.getElementById('f5a-body-p1');
      const p2 = document.getElementById('f5a-body-p2');
      function onClick(e){
        const doneBtn = e.target && e.target.closest ? e.target.closest('[data-f5a-done]') : null;
        const rqBtn = e.target && e.target.closest ? e.target.closest('[data-f5a-rqcount]') : null;
        const monthInput = document.getElementById('f5a-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        let fromVal = '', toVal = '';
        if (monthVal) {
          try{
            const parts = monthVal.split('-');
            const yy = Number(parts[0]);
            const mm = Number(parts[1]);
            const firstDay = `${yy}-${String(mm).padStart(2,'0')}-01`;
            const lastDate = new Date(yy, mm, 0).getDate();
            const lastDay = `${yy}-${String(mm).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;
            fromVal = firstDay; toVal = lastDay;
          }catch(_){ }
        }
        if (rqBtn){
          const name = rqBtn.getAttribute('data-f5a-rqcount') || '';
          if (name) openRqDetailModal(name, fromVal, toVal);
          return;
        }
        if (doneBtn){
          const name = doneBtn.getAttribute('data-f5a-done') || '';
          if (name) openDetailModal(name, 'All', fromVal, toVal);
          return;
        }
      }
      if (p1) p1.addEventListener('click', onClick);
      if (p2) p2.addEventListener('click', onClick);
    })();

    // ===== Form 7: Modal cũ đã bị vô hiệu hóa - KHÔNG SỬ DỤNG =====
    // Modal cũ "form7-modal" với Gate 1/2 đã được thay thế bằng "form7-subpanel-modal"
    // Các function dưới đây được giữ lại để tránh lỗi reference, nhưng KHÔNG nên gọi
    
    let form7Context = null;
    let form7IsSubmitting = false;
    let form7LastOpenTrigger = null;

    function openForm7Modal(ctx) {
      console.warn('⚠️ openForm7Modal() đã bị deprecated! Sử dụng openForm7SubpanelModal() thay thế.');
      // Không làm gì cả - modal cũ đã bị xóa
    }

    function closeForm7Modal() {
      console.warn('⚠️ closeForm7Modal() đã bị deprecated!');
      // Không làm gì cả
    }

    async function submitForm7() {
      console.error('❌ submitForm7() đã bị deprecated! Modal cũ không còn được sử dụng.');
      showToast('Lỗi: Đang sử dụng modal cũ đã bị vô hiệu hóa. Vui lòng F5 tải lại trang.', 'error');
        return;
    }

    // ===== Form 7: Modal Subpanel =====
    let form7SubpanelContext = null;
    let form7SubpanelKind = null;

    function openForm7SubpanelModal(kind, ctx){
      form7SubpanelContext = ctx || {};
      form7SubpanelKind = kind;
      
      // Kiểm tra modal có tồn tại không
      const modal = document.getElementById('form7-subpanel-modal');
      if (!modal) {
        console.error('Modal form7-subpanel-modal not found!');
        return;
      }
      
      // Cập nhật thông tin trong modal
      const nameEl = document.getElementById('form7-subpanel-name');
      const codeEl = document.getElementById('form7-subpanel-code');
      const taskNameEl = document.getElementById('form7-subpanel-task-name');
      
      if (nameEl) nameEl.textContent = ctx?.name || '';
      if (codeEl) codeEl.textContent = ctx?.taskId || '';
      if (taskNameEl) taskNameEl.textContent = ctx?.taskName || '';
      
      // Cập nhật title và màu sắc
      const title = document.getElementById('form7-subpanel-title');
      const submitBtn = document.getElementById('form7-subpanel-submit');
      
      if (title && submitBtn) {
        if (kind === 'ce') {
          title.textContent = 'CE Rà soát - Gửi dữ liệu';
          title.className = 'text-lg font-semibold text-cyan-800';
          submitBtn.textContent = 'Gửi CE rà soát';
          submitBtn.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-cyan-600 hover:brightness-105';
        } else {
          title.textContent = '4M Rà soát - Gửi dữ liệu';
          title.className = 'text-lg font-semibold text-emerald-800';
          submitBtn.textContent = 'Gửi 4M rà soát';
          submitBtn.className = 'px-4 py-2 rounded-lg text-white font-semibold bg-emerald-600 hover:brightness-105';
        }
      }
      
      // Reset form
      const notesEl = document.getElementById('form7-subpanel-notes');
      const fileEl = document.getElementById('form7-subpanel-file');
      const ceCheckbox = document.getElementById('form7-subpanel-ce-checkbox');
      if (notesEl) notesEl.value = '';
      if (fileEl) fileEl.value = '';
      if (ceCheckbox) ceCheckbox.checked = false;
      
      // Hiển thị/ẩn checkbox CE tùy theo loại modal
      const ceOption = document.getElementById('form7-subpanel-ce-option');
      if (ceOption) {
        if (kind === 'ce') {
          ceOption.style.display = 'flex';
        } else {
          ceOption.style.display = 'none';
        }
      }
      
      // Hiển thị modal
      modal.classList.add('open');
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
    }

    // ===== Form 8: Modal Subpanel =====
    let form8SubpanelContext = null;

    function openForm8SubpanelModal(ctx){
      form8SubpanelContext = ctx || {};
      
      // Kiểm tra modal có tồn tại không
      const modal = document.getElementById('form8-subpanel-modal');
      if (!modal) {
        console.error('Modal form8-subpanel-modal not found!');
        return;
      }
      
      // Cập nhật thông tin trong modal
      const nameEl = document.getElementById('form8-subpanel-name');
      const codeEl = document.getElementById('form8-subpanel-code');
      const taskNameEl = document.getElementById('form8-subpanel-task-name');
      
      if (nameEl) nameEl.textContent = ctx?.name || '';
      if (codeEl) codeEl.textContent = ctx?.taskId || '';
      if (taskNameEl) taskNameEl.textContent = ctx?.taskName || '';
      
      // Reset form
      const notesEl = document.getElementById('form8-subpanel-notes');
      const fileEl = document.getElementById('form8-subpanel-file');
      const fourMCheckbox = document.getElementById('form8-subpanel-4m-checkbox');
      if (notesEl) notesEl.value = '';
      if (fileEl) fileEl.value = '';
      if (fourMCheckbox) fourMCheckbox.checked = false;
      
      // Hiển thị modal
      modal.classList.add('open');
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeForm8SubpanelModal(){
      const modal = document.getElementById('form8-subpanel-modal');
      modal.classList.remove('open');
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      form8SubpanelContext = null;
    }

    async function submitForm8SubpanelModal(){
      if (!form8SubpanelContext) return;
      
      const notes = document.getElementById('form8-subpanel-notes').value.trim();
      const fileEl = document.getElementById('form8-subpanel-file');
      const fourMCheckbox = document.getElementById('form8-subpanel-4m-checkbox');
      const ctx = form8SubpanelContext;
      const fourMNotRequired = fourMCheckbox ? fourMCheckbox.checked : false;

      // Validation: Nếu không tick "không cần rà soát", thì file Excel là bắt buộc
      if (!fourMNotRequired) {
        const hasFile = fileEl && fileEl.files && fileEl.files[0];
        console.log('[Form8 Debug] Validation - hasFile:', hasFile);
        console.log('[Form8 Debug] Validation - fourMNotRequired:', fourMNotRequired);
        
        if (!hasFile) {
          showToast('Vui lòng chọn tệp Excel đính kèm hoặc tick "Không cần rà soát"', 'error');
          return;
        }
        
        // Kiểm tra định dạng file Excel
        const file = fileEl.files[0];
        const fileName = file.name.toLowerCase();
        const isExcelFile = fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || 
                           fileName.endsWith('.xlsm') || fileName.endsWith('.xlsb');
        
        console.log('[Form8 Debug] Validation - fileName:', fileName);
        console.log('[Form8 Debug] Validation - isExcelFile:', isExcelFile);
        
        if (!isExcelFile) {
          showToast('Vui lòng chọn file Excel (.xlsx, .xls, .xlsm, .xlsb)', 'error');
          return;
        }
      } else {
        console.log('[Form8 Debug] Validation - Skipped (4M not required)');
      }

      const formData = new FormData();
      formData.append('action', '4m_review_submit');
      formData.append('form_type', '4M Review');
      formData.append('timestamp', formatDdMmYyyyHHmm(new Date()));
      formData.append('person_name', ctx?.name || '');
      formData.append('task_id', ctx?.taskId || '');
      formData.append('code', ctx?.code || '');
      formData.append('task_name', ctx?.taskName || '');
      formData.append('notes', notes);
      formData.append('4m_not_required', fourMNotRequired ? '1' : '0');
      
      if (fileEl && fileEl.files && fileEl.files[0]){
        const file = fileEl.files[0];
        console.log('[Form8 Debug] File info:', {
          name: file.name,
          size: file.size,
          type: file.type,
          lastModified: file.lastModified
        });
        
        formData.append('file', file);
        formData.append('file_name', file.name || '');
        try{ 
          const extension = file.name.split('.').pop().toLowerCase();
          formData.append('file_extension', extension);
          console.log('[Form8 Debug] File extension:', extension);
        }catch(e){
          console.log('[Form8 Debug] Extension error:', e);
        }
      } else {
        console.log('[Form8 Debug] No file selected');
      }

      // Gửi dữ liệu
      const submitBtn = document.getElementById('form8-subpanel-submit');
      const prevText = submitBtn?.textContent;
      
      try {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Đang gửi...';
        }

        console.log('[Form8 Debug] Gửi dữ liệu:', {
          action: '4m_review_submit',
          person_name: ctx?.name,
          task_id: ctx?.taskId,
          hasFile: fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0].name : 'No file',
          fourMNotRequired: fourMNotRequired
        });

        const response = await fetch('https://iatzhxxuk.tino.page/webhook/72b41c74-fd19-4d42-8c5a-ed3a03d55f90', {
          method: 'POST',
          body: formData,
          mode: 'cors',
          headers: {
            'Accept': 'application/json'
          }
        });

        console.log('[Form8 Debug] Response status:', response.status);
        console.log('[Form8 Debug] Response ok:', response.ok);

        if (response.ok) {
          showToast('Gửi 4M rà soát thành công!', 'success');
          closeForm8SubpanelModal();
          // Refresh data nếu cần
          if (typeof renderForm8 === 'function') {
            renderForm8();
          }
        } else {
          const errorText = await response.text();
          console.error('[Form8 Debug] Server error:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
      } catch (e) {
        console.error('[Form8 Debug] Error:', e);
        
        // Xử lý các loại lỗi khác nhau
        let errorMessage = 'Gửi thất bại';
        if (e.message.includes('CORS')) {
          errorMessage = 'Lỗi CORS: Server không cho phép truy cập từ trình duyệt này';
        } else if (e.message.includes('404')) {
          errorMessage = 'Lỗi 404: URL không tồn tại hoặc không đúng';
        } else if (e.message.includes('Failed to fetch')) {
          errorMessage = 'Không thể kết nối đến server. Vui lòng kiểm tra kết nối mạng';
        } else {
          errorMessage = `Gửi thất bại: ${e.message}`;
        }
        
        showToast(errorMessage, 'error');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = prevText || 'Gửi 4M rà soát';
        }
      }
    }


    function closeForm7SubpanelModal(){
      const modal = document.getElementById('form7-subpanel-modal');
      modal.classList.remove('open');
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      form7SubpanelContext = null;
      form7SubpanelKind = null;
    }

    async function submitForm7SubpanelModal(){
      if (!form7SubpanelContext || !form7SubpanelKind) return;
      
      const notes = document.getElementById('form7-subpanel-notes').value.trim();
      const fileEl = document.getElementById('form7-subpanel-file');
      const ceCheckbox = document.getElementById('form7-subpanel-ce-checkbox');
      const kind = form7SubpanelKind;
      const ctx = form7SubpanelContext;
      const ceNotRequired = ceCheckbox ? ceCheckbox.checked : false;

      // Validation nhẹ hơn: chỉ cảnh báo nếu không có cả file và checkbox
      if (kind === 'ce' && !ceNotRequired) {
        const hasFile = fileEl && fileEl.files && fileEl.files[0];
        if (!hasFile && !notes) {
          showToast('Vui lòng nhập ghi chú hoặc đính kèm file, hoặc tick "Tác vụ không cần làm CE"', 'error');
          return;
        }
      }

      const formData = new FormData();
      formData.append('action', kind==='ce' ? 'ce_review_submit' : '4m_review_submit');
      formData.append('form_type', kind==='ce' ? 'CE Review' : '4M Review');
      formData.append('timestamp', formatDdMmYyyyHHmm(new Date()));
      formData.append('person_name', ctx?.name || '');
      formData.append('task_id', ctx?.taskId || '');
      formData.append('code', ctx?.code || '');
      formData.append('task_name', ctx?.taskName || '');
      formData.append('notes', notes);
      formData.append('f7emailassignee', ctx?.f7emailassignee || '');
      
      // Thêm thông tin checkbox
      if (kind === 'ce') {
        formData.append('ce_not_required', ceNotRequired ? '1' : '0');
      }
      if (fileEl && fileEl.files && fileEl.files[0]){
        formData.append('file', fileEl.files[0]);
        formData.append('file_name', fileEl.files[0].name || '');
        try{ formData.append('file_extension', (fileEl.files[0].name||'').split('.').pop().toLowerCase()); }catch(_){ }
      }
      const metadata = {
        action: kind==='ce' ? 'ce_review_submit' : '4m_review_submit',
        form_type: kind==='ce' ? 'CE Review' : '4M Review',
        person_name: ctx?.name || '',
        task_id: ctx?.taskId || '',
        code: ctx?.code || '',
        task_name: ctx?.taskName || '',
        notes,
        f7emailassignee: ctx?.f7emailassignee || '',
        ce_not_required: kind === 'ce' ? ceNotRequired : false,
        timestamp_iso: new Date().toISOString()
      };
      formData.append('metadata_json', JSON.stringify(metadata));
      formData.append('body', JSON.stringify(metadata));

      const btn = document.getElementById('form7-subpanel-submit');
      const prev = btn ? btn.textContent : '';
      
      // Khai báo baseUrl ngoài try block để dùng trong catch
      const baseUrl = FORM7_SUBPANEL_URL;
      const testUrl = baseUrl.replace('/webhook/', '/webhook-test/');
      const prodUrl = baseUrl.replace('/webhook-test/', '/webhook/');
      
      try{
        if (btn){ btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
        
        console.log('[Form7 CE Debug] Bắt đầu gửi dữ liệu:', {
          url: FORM7_SUBPANEL_URL,
          kind: kind,
          person_name: ctx?.name,
          task_id: ctx?.taskId,
          hasFile: fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0].name : 'No file',
          ceNotRequired: ceNotRequired,
          hasNotes: !!notes
        });
        
        // Chỉ sử dụng CORS mode để tránh redirect và GET request không mong muốn
        
        let success = false;
        let lastError = null;
        
        // 1. Thử test URL với CORS
        try {
          console.log('[Form7 CE Debug] [1/2] Thử test URL với CORS...');
          const r1 = await fetch(testUrl, { 
            method: 'POST', 
            body: formData, 
            mode: 'cors',
            credentials: 'omit'
          });
          if (r1.ok) {
            const responseText = await r1.text().catch(() => '');
            console.log('[Form7 CE Debug] ✅ Test CORS thành công!');
            console.log('[Form7 CE Debug] Response:', responseText);
            success = true;
          } else {
            const errText = await r1.text().catch(() => '');
            console.log('[Form7 CE Debug] ❌ Test CORS failed:', r1.status, errText);
            throw new Error(`HTTP ${r1.status}: ${errText}`);
          }
        } catch (e1) {
          console.warn('[Form7 CE Debug] [1/2] Test CORS thất bại:', e1.message);
          lastError = e1;
          
          // 2. Thử prod URL với CORS
          try {
            console.log('[Form7 CE Debug] [2/2] Thử prod URL với CORS...');
            const r2 = await fetch(prodUrl, { 
              method: 'POST', 
              body: formData, 
              mode: 'cors',
              credentials: 'omit'
            });
            if (r2.ok) {
              const responseText = await r2.text().catch(() => '');
              console.log('[Form7 CE Debug] ✅ Prod CORS thành công!');
              console.log('[Form7 CE Debug] Response:', responseText);
              success = true;
            } else {
              const errText = await r2.text().catch(() => '');
              console.log('[Form7 CE Debug] ❌ Prod CORS failed:', r2.status, errText);
              throw new Error(`HTTP ${r2.status}: ${errText}`);
            }
          } catch (e2) {
            console.error('[Form7 CE Debug] [2/2] Prod CORS thất bại:', e2.message);
            lastError = e2;
          }
        }
        
        if (!success) {
          // Nếu server trả về 500, có thể do tạm thời không khả dụng
          if (lastError && lastError.message.includes('500')) {
            console.log('[Form7 CE Debug] Server 500 error - có thể do tạm thời, thử lại sau 3 giây...');
            showToast('Server tạm thời không khả dụng, đang thử lại...', 'warning');
            
            // Thử lại sau 3 giây
            setTimeout(async () => {
              try {
                console.log('[Form7 CE Debug] Retry attempt...');
                const retryResponse = await fetch(prodUrl, { 
                  method: 'POST', 
                  body: formData, 
                  mode: 'cors',
                  credentials: 'omit'
                });
                
                if (retryResponse.ok) {
                  const retryText = await retryResponse.text().catch(() => '');
                  console.log('[Form7 CE Debug] ✅ Retry thành công!');
                  console.log('[Form7 CE Debug] Retry Response:', retryText);
                  showToast('Đã gửi ' + (kind==='ce' ? 'CE rà soát' : '4M rà soát') + ' thành công! (retry)', 'success');
                  closeForm7SubpanelModal();
                } else {
                  const retryErrText = await retryResponse.text().catch(() => '');
                  console.log('[Form7 CE Debug] ❌ Retry failed:', retryResponse.status, retryErrText);
                  showToast('Gửi thất bại: ' + retryErrText, 'error');
                }
              } catch (retryErr) {
                console.error('[Form7 CE Debug] ❌ Retry error:', retryErr);
                showToast('Gửi thất bại: ' + retryErr.message, 'error');
              }
            }, 3000);
            return; // Không throw error ngay
          }
          
          throw lastError || new Error('Tất cả phương án gửi đều thất bại');
        }
        
        console.log('[Form7 CE Debug] ✅ Request gửi thành công!');
        console.log('[Form7 CE Debug] Response headers:', success ? 'Success' : 'Failed');
        showToast('Đã gửi ' + (kind==='ce' ? 'CE rà soát' : '4M rà soát') + ' thành công!', 'success');
        closeForm7SubpanelModal();
        
        // Refresh dữ liệu sau 2 giây
        setTimeout(() => {
          try {
            if (typeof renderForm7 === 'function') {
              console.log('[Form7 CE Debug] Làm mới dữ liệu...');
              renderForm7();
            }
          } catch(_) {}
        }, 2000);
        
      }catch(err){
        console.error('[Form7 CE Debug] ❌ Lỗi gửi dữ liệu:', err);
        
        // Xử lý các loại lỗi khác nhau
        let errorMessage = 'Gửi thất bại';
        if (err.message.includes('NetworkError') || err.message.includes('Failed to fetch')) {
          errorMessage = 'Không thể kết nối đến server. Vui lòng kiểm tra kết nối mạng.';
        } else if (err.message.includes('CORS')) {
          errorMessage = 'Lỗi CORS: Vui lòng liên hệ admin để kiểm tra cấu hình webhook.';
        } else if (err.message.includes('404')) {
          errorMessage = 'Lỗi 404: URL webhook không tồn tại.';
        } else if (err.message.includes('400')) {
          errorMessage = 'Lỗi 400: Dữ liệu không đúng định dạng.';
        } else if (err.message.includes('500')) {
          errorMessage = 'Lỗi 500: Server gặp sự cố. Vui lòng thử lại sau.';
        } else {
          errorMessage = `Gửi thất bại: ${err.message}`;
        }
        
        showToast(errorMessage, 'error');
        
        // Log chi tiết để debug
        console.error('[Form7 CE Debug] Chi tiết lỗi:', {
          message: err.message,
          stack: err.stack,
          testUrl: baseUrl.replace('/webhook/', '/webhook-test/'),
          prodUrl: baseUrl.replace('/webhook-test/', '/webhook/'),
          metadata: metadata
        });
        
      }finally{
        if (btn){ 
          btn.disabled = false; 
          btn.textContent = prev || 'Gửi'; 
        }
      }
    }

    // ===== CE Review Modal Functions =====
    let ceReviewContext = null;
    let ceReviewIsSubmitting = false;

    function openCeReviewModal(ctx) {
      ceReviewContext = ctx || {};
      
      // Cập nhật thông tin tác vụ trong modal
      document.getElementById('ce-review-name').textContent = ctx?.name || '';
      document.getElementById('ce-review-code').textContent = ctx?.taskId || '';
      document.getElementById('ce-review-task-name').textContent = ctx?.taskName || '';
      
      // Hiển thị modal
      const modal = document.getElementById('ce-review-modal');
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeCeReviewModal() {
      const modal = document.getElementById('ce-review-modal');
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      ceReviewContext = null;
    }

    async function submitCeReview() {
      if (ceReviewIsSubmitting) return;
      
      try {
        ceReviewIsSubmitting = true;
        const btn = document.getElementById('ce-review-submit');
        const prev = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = "<span class='spinner mr-2'></span>Đang lưu...";
        
        // Tạo FormData cho CE Review
        const formData = new FormData();
        
        // Thông tin tác vụ
        if (ceReviewContext) {
          formData.append('person_name', ceReviewContext.name || '');
          formData.append('task_id', ceReviewContext.taskId || '');
          formData.append('code', ceReviewContext.code || '');
          formData.append('task_name', ceReviewContext.taskName || '');
        }
        
        // Thêm timestamp và action
        formData.append('timestamp', formatDdMmYyyyHHmm(new Date()));
        formData.append('action', 'ce_review_submit');
        formData.append('form_type', 'CE Review');
        
        // Tạo metadata JSON
        const metadata = {
          action: 'ce_review_submit',
          form_type: 'CE Review',
          person_name: ceReviewContext?.name || '',
          task_id: ceReviewContext?.taskId || '',
          code: ceReviewContext?.code || '',
          task_name: ceReviewContext?.taskName || '',
          timestamp_iso: new Date().toISOString()
        };
        
        formData.append('metadata_json', JSON.stringify(metadata));
        formData.append('body', JSON.stringify(metadata));
        
        console.log('CE Review: Gửi dữ liệu đến URL:', FORM7_UPLOAD_URL);
        console.log('CE Review: Metadata:', metadata);
        
        // Gửi dữ liệu
        const response = await fetch(FORM7_UPLOAD_URL, {
          method: 'POST',
          body: formData,
          mode: 'no-cors'
        });
        
        showToast('Lưu CE rà soát thành công!', 'success');
        closeCeReviewModal();
        
      } catch (error) {
        console.error('CE Review: Lỗi gửi dữ liệu:', error);
        showToast('Lưu CE rà soát thất bại. Vui lòng thử lại.', 'error');
      } finally {
        ceReviewIsSubmitting = false;
        const btn = document.getElementById('ce-review-submit');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Lưu CE rà soát';
        }
      }
    }

    // ===== 4M Review Modal Functions =====
    let fourMReviewContext = null;
    let fourMReviewIsSubmitting = false;

    function open4mReviewModal(ctx) {
      fourMReviewContext = ctx || {};
      
      // Cập nhật thông tin tác vụ trong modal
      document.getElementById('4m-review-name').textContent = ctx?.name || '';
      document.getElementById('4m-review-code').textContent = ctx?.taskId || '';
      document.getElementById('4m-review-task-name').textContent = ctx?.taskName || '';
      
      // Hiển thị modal
      const modal = document.getElementById('4m-review-modal');
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
    }

    function close4mReviewModal() {
      const modal = document.getElementById('4m-review-modal');
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      fourMReviewContext = null;
    }

    async function submit4mReview() {
      if (fourMReviewIsSubmitting) return;
      
      try {
        fourMReviewIsSubmitting = true;
        const btn = document.getElementById('4m-review-submit');
        const prev = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = "<span class='spinner mr-2'></span>Đang lưu...";
        
        // Tạo FormData cho 4M Review
        const formData = new FormData();
        
        // Thông tin tác vụ
        if (fourMReviewContext) {
          formData.append('person_name', fourMReviewContext.name || '');
          formData.append('task_id', fourMReviewContext.taskId || '');
          formData.append('code', fourMReviewContext.code || '');
          formData.append('task_name', fourMReviewContext.taskName || '');
        }
        
        // Thêm timestamp và action
        formData.append('timestamp', formatDdMmYyyyHHmm(new Date()));
        formData.append('action', '4m_review_submit');
        formData.append('form_type', '4M Review');
        
        // Tạo metadata JSON
        const metadata = {
          action: '4m_review_submit',
          form_type: '4M Review',
          person_name: fourMReviewContext?.name || '',
          task_id: fourMReviewContext?.taskId || '',
          code: fourMReviewContext?.code || '',
          task_name: fourMReviewContext?.taskName || '',
          timestamp_iso: new Date().toISOString()
        };
        
        formData.append('metadata_json', JSON.stringify(metadata));
        formData.append('body', JSON.stringify(metadata));
        
        console.log('[4M Review Debug] Gửi dữ liệu đến URL:', FORM7_UPLOAD_URL);
        console.log('[4M Review Debug] Metadata:', metadata);
        
        // Chỉ sử dụng CORS mode để tránh redirect và GET request không mong muốn
        const baseUrl = FORM7_UPLOAD_URL;
        const testUrl = baseUrl.replace('/webhook/', '/webhook-test/');
        const prodUrl = baseUrl.replace('/webhook-test/', '/webhook/');
        
        let success = false;
        let lastError = null;
        
        // 1. Thử test URL với CORS
        try {
          console.log('[4M Review Debug] [1/2] Thử test URL với CORS...');
          const r1 = await fetch(testUrl, { 
            method: 'POST', 
            body: formData, 
            mode: 'cors',
            credentials: 'omit'
          });
          if (r1.ok) {
            const responseText = await r1.text().catch(() => '');
            console.log('[4M Review Debug] ✅ Test CORS thành công!');
            console.log('[4M Review Debug] Response:', responseText);
            success = true;
          } else {
            const errText = await r1.text().catch(() => '');
            console.log('[4M Review Debug] ❌ Test CORS failed:', r1.status, errText);
            throw new Error(`HTTP ${r1.status}: ${errText}`);
          }
        } catch (e1) {
          console.warn('[4M Review Debug] [1/2] Test CORS thất bại:', e1.message);
          lastError = e1;
          
          // 2. Thử prod URL với CORS
          try {
            console.log('[4M Review Debug] [2/2] Thử prod URL với CORS...');
            const r2 = await fetch(prodUrl, { 
              method: 'POST', 
              body: formData, 
              mode: 'cors',
              credentials: 'omit'
            });
            if (r2.ok) {
              const responseText = await r2.text().catch(() => '');
              console.log('[4M Review Debug] ✅ Prod CORS thành công!');
              console.log('[4M Review Debug] Response:', responseText);
              success = true;
            } else {
              const errText = await r2.text().catch(() => '');
              console.log('[4M Review Debug] ❌ Prod CORS failed:', r2.status, errText);
              throw new Error(`HTTP ${r2.status}: ${errText}`);
            }
          } catch (e2) {
            console.error('[4M Review Debug] [2/2] Prod CORS thất bại:', e2.message);
            lastError = e2;
          }
        }
        
        if (!success) {
          // Nếu server trả về 500, có thể do tạm thời không khả dụng
          if (lastError && lastError.message.includes('500')) {
            console.log('[4M Review Debug] Server 500 error - có thể do tạm thời, thử lại sau 3 giây...');
            showToast('Server tạm thời không khả dụng, đang thử lại...', 'warning');
            
            // Thử lại sau 3 giây
            setTimeout(async () => {
              try {
                console.log('[4M Review Debug] Retry attempt...');
                const retryResponse = await fetch(prodUrl, { 
                  method: 'POST', 
                  body: formData, 
                  mode: 'cors',
                  credentials: 'omit'
                });
                
                if (retryResponse.ok) {
                  const retryText = await retryResponse.text().catch(() => '');
                  console.log('[4M Review Debug] ✅ Retry thành công!');
                  console.log('[4M Review Debug] Retry Response:', retryText);
                  showToast('Lưu 4M rà soát thành công! (retry)', 'success');
                  close4mReviewModal();
                } else {
                  const retryErrText = await retryResponse.text().catch(() => '');
                  console.log('[4M Review Debug] ❌ Retry failed:', retryResponse.status, retryErrText);
                  showToast('Lưu 4M rà soát thất bại: ' + retryErrText, 'error');
                }
              } catch (retryErr) {
                console.error('[4M Review Debug] ❌ Retry error:', retryErr);
                showToast('Lưu 4M rà soát thất bại: ' + retryErr.message, 'error');
              }
            }, 3000);
            return; // Không throw error ngay
          }
          
          throw lastError || new Error('Tất cả phương án gửi đều thất bại');
        }
        
        console.log('[4M Review Debug] ✅ Request gửi thành công!');
        showToast('Lưu 4M rà soát thành công!', 'success');
        close4mReviewModal();
        
      } catch (error) {
        console.error('[4M Review Debug] ❌ Lỗi gửi dữ liệu:', error);
        showToast('Lưu 4M rà soát thất bại. Vui lòng thử lại.', 'error');
      } finally {
        fourMReviewIsSubmitting = false;
        const btn = document.getElementById('4m-review-submit');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Lưu 4M rà soát';
        }
      }
    }

    // ===== Sample Handover Modal Functions =====
    let sampleHandoverContext = null;
    let sampleHandoverIsSubmitting = false;

    function openSampleHandoverModal(ctx) {
      sampleHandoverContext = ctx || {};
      
      // Cập nhật thông tin tác vụ trong modal
      document.getElementById('sample-handover-name').textContent = ctx?.name || '';
      document.getElementById('sample-handover-code').textContent = ctx?.taskId || '';
      document.getElementById('sample-handover-task-name').textContent = ctx?.taskName || '';
      
      // Reset form
      const radios = document.querySelectorAll('input[name="sample-handover-status"]');
      radios.forEach(r => r.checked = false);
      const notesEl = document.getElementById('sample-handover-notes');
      if (notesEl) notesEl.value = '';
      
      // Hiển thị modal
      const modal = document.getElementById('sample-handover-modal');
      modal.classList.add('open');
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeSampleHandoverModal() {
      const modal = document.getElementById('sample-handover-modal');
      modal.classList.remove('open');
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      sampleHandoverContext = null;
    }

    async function submitSampleHandover() {
      if (sampleHandoverIsSubmitting) return;
      
      // Lấy lựa chọn
      const selectedRadio = document.querySelector('input[name="sample-handover-status"]:checked');
      if (!selectedRadio) {
        showToast('Vui lòng chọn trạng thái bàn giao', 'error');
        return;
      }
      
      const status = selectedRadio.value;
      const notes = document.getElementById('sample-handover-notes').value.trim();
      
      try {
        sampleHandoverIsSubmitting = true;
        const btn = document.getElementById('sample-handover-submit');
        const prev = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi...";
        
        // Tạo FormData
        const formData = new FormData();
        
        // Thông tin tác vụ
        if (sampleHandoverContext) {
          formData.append('person_name', sampleHandoverContext.name || '');
          formData.append('task_id', sampleHandoverContext.taskId || '');
          formData.append('code', sampleHandoverContext.code || '');
          formData.append('task_name', sampleHandoverContext.taskName || '');
          formData.append('f7emailassignee', sampleHandoverContext.f7emailassignee || '');
        }
        
        // Trạng thái và ghi chú
        formData.append('handover_status', status);
        formData.append('notes', notes);
        formData.append('timestamp', formatDdMmYyyyHHmm(new Date()));
        formData.append('action', 'sample_handover_submit');
        formData.append('form_type', 'Sample Handover');
        
        // Tạo metadata JSON
        const metadata = {
          action: 'sample_handover_submit',
          form_type: 'Sample Handover',
          person_name: sampleHandoverContext?.name || '',
          task_id: sampleHandoverContext?.taskId || '',
          code: sampleHandoverContext?.code || '',
          task_name: sampleHandoverContext?.taskName || '',
          f7emailassignee: sampleHandoverContext?.f7emailassignee || '',
          handover_status: status,
          notes,
          timestamp_iso: new Date().toISOString()
        };
        
        formData.append('metadata_json', JSON.stringify(metadata));
        formData.append('body', JSON.stringify(metadata));
        
        console.log('[Sample Handover Debug] Bắt đầu gửi dữ liệu...');
        console.log('[Sample Handover Debug] Metadata:', metadata);
        
        // Chỉ sử dụng CORS mode để tránh redirect và GET request không mong muốn
        const baseUrl = FORM7_SAMPLE_HANDOVER_URL;
        const testUrl = baseUrl.replace('/webhook/', '/webhook-test/');
        const prodUrl = baseUrl.replace('/webhook-test/', '/webhook/');
        
        let success = false;
        let lastError = null;
        
        // 1. Thử test URL với CORS
        try {
          console.log('[Sample Handover Debug] [1/2] Thử test URL với CORS...');
          const r1 = await fetch(testUrl, { 
            method: 'POST', 
            body: formData, 
            mode: 'cors',
            credentials: 'omit'
          });
          if (r1.ok) {
            const responseText = await r1.text().catch(() => '');
            console.log('[Sample Handover Debug] ✅ Test CORS thành công!');
            console.log('[Sample Handover Debug] Response:', responseText);
            success = true;
          } else {
            const errText = await r1.text().catch(() => '');
            console.log('[Sample Handover Debug] ❌ Test CORS failed:', r1.status, errText);
            throw new Error(`HTTP ${r1.status}: ${errText}`);
          }
        } catch (e1) {
          console.warn('[Sample Handover Debug] [1/2] Test CORS thất bại:', e1.message);
          lastError = e1;
          
          // 2. Thử prod URL với CORS
          try {
            console.log('[Sample Handover Debug] [2/2] Thử prod URL với CORS...');
            const r2 = await fetch(prodUrl, { 
              method: 'POST', 
              body: formData, 
              mode: 'cors',
              credentials: 'omit'
            });
            if (r2.ok) {
              const responseText = await r2.text().catch(() => '');
              console.log('[Sample Handover Debug] ✅ Prod CORS thành công!');
              console.log('[Sample Handover Debug] Response:', responseText);
              success = true;
            } else {
              const errText = await r2.text().catch(() => '');
              console.log('[Sample Handover Debug] ❌ Prod CORS failed:', r2.status, errText);
              throw new Error(`HTTP ${r2.status}: ${errText}`);
            }
          } catch (e2) {
            console.error('[Sample Handover Debug] [2/2] Prod CORS thất bại:', e2.message);
            lastError = e2;
          }
        }
        
        if (!success) {
          // Nếu server trả về 500, có thể do tạm thời không khả dụng
          if (lastError && lastError.message.includes('500')) {
            console.log('[Sample Handover Debug] Server 500 error - có thể do tạm thời, thử lại sau 3 giây...');
            showToast('Server tạm thời không khả dụng, đang thử lại...', 'warning');
            
            // Thử lại sau 3 giây
            setTimeout(async () => {
              try {
                console.log('[Sample Handover Debug] Retry attempt...');
                const retryResponse = await fetch(prodUrl, { 
                  method: 'POST', 
                  body: formData, 
                  mode: 'cors',
                  credentials: 'omit'
                });
                
                if (retryResponse.ok) {
                  const retryText = await retryResponse.text().catch(() => '');
                  console.log('[Sample Handover Debug] ✅ Retry thành công!');
                  console.log('[Sample Handover Debug] Retry Response:', retryText);
                  showToast('Bàn giao mẫu thành công! (retry)', 'success');
                  closeSampleHandoverModal();
                } else {
                  const retryErrText = await retryResponse.text().catch(() => '');
                  console.log('[Sample Handover Debug] ❌ Retry failed:', retryResponse.status, retryErrText);
                  showToast('Bàn giao mẫu thất bại: ' + retryErrText, 'error');
                }
              } catch (retryErr) {
                console.error('[Sample Handover Debug] ❌ Retry error:', retryErr);
                showToast('Bàn giao mẫu thất bại: ' + retryErr.message, 'error');
              }
            }, 3000);
            return; // Không throw error ngay
          }
          
          throw lastError || new Error('Tất cả phương án gửi đều thất bại');
        }
        
        console.log('[Sample Handover Debug] ✅ Request gửi thành công!');
        showToast('Khai báo mẫu bàn giao thành công!', 'success');
        closeSampleHandoverModal();
        
      } catch (error) {
        console.error('[Sample Handover Debug] ❌ Lỗi gửi dữ liệu:', error);
        showToast('Khai báo mẫu bàn giao thất bại. Vui lòng thử lại.', 'error');
      } finally {
        sampleHandoverIsSubmitting = false;
        const btn = document.getElementById('sample-handover-submit');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Xác nhận';
        }
      }
    }

    // Event listeners cho Form 7 modal CŨ - ĐÃ VÔ HIỆU HÓA
    // Modal cũ đã bị xóa, các listeners này không còn tác dụng
    // Giữ lại để tránh lỗi reference trong code cũ
    const form7Modal = null; // Modal cũ đã bị xóa
    const form7CloseBtn = null;
    const form7CancelBtn = null;
    const form7SubmitBtn = null;
    
    console.log('ℹ️ Form 7: Đang sử dụng modal Subpanel mới (form7-subpanel-modal)');

    // ===== Event listeners cho CE Review Modal =====
    const ceReviewModal = document.getElementById('ce-review-modal');
    const ceReviewCloseBtn = document.getElementById('ce-review-close');
    const ceReviewCancelBtn = document.getElementById('ce-review-cancel');
    const ceReviewSubmitBtn = document.getElementById('ce-review-submit');

    if (ceReviewCloseBtn) {
      ceReviewCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeCeReviewModal();
      });
    }

    if (ceReviewCancelBtn) {
      ceReviewCancelBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeCeReviewModal();
      });
    }

    if (ceReviewSubmitBtn) {
      ceReviewSubmitBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await submitCeReview();
      });
    }

    // ===== Event listeners cho 4M Review Modal =====
    const fourMReviewModal = document.getElementById('4m-review-modal');
    const fourMReviewCloseBtn = document.getElementById('4m-review-close');
    const fourMReviewCancelBtn = document.getElementById('4m-review-cancel');
    const fourMReviewSubmitBtn = document.getElementById('4m-review-submit');

    if (fourMReviewCloseBtn) {
      fourMReviewCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        close4mReviewModal();
      });
    }

    if (fourMReviewCancelBtn) {
      fourMReviewCancelBtn.addEventListener('click', (e) => {
        e.preventDefault();
        close4mReviewModal();
      });
    }

    if (fourMReviewSubmitBtn) {
      fourMReviewSubmitBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await submit4mReview();
      });
    }

    // Close modal khi click outside
    if (form7Modal) {
      form7Modal.addEventListener('click', (e) => {
        if (e.target === form7Modal) {
          closeForm7Modal();
        }
      });
    }

    if (ceReviewModal) {
      ceReviewModal.addEventListener('click', (e) => {
        if (e.target === ceReviewModal) {
          closeCeReviewModal();
        }
      });
    }

    if (fourMReviewModal) {
      fourMReviewModal.addEventListener('click', (e) => {
        if (e.target === fourMReviewModal) {
          close4mReviewModal();
        }
      });
    }

    // ===== Event listeners cho Form 8 Subpanel Modal =====
    const form8SubpanelModal = document.getElementById('form8-subpanel-modal');
    const form8SubpanelCloseBtn = document.getElementById('form8-subpanel-close');
    const form8SubpanelCancelBtn = document.getElementById('form8-subpanel-cancel');
    const form8SubpanelSubmitBtn = document.getElementById('form8-subpanel-submit');

    if (form8SubpanelCloseBtn) {
      form8SubpanelCloseBtn.addEventListener('click', closeForm8SubpanelModal);
    }
    if (form8SubpanelCancelBtn) {
      form8SubpanelCancelBtn.addEventListener('click', closeForm8SubpanelModal);
    }
    if (form8SubpanelSubmitBtn) {
      form8SubpanelSubmitBtn.addEventListener('click', submitForm8SubpanelModal);
    }
    if (form8SubpanelModal) {
      form8SubpanelModal.addEventListener('click', (e) => {
        if (e.target === form8SubpanelModal) {
          closeForm8SubpanelModal();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !form8SubpanelModal.classList.contains('hidden')) {
          closeForm8SubpanelModal();
        }
      });
    }


    // ===== Event listeners cho Form 7 Subpanel Modal =====
    const form7SubpanelModal = document.getElementById('form7-subpanel-modal');
    const form7SubpanelCloseBtn = document.getElementById('form7-subpanel-close');
    const form7SubpanelCancelBtn = document.getElementById('form7-subpanel-cancel');
    const form7SubpanelSubmitBtn = document.getElementById('form7-subpanel-submit');

    if (form7SubpanelCloseBtn) {
      form7SubpanelCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeForm7SubpanelModal();
      });
    }

    if (form7SubpanelCancelBtn) {
      form7SubpanelCancelBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeForm7SubpanelModal();
      });
    }

    if (form7SubpanelSubmitBtn) {
      form7SubpanelSubmitBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await submitForm7SubpanelModal();
      });
    }

    if (form7SubpanelModal) {
      form7SubpanelModal.addEventListener('click', (e) => {
        if (e.target === form7SubpanelModal) {
          closeForm7SubpanelModal();
        }
      });
      // Đảm bảo ẩn khi load trang
      form7SubpanelModal.classList.remove('open');
      form7SubpanelModal.classList.add('hidden');
      form7SubpanelModal.setAttribute('aria-hidden','true');
    }

    // Close modal với phím Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (form7Modal && !form7Modal.classList.contains('hidden')) {
          closeForm7Modal();
        } else if (ceReviewModal && !ceReviewModal.classList.contains('hidden')) {
          closeCeReviewModal();
        } else if (fourMReviewModal && !fourMReviewModal.classList.contains('hidden')) {
          close4mReviewModal();
        } else if (form7SubpanelModal && !form7SubpanelModal.classList.contains('hidden')) {
          closeForm7SubpanelModal();
        } else {
          const sampleHandoverModal = document.getElementById('sample-handover-modal');
          if (sampleHandoverModal && !sampleHandoverModal.classList.contains('hidden')) {
            closeSampleHandoverModal();
          }
        }
      }
    });

    // ===== Event listeners cho Sample Handover Modal =====
    const sampleHandoverModal = document.getElementById('sample-handover-modal');
    const sampleHandoverCloseBtn = document.getElementById('sample-handover-close');
    const sampleHandoverCancelBtn = document.getElementById('sample-handover-cancel');
    const sampleHandoverSubmitBtn = document.getElementById('sample-handover-submit');

    if (sampleHandoverCloseBtn) {
      sampleHandoverCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeSampleHandoverModal();
      });
    }

    if (sampleHandoverCancelBtn) {
      sampleHandoverCancelBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeSampleHandoverModal();
      });
    }

    if (sampleHandoverSubmitBtn) {
      sampleHandoverSubmitBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await submitSampleHandover();
      });
    }

    if (sampleHandoverModal) {
      sampleHandoverModal.addEventListener('click', (e) => {
        if (e.target === sampleHandoverModal) {
          closeSampleHandoverModal();
        }
      });
      // Đảm bảo ẩn khi load trang
      sampleHandoverModal.classList.remove('open');
      sampleHandoverModal.classList.add('hidden');
      sampleHandoverModal.setAttribute('aria-hidden','true');
    }

    // ===== Khởi tạo dropdown cho Form 8 (Form 7 đã được khởi tạo ở dòng 2915) =====
    const f8NameSelect = document.getElementById('f8-name');
    
    // Sử dụng danh sách tên giống Form 1
    const FORM8_NAMES = FORM1_NAMES;
    
    // Khởi tạo dropdown cho Form 8
    if (f8NameSelect) {
      FORM8_NAMES.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        f8NameSelect.appendChild(option);
      });
    }

    console.log('Form 7: Modal và handlers đã được khởi tạo thành công');
    console.log('Form 8: Dropdown và tra cứu đã được khởi tạo thành công');
    // ===== Form 5 P4: Render using P3 data =====
    function renderForm5P4(){
      try{
        const body = document.getElementById('f5a-body-p4');
        if (!body) return;

        // Get month filter
        const monthInput = document.getElementById('f5a-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        
        // Check if P3 data is available
        if(!F5A_P3_RAW || F5A_P3_RAW.length === 0){
          body.innerHTML = `
            <tr>
              <td colspan="9" class="px-3 py-3 text-center">
                <div class="text-gray-500 mb-2">Chưa có dữ liệu</div>
                <div class="text-sm text-blue-600">👆 Nhấn nút <b>"Tra cứu P4"</b> ở trên để tải dữ liệu</div>
              </td>
            </tr>
          `;
          return;
        }

        // Helper functions (same as P3)
        const norm = (s) => String(s||'').toLowerCase().trim();
        const getV = (obj, keys) => {
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
          for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
          return '';
        };
        
        const parseDate = (value) => {
          try{
            if(!value) return null;
            const s = String(value).trim();
            let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if(m){
              const d = new Date(+m[3], +m[2]-1, +m[1]);
              return isNaN(d) ? null : d;
            }
            m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
            if(m){
              const d = new Date(+m[1], +m[2]-1, +m[3]);
              return isNaN(d) ? null : d;
            }
            const d = new Date(s);
            return isNaN(d) ? null : d;
          }catch(_){ return null; }
        };
        
        const formatYyyyMm = (d) => {
          if(!d) return '';
          const yy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,'0');
          return `${yy}-${mm}`;
        };
        
        // Aggregate by employee with completion percentages
        const byName = new Map();
        
        // Debug: Log detailed information
        console.log('[P4] Raw data length:', F5A_P3_RAW ? F5A_P3_RAW.length : 'No data');
        console.log('[P4] Month filter:', monthVal);
        
        if(F5A_P3_RAW && F5A_P3_RAW.length > 0){
          console.log('[P4] Sample row keys:', Object.keys(F5A_P3_RAW[0]));
          
          // Check employee name fields
          const sampleName = getV(F5A_P3_RAW[0], [
            'assignee','employee','name',
            'nhân viên','nhan vien','nhanvien',
            'tên nhân viên','ten nhan vien','tennhanvien',
            'phụ trách','phu trac','phutrac'
          ]);
          console.log('[P4] Sample employee name:', sampleName);
          
          // Check "4M rà soát" field
          const sample4m = getV(F5A_P3_RAW[0], [
            '4M rà soát','4m rà soát','4m ra soat',
            '4M','4m rasoat','rasoat4m'
          ]);
          console.log('[P4] Sample "4M rà soát":', sample4m, '(empty?', !sample4m, ')');
          
          // Check all percentage fields in the data
          const allKeys = Object.keys(F5A_P3_RAW[0]);
          const percentKeys = allKeys.filter(k => 
            k.toLowerCase().includes('tckt') || 
            k.toLowerCase().includes('ce') || 
            k.toLowerCase().includes('hdkt') || 
            k.toLowerCase().includes('đào tạo') || 
            k.toLowerCase().includes('jig') || 
            k.toLowerCase().includes('khkscl') ||
            k.toLowerCase().includes('hoàn thành')
          );
          console.log('[P4] Percentage-related keys:', percentKeys);
          
          // Check specific percentage fields
          const sampleTckt = getV(F5A_P3_RAW[0], ['TCKT(% hoàn thành)','tckt(% hoàn thành)','tckt']);
          const sampleCe = getV(F5A_P3_RAW[0], ['CE(% hoàn thành)','ce(% hoàn thành)','ce']);
          console.log('[P4] Sample TCKT:', sampleTckt);
          console.log('[P4] Sample CE:', sampleCe);
          
          // Check completion date
          const sampleDate = getV(F5A_P3_RAW[0], [
            'ngày hoàn thành thực tế','ngay hoan thanh thuc te',
            'ngày hoàn thành','ngay hoan thanh',
            'completion date','completiondate'
          ]);
          console.log('[P4] Sample completion date:', sampleDate);
        } else {
          console.log('[P4] No data available!');
        }
        
        let processedCount = 0;
        let skippedNoName = 0;
        let skippedWrongMonth = 0;
        let skippedNotProduct = 0;
        
        F5A_P3_RAW.forEach(r => {
          const name = String(getV(r, [
            'assignee','employee','name',
            'nhân viên','nhan vien','nhanvien',
            'tên nhân viên','ten nhan vien','tennhanvien',
            'phụ trách','phu trac','phutrac'
          ])||'').trim();
          
          if(!name) {
            skippedNoName++;
            return;
          }
          
          // Skip tasks assigned to "x" (pending tasks)
          if(name.toLowerCase() === 'x') {
            return;
          }
          
          const completionDateStr = getV(r, [
            'ngày hoàn thành thực tế','ngay hoan thanh thuc te',
            'ngày hoàn thành','ngay hoan thanh',
            'completion date','completiondate',
            'actual completion date','actualcompletiondate'
          ]);
          
          const completionDate = parseDate(completionDateStr);
          // Prefer month filter by 'Ngày khai báo 4M' -> 'Ngày khai báo CE' -> completion date
          const fourMDateStr = getV(r,[ 'Ngày khai báo 4M','ngay khai bao 4m','ngày khai báo 4m','4m_date','4mdate' ]);
          const ceDateStr = getV(r,[ 'Ngày khai báo CE','ngay khai bao ce','ngày khai báo ce','cedate','ce_date' ]);
          const fourMDate = parseDate(fourMDateStr);
          const ceDate = parseDate(ceDateStr);
          // Form 8 giống điều kiện: ưu tiên Ngày hoàn thành thực tế, thiếu mới fallback CE/4M
          const refDate = completionDate || ceDate || fourMDate;
          // Filter by selected month using refDate
          if (monthVal){
            if (!refDate){ skippedWrongMonth++; return; }
            const taskMonth = formatYyyyMm(refDate);
            if (taskMonth !== monthVal){ skippedWrongMonth++; return; }
          }
          
          // Chỉ lấy các tác vụ có "Phân loại" = "Sản phẩm"
          const classification = String(getV(r,[ 'Phân loại','phan loai','phanloai','classification','loai','loại' ])||'').trim();
          const clsNorm = (typeof vnLower==='function') ? vnLower(classification) : classification.toLowerCase();
          if (clsNorm !== 'san pham' && clsNorm !== 'sản phẩm') { skippedNotProduct++; return; }
          
          processedCount++;
          
          if(!byName.has(name)){
            byName.set(name, { 
              name, 
              totalTasks: 0,
              tcktTotal: 0, tcktCompleted: 0,
              ceTotal: 0, ceCompleted: 0,
              hdktTotal: 0, hdktCompleted: 0,
              bbTotal: 0, bbCompleted: 0,
              jigTotal: 0, jigCompleted: 0,
              khksclTotal: 0, khksclCompleted: 0,
              notNeeded4m: 0
            });
          }
          
          const rec = byName.get(name);
          rec.totalTasks += 1; // Count only tasks with "4M rà soát" not empty
          
          // Get completion percentages for each category (exact JSON field names)
          const tckt = String(getV(r, [
            'TCKT(% hoàn thành)','tckt(% hoàn thành)',
            'tckt','TCKT','tckt % hoàn thành'
          ])||'').trim();
          const ce = String(getV(r, [
            'CE(% hoàn thành)','ce(% hoàn thành)',
            'ce','CE','ce % hoàn thành'
          ])||'').trim();
          const hdkt = String(getV(r, [
            'HDKT(% hoàn thành)','hdkt(% hoàn thành)',
            'hdkt','HDKT','hdkt % hoàn thành'
          ])||'').trim();
          const bb = String(getV(r, [
            'BB đào tạo(% hoàn thành)','bb đào tạo(% hoàn thành)',
            'bb đào tạo','BB đào tạo','bb','bb dao tao'
          ])||'').trim();
          const jig = String(getV(r, [
            'Jig tool(% hoàn thành)','jig tool(% hoàn thành)',
            'jig tool','Jig tool','jig','jigtool'
          ])||'').trim();
          const khkscl = String(getV(r, [
            'KHKSCL(% hoàn thành)','khkscl(% hoàn thành)',
            'khkscl','KHKSCL','khkscl % hoàn thành'
          ])||'').trim();
          
          // Parse percentage values and accumulate (for average calculation)
          const parsePercent = (val) => {
            if(!val) return 0;
            let v = String(val).replace('%','').trim();
            // Chuẩn hóa dấu phẩy thành dấu chấm
            if (v.includes(',') && !v.includes('.')) v = v.replace(',', '.');
            const num = parseFloat(v);
            if(isNaN(num)) return 0;
            // Convert 0-1 range to 0-100 range
            return num <= 1 && num > 0 ? num * 100 : num;
          };
          
          // Debug: Log first few processed tasks
          if(processedCount <= 3) {
            console.log(`[P4] Processing task ${processedCount}:`, name);
            console.log('  TCKT:', tckt, '→', parsePercent(tckt));
            console.log('  CE:', ce, '→', parsePercent(ce));
          }
          
          // Accumulate percentage values for average calculation
          // Nếu 4M rà soát = "Không cần" => tính 100% cho tất cả hạng mục
          const fourMStatus = String(getV(r, [ '4M rà soát','4m rà soát','4m ra soat','4M','4m rasoat','rasoat4m' ])||'').trim();
          const fourMNorm = (typeof vnLower==='function') ? vnLower(fourMStatus) : fourMStatus.toLowerCase();
          const isNotNeeded = (fourMNorm.includes('khong can') || fourMNorm.includes('không cần'));
          if (isNotNeeded) rec.notNeeded4m += 1;
          const pTCKT = isNotNeeded ? 100 : parsePercent(tckt);
          const pCE = isNotNeeded ? 100 : parsePercent(ce);
          const pHDKT = isNotNeeded ? 100 : parsePercent(hdkt);
          const pBB = isNotNeeded ? 100 : parsePercent(bb);
          const pJIG = isNotNeeded ? 100 : parsePercent(jig);
          const pKH = isNotNeeded ? 100 : parsePercent(khkscl);
          rec.tcktTotal += 1; rec.tcktCompleted += pTCKT;
          rec.ceTotal += 1; rec.ceCompleted += pCE;
          rec.hdktTotal += 1; rec.hdktCompleted += pHDKT;
          rec.bbTotal += 1; rec.bbCompleted += pBB;
          rec.jigTotal += 1; rec.jigCompleted += pJIG;
          rec.khksclTotal += 1; rec.khksclCompleted += pKH;
        });
        
        // Debug: Log processing statistics
        console.log('[P4] Processing stats:');
        console.log('  - Total rows:', F5A_P3_RAW.length);
        console.log('  - Processed:', processedCount);
        console.log('  - Skipped (no name):', skippedNoName);
        console.log('  - Skipped (not product):', skippedNotProduct);
        console.log('  - Skipped (wrong month):', skippedWrongMonth);
        console.log('  - Employees found:', byName.size);
        
        // Check if any tasks have "4M rà soát" data
        const tasksWith4M = F5A_P3_RAW.filter(r => {
          const rasoat4m = String(getV(r, [
            '4M rà soát','4m rà soát','4m ra soat',
            '4M','4m rasoat','rasoat4m'
          ])||'').trim();
          return !!rasoat4m;
        });
        console.log('[P4] Tasks with "4M rà soát" data:', tasksWith4M.length);
        
        if(tasksWith4M.length > 0) {
          console.log('[P4] Sample task with 4M data:', tasksWith4M[0]);
        }
        
        // Sort by name
        const sorted = Array.from(byName.values()).sort((a,b) => a.name.localeCompare(b.name, 'vi'));
        
        // Generate rows with completion percentages (average values)
        const rowsP4 = [];
        let sumTotal = 0, sumTckt = 0, sumCe = 0, sumHdkt = 0, sumBb = 0, sumJig = 0, sumKhkscl = 0, sumP4 = 0;
        
        sorted.forEach(r => {
          // Calculate AVERAGE percentages for each category (with 2 decimal places)
          const tcktPercentage = r.tcktTotal > 0 ? (r.tcktCompleted / r.tcktTotal).toFixed(2) : '0.00';
          const cePercentage = r.ceTotal > 0 ? (r.ceCompleted / r.ceTotal).toFixed(2) : '0.00';
          const hdktPercentage = r.hdktTotal > 0 ? (r.hdktCompleted / r.hdktTotal).toFixed(2) : '0.00';
          const bbPercentage = r.bbTotal > 0 ? (r.bbCompleted / r.bbTotal).toFixed(2) : '0.00';
          const jigPercentage = r.jigTotal > 0 ? (r.jigCompleted / r.jigTotal).toFixed(2) : '0.00';
          const khksclPercentage = r.khksclTotal > 0 ? (r.khksclCompleted / r.khksclTotal).toFixed(2) : '0.00';
          
          // Calculate "Thẻ P4 (%)" - average of all 6 categories (always divide by 6)
          const tcktVal = parseFloat(tcktPercentage);
          const ceVal = parseFloat(cePercentage);
          const hdktVal = parseFloat(hdktPercentage);
          const bbVal = parseFloat(bbPercentage);
          const jigVal = parseFloat(jigPercentage);
          const khksclVal = parseFloat(khksclPercentage);
          
          // Always sum all 6 values (0% for empty categories) and divide by 6
          const totalSum = tcktVal + ceVal + hdktVal + bbVal + jigVal + khksclVal;
          const p4Percentage = (totalSum / 6).toFixed(2);
          
          sumTotal += r.totalTasks;
          sumTckt += parseFloat(tcktPercentage);
          sumCe += parseFloat(cePercentage);
          sumHdkt += parseFloat(hdktPercentage);
          sumBb += parseFloat(bbPercentage);
          sumJig += parseFloat(jigPercentage);
          sumKhkscl += parseFloat(khksclPercentage);
          sumP4 += parseFloat(p4Percentage);
          
          rowsP4.push(`
            <tr>
              <td class="px-3 py-2 font-medium">${r.name}</td>
              <td class="px-3 py-2 text-center font-semibold cursor-pointer hover:bg-blue-50" onclick="openP4MachineModal('${r.name.replace(/'/g, "\\'")}', '${monthVal}')" title="Click để xem chi tiết tác vụ máy">
                ${r.totalTasks}
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-semibold ${parseFloat(tcktPercentage) >= 80 ? 'text-green-600' : parseFloat(tcktPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${tcktPercentage}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-semibold ${parseFloat(cePercentage) >= 80 ? 'text-green-600' : parseFloat(cePercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${cePercentage}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-semibold ${parseFloat(hdktPercentage) >= 80 ? 'text-green-600' : parseFloat(hdktPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${hdktPercentage}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-semibold ${parseFloat(bbPercentage) >= 80 ? 'text-green-600' : parseFloat(bbPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${bbPercentage}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-semibold ${parseFloat(jigPercentage) >= 80 ? 'text-green-600' : parseFloat(jigPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${jigPercentage}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-semibold ${parseFloat(khksclPercentage) >= 80 ? 'text-green-600' : parseFloat(khksclPercentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${khksclPercentage}%</span>
              </td>
              <td class="px-3 py-2 text-center">
                <span class="font-semibold ${parseFloat(p4Percentage) >= 80 ? 'text-green-600' : parseFloat(p4Percentage) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${p4Percentage}%</span>
              </td>
            </tr>
          `);
        });
        
        // Add total row with average percentages (with 2 decimal places)
        const avgTckt = sorted.length > 0 ? (sumTckt / sorted.length).toFixed(2) : '0.00';
        const avgCe = sorted.length > 0 ? (sumCe / sorted.length).toFixed(2) : '0.00';
        const avgHdkt = sorted.length > 0 ? (sumHdkt / sorted.length).toFixed(2) : '0.00';
        const avgBb = sorted.length > 0 ? (sumBb / sorted.length).toFixed(2) : '0.00';
        const avgJig = sorted.length > 0 ? (sumJig / sorted.length).toFixed(2) : '0.00';
        const avgKhkscl = sorted.length > 0 ? (sumKhkscl / sorted.length).toFixed(2) : '0.00';
        const avgP4 = sorted.length > 0 ? (sumP4 / sorted.length).toFixed(2) : '0.00';
        
        const totalNotNeeded = sorted.reduce((a,b)=> a + (b.notNeeded4m||0), 0);
        const totalRow = `
          <tr class="bg-blue-50 font-semibold">
            <td class="px-3 py-2">TỔNG</td>
            <td class="px-3 py-2 text-center">${sumTotal}</td>
            <td class="px-3 py-2 text-center">
              <span class="font-bold ${parseFloat(avgTckt) >= 80 ? 'text-green-600' : parseFloat(avgTckt) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgTckt}%</span>
            </td>
            <td class="px-3 py-2 text-center">
              <span class="font-bold ${parseFloat(avgCe) >= 80 ? 'text-green-600' : parseFloat(avgCe) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgCe}%</span>
            </td>
            <td class="px-3 py-2 text-center">
              <span class="font-bold ${parseFloat(avgHdkt) >= 80 ? 'text-green-600' : parseFloat(avgHdkt) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgHdkt}%</span>
            </td>
            <td class="px-3 py-2 text-center">
              <span class="font-bold ${parseFloat(avgBb) >= 80 ? 'text-green-600' : parseFloat(avgBb) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgBb}%</span>
            </td>
            <td class="px-3 py-2 text-center">
              <span class="font-bold ${parseFloat(avgJig) >= 80 ? 'text-green-600' : parseFloat(avgJig) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgJig}%</span>
            </td>
            <td class="px-3 py-2 text-center">
              <span class="font-bold ${parseFloat(avgKhkscl) >= 80 ? 'text-green-600' : parseFloat(avgKhkscl) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgKhkscl}%</span>
            </td>
            <td class="px-3 py-2 text-center">
              <span class="font-bold ${parseFloat(avgP4) >= 80 ? 'text-green-600' : parseFloat(avgP4) >= 50 ? 'text-blue-600' : 'text-orange-600'}">${avgP4}%</span>
            </td>
          </tr>
        `;
        
        body.innerHTML = (rowsP4.join('') + totalRow) || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Chưa có dữ liệu</td></tr>';
        
        // Enable table drag
        try{ enableTableDrag('f5a-body-p4'); }catch(_){ }
        
        console.log('[F5A P4] Rendered', sorted.length, 'employees with enhanced analysis');
        
      }catch(err){
        console.error('[F5A P4] Render error:', err);
        const body = document.getElementById('f5a-body-p4');
        if(body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="9">Lỗi hiển thị dữ liệu</td></tr>';
      }
    }

    // ===== Form 5: Tab Navigation Handler =====
    // ===== Form 5 P3: Fetch and render CE review data =====
    async function f5aFetchP3Data(month){
      try{
        console.log('[F5A P3] Fetching CE review data for month:', month || 'all');
        
        // Build URLs with proper parameters like P1/P2
        const baseUrl = FORM5_P3_URL;
        const testUrl = baseUrl.replace('/webhook/', '/webhook-test/');
        const prodUrl = baseUrl.replace('/webhook-test/', '/webhook/');
        
        // Build query string with month filter
        const makeQs = (withAction, withRange) => {
          const qs = new URLSearchParams();
          if(withAction) qs.append('action', 'form5_p3');
          if(withRange && month){
            qs.append('month', month);
            try{
              const [yy, mm] = month.split('-');
              const firstDay = `${yy}-${mm}-01`;
              const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
              const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
              qs.append('from', firstDay);
              qs.append('to', lastDay);
            }catch(_){}
          }
          qs.append('_ts', Date.now().toString());
          return qs.toString();
        };
        
        // Try multiple URL combinations like P1/P2
        const urls = [];
        [true, false].forEach(withRange => {
          [true, false].forEach(withAction => {
            const q = makeQs(withAction, withRange);
            urls.push(`${prodUrl}${q ? `?${q}` : ''}`);
            urls.push(`${testUrl}${q ? `?${q}` : ''}`);
          });
        });
        // Also try without query
        urls.push(prodUrl);
        urls.push(testUrl);
        
        let rows = [];
        for(const u of urls){
          try{
            console.log('[F5A P3] Trying:', u);
            const r = await fetch(u, { method: 'GET', headers: { 'Accept': 'application/json, text/plain, */*' } });
            const text = await r.text();
            console.log('[F5A P3] Response status:', r.status, 'length:', text.length);
            
            let data = null;
            try{ data = JSON.parse(text); }catch{ data = null; }
            
            if(!data && typeof text === 'string'){
              const m = text.match(/\[[\s\S]*\]/);
              if(m){
                try{ data = JSON.parse(m[0]); console.log('[F5A P3] Extracted JSON from text'); }catch(_){}
              }
            }
            
            const picked = f5aPickRowsDeep(data ?? text);
            if(Array.isArray(picked) && picked.length){
              rows = picked;
              console.log('[F5A P3] Success! Got', rows.length, 'rows from:', u);
              break;
            }
          }catch(e){
            console.log('[F5A P3] Failed:', e.message);
            // Continue to next URL
          }
        }
        
        // Unwrap n8n format: [{ json: {...} }]
        const unwrapped = Array.isArray(rows) ? rows.map(r => (r && typeof r === 'object' && ('json' in r)) ? r.json : r) : [];
        
        F5A_P3_RAW = unwrapped;
        F5A_P3_META = { month: month || '' };
        
        // Save timestamp
        try{ LS.set('f5a.p3.lastUpdated', String(Date.now())); }catch(_){ }
        
        console.log('[F5A P3] Final result:', F5A_P3_RAW.length, 'records');
        
        // If no data due to CORS, show helpful message
        if(!F5A_P3_RAW || F5A_P3_RAW.length === 0){
          console.warn('[F5A P3] No data received. This is likely a CORS issue.');
          console.warn('[F5A P3] Endpoint:', FORM5_P3_URL);
          console.warn('[F5A P3] Solutions:');
          console.warn('[F5A P3] 1. Serve HTML from web server (not file://)');
          console.warn('[F5A P3] 2. Add CORS headers to webhook endpoint');
          console.warn('[F5A P3] 3. Contact admin to fix endpoint CORS');
          
          // Show user-friendly error message
          const body = document.getElementById('f5a-body-p3');
          if(body){
            body.innerHTML = `
              <tr>
                <td colspan="6" class="px-3 py-3 text-center">
                  <div class="text-red-500 mb-2">⚠️ Không thể tải dữ liệu P3</div>
                  <div class="text-sm text-gray-600 mb-2">Lỗi CORS - Endpoint chưa được cấu hình đúng</div>
                  <div class="text-xs text-blue-600">
                    <strong>Giải pháp:</strong><br>
                    1. Liên hệ admin để thêm CORS headers vào endpoint<br>
                    2. Hoặc host file HTML trên web server
                  </div>
                </td>
              </tr>
            `;
          }
        }
        
        return F5A_P3_RAW;
      }catch(err){
        console.error('[F5A P3] Fetch error:', err);
        F5A_P3_RAW = [];
        return [];
      }
    }

    function renderForm5P3(){
      try{
        const body = document.getElementById('f5a-body-p3');
        if (!body) return;
        
        console.log('[F5A P3] Rendering from F5A_P3_RAW, length:', F5A_P3_RAW ? F5A_P3_RAW.length : 0);
        
        if(!Array.isArray(F5A_P3_RAW) || !F5A_P3_RAW.length){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Chưa có dữ liệu</td></tr>';
          return;
        }
        
        // Get month filter
        const monthInput = document.getElementById('f5a-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        
        // Helper functions
        const norm = (s) => String(s||'').toLowerCase().trim();
        const getV = (obj, keys) => {
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
          for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
          return '';
        };
        
        // Parse date flexible
        const parseDate = (value) => {
          try{
            if(!value) return null;
            const s = String(value).trim();
            // DD/MM/YYYY HH:mm
            let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if(m){
              const d = new Date(+m[3], +m[2]-1, +m[1]);
              return isNaN(d) ? null : d;
            }
            // YYYY-MM-DD
            m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
            if(m){
              const d = new Date(+m[1], +m[2]-1, +m[3]);
              return isNaN(d) ? null : d;
            }
            const d = new Date(s);
            return isNaN(d) ? null : d;
          }catch(_){ return null; }
        };
        
        const formatYyyyMm = (d) => {
          if(!d) return '';
          const yy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,'0');
          return `${yy}-${mm}`;
        };
        
        // Aggregate by employee
        const byName = new Map();
        
        F5A_P3_RAW.forEach(r => {
          // Get assignee name
          const name = String(getV(r, [
            'assignee','employee','name',
            'nhân viên','nhan vien','nhanvien',
            'tên nhân viên','ten nhan vien','tennhanvien',
            'phụ trách','phu trac','phutrac'
          ])||'').trim();
          
          if(!name) return;
          
          // Skip tasks assigned to "x" (pending tasks)
          if(name.toLowerCase() === 'x') {
            return;
          }
          
          // Get completion date
          const completionDateStr = getV(r, [
            'ngày hoàn thành thực tế','ngay hoan thanh thuc te',
            'ngày hoàn thành','ngay hoan thanh',
            'completion date','completiondate',
            'actual completion date','actualcompletiondate'
          ]);
          
          const completionDate = parseDate(completionDateStr);
          
          // Filter by month if specified
          if(monthVal && completionDate){
            const taskMonth = formatYyyyMm(completionDate);
            if(taskMonth !== monthVal) return; // Skip if not in selected month
          } else if(monthVal && !completionDate) {
            return; // Skip tasks without completion date when month filter is active
          }
          
          // Get CE review status
          const ceReview = String(getV(r, [
            'ce rà soát','ce ra soat','cerasoat',
            'ce review','cereview',
            'rà soát ce','ra soat ce','rasotce',
            'tình trạng ce','tinh trang ce'
          ])||'').trim();
          
          // Initialize record if not exists
          if(!byName.has(name)){
            byName.set(name, { 
              name, 
              total: 0,
              completed: 0, 
              notNeeded: 0, 
              pending: 0
            });
          }
          
          const rec = byName.get(name);
          
          // Count by CE review status
          const ceNorm = norm(ceReview);
          if(ceNorm === 'đã gửi' || ceNorm === 'da gui' || ceNorm === 'dagui'){
            rec.completed += 1;
          } else if(ceNorm === 'không cần' || ceNorm === 'khong can' || ceNorm === 'khongcan'){
            rec.notNeeded += 1;
          } else if(!ceReview || ceReview === ''){
            rec.pending += 1;
          }
          
          // Total = sum of completed + notNeeded + pending
          rec.total = rec.completed + rec.notNeeded + rec.pending;
        });
        
        // Sort by name
        const sorted = Array.from(byName.values()).sort((a,b) => a.name.localeCompare(b.name, 'vi'));
        
        // Render table
        const rowsP3 = [];
        let sumTotal = 0, sumCompleted = 0, sumNotNeeded = 0, sumPending = 0;
        
        sorted.forEach(r => {
          // Calculate percentage
          const percentage = r.total > 0 ? Math.round(((r.completed + r.notNeeded) / r.total) * 100) : 0;
          
          sumTotal += r.total;
          sumCompleted += r.completed;
          sumNotNeeded += r.notNeeded;
          sumPending += r.pending;
          
          rowsP3.push(`
            <tr>
              <td class="px-3 py-2">${r.name}</td>
              <td class="px-3 py-2 text-center">
                <button onclick="showP3TaskDetails('${r.name}', 'total', '${monthVal}')" 
                        class="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer font-semibold" 
                        title="Click để xem chi tiết">
                  ${r.total}
                </button>
              </td>
              <td class="px-3 py-2 text-center">
                <button onclick="showP3TaskDetails('${r.name}', 'completed', '${monthVal}')" 
                        class="text-green-600 hover:text-green-800 hover:underline cursor-pointer font-semibold" 
                        title="Click để xem chi tiết">
                  ${r.completed}
                </button>
              </td>
              <td class="px-3 py-2 text-center">
                <button onclick="showP3TaskDetails('${r.name}', 'notNeeded', '${monthVal}')" 
                        class="text-blue-600 hover:text-blue-800 hover:underline cursor-pointer font-semibold" 
                        title="Click để xem chi tiết">
                  ${r.notNeeded}
                </button>
              </td>
              <td class="px-3 py-2 text-center">
                <button onclick="showP3TaskDetails('${r.name}', 'pending', '${monthVal}')" 
                        class="text-orange-600 hover:text-orange-800 hover:underline cursor-pointer font-semibold" 
                        title="Click để xem chi tiết">
                  ${r.pending}
                </button>
              </td>
              <td class="px-3 py-2 text-center"><span class="font-semibold ${percentage >= 80 ? 'text-green-600' : percentage >= 50 ? 'text-blue-600' : 'text-orange-600'}">${percentage}%</span></td>
            </tr>
          `);
        });
        
        // Add total row
        const totalPercentage = sumTotal > 0 ? Math.round(((sumCompleted + sumNotNeeded) / sumTotal) * 100) : 0;
        const totalRow = `
          <tr class="bg-blue-50 font-semibold">
            <td class="px-3 py-2">TỔNG</td>
            <td class="px-3 py-2 text-center">${sumTotal}</td>
            <td class="px-3 py-2 text-center">${sumCompleted}</td>
            <td class="px-3 py-2 text-center">${sumNotNeeded}</td>
            <td class="px-3 py-2 text-center">${sumPending}</td>
            <td class="px-3 py-2 text-center"><span class="font-bold ${totalPercentage >= 80 ? 'text-green-600' : totalPercentage >= 50 ? 'text-blue-600' : 'text-orange-600'}">${totalPercentage}%</span></td>
          </tr>
        `;
        
        body.innerHTML = (rowsP3.join('') + totalRow) || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Chưa có dữ liệu</td></tr>';
        
        // Enable table drag
        try{ enableTableDrag('f5a-body-p3'); }catch(_){ }
        
        console.log('[F5A P3] Rendered', sorted.length, 'employees');
        
        // Debug: Log first employee details
        if(sorted.length > 0){
          const firstEmp = sorted[0];
          console.log('[F5A P3] Debug - First employee:', firstEmp.name);
          console.log('[F5A P3] Debug - Total tasks:', firstEmp.total);
          console.log('[F5A P3] Debug - Completed:', firstEmp.completed);
          console.log('[F5A P3] Debug - Not needed:', firstEmp.notNeeded);
          console.log('[F5A P3] Debug - Pending:', firstEmp.pending);
        }
      }catch(err){
        console.error('[F5A P3] Render error:', err);
        const body = document.getElementById('f5a-body-p3');
        if(body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="6">Lỗi hiển thị dữ liệu</td></tr>';
      }
    }

    (function initF5aTabs(){
      try{
        const tabBtns = [
          document.getElementById('f5a-tab-p1'),
          document.getElementById('f5a-tab-p2'),
          document.getElementById('f5a-tab-p3'),
          document.getElementById('f5a-tab-p4')
        ];
        const panels = [
          document.getElementById('f5a-panel-p1'),
          document.getElementById('f5a-panel-p2'),
          document.getElementById('f5a-panel-p3'),
          document.getElementById('f5a-panel-p4')
        ];

        function setActiveBtn(btn, active){
          if (!btn) return;
          if (active){
            btn.classList.remove('text-gray-600');
            btn.classList.add('text-white','bg-primary-blue','border-primary-blue');
          } else {
            btn.classList.remove('text-white','bg-primary-blue','border-primary-blue');
            btn.classList.add('text-gray-600');
          }
        }

        function switchTab(index){
          try{
            panels.forEach((p,i)=>{ if (p) p.classList.toggle('hidden', i!==index); });
            tabBtns.forEach((b,i)=> setActiveBtn(b, i===index));
            try{ LS.set('f5a.activeTab', String(index)); }catch(_){ }
            
            // P3: Render if data exists, otherwise show hint to click "Tra cứu P3"
            if(index === 2){
              if(F5A_P3_RAW && F5A_P3_RAW.length){
                renderForm5P3();
              } else {
                const body = document.getElementById('f5a-body-p3');
                if(body){
                  body.innerHTML = `
                    <tr>
                      <td colspan="6" class="px-3 py-3 text-center">
                        <div class="text-gray-500 mb-2">Chưa có dữ liệu P3</div>
                        <div class="text-sm text-blue-600">👆 Nhấn nút <b>"Tra cứu P3"</b> ở trên để tải dữ liệu</div>
                      </td>
                    </tr>
                  `;
                }
              }
            }
            
            // P4: Auto-fetch P3 data and render (same data source as P3, different view)
            if(index === 3){
              const monthInput = document.getElementById('f5a-month');
              const month = monthInput ? monthInput.value : '';
              
              // Check if need to fetch
              const needFetch = !F5A_P3_RAW || F5A_P3_RAW.length === 0 || F5A_P3_META.month !== month;
              
              if(needFetch){
                const body = document.getElementById('f5a-body-p4');
                if(body){
                  body.innerHTML = `
                    <tr>
                      <td colspan="8" class="px-3 py-3 text-center">
                        <div class="text-gray-500 mb-2">Đang tải dữ liệu P4...</div>
                      </td>
                    </tr>
                  `;
                }
                
                // Fetch and render
                f5aFetchP3Data(month).then(()=>{
                  renderForm5P4();
                }).catch(err=>{
                  console.error('[P4 Tab] Fetch error:', err);
                  const body = document.getElementById('f5a-body-p4');
                  if(body){
                    body.innerHTML = `
                      <tr>
                        <td colspan="8" class="px-3 py-3 text-center">
                          <div class="text-red-600 mb-2">Lỗi tải dữ liệu</div>
                          <div class="text-sm text-gray-600">👆 Thử nhấn nút <b>"Tra cứu P4"</b> ở trên</div>
                        </td>
                      </tr>
                    `;
                  }
                });
              } else {
                // Data already available, just render
                renderForm5P4();
              }
            }
          }catch(err){ console.error('Form5 switchTab error:', err); }
        }

        tabBtns.forEach((btn, idx)=>{ if(btn){ btn.addEventListener('click', (e)=>{ e.preventDefault(); switchTab(idx); }); } });

        // Restore last tab or default to P1
        let initial = 0;
        try{ const last = LS.get('f5a.activeTab'); const n = Number(last); if (Number.isFinite(n) && n>=0 && n<4) initial = n; }catch(_){ }
        switchTab(initial);
      }catch(err){ console.warn('initF5aTabs failed', err); }
    })();

    // Bind explicit click for "Tra cứu P4" to fetch P3-data and render P4 (avoid any legacy handlers)
    (function initF5aSearchP4(){
      try{
        const btn = document.getElementById('f5a-search-p4');
        if (btn && !btn._bound){
          try{ btn.onclick = null; }catch(_){ }
          btn.addEventListener('click', async (e)=>{
            e.preventDefault();
            try{ e.stopImmediatePropagation(); }catch(_){ }
            const monthInput = document.getElementById('f5a-month');
            const month = monthInput ? (monthInput.value||'') : '';
            const prev = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
            try{
              await f5aFetchP3Data(month);
              renderForm5P4();
            }finally{
              btn.disabled = false;
              btn.textContent = prev || 'Tra cứu P4';
            }
          });
          btn._bound = true;
        }
      }catch(_){ }
    })();

    // ===== P4 Machine Task Details Modal Functions =====
    function openP4MachineModal(employeeName, month) {
      try {
        const modal = document.getElementById('p4-machine-modal');
        const employeeEl = document.getElementById('p4-machine-employee');
        const body = document.getElementById('p4-machine-modal-body');
        
        if (!modal || !employeeEl || !body) return;
        
        // Set employee name
        employeeEl.textContent = employeeName || '';
        
        // Show loading state
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Đang tải dữ liệu...</td></tr>';
        
        // Show modal
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
        
        // Load data
        loadP4MachineTaskDetails(employeeName, month);
        
      } catch (err) {
        console.error('[P4 Machine Modal] Open error:', err);
      }
    }

    function closeP4MachineModal() {
      try {
        const modal = document.getElementById('p4-machine-modal');
        if (modal) {
          modal.classList.add('hidden');
          modal.setAttribute('aria-hidden', 'true');
        }
      } catch (err) {
        console.error('[P4 Machine Modal] Close error:', err);
      }
    }

    async function loadP4MachineTaskDetails(employeeName, month) {
      try {
        const body = document.getElementById('p4-machine-modal-body');
        if (!body) return;
        
        console.log('[P4 Machine Details] Loading for:', employeeName, 'month:', month);
        
        // Check if we have P3 data
        if (!Array.isArray(F5A_P3_RAW) || !F5A_P3_RAW.length) {
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="13">Chưa có dữ liệu. Vui lòng nhấn "Tra cứu P4" trước.</td></tr>';
          return;
        }
        
        // Helper functions
        const norm = (s) => String(s||'').toLowerCase().trim();
        const getV = (obj, keys) => {
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
          for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
          return '';
        };
        
        const parseDate = (value) => {
          try{
            if(!value) return null;
            const s = String(value).trim();
            let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if(m){ return new Date(+m[3], +m[2]-1, +m[1]); }
            m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
            if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
            return new Date(s);
          }catch(_){ return null; }
        };
        
        const formatYyyyMm = (d) => {
          if(!d) return '';
          return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        };
        
        const parsePercent = (v) => {
          try{
            if(!v) return 0;
            const s = String(v).trim();
            const num = parseFloat(s);
            if(isNaN(num)) return 0;
            if(num >= 0 && num <= 1) return num * 100;
            if(num >= 0 && num <= 100) return num;
            return 0;
          }catch(_){ return 0; }
        };
        
        // Filter tasks for this employee and month
        const employeeTasks = F5A_P3_RAW.filter(r => {
          const name = String(getV(r, [
            'assignee','employee','name',
            'nhân viên','nhan vien','nhanvien',
            'tên nhân viên','ten nhan vien','tennhanvien',
            'phụ trách','phu trac','phutrac'
          ])||'').trim();
          
          if(!name || name.toLowerCase() === 'x') return false;
          if(!sameName(name, employeeName)) return false;
          
          const completionDateStr = getV(r, [
            'ngày hoàn thành thực tế','ngay hoan thanh thuc te',
            'ngày hoàn thành','ngay hoan thanh'
          ]);
          
          const completionDate = parseDate(completionDateStr);
          
          if(month && completionDate){
            const taskMonth = formatYyyyMm(completionDate);
            if(taskMonth !== month) return false;
          } else if(month && !completionDate) {
            return false;
          }
          
          // Only include tasks with 4M data
          const rasoat4m = String(getV(r, [
            '4M rà soát','4m rà soát','4m ra soat',
            '4M','4m rasoat'
          ])||'').trim();
          
          return !!rasoat4m;
        });
        
        console.log('[P4 Machine Details] Found', employeeTasks.length, 'tasks for', employeeName);
        
        if (!employeeTasks.length) {
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Không có dữ liệu tác vụ máy</td></tr>';
          return;
        }
        
        // Render table rows
        const rows = [];
        let stt = 0;
        
        employeeTasks.forEach(task => {
          stt++;
          
          const taskId = String(getV(task, ['taskid','task_id','ma_tac_vu','mã tác vụ','requestid','id'])||'').trim();
          const taskName = String(getV(task, [
            'taskname','ten_tac_vu','ten','name','title','tên tác vụ',
            'Task Name','TaskName','task_name','taskName',
            'Tên tác vụ','Tên Task','TênTask','ten_task',
            'Công việc','cong_viec','congviec','work','job',
            'Mô tả','mo_ta','mota','description','desc',
            'Nội dung','noi_dung','noidung','content'
          ])||'').trim();
          
          // Debug: Log task data if taskName is empty
          if (!taskName && stt <= 3) {
            console.log('[P4 Machine Debug] Task', stt, 'has empty taskName. Available fields:', Object.keys(task));
            console.log('[P4 Machine Debug] Sample task data:', task);
          }
          
          // Fallback: If taskName is still empty, try to find the longest text field
          let finalTaskName = taskName;
          if (!finalTaskName) {
            const textFields = Object.entries(task).filter(([key, value]) => {
              const str = String(value || '').trim();
              return str.length > 5 && str.length < 200 && !str.match(/^\d+$/) && !str.match(/^\d{4}-\d{2}-\d{2}/);
            });
            
            if (textFields.length > 0) {
              // Sort by length and take the longest one
              textFields.sort((a, b) => String(b[1]).length - String(a[1]).length);
              finalTaskName = String(textFields[0][1]).trim();
              console.log('[P4 Machine Debug] Using fallback taskName from field:', textFields[0][0], '=', finalTaskName);
            }
          }
          const completionDateStr = getV(task, [
            'ngày hoàn thành thực tế','ngay hoan thanh thuc te',
            'ngày hoàn thành','ngay hoan thanh'
          ]);
          const completionDate = parseDate(completionDateStr);
          const formattedDate = completionDate ? formatDdMmYyyy(completionDate) : '';
          
          // Parse 4M percentages
          const tckt = parsePercent(getV(task, ['TCKT(% hoàn thành)','tckt','tckt%']));
          const ce = parsePercent(getV(task, ['CE(% hoàn thành)','ce','ce%']));
          const hdkt = parsePercent(getV(task, ['HDKT(% hoàn thành)','hdkt','hdkt%']));
          const bb = parsePercent(getV(task, ['BB đào tạo(% hoàn thành)','bb dao tao','bb%']));
          const jig = parsePercent(getV(task, ['Jig tool(% hoàn thành)','jig tool','jig%']));
          const khkscl = parsePercent(getV(task, ['KHKSCL(% hoàn thành)','khkscl','khkscl%']));
          
          // Get 4M review data
          const rasoat4m = String(getV(task, [
            '4M rà soát','4m rà soát','4m ra soat',
            '4M','4m rasoat'
          ])||'').trim();
          
          const ngayKhaiBao4m = String(getV(task, [
            'ngày khai báo 4M','ngay khai bao 4m',
            'ngày khai báo','ngay khai bao',
            '4M ngày khai báo','4m ngay khai bao'
          ])||'').trim();
          
          const ghiChu4m = String(getV(task, [
            'ghi chú 4M','ghi chu 4m',
            'ghi chú','ghi chu',
            '4M ghi chú','4m ghi chu',
            'note 4M','note 4m'
          ])||'').trim();
          
          rows.push(`
            <tr>
              <td class="px-3 py-2 text-center">${stt}</td>
              <td class="px-3 py-2 font-mono text-blue-600">${taskId}</td>
              <td class="px-3 py-2">${finalTaskName || taskId || 'N/A'}</td>
              <td class="px-3 py-2">${formattedDate}</td>
              <td class="px-3 py-2 text-center">${tckt.toFixed(1)}%</td>
              <td class="px-3 py-2 text-center">${ce.toFixed(1)}%</td>
              <td class="px-3 py-2 text-center">${hdkt.toFixed(1)}%</td>
              <td class="px-3 py-2 text-center">${bb.toFixed(1)}%</td>
              <td class="px-3 py-2 text-center">${jig.toFixed(1)}%</td>
              <td class="px-3 py-2 text-center">${khkscl.toFixed(1)}%</td>
              <td class="px-3 py-2 text-center">
                <span class="px-2 py-1 rounded text-xs ${rasoat4m.toLowerCase().includes('đã') ? 'bg-green-100 text-green-800' : rasoat4m.toLowerCase().includes('chưa') ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                  ${rasoat4m || '-'}
                </span>
              </td>
              <td class="px-3 py-2">${ngayKhaiBao4m || '-'}</td>
              <td class="px-3 py-2">${ghiChu4m || '-'}</td>
            </tr>
          `);
        });
        
        body.innerHTML = rows.join('');
        
      } catch (err) {
        console.error('[P4 Machine Details] Load error:', err);
        const body = document.getElementById('p4-machine-modal-body');
        if (body) {
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-red-600" colspan="13">Lỗi tải dữ liệu</td></tr>';
        }
      }
    }

    // Helper function to compare names (same as used in P3)
    function sameName(a, b) {
      try {
        const normalize = (s) => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ').trim();
        return normalize(a) === normalize(b);
      } catch (_) {
        return String(a||'').toLowerCase().trim() === String(b||'').toLowerCase().trim();
      }
    }
  </script>

  <!-- Modal for P3 Task Details -->
  <div id="p3-task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <h3 id="p3-modal-title" class="text-lg font-semibold text-gray-800">Chi tiết tác vụ</h3>
          <button onclick="closeP3TaskModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[calc(90vh-80px)]">
          <div id="p3-modal-content" class="space-y-4">
            <!-- Content will be populated by JavaScript -->
          </div>
        </div>
        <div class="flex items-center justify-end p-4 border-t bg-gray-50">
          <button onclick="closeP3TaskModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for P4 Machine Task Details -->
  <div id="p4-machine-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-7xl w-full max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b bg-gradient-to-r from-emerald-50 to-white">
          <h3 id="p4-machine-modal-title" class="text-lg font-semibold text-emerald-800">Chi tiết tác vụ máy</h3>
          <button onclick="closeP4MachineModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[calc(90vh-80px)]">
          <div class="mb-4 text-sm text-gray-600">
            <span class="font-medium">Nhân viên:</span> <span id="p4-machine-employee" class="text-emerald-700 font-semibold"></span>
          </div>
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-[1600px] w-full text-sm table-zebra table-vdiv">
              <thead class="bg-gradient-to-r from-emerald-100 to-emerald-50 sticky top-0">
                <tr class="text-left text-gray-700">
                  <th class="px-3 py-2">STT</th>
                  <th class="px-3 py-2">Mã tác vụ</th>
                  <th class="px-3 py-2">Tên tác vụ</th>
                  <th class="px-3 py-2">Ngày hoàn thành</th>
                  <th class="px-3 py-2">TCKT(%)</th>
                  <th class="px-3 py-2">CE(%)</th>
                  <th class="px-3 py-2">HDKT(%)</th>
                  <th class="px-3 py-2">BB đào tạo(%)</th>
                  <th class="px-3 py-2">Jig tool(%)</th>
                  <th class="px-3 py-2">KHKSCL(%)</th>
                  <th class="px-3 py-2">4M rà soát</th>
                  <th class="px-3 py-2">Ngày khai báo 4M</th>
                  <th class="px-3 py-2">Ghi chú 4M</th>
                </tr>
              </thead>
              <tbody id="p4-machine-modal-body" class="divide-y divide-gray-100">
                <tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Đang tải dữ liệu...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="flex items-center justify-end p-4 border-t bg-gray-50">
          <button onclick="closeP4MachineModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for P4 Task Details -->
  <div id="p4-task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-7xl w-full max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b bg-gradient-to-r from-blue-50 to-white">
          <h3 id="p4-modal-title" class="text-lg font-semibold text-blue-800">Chi tiết tác vụ máy</h3>
          <button onclick="closeP4TaskModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[calc(90vh-80px)]">
          <div id="p4-modal-content"></div>
        </div>
        <div class="flex items-center justify-end p-4 border-t bg-gray-50">
          <button onclick="closeP4TaskModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // P3 Task Details Modal Functions
    function showP3TaskDetails(employeeName, taskType, month) {
      try {
        console.log('[P3 Modal] Showing details for:', employeeName, taskType, month);
        
        // Filter tasks for this employee
        const employeeTasks = F5A_P3_RAW.filter(r => {
          const name = String(getV(r, [
            'assignee','employee','name',
            'nhân viên','nhan vien','nhanvien',
            'tên nhân viên','ten nhan vien','tennhanvien',
            'phụ trách','phu trac','phutrac'
          ])||'').trim();
          
          // Skip tasks assigned to "x" (pending tasks)
          if(name.toLowerCase() === 'x') {
            return false;
          }
          
          return name === employeeName;
        });
        
        console.log('[P3 Modal] Found', employeeTasks.length, 'tasks for', employeeName);
        
        // Filter by month if specified (same logic as main table)
        let filteredTasks = employeeTasks;
        if(month){
          filteredTasks = employeeTasks.filter(r => {
            const completionDateStr = String(getV(r, [
              'ngày hoàn thành thực tế','ngay hoan thanh thuc te','completion date',
              'actual completion date','actualcompletiondate'
            ])||'').trim();
            
            const completionDate = parseDate(completionDateStr);
            if(!completionDate) return false; // Skip tasks without completion date
            
            const taskMonth = formatYyyyMm(completionDate);
            const matches = taskMonth === month;
            
            // Debug logging for first few tasks
            if(filteredTasks.length < 3) {
              console.log('[P3 Modal] Month filter debug:', {
                completionDateStr,
                parsedDate: completionDate,
                taskMonth,
                targetMonth: month,
                matches
              });
            }
            
            return matches;
          });
        }
        
        console.log('[P3 Modal] After month filter:', filteredTasks.length, 'tasks');
        
        // Filter by task type
        let finalTasks = [];
        const norm = (s) => String(s||'').toLowerCase().trim();
        
        filteredTasks.forEach(r => {
          const ceReview = String(getV(r, [
            'ce rà soát','ce ra soat','cerasoat',
            'ce review','cereview',
            'rà soát ce','ra soat ce','rasotce',
            'tình trạng ce','tinh trang ce'
          ])||'').trim();
          
          const ceNorm = norm(ceReview);
          
          switch(taskType) {
            case 'total':
              // For total: show tasks that have CE review status (completed + notNeeded + pending)
              if(ceNorm === 'đã gửi' || ceNorm === 'da gui' || ceNorm === 'dagui' ||
                 ceNorm === 'không cần' || ceNorm === 'khong can' || ceNorm === 'khongcan' ||
                 !ceNorm || ceNorm === ''){
                finalTasks.push({...r, status: 'Tất cả'});
              }
              break;
            case 'completed':
              if(ceNorm === 'đã gửi' || ceNorm === 'da gui' || ceNorm === 'dagui'){
                finalTasks.push({...r, status: 'Đã gửi'});
              }
              break;
            case 'notNeeded':
              if(ceNorm === 'không cần' || ceNorm === 'khong can' || ceNorm === 'khongcan'){
                finalTasks.push({...r, status: 'Không cần'});
              }
              break;
            case 'pending':
              if(!ceReview || ceNorm === ''){
                finalTasks.push({...r, status: 'Chưa hoàn thành'});
              }
              break;
          }
        });
        
        console.log('[P3 Modal] Final tasks to show:', finalTasks.length);
        console.log('[P3 Modal] Debug - Employee:', employeeName);
        console.log('[P3 Modal] Debug - Task type:', taskType);
        console.log('[P3 Modal] Debug - Month filter:', month);
        console.log('[P3 Modal] Debug - Total employee tasks:', employeeTasks.length);
        console.log('[P3 Modal] Debug - After month filter:', filteredTasks.length);
        
        // Show warning if numbers don't match
        if(taskType === 'total' && finalTasks.length !== 5) {
          console.warn('[P3 Modal] WARNING: Expected 5 tasks but got', finalTasks.length);
          console.warn('[P3 Modal] This suggests you might be looking at P1/P2 data instead of P3');
        }
        
        // Update modal title
        const typeNames = {
          'total': 'Tất cả tác vụ',
          'completed': 'Đã hoàn thiện CE',
          'notNeeded': 'Không cần làm CE', 
          'pending': 'Chưa hoàn thành'
        };
        
        document.getElementById('p3-modal-title').textContent = 
          `${employeeName} - ${typeNames[taskType]} (${finalTasks.length} tác vụ)`;
        
        // Generate task list HTML
        let content = '';
        if(finalTasks.length === 0){
          content = '<div class="text-center text-gray-500 py-8">Không có tác vụ nào</div>';
        } else {
          content = '<div class="overflow-x-auto"><table class="w-full text-sm border-collapse border border-gray-300">';
          content += `
            <thead class="bg-gray-100">
              <tr>
                <th class="border border-gray-300 px-3 py-2 text-left">STT</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Mã tác vụ</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Tên tác vụ</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Ngày hoàn thành</th>
                <th class="border border-gray-300 px-3 py-2 text-left">CE rà soát</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Kết luận</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Ghi chú</th>
              </tr>
            </thead>
            <tbody>
          `;
          
          finalTasks.forEach((task, idx) => {
            const taskCode = String(getV(task, ['mã tác vụ','ma tac vu','matacvu','task code','taskcode'])||'').trim();
            const taskName = String(getV(task, ['task name','ten tac vu','tên tác vụ','taskname','ten tac vu'])||'').trim();
            const completionDate = String(getV(task, ['ngày hoàn thành thực tế','ngay hoan thanh thuc te','completion date'])||'').trim();
            const ceReview = String(getV(task, ['ce rà soát','ce ra soat','ce review'])||'').trim();
            const conclusion = String(getV(task, ['kết luận','ket luan','ketluan','conclusion'])||'').trim();
            const note = String(getV(task, ['ghi chú','ghi chu','ghichu','note','notes'])||'').trim();
            
            content += `
              <tr class="hover:bg-gray-50">
                <td class="border border-gray-300 px-3 py-2">${idx + 1}</td>
                <td class="border border-gray-300 px-3 py-2 font-mono text-xs">${taskCode || '-'}</td>
                <td class="border border-gray-300 px-3 py-2">${taskName || '-'}</td>
                <td class="border border-gray-300 px-3 py-2">${completionDate || '-'}</td>
                <td class="border border-gray-300 px-3 py-2">
                  <span class="px-2 py-1 rounded text-xs ${
                    task.status === 'Đã gửi' ? 'bg-green-100 text-green-800' :
                    task.status === 'Không cần' ? 'bg-blue-100 text-blue-800' :
                    'bg-orange-100 text-orange-800'
                  }">${ceReview || '-'}</span>
                </td>
                <td class="border border-gray-300 px-3 py-2">${conclusion || '-'}</td>
                <td class="border border-gray-300 px-3 py-2">${note || '-'}</td>
              </tr>
            `;
          });
          
          content += '</tbody></table></div>';
        }
        
        document.getElementById('p3-modal-content').innerHTML = content;
        
        // Show modal
        document.getElementById('p3-task-modal').classList.remove('hidden');
        
      } catch(err) {
        console.error('[P3 Modal] Error:', err);
        showToast('Lỗi hiển thị chi tiết tác vụ', 'error');
      }
    }
    
    function closeP3TaskModal() {
      document.getElementById('p3-task-modal').classList.add('hidden');
    }
    
    // Close modal when clicking outside
    document.getElementById('p3-task-modal').addEventListener('click', function(e) {
      if(e.target === this) {
        closeP3TaskModal();
      }
    });
    
    // Helper functions (reuse from P3 render)
    function getV(obj, keys) {
      const lower = {};
      Object.keys(obj||{}).forEach(k=>{ lower[String(k||'').toLowerCase().trim()] = obj[k]; });
      for(const k of keys){ const v = lower[String(k||'').toLowerCase().trim()]; if(v!==undefined) return v; }
      return '';
    }
    
    function parseDate(value) {
      try{
        if(!value) return null;
        const s = String(value).trim();
        // DD/MM/YYYY HH:mm
        let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if(m){
          const d = new Date(+m[3], +m[2]-1, +m[1]);
          return isNaN(d) ? null : d;
        }
        // YYYY-MM-DD
        m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
        if(m){
          const d = new Date(+m[1], +m[2]-1, +m[3]);
          return isNaN(d) ? null : d;
        }
        const d = new Date(s);
        return isNaN(d) ? null : d;
      }catch(_){ return null; }
    }
    
    function formatYyyyMm(d) {
      if(!d) return '';
      try {
        // Handle string dates like "2025-08-19"
        if (typeof d === 'string') {
          const match = d.match(/^(\d{4})-(\d{2})/);
          if (match) return `${match[1]}-${match[2]}`;
        }
        // Handle Date objects
        if (d instanceof Date) {
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      return `${yy}-${mm}`;
        }
        return '';
      } catch(_) {
        return '';
      }
    }
    
    // P4 Task Details Modal Functions
    function showP4TaskDetails(employeeName, taskType, month) {
      try {
        console.log('[P4 Modal] Showing details for:', employeeName, taskType, month);
        
        // Helper functions
        const norm = (s) => String(s||'').toLowerCase().trim();
        const getV = (obj, keys) => {
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{ lower[norm(k)] = obj[k]; });
          for(const k of keys){ const v = lower[norm(k)]; if(v!==undefined) return v; }
          return '';
        };
        
        const parseDate = (value) => {
          try{
            if(!value) return null;
            const s = String(value).trim();
            let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if(m){ return new Date(+m[3], +m[2]-1, +m[1]); }
            m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
            if(m){ return new Date(+m[1], +m[2]-1, +m[3]); }
            return new Date(s);
          }catch(_){ return null; }
        };
        
        const formatYyyyMm = (d) => {
          if(!d) return '';
          return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        };
        
        // Filter tasks for this employee with "4M rà soát" not empty
        let filteredTasks = F5A_P3_RAW.filter(r => {
          const name = String(getV(r, [
            'assignee','employee','name',
            'nhân viên','nhan vien','nhanvien',
            'tên nhân viên','ten nhan vien','tennhanvien',
            'phụ trách','phu trac','phutrac'
          ])||'').trim();
          
          // Skip tasks assigned to "x" (pending tasks)
          if(name.toLowerCase() === 'x') {
            return false;
          }
          
          if(name !== employeeName) return false;
          
          // Check "4M rà soát" - must not be empty
          const rasoat4m = String(getV(r, [
            '4M rà soát','4m rà soát','4m ra soat',
            '4M','4m rasoat','rasoat4m'
          ])||'').trim();
          
          if(!rasoat4m) return false;
          
          // Filter by month if specified
          if(month){
            const completionDateStr = getV(r, [
              'ngày hoàn thành thực tế','ngay hoan thanh thuc te',
              'ngày hoàn thành','ngay hoan thanh',
              'completion date','completiondate'
            ]);
            const completionDate = parseDate(completionDateStr);
            if(completionDate && formatYyyyMm(completionDate) !== month) return false;
          }
          
          return true;
        });
        
        console.log('[P4 Modal] Found', filteredTasks.length, 'tasks');
        
        // Generate table HTML
        let tableHtml = `
          <table class="min-w-full text-sm border">
            <thead class="bg-blue-50">
              <tr>
                <th class="px-3 py-2 text-left border">STT</th>
                <th class="px-3 py-2 text-left border">Mã tác vụ</th>
                <th class="px-3 py-2 text-left border">Task Name</th>
                <th class="px-3 py-2 text-left border">Ngày hoàn thành</th>
                <th class="px-3 py-2 text-center border">TCKT(%)</th>
                <th class="px-3 py-2 text-center border">CE(%)</th>
                <th class="px-3 py-2 text-center border">HDKT(%)</th>
                <th class="px-3 py-2 text-center border">BB đào tạo(%)</th>
                <th class="px-3 py-2 text-center border">Jig tool(%)</th>
                <th class="px-3 py-2 text-center border">KHKSCL(%)</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        if(filteredTasks.length === 0){
          tableHtml += '<tr><td colspan="10" class="px-3 py-3 text-center text-gray-500 border">Không có tác vụ nào</td></tr>';
        } else {
          filteredTasks.forEach((task, idx) => {
            const taskCode = String(getV(task, ['mã tác vụ','ma tac vu','task code','taskcode'])||'');
            const taskName = String(getV(task, ['task name','taskname','tên tác vụ','ten tac vu'])||'');
            const completionDate = String(getV(task, ['ngày hoàn thành thực tế','ngay hoan thanh thuc te'])||'');
            
            // Parse and format percentage values
            const formatPercent = (val) => {
              if(!val) return '-';
              const v = String(val).replace('%','').trim();
              const num = parseFloat(v);
              if(isNaN(num)) return '-';
              // If value is between 0-1, convert to percentage
              if(num <= 1 && num > 0) {
                return Math.round(num * 100) + '%';
              }
              // If value is already percentage, just add % if missing
              return Math.round(num) + '%';
            };
            
            const tckt = formatPercent(getV(task, ['TCKT(% hoàn thành)','tckt(% hoàn thành)','tckt']));
            const ce = formatPercent(getV(task, ['CE(% hoàn thành)','ce(% hoàn thành)','ce']));
            const hdkt = formatPercent(getV(task, ['HDKT(% hoàn thành)','hdkt(% hoàn thành)','hdkt']));
            const bb = formatPercent(getV(task, ['BB đào tạo(% hoàn thành)','bb đào tạo(% hoàn thành)','bb đào tạo']));
            const jig = formatPercent(getV(task, ['Jig tool(% hoàn thành)','jig tool(% hoàn thành)','jig tool']));
            const khkscl = formatPercent(getV(task, ['KHKSCL(% hoàn thành)','khkscl(% hoàn thành)','khkscl']));
            
            tableHtml += `
              <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 border">${idx + 1}</td>
                <td class="px-3 py-2 border font-mono text-xs">${taskCode}</td>
                <td class="px-3 py-2 border">${taskName}</td>
                <td class="px-3 py-2 border text-center">${completionDate}</td>
                <td class="px-3 py-2 border text-center">${tckt}</td>
                <td class="px-3 py-2 border text-center">${ce}</td>
                <td class="px-3 py-2 border text-center">${hdkt}</td>
                <td class="px-3 py-2 border text-center">${bb}</td>
                <td class="px-3 py-2 border text-center">${jig}</td>
                <td class="px-3 py-2 border text-center">${khkscl}</td>
              </tr>
            `;
          });
        }
        
        tableHtml += '</tbody></table>';
        
        // Update modal
        document.getElementById('p4-modal-title').textContent = `Chi tiết tác vụ máy - ${employeeName} (${filteredTasks.length} tác vụ)`;
        document.getElementById('p4-modal-content').innerHTML = tableHtml;
        document.getElementById('p4-task-modal').classList.remove('hidden');
        
      } catch(err) {
        console.error('[P4 Modal] Error:', err);
        alert('Lỗi hiển thị chi tiết tác vụ');
      }
    }
    
    function closeP4TaskModal() {
      document.getElementById('p4-task-modal').classList.add('hidden');
    }

    // Event listener cho nút "Chọn tệp" của Form 2
    document.addEventListener('DOMContentLoaded', function() {
      const uploadFileBtn = document.getElementById('upload-file-btn');
      const uploadFileInput = document.getElementById('upload-file');
      const uploadFileName = document.getElementById('upload-file-name');
      
      if (uploadFileBtn && uploadFileInput && uploadFileName) {
        uploadFileBtn.addEventListener('click', function(e) {
          e.preventDefault();
          uploadFileInput.click();
        });
        
        uploadFileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            uploadFileName.textContent = file.name;
            uploadFileName.className = 'text-sm text-green-600 font-medium';
          } else {
            uploadFileName.textContent = 'Không có tệp nào được chọn';
            uploadFileName.className = 'text-sm text-gray-600';
          }
        });
      }
    });

    // ===== NAVIGATION AND FORM VISIBILITY CONTROL =====
    // Hàm ẩn tất cả các form
    function hideAllForms() {
      const forms = document.querySelectorAll('section[id^="form"]');
      forms.forEach(form => {
        form.classList.add('hidden');
      });
    }

    // Hàm hiển thị form theo ID
    function showForm(formId) {
      hideAllForms();
      const targetForm = document.getElementById(formId);
      if (targetForm) {
        targetForm.classList.remove('hidden');
        // Bật tính năng collapse sidebar khi đã chọn form
        const sidebarNav = document.getElementById('sidebar-nav');
        if (sidebarNav) {
          sidebarNav.classList.add('collapsible');
        }
      }
    }

    // Hàm đóng tất cả các nhóm sidebar
    function closeAllSidebarGroups() {
      const groupItems = document.querySelectorAll('.group-items');
      groupItems.forEach(item => {
        item.classList.add('hidden');
      });
    }

    // Hàm mở/đóng nhóm sidebar
    function toggleSidebarGroup(button) {
      const groupItems = button.nextElementSibling;
      if (groupItems && groupItems.classList.contains('group-items')) {
        // Đóng tất cả các nhóm khác
        closeAllSidebarGroups();
        // Mở/đóng nhóm hiện tại
        groupItems.classList.toggle('hidden');
      }
    }

    // Khởi tạo navigation khi DOM loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Navigation] Initializing navigation system...');
      
      // 1. Ẩn tất cả các form trước
      hideAllForms();
      
      // 2. Không hiển thị form nào mặc định - người dùng phải chọn form để xem
      
      // 3. MỞ TẤT CẢ các nhóm sidebar để có thể click trực tiếp vào form
      const groupItems = document.querySelectorAll('.group-items');
      groupItems.forEach(item => {
        item.classList.remove('hidden');
      });
      
      // 4. Xử lý click vào các nút navigation (data-target)
      const navButtons = document.querySelectorAll('.nav-btn[data-target]');
      navButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const targetForm = this.getAttribute('data-target');
          console.log('[Navigation] Switching to form:', targetForm);
          
          // Hiển thị form được chọn
          showForm(targetForm);
          // Bật tính năng collapse sidebar khi user chọn form
          const sidebarNav = document.getElementById('sidebar-nav');
          if (sidebarNav && targetForm) {
            sidebarNav.classList.add('collapsible');
          }
        });
      });
      
      // 5. Vô hiệu hóa click vào các nút nhóm sidebar (group-btn) vì không cần thiết
      const groupButtons = document.querySelectorAll('.group-btn');
      groupButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          // Không làm gì cả - giữ nguyên trạng thái mở
        });
      });
      
      console.log('[Navigation] Navigation system initialized successfully');
      console.log('[Navigation] Found', navButtons.length, 'navigation buttons');
      console.log('[Navigation] Found', groupButtons.length, 'sidebar group buttons');
      console.log('[Navigation] All sidebar groups are now OPEN for direct form access');
    });
  </script>
</body>
</html>


